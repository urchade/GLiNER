<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>gliner.data_processing.processor - Home 0.2.24 documentation</title><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=d140fbf8" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="gliner.data_processing.processor"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../../index.html">
      
      
      <strong>Home</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction to ðŸ‘‘ GLiNER</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../instalation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configs.html">Components &amp; Configs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architectures.html">Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../convert_to_onnx.html">ONNX Export &amp; Deployment</a></li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gliner.model.html">gliner.model module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gliner.config.html">gliner.config module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gliner.training.html">gliner.training package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.training.trainer.html">gliner.training.trainer module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gliner.modeling.html">gliner.modeling package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.modeling.multitask.html">gliner.modeling.multitask package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gliner.modeling.multitask.relations_layers.html">gliner.modeling.multitask.relations_layers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gliner.modeling.multitask.triples_layers.html">gliner.modeling.multitask.triples_layers module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.modeling.base.html">gliner.modeling.base module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.modeling.decoder.html">gliner.modeling.decoder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.modeling.encoder.html">gliner.modeling.encoder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.modeling.layers.html">gliner.modeling.layers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.modeling.loss_functions.html">gliner.modeling.loss_functions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.modeling.outputs.html">gliner.modeling.outputs module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.modeling.scorers.html">gliner.modeling.scorers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.modeling.span_rep.html">gliner.modeling.span_rep module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.modeling.utils.html">gliner.modeling.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gliner.data_processing.html">gliner.data_processing package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.data_processing.collator.html">gliner.data_processing.collator module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.data_processing.processor.html">gliner.data_processing.processor module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.data_processing.tokenizer.html">gliner.data_processing.tokenizer module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.data_processing.utils.html">gliner.data_processing.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gliner.evaluation.html">gliner.evaluation package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.evaluation.evaluate_ner.html">gliner.evaluation.evaluate_ner module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.evaluation.evaluator.html">gliner.evaluation.evaluator module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.evaluation.utils.html">gliner.evaluation.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gliner.onnx.html">gliner.onnx package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.onnx.model.html">gliner.onnx.model module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gliner.decoding.html">gliner.decoding package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.decoding.trie.html">gliner.decoding.trie package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gliner.decoding.trie.labels_trie.html">gliner.decoding.trie.labels_trie module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gliner.decoding.trie.python_labels_trie.html">gliner.decoding.trie.python_labels_trie module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.decoding.decoder.html">gliner.decoding.decoder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gliner.decoding.utils.html">gliner.decoding.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gliner.utils.html">gliner.utils module</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../index.html"><span itemprop="name">Home</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">gliner.data_processing.processor</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for gliner.data_processing.processor</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span data-line="2"><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
</span><span data-line="3"><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
</span><span data-line="6">
</span><span data-line="7"><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
</span><span data-line="9"><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn.utils.rnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">pad_sequence</span>
</span><span data-line="10">
</span><span data-line="11"><span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_mapping</span><span class="p">,</span> <span class="n">get_negatives</span><span class="p">,</span> <span class="n">pad_2d_tensor</span><span class="p">,</span> <span class="n">prepare_span_idx</span><span class="p">,</span> <span class="n">prepare_word_mask</span>
</span><span data-line="12"><span class="kn">from</span><span class="w"> </span><span class="nn">.tokenizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">WordsSplitter</span>
</span><span data-line="13">
</span><span data-line="14">
<div class="viewcode-block" id="BaseProcessor">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor">[docs]</a>
</span><span data-line="15"><span class="k">class</span><span class="w"> </span><span class="nc">BaseProcessor</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span data-line="16"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for data processors.</span>
</span><span data-line="17">
</span><span data-line="18"><span class="sd">    This class provides the common interface and utilities for all processor</span>
</span><span data-line="19"><span class="sd">    implementations, handling tokenization, label preparation, and batch collation</span>
</span><span data-line="20"><span class="sd">    for NER and RE tasks.</span>
</span><span data-line="21"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="22">
<div class="viewcode-block" id="BaseProcessor.__init__">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.__init__">[docs]</a>
</span><span data-line="23">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">):</span>
</span><span data-line="24"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the base processor.</span>
</span><span data-line="25">
</span><span data-line="26"><span class="sd">        Args:</span>
</span><span data-line="27"><span class="sd">            config: Configuration object containing model and processing parameters.</span>
</span><span data-line="28"><span class="sd">            tokenizer: Transformer tokenizer for subword tokenization.</span>
</span><span data-line="29"><span class="sd">            words_splitter: Word-level tokenizer/splitter. If None, creates one</span>
</span><span data-line="30"><span class="sd">                based on config.words_splitter_type.</span>
</span><span data-line="31"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="32">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span data-line="33">        <span class="bp">self</span><span class="o">.</span><span class="n">transformer_tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
</span><span data-line="34">        <span class="k">if</span> <span class="n">words_splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="35">            <span class="bp">self</span><span class="o">.</span><span class="n">words_splitter</span> <span class="o">=</span> <span class="n">WordsSplitter</span><span class="p">(</span><span class="n">splitter_type</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">words_splitter_type</span><span class="p">)</span>
</span><span data-line="36">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="37">            <span class="bp">self</span><span class="o">.</span><span class="n">words_splitter</span> <span class="o">=</span> <span class="n">words_splitter</span>
</span><span data-line="38">        <span class="bp">self</span><span class="o">.</span><span class="n">ent_token</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ent_token</span>
</span><span data-line="39">        <span class="bp">self</span><span class="o">.</span><span class="n">sep_token</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sep_token</span>
</span><span data-line="40">
</span><span data-line="41">        <span class="c1"># Check if the tokenizer has unk_token and pad_token</span>
</span><span data-line="42">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_and_set_special_tokens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">)</span></div>

</span><span data-line="43">
</span><span data-line="44">    <span class="k">def</span><span class="w"> </span><span class="nf">_check_and_set_special_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
</span><span data-line="45"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check and set special tokens for the tokenizer.</span>
</span><span data-line="46">
</span><span data-line="47"><span class="sd">        Ensures the tokenizer has necessary special tokens (unk_token, pad_token).</span>
</span><span data-line="48"><span class="sd">        If pad_token is missing, attempts to use eos_token as a fallback.</span>
</span><span data-line="49">
</span><span data-line="50"><span class="sd">        Args:</span>
</span><span data-line="51"><span class="sd">            tokenizer: The tokenizer to check and modify.</span>
</span><span data-line="52">
</span><span data-line="53"><span class="sd">        Warnings:</span>
</span><span data-line="54"><span class="sd">            UserWarning: If unk_token or pad_token is missing.</span>
</span><span data-line="55"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="56">        <span class="k">if</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">unk_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="57">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;unk_token_id&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">unk_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="58">                <span class="c1"># Tokenizer has unk_token_id but not unk_token</span>
</span><span data-line="59">                <span class="k">pass</span>
</span><span data-line="60">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="61">                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Tokenizer missing &#39;unk_token&#39;. This may cause issues.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="62">
</span><span data-line="63">        <span class="k">if</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="64">            <span class="c1"># Try to use eos_token as pad_token (common practice)</span>
</span><span data-line="65">            <span class="k">if</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="66">                <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
</span><span data-line="67">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="68">                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="69">                    <span class="s2">&quot;Tokenizer missing &#39;pad_token&#39;. Consider setting it explicitly.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
</span><span data-line="70">                <span class="p">)</span>
</span><span data-line="71">
<div class="viewcode-block" id="BaseProcessor.get_dict">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.get_dict">[docs]</a>
</span><span data-line="72">    <span class="nd">@staticmethod</span>
</span><span data-line="73">    <span class="k">def</span><span class="w"> </span><span class="nf">get_dict</span><span class="p">(</span><span class="n">spans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">classes_to_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
</span><span data-line="74"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a dictionary mapping spans to their class IDs.</span>
</span><span data-line="75">
</span><span data-line="76"><span class="sd">        Args:</span>
</span><span data-line="77"><span class="sd">            spans: List of tuples (start, end, label) representing entity spans.</span>
</span><span data-line="78"><span class="sd">            classes_to_id: Mapping from class labels to integer IDs.</span>
</span><span data-line="79">
</span><span data-line="80"><span class="sd">        Returns:</span>
</span><span data-line="81"><span class="sd">            Dictionary mapping (start, end) tuples to class IDs.</span>
</span><span data-line="82"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="83">        <span class="n">dict_tag</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span data-line="84">        <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">spans</span><span class="p">:</span>
</span><span data-line="85">            <span class="k">if</span> <span class="n">span</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">classes_to_id</span><span class="p">:</span>
</span><span data-line="86">                <span class="n">dict_tag</span><span class="p">[(</span><span class="n">span</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">span</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">classes_to_id</span><span class="p">[</span><span class="n">span</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span data-line="87">        <span class="k">return</span> <span class="n">dict_tag</span></div>

</span><span data-line="88">
<div class="viewcode-block" id="BaseProcessor.preprocess_example">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.preprocess_example">[docs]</a>
</span><span data-line="89">    <span class="nd">@abstractmethod</span>
</span><span data-line="90">    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_example</span><span class="p">(</span>
</span><span data-line="91">        <span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ner</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">classes_to_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</span><span data-line="92">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span data-line="93"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Preprocess a single example for model input.</span>
</span><span data-line="94">
</span><span data-line="95"><span class="sd">        Args:</span>
</span><span data-line="96"><span class="sd">            tokens: List of token strings.</span>
</span><span data-line="97"><span class="sd">            ner: List of NER annotations as (start, end, label) tuples.</span>
</span><span data-line="98"><span class="sd">            classes_to_id: Mapping from class labels to integer IDs.</span>
</span><span data-line="99">
</span><span data-line="100"><span class="sd">        Returns:</span>
</span><span data-line="101"><span class="sd">            Dictionary containing preprocessed example data.</span>
</span><span data-line="102">
</span><span data-line="103"><span class="sd">        Raises:</span>
</span><span data-line="104"><span class="sd">            NotImplementedError: Must be implemented by subclasses.</span>
</span><span data-line="105"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="106">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subclasses should implement this method&quot;</span><span class="p">)</span></div>

</span><span data-line="107">
<div class="viewcode-block" id="BaseProcessor.create_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.create_labels">[docs]</a>
</span><span data-line="108">    <span class="nd">@abstractmethod</span>
</span><span data-line="109">    <span class="k">def</span><span class="w"> </span><span class="nf">create_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="110"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create label tensors from batch data.</span>
</span><span data-line="111">
</span><span data-line="112"><span class="sd">        Returns:</span>
</span><span data-line="113"><span class="sd">            Tensor containing labels for the batch.</span>
</span><span data-line="114">
</span><span data-line="115"><span class="sd">        Raises:</span>
</span><span data-line="116"><span class="sd">            NotImplementedError: Must be implemented by subclasses.</span>
</span><span data-line="117"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="118">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subclasses should implement this method&quot;</span><span class="p">)</span></div>

</span><span data-line="119">
<div class="viewcode-block" id="BaseProcessor.tokenize_and_prepare_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.tokenize_and_prepare_labels">[docs]</a>
</span><span data-line="120">    <span class="nd">@abstractmethod</span>
</span><span data-line="121">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_and_prepare_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="122"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize inputs and prepare labels for a batch.</span>
</span><span data-line="123">
</span><span data-line="124"><span class="sd">        Raises:</span>
</span><span data-line="125"><span class="sd">            NotImplementedError: Must be implemented by subclasses.</span>
</span><span data-line="126"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="127">        <span class="k">pass</span></div>

</span><span data-line="128">
<div class="viewcode-block" id="BaseProcessor.prepare_inputs">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.prepare_inputs">[docs]</a>
</span><span data-line="129">    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_inputs</span><span class="p">(</span>
</span><span data-line="130">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="131">        <span class="n">texts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span data-line="132">        <span class="n">entities</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span data-line="133">        <span class="n">blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="134">        <span class="n">add_entities</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="135">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="136">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</span><span data-line="137"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare input texts with entity type prompts.</span>
</span><span data-line="138">
</span><span data-line="139"><span class="sd">        Prepends entity type special tokens that aggregates entity label information.</span>
</span><span data-line="140">
</span><span data-line="141"><span class="sd">        Args:</span>
</span><span data-line="142"><span class="sd">            texts: Sequences of token strings, one per example.</span>
</span><span data-line="143"><span class="sd">            entities: Entity types to extract. Can be:</span>
</span><span data-line="144"><span class="sd">                - List of lists (per-example entity types)</span>
</span><span data-line="145"><span class="sd">                - Dictionary (shared entity types)</span>
</span><span data-line="146"><span class="sd">                - List of strings (same types for all examples)</span>
</span><span data-line="147"><span class="sd">            blank: Optional blank entity token for zero-shot scenarios.</span>
</span><span data-line="148"><span class="sd">            add_entities: Whether to add entity text string to the prompt.</span>
</span><span data-line="149"><span class="sd">            **kwargs: Additional keyword arguments.</span>
</span><span data-line="150">
</span><span data-line="151"><span class="sd">        Returns:</span>
</span><span data-line="152"><span class="sd">            Tuple containing:</span>
</span><span data-line="153"><span class="sd">                - List of input text sequences with prepended prompts</span>
</span><span data-line="154"><span class="sd">                - List of prompt lengths for each example</span>
</span><span data-line="155"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="156">        <span class="n">input_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="157">        <span class="n">prompt_lengths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="158">
</span><span data-line="159">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
</span><span data-line="160">            <span class="n">ents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_entities</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">blank</span><span class="p">)</span>
</span><span data-line="161">
</span><span data-line="162">            <span class="n">ents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_remap_entities</span><span class="p">(</span><span class="n">ents</span><span class="p">)</span>
</span><span data-line="163">            <span class="n">prompt</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="164">            <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">ents</span><span class="p">:</span>
</span><span data-line="165">                <span class="n">prompt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ent_token</span><span class="p">)</span>
</span><span data-line="166">                <span class="k">if</span> <span class="n">add_entities</span><span class="p">:</span>
</span><span data-line="167">                    <span class="n">prompt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ent</span><span class="p">))</span>
</span><span data-line="168">
</span><span data-line="169">            <span class="n">prompt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_prompt_tokens</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">ents</span><span class="p">)</span>
</span><span data-line="170">
</span><span data-line="171">            <span class="n">prompt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sep_token</span><span class="p">)</span>
</span><span data-line="172">            <span class="n">prompt_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">))</span>
</span><span data-line="173">            <span class="n">input_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
</span><span data-line="174">        <span class="k">return</span> <span class="n">input_texts</span><span class="p">,</span> <span class="n">prompt_lengths</span></div>

</span><span data-line="175">
</span><span data-line="176">    <span class="k">def</span><span class="w"> </span><span class="nf">_select_entities</span><span class="p">(</span>
</span><span data-line="177">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="178">        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="179">        <span class="n">entities</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span data-line="180">        <span class="n">blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="181">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="182"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Select entities for a specific example.</span>
</span><span data-line="183">
</span><span data-line="184"><span class="sd">        Args:</span>
</span><span data-line="185"><span class="sd">            i: Index of the example.</span>
</span><span data-line="186"><span class="sd">            entities: Entity specifications (see prepare_inputs).</span>
</span><span data-line="187"><span class="sd">            blank: Optional blank entity token.</span>
</span><span data-line="188">
</span><span data-line="189"><span class="sd">        Returns:</span>
</span><span data-line="190"><span class="sd">            List of entity type strings for this example.</span>
</span><span data-line="191"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="192">        <span class="k">if</span> <span class="n">blank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="193">            <span class="k">return</span> <span class="p">[</span><span class="n">blank</span><span class="p">]</span>
</span><span data-line="194">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span data-line="195">            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
</span><span data-line="196">        <span class="k">if</span> <span class="n">entities</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entities</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>  <span class="c1"># per-item lists</span>
</span><span data-line="197">            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">entities</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># type: ignore[index]</span>
</span><span data-line="198">        <span class="k">if</span> <span class="n">entities</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entities</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># same for all</span>
</span><span data-line="199">            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>  <span class="c1"># type: ignore[list-item]</span>
</span><span data-line="200">        <span class="k">return</span> <span class="p">[]</span>
</span><span data-line="201">
</span><span data-line="202">    <span class="k">def</span><span class="w"> </span><span class="nf">_maybe_remap_entities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ents</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="203"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Optionally remap entity types.</span>
</span><span data-line="204">
</span><span data-line="205"><span class="sd">        Default implementation returns entities as-is. Subclasses can override</span>
</span><span data-line="206"><span class="sd">        to provide custom entity type remapping.</span>
</span><span data-line="207">
</span><span data-line="208"><span class="sd">        Args:</span>
</span><span data-line="209"><span class="sd">            ents: Sequence of entity type strings.</span>
</span><span data-line="210">
</span><span data-line="211"><span class="sd">        Returns:</span>
</span><span data-line="212"><span class="sd">            List of (potentially remapped) entity type strings.</span>
</span><span data-line="213"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="214">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">ents</span><span class="p">)</span>
</span><span data-line="215">
</span><span data-line="216">    <span class="k">def</span><span class="w"> </span><span class="nf">_extra_prompt_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ents</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="217"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add extra tokens to the prompt.</span>
</span><span data-line="218">
</span><span data-line="219"><span class="sd">        Default implementation returns no extra tokens. Subclasses can override</span>
</span><span data-line="220"><span class="sd">        to add custom prompt tokens.</span>
</span><span data-line="221">
</span><span data-line="222"><span class="sd">        Args:</span>
</span><span data-line="223"><span class="sd">            i: Index of the example.</span>
</span><span data-line="224"><span class="sd">            text: The text sequence.</span>
</span><span data-line="225"><span class="sd">            ents: The entity types for this example.</span>
</span><span data-line="226">
</span><span data-line="227"><span class="sd">        Returns:</span>
</span><span data-line="228"><span class="sd">            List of extra prompt tokens (default: empty list).</span>
</span><span data-line="229"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="230">        <span class="k">return</span> <span class="p">[]</span>
</span><span data-line="231">
<div class="viewcode-block" id="BaseProcessor.prepare_word_mask">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.prepare_word_mask">[docs]</a>
</span><span data-line="232">    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_word_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">tokenized_inputs</span><span class="p">,</span> <span class="n">skip_first_words</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">token_level</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span data-line="233"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare word-level masks for tokenized inputs.</span>
</span><span data-line="234">
</span><span data-line="235"><span class="sd">        Creates masks that map subword tokens back to their original words.</span>
</span><span data-line="236">
</span><span data-line="237"><span class="sd">        Args:</span>
</span><span data-line="238"><span class="sd">            texts: Original text sequences.</span>
</span><span data-line="239"><span class="sd">            tokenized_inputs: Tokenized inputs from transformer tokenizer.</span>
</span><span data-line="240"><span class="sd">            skip_first_words: Optional list of word counts to skip per example</span>
</span><span data-line="241"><span class="sd">                (e.g., prompt words).</span>
</span><span data-line="242"><span class="sd">            token_level: If True, create token-level masks instead of word-level.</span>
</span><span data-line="243">
</span><span data-line="244"><span class="sd">        Returns:</span>
</span><span data-line="245"><span class="sd">            Word mask array.</span>
</span><span data-line="246"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="247">        <span class="k">return</span> <span class="n">prepare_word_mask</span><span class="p">(</span>
</span><span data-line="248">            <span class="n">texts</span><span class="p">,</span>
</span><span data-line="249">            <span class="n">tokenized_inputs</span><span class="p">,</span>
</span><span data-line="250">            <span class="n">skip_first_words</span><span class="o">=</span><span class="n">skip_first_words</span><span class="p">,</span>
</span><span data-line="251">            <span class="n">token_level</span><span class="o">=</span><span class="n">token_level</span><span class="p">,</span>
</span><span data-line="252">        <span class="p">)</span></div>

</span><span data-line="253">
<div class="viewcode-block" id="BaseProcessor.tokenize_inputs">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.tokenize_inputs">[docs]</a>
</span><span data-line="254">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="255"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize input texts with entity prompts.</span>
</span><span data-line="256">
</span><span data-line="257"><span class="sd">        Args:</span>
</span><span data-line="258"><span class="sd">            texts: Sequences of token strings.</span>
</span><span data-line="259"><span class="sd">            entities: Entity types for extraction.</span>
</span><span data-line="260"><span class="sd">            blank: Optional blank entity token.</span>
</span><span data-line="261"><span class="sd">            **kwargs: Additional keyword arguments.</span>
</span><span data-line="262">
</span><span data-line="263"><span class="sd">        Returns:</span>
</span><span data-line="264"><span class="sd">            Dictionary containing tokenized inputs with keys:</span>
</span><span data-line="265"><span class="sd">                - input_ids: Token IDs</span>
</span><span data-line="266"><span class="sd">                - attention_mask: Attention mask</span>
</span><span data-line="267"><span class="sd">                - words_mask: Word-level mask</span>
</span><span data-line="268"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="269">        <span class="n">input_texts</span><span class="p">,</span> <span class="n">prompt_lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_inputs</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="n">blank</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="270">
</span><span data-line="271">        <span class="n">tokenized_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">(</span>
</span><span data-line="272">            <span class="n">input_texts</span><span class="p">,</span>
</span><span data-line="273">            <span class="n">is_split_into_words</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="274">            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span data-line="275">            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="276">            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;longest&quot;</span><span class="p">,</span>
</span><span data-line="277">        <span class="p">)</span>
</span><span data-line="278">        <span class="n">words_masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_word_mask</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">tokenized_inputs</span><span class="p">,</span> <span class="n">prompt_lengths</span><span class="p">)</span>
</span><span data-line="279">        <span class="n">tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;words_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">words_masks</span><span class="p">)</span>
</span><span data-line="280">
</span><span data-line="281">        <span class="k">return</span> <span class="n">tokenized_inputs</span></div>

</span><span data-line="282">
<div class="viewcode-block" id="BaseProcessor.batch_generate_class_mappings">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.batch_generate_class_mappings">[docs]</a>
</span><span data-line="283">    <span class="k">def</span><span class="w"> </span><span class="nf">batch_generate_class_mappings</span><span class="p">(</span>
</span><span data-line="284">        <span class="bp">self</span><span class="p">,</span> <span class="n">batch_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">negatives</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ner&quot;</span><span class="p">,</span> <span class="n">sampled_neg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
</span><span data-line="285">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
</span><span data-line="286"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate class mappings for a batch with negative sampling.</span>
</span><span data-line="287">
</span><span data-line="288"><span class="sd">        Creates bidirectional mappings between class labels and integer IDs,</span>
</span><span data-line="289"><span class="sd">        with support for negative type sampling to improve model robustness.</span>
</span><span data-line="290">
</span><span data-line="291"><span class="sd">        Args:</span>
</span><span data-line="292"><span class="sd">            batch_list: List of example dictionaries.</span>
</span><span data-line="293"><span class="sd">            negatives: Optional pre-sampled negative types. If None, samples</span>
</span><span data-line="294"><span class="sd">                from batch.</span>
</span><span data-line="295"><span class="sd">            key: Key to access labels in batch dictionaries (default: &#39;ner&#39;).</span>
</span><span data-line="296"><span class="sd">            sampled_neg: Number of negative types to sample if negatives is None.</span>
</span><span data-line="297">
</span><span data-line="298"><span class="sd">        Returns:</span>
</span><span data-line="299"><span class="sd">            Tuple containing:</span>
</span><span data-line="300"><span class="sd">                - List of class-to-ID mappings (one per example)</span>
</span><span data-line="301"><span class="sd">                - List of ID-to-class mappings (one per example)</span>
</span><span data-line="302"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="303">        <span class="k">if</span> <span class="n">negatives</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="304">            <span class="n">negatives</span> <span class="o">=</span> <span class="n">get_negatives</span><span class="p">(</span><span class="n">batch_list</span><span class="p">,</span> <span class="n">sampled_neg</span><span class="o">=</span><span class="n">sampled_neg</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="305">        <span class="n">class_to_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="306">        <span class="n">id_to_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="307">        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch_list</span><span class="p">:</span>
</span><span data-line="308">            <span class="n">max_neg_type_ratio</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_neg_type_ratio</span><span class="p">)</span>
</span><span data-line="309">            <span class="n">neg_type_ratio</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_neg_type_ratio</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_neg_type_ratio</span> <span class="k">else</span> <span class="mi">0</span>
</span><span data-line="310">
</span><span data-line="311">            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_negatives&quot;</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>  <span class="c1"># manually setting negative types</span>
</span><span data-line="312">                <span class="n">negs_i</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_negatives&quot;</span><span class="p">]</span>
</span><span data-line="313">            <span class="k">else</span><span class="p">:</span>  <span class="c1"># in-batch negative types</span>
</span><span data-line="314">                <span class="n">negs_i</span> <span class="o">=</span> <span class="n">negatives</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">*</span> <span class="n">neg_type_ratio</span><span class="p">]</span> <span class="k">if</span> <span class="n">neg_type_ratio</span> <span class="k">else</span> <span class="p">[]</span>
</span><span data-line="315">
</span><span data-line="316">            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_labels&quot;</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>  <span class="c1"># labels are predefined</span>
</span><span data-line="317">                <span class="n">types</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_labels&quot;</span><span class="p">]</span>
</span><span data-line="318">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="319">                <span class="n">types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">+</span> <span class="n">negs_i</span><span class="p">))</span>
</span><span data-line="320">                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
</span><span data-line="321">                <span class="n">types</span> <span class="o">=</span> <span class="n">types</span><span class="p">[:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_types</span><span class="p">)]</span>
</span><span data-line="322">
</span><span data-line="323">            <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span>
</span><span data-line="324">            <span class="n">id_to_class</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span data-line="325">            <span class="n">class_to_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_to_id</span><span class="p">)</span>
</span><span data-line="326">            <span class="n">id_to_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_to_class</span><span class="p">)</span>
</span><span data-line="327">
</span><span data-line="328">        <span class="k">return</span> <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span></div>

</span><span data-line="329">
<div class="viewcode-block" id="BaseProcessor.collate_raw_batch">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.collate_raw_batch">[docs]</a>
</span><span data-line="330">    <span class="k">def</span><span class="w"> </span><span class="nf">collate_raw_batch</span><span class="p">(</span>
</span><span data-line="331">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="332">        <span class="n">batch_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
</span><span data-line="333">        <span class="n">entity_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="334">        <span class="n">negatives</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="335">        <span class="n">class_to_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="336">        <span class="n">id_to_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="337">        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">,</span>
</span><span data-line="338">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span data-line="339"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Collate a raw batch with optional dynamic or provided label mappings.</span>
</span><span data-line="340">
</span><span data-line="341"><span class="sd">        Args:</span>
</span><span data-line="342"><span class="sd">            batch_list: List of raw example dictionaries.</span>
</span><span data-line="343"><span class="sd">            entity_types: Optional predefined entity types. Can be a single list</span>
</span><span data-line="344"><span class="sd">                for all examples or list of lists for per-example types.</span>
</span><span data-line="345"><span class="sd">            negatives: Optional list of negative entity types.</span>
</span><span data-line="346"><span class="sd">            class_to_ids: Optional predefined class-to-ID mapping(s).</span>
</span><span data-line="347"><span class="sd">            id_to_classes: Optional predefined ID-to-class mapping(s).</span>
</span><span data-line="348"><span class="sd">            key: Key for accessing labels in batch (default: &#39;ner&#39;).</span>
</span><span data-line="349">
</span><span data-line="350"><span class="sd">        Returns:</span>
</span><span data-line="351"><span class="sd">            Dictionary containing collated batch data ready for model input.</span>
</span><span data-line="352"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="353">        <span class="k">if</span> <span class="n">class_to_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">entity_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="354">            <span class="c1"># Dynamically infer per-example mappings</span>
</span><span data-line="355">            <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_generate_class_mappings</span><span class="p">(</span><span class="n">batch_list</span><span class="p">,</span> <span class="n">negatives</span><span class="p">)</span>
</span><span data-line="356">        <span class="k">elif</span> <span class="n">class_to_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="357">            <span class="c1"># Build mappings from entity_types</span>
</span><span data-line="358">            <span class="k">if</span> <span class="n">entity_types</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span data-line="359">                <span class="c1"># Per-example mappings</span>
</span><span data-line="360">                <span class="n">built</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_mapping</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">entity_types</span><span class="p">]</span>  <span class="c1"># list of (fwd, rev)</span>
</span><span data-line="361">                <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">built</span><span class="p">))</span>
</span><span data-line="362">                <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">class_to_ids</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">id_to_classes</span><span class="p">)</span>
</span><span data-line="363">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="364">                <span class="c1"># Single mapping for all examples</span>
</span><span data-line="365">                <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span> <span class="o">=</span> <span class="n">make_mapping</span><span class="p">(</span><span class="n">entity_types</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span data-line="366">
</span><span data-line="367">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">class_to_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span data-line="368">            <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="369">                <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_example</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;tokenized_text&quot;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">class_to_ids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_list</span><span class="p">)</span>
</span><span data-line="370">            <span class="p">]</span>
</span><span data-line="371">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="372">            <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_example</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;tokenized_text&quot;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">class_to_ids</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch_list</span><span class="p">]</span>
</span><span data-line="373">
</span><span data-line="374">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_batch_dict</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span><span class="p">)</span></div>

</span><span data-line="375">
<div class="viewcode-block" id="BaseProcessor.collate_fn">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.collate_fn">[docs]</a>
</span><span data-line="376">    <span class="k">def</span><span class="w"> </span><span class="nf">collate_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">prepare_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="377"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Collate function for DataLoader.</span>
</span><span data-line="378">
</span><span data-line="379"><span class="sd">        Args:</span>
</span><span data-line="380"><span class="sd">            batch: Batch of examples from dataset.</span>
</span><span data-line="381"><span class="sd">            prepare_labels: Whether to prepare labels (default: True).</span>
</span><span data-line="382"><span class="sd">            *args: Variable length argument list.</span>
</span><span data-line="383"><span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
</span><span data-line="384">
</span><span data-line="385"><span class="sd">        Returns:</span>
</span><span data-line="386"><span class="sd">            Dictionary containing model inputs and labels.</span>
</span><span data-line="387"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="388">        <span class="n">model_input_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_and_prepare_labels</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">prepare_labels</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="389">        <span class="k">return</span> <span class="n">model_input_batch</span></div>

</span><span data-line="390">
<div class="viewcode-block" id="BaseProcessor.create_batch_dict">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.create_batch_dict">[docs]</a>
</span><span data-line="391">    <span class="nd">@abstractmethod</span>
</span><span data-line="392">    <span class="k">def</span><span class="w"> </span><span class="nf">create_batch_dict</span><span class="p">(</span>
</span><span data-line="393">        <span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">class_to_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">id_to_classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
</span><span data-line="394">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span data-line="395"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a batch dictionary from preprocessed examples.</span>
</span><span data-line="396">
</span><span data-line="397"><span class="sd">        Args:</span>
</span><span data-line="398"><span class="sd">            batch: List of preprocessed example dictionaries.</span>
</span><span data-line="399"><span class="sd">            class_to_ids: List of class-to-ID mappings.</span>
</span><span data-line="400"><span class="sd">            id_to_classes: List of ID-to-class mappings.</span>
</span><span data-line="401">
</span><span data-line="402"><span class="sd">        Returns:</span>
</span><span data-line="403"><span class="sd">            Dictionary containing collated batch tensors.</span>
</span><span data-line="404">
</span><span data-line="405"><span class="sd">        Raises:</span>
</span><span data-line="406"><span class="sd">            NotImplementedError: Must be implemented by subclasses.</span>
</span><span data-line="407"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="408">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subclasses should implement this method&quot;</span><span class="p">)</span></div>

</span><span data-line="409">
<div class="viewcode-block" id="BaseProcessor.create_dataloader">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseProcessor.create_dataloader">[docs]</a>
</span><span data-line="410">    <span class="k">def</span><span class="w"> </span><span class="nf">create_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">entity_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span data-line="411"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a PyTorch DataLoader with the processor&#39;s collate function.</span>
</span><span data-line="412">
</span><span data-line="413"><span class="sd">        Args:</span>
</span><span data-line="414"><span class="sd">            data: Dataset to load.</span>
</span><span data-line="415"><span class="sd">            entity_types: Optional entity types for extraction.</span>
</span><span data-line="416"><span class="sd">            *args: Additional positional arguments for DataLoader.</span>
</span><span data-line="417"><span class="sd">            **kwargs: Additional keyword arguments for DataLoader.</span>
</span><span data-line="418">
</span><span data-line="419"><span class="sd">        Returns:</span>
</span><span data-line="420"><span class="sd">            DataLoader instance configured with this processor&#39;s collate_fn.</span>
</span><span data-line="421"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="422">        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">entity_types</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>

</span><span data-line="423">
</span><span data-line="424">
<div class="viewcode-block" id="UniEncoderSpanProcessor">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderSpanProcessor">[docs]</a>
</span><span data-line="425"><span class="k">class</span><span class="w"> </span><span class="nc">UniEncoderSpanProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
</span><span data-line="426"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Processor for span-based NER with uni-encoder architecture.</span>
</span><span data-line="427">
</span><span data-line="428"><span class="sd">    This processor handles span enumeration and labeling for models that</span>
</span><span data-line="429"><span class="sd">    predict entity types for all possible spans up to a maximum width.</span>
</span><span data-line="430"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="431">
<div class="viewcode-block" id="UniEncoderSpanProcessor.preprocess_example">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderSpanProcessor.preprocess_example">[docs]</a>
</span><span data-line="432">    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">ner</span><span class="p">,</span> <span class="n">classes_to_id</span><span class="p">):</span>
</span><span data-line="433"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Preprocess a single example for span-based prediction.</span>
</span><span data-line="434">
</span><span data-line="435"><span class="sd">        Enumerates all possible spans up to max_width and creates labels</span>
</span><span data-line="436"><span class="sd">        for each span based on NER annotations.</span>
</span><span data-line="437">
</span><span data-line="438"><span class="sd">        Args:</span>
</span><span data-line="439"><span class="sd">            tokens: List of token strings.</span>
</span><span data-line="440"><span class="sd">            ner: List of NER annotations as (start, end, label) tuples.</span>
</span><span data-line="441"><span class="sd">            classes_to_id: Mapping from class labels to integer IDs.</span>
</span><span data-line="442">
</span><span data-line="443"><span class="sd">        Returns:</span>
</span><span data-line="444"><span class="sd">            Dictionary containing:</span>
</span><span data-line="445"><span class="sd">                - tokens: Token strings</span>
</span><span data-line="446"><span class="sd">                - span_idx: Tensor of span indices (start, end)</span>
</span><span data-line="447"><span class="sd">                - span_label: Tensor of span labels</span>
</span><span data-line="448"><span class="sd">                - seq_length: Sequence length</span>
</span><span data-line="449"><span class="sd">                - entities: Original NER annotations</span>
</span><span data-line="450">
</span><span data-line="451"><span class="sd">        Warnings:</span>
</span><span data-line="452"><span class="sd">            UserWarning: If sequence length exceeds max_len (gets truncated).</span>
</span><span data-line="453"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="454">        <span class="n">max_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_width</span>
</span><span data-line="455">        <span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span data-line="456">        <span class="k">if</span> <span class="n">num_tokens</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="457">            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;[PAD]&quot;</span><span class="p">]</span>
</span><span data-line="458">        <span class="n">max_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_len</span>
</span><span data-line="459">        <span class="k">if</span> <span class="n">num_tokens</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
</span><span data-line="460">            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sentence of length </span><span class="si">{</span><span class="n">num_tokens</span><span class="si">}</span><span class="s2"> has been truncated to </span><span class="si">{</span><span class="n">max_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="461">            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">max_len</span><span class="p">]</span>
</span><span data-line="462">        <span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span data-line="463">        <span class="n">spans_idx</span> <span class="o">=</span> <span class="n">prepare_span_idx</span><span class="p">(</span><span class="n">num_tokens</span><span class="p">,</span> <span class="n">max_width</span><span class="p">)</span>
</span><span data-line="464">        <span class="n">dict_lab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dict</span><span class="p">(</span><span class="n">ner</span><span class="p">,</span> <span class="n">classes_to_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">ner</span> <span class="k">else</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span data-line="465">        <span class="n">span_label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">dict_lab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spans_idx</span><span class="p">])</span>
</span><span data-line="466">        <span class="n">spans_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">spans_idx</span><span class="p">)</span>
</span><span data-line="467">        <span class="n">valid_span_mask</span> <span class="o">=</span> <span class="n">spans_idx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">num_tokens</span> <span class="o">-</span> <span class="mi">1</span>
</span><span data-line="468">        <span class="n">span_label</span> <span class="o">=</span> <span class="n">span_label</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">valid_span_mask</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="469">
</span><span data-line="470">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="471">            <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">,</span>
</span><span data-line="472">            <span class="s2">&quot;span_idx&quot;</span><span class="p">:</span> <span class="n">spans_idx</span><span class="p">,</span>
</span><span data-line="473">            <span class="s2">&quot;span_label&quot;</span><span class="p">:</span> <span class="n">span_label</span><span class="p">,</span>
</span><span data-line="474">            <span class="s2">&quot;seq_length&quot;</span><span class="p">:</span> <span class="n">num_tokens</span><span class="p">,</span>
</span><span data-line="475">            <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="n">ner</span><span class="p">,</span>
</span><span data-line="476">        <span class="p">}</span></div>

</span><span data-line="477">
<div class="viewcode-block" id="UniEncoderSpanProcessor.create_batch_dict">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderSpanProcessor.create_batch_dict">[docs]</a>
</span><span data-line="478">    <span class="k">def</span><span class="w"> </span><span class="nf">create_batch_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span><span class="p">):</span>
</span><span data-line="479"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a batch dictionary from preprocessed span examples.</span>
</span><span data-line="480">
</span><span data-line="481"><span class="sd">        Args:</span>
</span><span data-line="482"><span class="sd">            batch: List of preprocessed example dictionaries.</span>
</span><span data-line="483"><span class="sd">            class_to_ids: List of class-to-ID mappings.</span>
</span><span data-line="484"><span class="sd">            id_to_classes: List of ID-to-class mappings.</span>
</span><span data-line="485">
</span><span data-line="486"><span class="sd">        Returns:</span>
</span><span data-line="487"><span class="sd">            Dictionary containing:</span>
</span><span data-line="488"><span class="sd">                - seq_length: Sequence lengths</span>
</span><span data-line="489"><span class="sd">                - span_idx: Padded span indices</span>
</span><span data-line="490"><span class="sd">                - tokens: Token strings</span>
</span><span data-line="491"><span class="sd">                - span_mask: Mask for valid spans</span>
</span><span data-line="492"><span class="sd">                - span_label: Padded span labels</span>
</span><span data-line="493"><span class="sd">                - entities: Original NER annotations</span>
</span><span data-line="494"><span class="sd">                - classes_to_id: Class mappings</span>
</span><span data-line="495"><span class="sd">                - id_to_classes: Reverse class mappings</span>
</span><span data-line="496"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="497">        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span data-line="498">        <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span data-line="499">        <span class="n">span_idx</span> <span class="o">=</span> <span class="n">pad_sequence</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;span_idx&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">],</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="500">        <span class="n">span_label</span> <span class="o">=</span> <span class="n">pad_sequence</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;span_label&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">],</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="501">        <span class="n">seq_length</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;seq_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="502">        <span class="n">span_mask</span> <span class="o">=</span> <span class="n">span_label</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span><span data-line="503">
</span><span data-line="504">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="505">            <span class="s2">&quot;seq_length&quot;</span><span class="p">:</span> <span class="n">seq_length</span><span class="p">,</span>
</span><span data-line="506">            <span class="s2">&quot;span_idx&quot;</span><span class="p">:</span> <span class="n">span_idx</span><span class="p">,</span>
</span><span data-line="507">            <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">,</span>
</span><span data-line="508">            <span class="s2">&quot;span_mask&quot;</span><span class="p">:</span> <span class="n">span_mask</span><span class="p">,</span>
</span><span data-line="509">            <span class="s2">&quot;span_label&quot;</span><span class="p">:</span> <span class="n">span_label</span><span class="p">,</span>
</span><span data-line="510">            <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="n">entities</span><span class="p">,</span>
</span><span data-line="511">            <span class="s2">&quot;classes_to_id&quot;</span><span class="p">:</span> <span class="n">class_to_ids</span><span class="p">,</span>
</span><span data-line="512">            <span class="s2">&quot;id_to_classes&quot;</span><span class="p">:</span> <span class="n">id_to_classes</span><span class="p">,</span>
</span><span data-line="513">        <span class="p">}</span></div>

</span><span data-line="514">
<div class="viewcode-block" id="UniEncoderSpanProcessor.create_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderSpanProcessor.create_labels">[docs]</a>
</span><span data-line="515">    <span class="k">def</span><span class="w"> </span><span class="nf">create_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
</span><span data-line="516"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create one-hot encoded labels for spans.</span>
</span><span data-line="517">
</span><span data-line="518"><span class="sd">        Creates multi-label one-hot vectors for each span, allowing spans</span>
</span><span data-line="519"><span class="sd">        to have multiple entity types.</span>
</span><span data-line="520">
</span><span data-line="521"><span class="sd">        Args:</span>
</span><span data-line="522"><span class="sd">            batch: Batch dictionary containing tokens, entities, and class mappings.</span>
</span><span data-line="523">
</span><span data-line="524"><span class="sd">        Returns:</span>
</span><span data-line="525"><span class="sd">            Tensor of shape (batch_size, max_spans, num_classes) containing</span>
</span><span data-line="526"><span class="sd">            one-hot encoded labels.</span>
</span><span data-line="527"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="528">        <span class="n">labels_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="529">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">])):</span>
</span><span data-line="530">            <span class="n">tokens</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="531">            <span class="n">classes_to_id</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="532">            <span class="n">ner</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="533">            <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes_to_id</span><span class="p">)</span>
</span><span data-line="534">            <span class="n">spans_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">prepare_span_idx</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_width</span><span class="p">))</span>
</span><span data-line="535">            <span class="n">span_to_index</span> <span class="o">=</span> <span class="p">{(</span><span class="n">spans_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">spans_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()):</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spans_idx</span><span class="p">))}</span>
</span><span data-line="536">            <span class="n">labels_one_hot</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spans_idx</span><span class="p">),</span> <span class="n">num_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
</span><span data-line="537">            <span class="n">end_token_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span data-line="538">            <span class="n">span_labels_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="539">            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ner</span><span class="p">:</span>
</span><span data-line="540">                <span class="n">span</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span data-line="541">                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">classes_to_id</span> <span class="ow">and</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">span_to_index</span><span class="p">:</span>
</span><span data-line="542">                    <span class="n">idx</span> <span class="o">=</span> <span class="n">span_to_index</span><span class="p">[</span><span class="n">span</span><span class="p">]</span>
</span><span data-line="543">                    <span class="n">class_id</span> <span class="o">=</span> <span class="n">classes_to_id</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
</span><span data-line="544">                    <span class="n">labels_one_hot</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">class_id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span data-line="545">                    <span class="n">span_labels_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
</span><span data-line="546">            <span class="n">valid_span_mask</span> <span class="o">=</span> <span class="n">spans_idx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">end_token_idx</span>
</span><span data-line="547">            <span class="n">labels_one_hot</span><span class="p">[</span><span class="n">valid_span_mask</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span data-line="548">            <span class="n">labels_one_hot</span> <span class="o">=</span> <span class="n">labels_one_hot</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span data-line="549">            <span class="n">labels_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels_one_hot</span><span class="p">)</span>
</span><span data-line="550">        <span class="n">labels_batch</span> <span class="o">=</span> <span class="n">pad_2d_tensor</span><span class="p">(</span><span class="n">labels_batch</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">labels_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="551">        <span class="k">return</span> <span class="n">labels_batch</span></div>

</span><span data-line="552">
<div class="viewcode-block" id="UniEncoderSpanProcessor.tokenize_and_prepare_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderSpanProcessor.tokenize_and_prepare_labels">[docs]</a>
</span><span data-line="553">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_and_prepare_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">prepare_labels</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="554"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize inputs and prepare span labels for a batch.</span>
</span><span data-line="555">
</span><span data-line="556"><span class="sd">        Args:</span>
</span><span data-line="557"><span class="sd">            batch: Batch dictionary with tokens and class mappings.</span>
</span><span data-line="558"><span class="sd">            prepare_labels: Whether to prepare labels.</span>
</span><span data-line="559"><span class="sd">            *args: Variable length argument list.</span>
</span><span data-line="560"><span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
</span><span data-line="561">
</span><span data-line="562"><span class="sd">        Returns:</span>
</span><span data-line="563"><span class="sd">            Dictionary containing tokenized inputs and optionally labels.</span>
</span><span data-line="564"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="565">        <span class="n">tokenized_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_inputs</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">])</span>
</span><span data-line="566">        <span class="k">if</span> <span class="n">prepare_labels</span><span class="p">:</span>
</span><span data-line="567">            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_labels</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span data-line="568">            <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span data-line="569">
</span><span data-line="570">        <span class="k">return</span> <span class="n">tokenized_input</span></div>
</div>

</span><span data-line="571">
</span><span data-line="572">
<div class="viewcode-block" id="UniEncoderTokenProcessor">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderTokenProcessor">[docs]</a>
</span><span data-line="573"><span class="k">class</span><span class="w"> </span><span class="nc">UniEncoderTokenProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
</span><span data-line="574"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Processor for token-based NER with uni-encoder architecture.</span>
</span><span data-line="575">
</span><span data-line="576"><span class="sd">    This processor handles token-level classification where each token is</span>
</span><span data-line="577"><span class="sd">    labeled with BIO-style tags (Begin, Inside, Outside) for each entity type.</span>
</span><span data-line="578"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="579">
<div class="viewcode-block" id="UniEncoderTokenProcessor.preprocess_example">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderTokenProcessor.preprocess_example">[docs]</a>
</span><span data-line="580">    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">ner</span><span class="p">,</span> <span class="n">classes_to_id</span><span class="p">):</span>
</span><span data-line="581"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Preprocess a single example for token-based prediction.</span>
</span><span data-line="582">
</span><span data-line="583"><span class="sd">        Args:</span>
</span><span data-line="584"><span class="sd">            tokens: List of token strings.</span>
</span><span data-line="585"><span class="sd">            ner: List of NER annotations as (start, end, label) tuples.</span>
</span><span data-line="586"><span class="sd">            classes_to_id: Mapping from class labels to integer IDs.</span>
</span><span data-line="587">
</span><span data-line="588"><span class="sd">        Returns:</span>
</span><span data-line="589"><span class="sd">            Dictionary containing:</span>
</span><span data-line="590"><span class="sd">                - tokens: Token strings</span>
</span><span data-line="591"><span class="sd">                - seq_length: Sequence length</span>
</span><span data-line="592"><span class="sd">                - entities: Original NER annotations</span>
</span><span data-line="593"><span class="sd">                - entities_id: Entity annotations with class IDs</span>
</span><span data-line="594">
</span><span data-line="595"><span class="sd">        Warnings:</span>
</span><span data-line="596"><span class="sd">            UserWarning: If sequence length exceeds max_len (gets truncated).</span>
</span><span data-line="597"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="598">        <span class="c1"># Ensure there is always a token list, even if it&#39;s empty</span>
</span><span data-line="599">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="600">            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;[PAD]&quot;</span><span class="p">]</span>
</span><span data-line="601">
</span><span data-line="602">        <span class="c1"># Limit the length of tokens based on configuration maximum length</span>
</span><span data-line="603">        <span class="n">max_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_len</span>
</span><span data-line="604">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
</span><span data-line="605">            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sentence of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="si">}</span><span class="s2"> has been truncated to </span><span class="si">{</span><span class="n">max_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="606">            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">max_len</span><span class="p">]</span>
</span><span data-line="607">
</span><span data-line="608">        <span class="c1"># Generate entity IDs based on the NER spans provided and their classes</span>
</span><span data-line="609">        <span class="k">try</span><span class="p">:</span>  <span class="c1"># &#39;NoneType&#39; object is not iterable</span>
</span><span data-line="610">            <span class="n">entities_id</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">classes_to_id</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ner</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">classes_to_id</span><span class="p">]</span>
</span><span data-line="611">        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span data-line="612">            <span class="n">entities_id</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="613">
</span><span data-line="614">        <span class="n">example</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">,</span> <span class="s2">&quot;seq_length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="n">ner</span><span class="p">,</span> <span class="s2">&quot;entities_id&quot;</span><span class="p">:</span> <span class="n">entities_id</span><span class="p">}</span>
</span><span data-line="615">        <span class="k">return</span> <span class="n">example</span></div>

</span><span data-line="616">
<div class="viewcode-block" id="UniEncoderTokenProcessor.create_batch_dict">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderTokenProcessor.create_batch_dict">[docs]</a>
</span><span data-line="617">    <span class="k">def</span><span class="w"> </span><span class="nf">create_batch_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span><span class="p">):</span>
</span><span data-line="618"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a batch dictionary from preprocessed token examples.</span>
</span><span data-line="619">
</span><span data-line="620"><span class="sd">        Args:</span>
</span><span data-line="621"><span class="sd">            batch: List of preprocessed example dictionaries.</span>
</span><span data-line="622"><span class="sd">            class_to_ids: List of class-to-ID mappings.</span>
</span><span data-line="623"><span class="sd">            id_to_classes: List of ID-to-class mappings.</span>
</span><span data-line="624">
</span><span data-line="625"><span class="sd">        Returns:</span>
</span><span data-line="626"><span class="sd">            Dictionary containing:</span>
</span><span data-line="627"><span class="sd">                - tokens: Token strings</span>
</span><span data-line="628"><span class="sd">                - seq_length: Sequence lengths</span>
</span><span data-line="629"><span class="sd">                - entities: Original NER annotations</span>
</span><span data-line="630"><span class="sd">                - entities_id: Entity annotations with class IDs</span>
</span><span data-line="631"><span class="sd">                - classes_to_id: Class mappings</span>
</span><span data-line="632"><span class="sd">                - id_to_classes: Reverse class mappings</span>
</span><span data-line="633"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="634">        <span class="c1"># Extract relevant data from batch for batch processing</span>
</span><span data-line="635">        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span data-line="636">        <span class="n">seq_length</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;seq_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="637">        <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span data-line="638">        <span class="n">entities_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;entities_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span data-line="639">
</span><span data-line="640">        <span class="c1"># Assemble and return the batch dictionary</span>
</span><span data-line="641">        <span class="n">batch_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="642">            <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">,</span>
</span><span data-line="643">            <span class="s2">&quot;seq_length&quot;</span><span class="p">:</span> <span class="n">seq_length</span><span class="p">,</span>
</span><span data-line="644">            <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="n">entities</span><span class="p">,</span>
</span><span data-line="645">            <span class="s2">&quot;entities_id&quot;</span><span class="p">:</span> <span class="n">entities_id</span><span class="p">,</span>
</span><span data-line="646">            <span class="s2">&quot;classes_to_id&quot;</span><span class="p">:</span> <span class="n">class_to_ids</span><span class="p">,</span>
</span><span data-line="647">            <span class="s2">&quot;id_to_classes&quot;</span><span class="p">:</span> <span class="n">id_to_classes</span><span class="p">,</span>
</span><span data-line="648">        <span class="p">}</span>
</span><span data-line="649">
</span><span data-line="650">        <span class="k">return</span> <span class="n">batch_dict</span></div>

</span><span data-line="651">
<div class="viewcode-block" id="UniEncoderTokenProcessor.create_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderTokenProcessor.create_labels">[docs]</a>
</span><span data-line="652">    <span class="k">def</span><span class="w"> </span><span class="nf">create_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entities_id</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
</span><span data-line="653"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create token-level labels with begin/inside/end markers.</span>
</span><span data-line="654">
</span><span data-line="655"><span class="sd">        Creates labels indicating which tokens are at the start, end, or inside</span>
</span><span data-line="656"><span class="sd">        of entity spans for each entity type.</span>
</span><span data-line="657">
</span><span data-line="658"><span class="sd">        Args:</span>
</span><span data-line="659"><span class="sd">            entities_id: List of entity annotations with class IDs for each example.</span>
</span><span data-line="660"><span class="sd">            batch_size: Size of the batch.</span>
</span><span data-line="661"><span class="sd">            seq_len: Maximum sequence length in batch.</span>
</span><span data-line="662"><span class="sd">            num_classes: Number of entity classes.</span>
</span><span data-line="663">
</span><span data-line="664"><span class="sd">        Returns:</span>
</span><span data-line="665"><span class="sd">            Tensor of shape (batch_size, seq_len, num_classes, 3) where the last</span>
</span><span data-line="666"><span class="sd">            dimension contains [start_marker, end_marker, inside_marker].</span>
</span><span data-line="667"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="668">        <span class="n">word_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
</span><span data-line="669">
</span><span data-line="670">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sentence_entities</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entities_id</span><span class="p">):</span>
</span><span data-line="671">            <span class="k">for</span> <span class="n">st</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">sp_label</span> <span class="ow">in</span> <span class="n">sentence_entities</span><span class="p">:</span>
</span><span data-line="672">                <span class="n">class_idx</span> <span class="o">=</span> <span class="n">sp_label</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Convert to 0-indexed</span>
</span><span data-line="673">
</span><span data-line="674">                <span class="c1"># skip entities that point beyond sequence length</span>
</span><span data-line="675">                <span class="k">if</span> <span class="n">st</span> <span class="o">&gt;=</span> <span class="n">seq_len</span> <span class="ow">or</span> <span class="n">ed</span> <span class="o">&gt;=</span> <span class="n">seq_len</span><span class="p">:</span>
</span><span data-line="676">                    <span class="k">continue</span>
</span><span data-line="677">
</span><span data-line="678">                <span class="n">word_labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># start token</span>
</span><span data-line="679">                <span class="n">word_labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># end token</span>
</span><span data-line="680">                <span class="n">word_labels</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">st</span> <span class="p">:</span> <span class="n">ed</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># inside tokens (inclusive)</span>
</span><span data-line="681">
</span><span data-line="682">        <span class="k">return</span> <span class="n">word_labels</span></div>

</span><span data-line="683">
<div class="viewcode-block" id="UniEncoderTokenProcessor.tokenize_and_prepare_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderTokenProcessor.tokenize_and_prepare_labels">[docs]</a>
</span><span data-line="684">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_and_prepare_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">prepare_labels</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="685"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize inputs and prepare token-level labels for a batch.</span>
</span><span data-line="686">
</span><span data-line="687"><span class="sd">        Args:</span>
</span><span data-line="688"><span class="sd">            batch: Batch dictionary with tokens and class mappings.</span>
</span><span data-line="689"><span class="sd">            prepare_labels: Whether to prepare labels.</span>
</span><span data-line="690"><span class="sd">            *args: Variable length argument list.</span>
</span><span data-line="691"><span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
</span><span data-line="692">
</span><span data-line="693"><span class="sd">        Returns:</span>
</span><span data-line="694"><span class="sd">            Dictionary containing tokenized inputs and optionally labels.</span>
</span><span data-line="695"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="696">        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">])</span>
</span><span data-line="697">        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;seq_length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span data-line="698">        <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span> <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">]])</span>
</span><span data-line="699">
</span><span data-line="700">        <span class="n">tokenized_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_inputs</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">])</span>
</span><span data-line="701">
</span><span data-line="702">        <span class="k">if</span> <span class="n">prepare_labels</span><span class="p">:</span>
</span><span data-line="703">            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_labels</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;entities_id&quot;</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
</span><span data-line="704">            <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span data-line="705">        <span class="k">return</span> <span class="n">tokenized_input</span></div>
</div>

</span><span data-line="706">
</span><span data-line="707">
<div class="viewcode-block" id="BaseBiEncoderProcessor">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseBiEncoderProcessor">[docs]</a>
</span><span data-line="708"><span class="k">class</span><span class="w"> </span><span class="nc">BaseBiEncoderProcessor</span><span class="p">(</span><span class="n">BaseProcessor</span><span class="p">):</span>
</span><span data-line="709"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base processor for bi-encoder architectures.</span>
</span><span data-line="710">
</span><span data-line="711"><span class="sd">    Bi-encoder models use separate encoders for text and entity types.</span>
</span><span data-line="712"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="713">
<div class="viewcode-block" id="BaseBiEncoderProcessor.__init__">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseBiEncoderProcessor.__init__">[docs]</a>
</span><span data-line="714">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">,</span> <span class="n">labels_tokenizer</span><span class="p">):</span>
</span><span data-line="715"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the bi-encoder processor.</span>
</span><span data-line="716">
</span><span data-line="717"><span class="sd">        Args:</span>
</span><span data-line="718"><span class="sd">            config: Configuration object.</span>
</span><span data-line="719"><span class="sd">            tokenizer: Transformer tokenizer for text encoding.</span>
</span><span data-line="720"><span class="sd">            words_splitter: Word-level tokenizer/splitter.</span>
</span><span data-line="721"><span class="sd">            labels_tokenizer: Separate tokenizer for entity type encoding.</span>
</span><span data-line="722"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="723">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">)</span>
</span><span data-line="724">        <span class="bp">self</span><span class="o">.</span><span class="n">labels_tokenizer</span> <span class="o">=</span> <span class="n">labels_tokenizer</span>
</span><span data-line="725">
</span><span data-line="726">        <span class="c1"># Check special tokens for additional tokenizers</span>
</span><span data-line="727">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_tokenizer</span><span class="p">:</span>
</span><span data-line="728">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_and_set_special_tokens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_tokenizer</span><span class="p">)</span></div>

</span><span data-line="729">
<div class="viewcode-block" id="BaseBiEncoderProcessor.tokenize_inputs">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseBiEncoderProcessor.tokenize_inputs">[docs]</a>
</span><span data-line="730">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">entities</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="731"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize inputs for bi-encoder architecture.</span>
</span><span data-line="732">
</span><span data-line="733"><span class="sd">        Separately tokenizes text sequences and entity types using different</span>
</span><span data-line="734"><span class="sd">        tokenizers.</span>
</span><span data-line="735">
</span><span data-line="736"><span class="sd">        Args:</span>
</span><span data-line="737"><span class="sd">            texts: Sequences of token strings.</span>
</span><span data-line="738"><span class="sd">            entities: Optional list of entity types to encode.</span>
</span><span data-line="739">
</span><span data-line="740"><span class="sd">        Returns:</span>
</span><span data-line="741"><span class="sd">            Dictionary containing:</span>
</span><span data-line="742"><span class="sd">                - input_ids: Text token IDs</span>
</span><span data-line="743"><span class="sd">                - attention_mask: Text attention mask</span>
</span><span data-line="744"><span class="sd">                - words_mask: Word-level mask</span>
</span><span data-line="745"><span class="sd">                - labels_input_ids: Entity type token IDs (if entities provided)</span>
</span><span data-line="746"><span class="sd">                - labels_attention_mask: Entity type attention mask (if entities provided)</span>
</span><span data-line="747"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="748">        <span class="n">tokenized_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">(</span>
</span><span data-line="749">            <span class="n">texts</span><span class="p">,</span> <span class="n">is_split_into_words</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;longest&quot;</span>
</span><span data-line="750">        <span class="p">)</span>
</span><span data-line="751">
</span><span data-line="752">        <span class="k">if</span> <span class="n">entities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="753">            <span class="n">tokenized_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_tokenizer</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;longest&quot;</span><span class="p">)</span>
</span><span data-line="754">
</span><span data-line="755">            <span class="n">tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;labels_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenized_labels</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
</span><span data-line="756">            <span class="n">tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;labels_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenized_labels</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
</span><span data-line="757">
</span><span data-line="758">        <span class="n">words_masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_word_mask</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">tokenized_inputs</span><span class="p">,</span> <span class="n">skip_first_words</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span data-line="759">        <span class="n">tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;words_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">words_masks</span><span class="p">)</span>
</span><span data-line="760">        <span class="k">return</span> <span class="n">tokenized_inputs</span></div>

</span><span data-line="761">
<div class="viewcode-block" id="BaseBiEncoderProcessor.batch_generate_class_mappings">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BaseBiEncoderProcessor.batch_generate_class_mappings">[docs]</a>
</span><span data-line="762">    <span class="k">def</span><span class="w"> </span><span class="nf">batch_generate_class_mappings</span><span class="p">(</span>
</span><span data-line="763">        <span class="bp">self</span><span class="p">,</span> <span class="n">batch_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span>
</span><span data-line="764">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
</span><span data-line="765"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate class mappings for bi-encoder with batch-level type pooling.</span>
</span><span data-line="766">
</span><span data-line="767"><span class="sd">        Unlike uni-encoder which generates per-example mappings, bi-encoder</span>
</span><span data-line="768"><span class="sd">        creates a single shared mapping across the batch for more efficient</span>
</span><span data-line="769"><span class="sd">        entity type encoding.</span>
</span><span data-line="770">
</span><span data-line="771"><span class="sd">        Args:</span>
</span><span data-line="772"><span class="sd">            batch_list: List of example dictionaries.</span>
</span><span data-line="773"><span class="sd">            *args: Variable length argument list (unused).</span>
</span><span data-line="774">
</span><span data-line="775"><span class="sd">        Returns:</span>
</span><span data-line="776"><span class="sd">            Tuple containing:</span>
</span><span data-line="777"><span class="sd">                - List of identical class-to-ID mappings (one per example)</span>
</span><span data-line="778"><span class="sd">                - List of identical ID-to-class mappings (one per example)</span>
</span><span data-line="779"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="780">        <span class="n">classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="781">        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch_list</span><span class="p">:</span>
</span><span data-line="782">            <span class="k">if</span> <span class="s2">&quot;ner_negatives&quot;</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>  <span class="c1"># manually setting negative types</span>
</span><span data-line="783">                <span class="n">negs_i</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;ner_negatives&quot;</span><span class="p">]</span>
</span><span data-line="784">            <span class="k">else</span><span class="p">:</span>  <span class="c1"># in-batch negative types</span>
</span><span data-line="785">                <span class="n">negs_i</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="786">
</span><span data-line="787">            <span class="n">types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;ner&quot;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">negs_i</span><span class="p">))</span>
</span><span data-line="788">
</span><span data-line="789">            <span class="k">if</span> <span class="s2">&quot;ner_label&quot;</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>  <span class="c1"># labels are predefined</span>
</span><span data-line="790">                <span class="n">types</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;ner_label&quot;</span><span class="p">]</span>
</span><span data-line="791">
</span><span data-line="792">            <span class="n">classes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
</span><span data-line="793">        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
</span><span data-line="794">        <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">classes</span><span class="p">))[:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_types</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_list</span><span class="p">))]</span>
</span><span data-line="795">        <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span>
</span><span data-line="796">        <span class="n">id_to_class</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span data-line="797">
</span><span data-line="798">        <span class="n">class_to_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_to_id</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_list</span><span class="p">))]</span>
</span><span data-line="799">        <span class="n">id_to_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_to_class</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_list</span><span class="p">))]</span>
</span><span data-line="800">
</span><span data-line="801">        <span class="k">return</span> <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span></div>
</div>

</span><span data-line="802">
</span><span data-line="803">
<div class="viewcode-block" id="BiEncoderSpanProcessor">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BiEncoderSpanProcessor">[docs]</a>
</span><span data-line="804"><span class="k">class</span><span class="w"> </span><span class="nc">BiEncoderSpanProcessor</span><span class="p">(</span><span class="n">UniEncoderSpanProcessor</span><span class="p">,</span> <span class="n">BaseBiEncoderProcessor</span><span class="p">):</span>
</span><span data-line="805"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Processor for span-based NER with bi-encoder architecture.</span>
</span><span data-line="806">
</span><span data-line="807"><span class="sd">    Combines span enumeration from UniEncoderSpanProcessor with the bi-encoder</span>
</span><span data-line="808"><span class="sd">    approach from BaseBiEncoderProcessor.</span>
</span><span data-line="809"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="810">
<div class="viewcode-block" id="BiEncoderSpanProcessor.tokenize_and_prepare_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BiEncoderSpanProcessor.tokenize_and_prepare_labels">[docs]</a>
</span><span data-line="811">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_and_prepare_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">prepare_labels</span><span class="p">,</span> <span class="n">prepare_entities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="812"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize inputs and prepare span labels for bi-encoder.</span>
</span><span data-line="813">
</span><span data-line="814"><span class="sd">        Args:</span>
</span><span data-line="815"><span class="sd">            batch: Batch dictionary with tokens and class mappings.</span>
</span><span data-line="816"><span class="sd">            prepare_labels: Whether to prepare labels.</span>
</span><span data-line="817"><span class="sd">            prepare_entities: Whether to encode entity types separately.</span>
</span><span data-line="818"><span class="sd">            *args: Variable length argument list.</span>
</span><span data-line="819"><span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
</span><span data-line="820">
</span><span data-line="821"><span class="sd">        Returns:</span>
</span><span data-line="822"><span class="sd">            Dictionary containing tokenized inputs, entity encodings, and optionally labels.</span>
</span><span data-line="823"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="824">        <span class="k">if</span> <span class="n">prepare_entities</span><span class="p">:</span>
</span><span data-line="825">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
</span><span data-line="826">                <span class="n">entities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">])</span>
</span><span data-line="827">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="828">                <span class="n">entities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span data-line="829">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="830">            <span class="n">entities</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="831">        <span class="n">tokenized_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_inputs</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">],</span> <span class="n">entities</span><span class="p">)</span>
</span><span data-line="832">        <span class="k">if</span> <span class="n">prepare_labels</span><span class="p">:</span>
</span><span data-line="833">            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_labels</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span data-line="834">            <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span data-line="835">        <span class="k">return</span> <span class="n">tokenized_input</span></div>
</div>

</span><span data-line="836">
</span><span data-line="837">
<div class="viewcode-block" id="BiEncoderTokenProcessor">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BiEncoderTokenProcessor">[docs]</a>
</span><span data-line="838"><span class="k">class</span><span class="w"> </span><span class="nc">BiEncoderTokenProcessor</span><span class="p">(</span><span class="n">UniEncoderTokenProcessor</span><span class="p">,</span> <span class="n">BaseBiEncoderProcessor</span><span class="p">):</span>
</span><span data-line="839"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Processor for token-based NER with bi-encoder architecture.</span>
</span><span data-line="840">
</span><span data-line="841"><span class="sd">    Combines token-level classification from UniEncoderTokenProcessor with the</span>
</span><span data-line="842"><span class="sd">    dual-encoder approach from BaseBiEncoderProcessor.</span>
</span><span data-line="843"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="844">
<div class="viewcode-block" id="BiEncoderTokenProcessor.tokenize_and_prepare_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.BiEncoderTokenProcessor.tokenize_and_prepare_labels">[docs]</a>
</span><span data-line="845">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_and_prepare_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">prepare_labels</span><span class="p">,</span> <span class="n">prepare_entities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="846"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize inputs and prepare token-level labels for bi-encoder.</span>
</span><span data-line="847">
</span><span data-line="848"><span class="sd">        Args:</span>
</span><span data-line="849"><span class="sd">            batch: Batch dictionary with tokens and class mappings.</span>
</span><span data-line="850"><span class="sd">            prepare_labels: Whether to prepare labels.</span>
</span><span data-line="851"><span class="sd">            prepare_entities: Whether to encode entity types separately.</span>
</span><span data-line="852"><span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
</span><span data-line="853">
</span><span data-line="854"><span class="sd">        Returns:</span>
</span><span data-line="855"><span class="sd">            Dictionary containing tokenized inputs, entity encodings, and optionally labels.</span>
</span><span data-line="856"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="857">        <span class="k">if</span> <span class="n">prepare_entities</span><span class="p">:</span>
</span><span data-line="858">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
</span><span data-line="859">                <span class="n">entities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">])</span>
</span><span data-line="860">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="861">                <span class="n">entities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span data-line="862">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="863">            <span class="n">entities</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="864">        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">])</span>
</span><span data-line="865">        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;seq_length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span data-line="866">        <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
</span><span data-line="867">
</span><span data-line="868">        <span class="n">tokenized_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_inputs</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">],</span> <span class="n">entities</span><span class="p">)</span>
</span><span data-line="869">
</span><span data-line="870">        <span class="k">if</span> <span class="n">prepare_labels</span><span class="p">:</span>
</span><span data-line="871">            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_labels</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;entities_id&quot;</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
</span><span data-line="872">            <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span data-line="873">
</span><span data-line="874">        <span class="k">return</span> <span class="n">tokenized_input</span></div>
</div>

</span><span data-line="875">
</span><span data-line="876">
<div class="viewcode-block" id="UniEncoderSpanDecoderProcessor">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderSpanDecoderProcessor">[docs]</a>
</span><span data-line="877"><span class="k">class</span><span class="w"> </span><span class="nc">UniEncoderSpanDecoderProcessor</span><span class="p">(</span><span class="n">UniEncoderSpanProcessor</span><span class="p">):</span>
</span><span data-line="878"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Processor for span-based NER with encoder-decoder architecture.</span>
</span><span data-line="879">
</span><span data-line="880"><span class="sd">    Extends span-based processing with a decoder that generates entity type</span>
</span><span data-line="881"><span class="sd">    labels autoregressively, enabling more flexible prediction strategies.</span>
</span><span data-line="882"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="883">
<div class="viewcode-block" id="UniEncoderSpanDecoderProcessor.__init__">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderSpanDecoderProcessor.__init__">[docs]</a>
</span><span data-line="884">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">,</span> <span class="n">decoder_tokenizer</span><span class="p">):</span>
</span><span data-line="885"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the encoder-decoder processor.</span>
</span><span data-line="886">
</span><span data-line="887"><span class="sd">        Args:</span>
</span><span data-line="888"><span class="sd">            config: Configuration object.</span>
</span><span data-line="889"><span class="sd">            tokenizer: Transformer tokenizer for encoding.</span>
</span><span data-line="890"><span class="sd">            words_splitter: Word-level tokenizer/splitter.</span>
</span><span data-line="891"><span class="sd">            decoder_tokenizer: Separate tokenizer for decoder (label generation).</span>
</span><span data-line="892"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="893">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">)</span>
</span><span data-line="894">        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_tokenizer</span> <span class="o">=</span> <span class="n">decoder_tokenizer</span>
</span><span data-line="895">
</span><span data-line="896">        <span class="c1"># Check special tokens for additional tokenizers</span>
</span><span data-line="897">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_tokenizer</span><span class="p">:</span>
</span><span data-line="898">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_and_set_special_tokens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder_tokenizer</span><span class="p">)</span></div>

</span><span data-line="899">
<div class="viewcode-block" id="UniEncoderSpanDecoderProcessor.tokenize_inputs">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderSpanDecoderProcessor.tokenize_inputs">[docs]</a>
</span><span data-line="900">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="901"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize inputs for encoder-decoder architecture.</span>
</span><span data-line="902">
</span><span data-line="903"><span class="sd">        Prepares both encoder and decoder inputs, with optional decoder context</span>
</span><span data-line="904"><span class="sd">        based on configuration.</span>
</span><span data-line="905">
</span><span data-line="906"><span class="sd">        Args:</span>
</span><span data-line="907"><span class="sd">            texts: Sequences of token strings.</span>
</span><span data-line="908"><span class="sd">            entities: Entity types for extraction.</span>
</span><span data-line="909"><span class="sd">            blank: Optional blank entity token for zero-shot scenarios.</span>
</span><span data-line="910">
</span><span data-line="911"><span class="sd">        Returns:</span>
</span><span data-line="912"><span class="sd">            Dictionary containing encoder and decoder tokenized inputs.</span>
</span><span data-line="913"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="914">        <span class="n">add_entities</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="915">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoder_mode</span> <span class="o">==</span> <span class="s1">&#39;prompt&#39;</span><span class="p">:</span>
</span><span data-line="916">            <span class="n">add_entities</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="917">
</span><span data-line="918">        <span class="n">input_texts</span><span class="p">,</span> <span class="n">prompt_lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_inputs</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="n">blank</span><span class="p">,</span> <span class="n">add_entities</span><span class="o">=</span><span class="n">add_entities</span><span class="p">)</span>
</span><span data-line="919">
</span><span data-line="920">        <span class="n">tokenized_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">(</span>
</span><span data-line="921">            <span class="n">input_texts</span><span class="p">,</span>
</span><span data-line="922">            <span class="n">is_split_into_words</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="923">            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span data-line="924">            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="925">            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;longest&quot;</span><span class="p">,</span>
</span><span data-line="926">        <span class="p">)</span>
</span><span data-line="927">        <span class="n">words_masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_word_mask</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">tokenized_inputs</span><span class="p">,</span> <span class="n">skip_first_words</span><span class="o">=</span><span class="n">prompt_lengths</span><span class="p">)</span>
</span><span data-line="928">        <span class="n">tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;words_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">words_masks</span><span class="p">)</span>
</span><span data-line="929">
</span><span data-line="930">        <span class="c1"># Add decoder inputs if decoder tokenizer is available and mode is &#39;span&#39;</span>
</span><span data-line="931">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoder_mode</span> <span class="o">==</span> <span class="s2">&quot;span&quot;</span><span class="p">:</span>
</span><span data-line="932">            <span class="n">decoder_input_texts</span> <span class="o">=</span> <span class="p">[[</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="n">t</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">)]</span> <span class="k">for</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">input_texts</span><span class="p">]</span>
</span><span data-line="933">            <span class="n">decoder_tokenized_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_tokenizer</span><span class="p">(</span>
</span><span data-line="934">                <span class="n">decoder_input_texts</span><span class="p">,</span>
</span><span data-line="935">                <span class="n">is_split_into_words</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="936">                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span data-line="937">                <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="938">                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;longest&quot;</span><span class="p">,</span>
</span><span data-line="939">            <span class="p">)</span>
</span><span data-line="940">            <span class="n">tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;decoder_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoder_tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
</span><span data-line="941">            <span class="n">tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;decoder_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoder_tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
</span><span data-line="942">
</span><span data-line="943">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">full_decoder_context</span><span class="p">:</span>
</span><span data-line="944">                <span class="n">decoder_words_masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_word_mask</span><span class="p">(</span>
</span><span data-line="945">                    <span class="n">texts</span><span class="p">,</span> <span class="n">decoder_tokenized_inputs</span><span class="p">,</span> <span class="n">skip_first_words</span><span class="o">=</span><span class="n">prompt_lengths</span><span class="p">,</span> <span class="n">token_level</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="946">                <span class="p">)</span>
</span><span data-line="947">                <span class="n">tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;decoder_words_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">decoder_words_masks</span><span class="p">)</span>
</span><span data-line="948">
</span><span data-line="949">        <span class="k">return</span> <span class="n">tokenized_inputs</span></div>

</span><span data-line="950">
<div class="viewcode-block" id="UniEncoderSpanDecoderProcessor.create_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderSpanDecoderProcessor.create_labels">[docs]</a>
</span><span data-line="951">    <span class="k">def</span><span class="w"> </span><span class="nf">create_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="952"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create labels for both span classification and decoder generation.</span>
</span><span data-line="953">
</span><span data-line="954"><span class="sd">        Args:</span>
</span><span data-line="955"><span class="sd">            batch: Batch dictionary containing tokens, entities, and class mappings.</span>
</span><span data-line="956"><span class="sd">            blank: Optional blank entity token for zero-shot scenarios.</span>
</span><span data-line="957">
</span><span data-line="958"><span class="sd">        Returns:</span>
</span><span data-line="959"><span class="sd">            Tuple containing:</span>
</span><span data-line="960"><span class="sd">                - Span classification labels (one-hot encoded)</span>
</span><span data-line="961"><span class="sd">                - Decoder generation labels (tokenized entity types) or None</span>
</span><span data-line="962"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="963">        <span class="n">labels_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="964">        <span class="n">decoder_label_strings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="965">
</span><span data-line="966">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">])):</span>
</span><span data-line="967">            <span class="n">tokens</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="968">            <span class="n">classes_to_id</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="969">            <span class="n">ner</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="970">            <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes_to_id</span><span class="p">)</span>
</span><span data-line="971">
</span><span data-line="972">            <span class="n">spans_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">prepare_span_idx</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_width</span><span class="p">))</span>
</span><span data-line="973">            <span class="n">span_to_index</span> <span class="o">=</span> <span class="p">{(</span><span class="n">spans_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">spans_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()):</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spans_idx</span><span class="p">))}</span>
</span><span data-line="974">
</span><span data-line="975">            <span class="k">if</span> <span class="n">blank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="976">                <span class="n">num_classes</span> <span class="o">=</span> <span class="mi">1</span>
</span><span data-line="977">
</span><span data-line="978">            <span class="n">labels_one_hot</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spans_idx</span><span class="p">),</span> <span class="n">num_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
</span><span data-line="979">            <span class="n">end_token_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span data-line="980">            <span class="n">used_spans</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="981">            <span class="n">span_labels_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="982">
</span><span data-line="983">            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ner</span><span class="p">:</span>
</span><span data-line="984">                <span class="n">span</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span data-line="985">                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">classes_to_id</span> <span class="ow">and</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">span_to_index</span><span class="p">:</span>
</span><span data-line="986">                    <span class="n">idx</span> <span class="o">=</span> <span class="n">span_to_index</span><span class="p">[</span><span class="n">span</span><span class="p">]</span>
</span><span data-line="987">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoder_mode</span> <span class="o">==</span> <span class="s2">&quot;span&quot;</span><span class="p">:</span>
</span><span data-line="988">                        <span class="n">class_id</span> <span class="o">=</span> <span class="n">classes_to_id</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">if</span> <span class="n">blank</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
</span><span data-line="989">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="990">                        <span class="n">class_id</span> <span class="o">=</span> <span class="n">classes_to_id</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
</span><span data-line="991">
</span><span data-line="992">                    <span class="k">if</span> <span class="n">labels_one_hot</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">class_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_spans</span><span class="p">:</span>
</span><span data-line="993">                        <span class="n">used_spans</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span data-line="994">                        <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;=</span> <span class="n">end_token_idx</span><span class="p">:</span>
</span><span data-line="995">                            <span class="n">labels_one_hot</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">class_id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span data-line="996">                            <span class="n">span_labels_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
</span><span data-line="997">
</span><span data-line="998">            <span class="n">valid_span_mask</span> <span class="o">=</span> <span class="n">spans_idx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">end_token_idx</span>
</span><span data-line="999">            <span class="n">labels_one_hot</span><span class="p">[</span><span class="n">valid_span_mask</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span data-line="1000">            <span class="n">labels_one_hot</span> <span class="o">=</span> <span class="n">labels_one_hot</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span data-line="1001">            <span class="n">labels_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels_one_hot</span><span class="p">)</span>
</span><span data-line="1002">            
</span><span data-line="1003">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoder_mode</span> <span class="o">==</span> <span class="s1">&#39;span&#39;</span><span class="p">:</span>
</span><span data-line="1004">                <span class="c1"># Collect decoder label strings in order</span>
</span><span data-line="1005">                <span class="n">sorted_idxs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">span_labels_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span data-line="1006">                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sorted_idxs</span><span class="p">:</span>
</span><span data-line="1007">                    <span class="n">decoder_label_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">span_labels_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span data-line="1008">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoder_mode</span> <span class="o">==</span> <span class="s1">&#39;prompt&#39;</span><span class="p">:</span>
</span><span data-line="1009">                <span class="n">decoder_label_strings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">classes_to_id</span><span class="p">))</span>
</span><span data-line="1010">                
</span><span data-line="1011">        <span class="n">labels_batch</span> <span class="o">=</span> <span class="n">pad_2d_tensor</span><span class="p">(</span><span class="n">labels_batch</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">labels_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1012">
</span><span data-line="1013">        <span class="n">decoder_tokenized_input</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1014">
</span><span data-line="1015">        <span class="k">if</span> <span class="ow">not</span> <span class="n">decoder_label_strings</span><span class="p">:</span>
</span><span data-line="1016">            <span class="n">decoder_label_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">]</span>
</span><span data-line="1017">
</span><span data-line="1018">        <span class="n">decoder_tokenized_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_tokenizer</span><span class="p">(</span>
</span><span data-line="1019">            <span class="n">decoder_label_strings</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;longest&quot;</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="1020">        <span class="p">)</span>
</span><span data-line="1021">        <span class="n">decoder_input_ids</span> <span class="o">=</span> <span class="n">decoder_tokenized_input</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
</span><span data-line="1022">        <span class="n">decoder_attention_mask</span> <span class="o">=</span> <span class="n">decoder_tokenized_input</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
</span><span data-line="1023">        <span class="n">decoder_labels</span> <span class="o">=</span> <span class="n">decoder_input_ids</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span data-line="1024">        <span class="n">decoder_labels</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="o">~</span><span class="n">decoder_attention_mask</span><span class="o">.</span><span class="n">bool</span><span class="p">(),</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span>
</span><span data-line="1025">        <span class="n">decoder_tokenized_input</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoder_labels</span>
</span><span data-line="1026">        <span class="k">return</span> <span class="n">labels_batch</span><span class="p">,</span> <span class="n">decoder_tokenized_input</span></div>

</span><span data-line="1027">
<div class="viewcode-block" id="UniEncoderSpanDecoderProcessor.tokenize_and_prepare_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.UniEncoderSpanDecoderProcessor.tokenize_and_prepare_labels">[docs]</a>
</span><span data-line="1028">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_and_prepare_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">prepare_labels</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="1029"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize inputs and prepare labels for encoder-decoder training.</span>
</span><span data-line="1030">
</span><span data-line="1031"><span class="sd">        Args:</span>
</span><span data-line="1032"><span class="sd">            batch: Batch dictionary with tokens and class mappings.</span>
</span><span data-line="1033"><span class="sd">            prepare_labels: Whether to prepare labels.</span>
</span><span data-line="1034"><span class="sd">            *args: Variable length argument list.</span>
</span><span data-line="1035"><span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
</span><span data-line="1036">
</span><span data-line="1037"><span class="sd">        Returns:</span>
</span><span data-line="1038"><span class="sd">            Dictionary containing encoder inputs, decoder inputs, and labels.</span>
</span><span data-line="1039"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1040">        <span class="n">blank</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1041">        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">blank_entity_prob</span> <span class="ow">and</span> <span class="n">prepare_labels</span><span class="p">:</span>
</span><span data-line="1042">            <span class="n">blank</span> <span class="o">=</span> <span class="s2">&quot;entity&quot;</span>
</span><span data-line="1043">
</span><span data-line="1044">        <span class="n">tokenized_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_inputs</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">],</span> <span class="n">blank</span><span class="p">)</span>
</span><span data-line="1045">
</span><span data-line="1046">        <span class="k">if</span> <span class="n">prepare_labels</span><span class="p">:</span>
</span><span data-line="1047">            <span class="n">labels</span><span class="p">,</span> <span class="n">decoder_tokenized_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_labels</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="n">blank</span><span class="p">)</span>
</span><span data-line="1048">            <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span data-line="1049">
</span><span data-line="1050">            <span class="k">if</span> <span class="n">decoder_tokenized_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1051">                <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;decoder_labels_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoder_tokenized_input</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
</span><span data-line="1052">                <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;decoder_labels_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoder_tokenized_input</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
</span><span data-line="1053">                <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;decoder_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoder_tokenized_input</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
</span><span data-line="1054">
</span><span data-line="1055">        <span class="k">return</span> <span class="n">tokenized_input</span></div>
</div>

</span><span data-line="1056">
</span><span data-line="1057">
<div class="viewcode-block" id="RelationExtractionSpanProcessor">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.RelationExtractionSpanProcessor">[docs]</a>
</span><span data-line="1058"><span class="k">class</span><span class="w"> </span><span class="nc">RelationExtractionSpanProcessor</span><span class="p">(</span><span class="n">UniEncoderSpanProcessor</span><span class="p">):</span>
</span><span data-line="1059"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Processor for joint entity and relation extraction.</span>
</span><span data-line="1060">
</span><span data-line="1061"><span class="sd">    Extends span-based NER processing to additionally handle relation extraction</span>
</span><span data-line="1062"><span class="sd">    between entity pairs, supporting end-to-end joint training.</span>
</span><span data-line="1063"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1064">
<div class="viewcode-block" id="RelationExtractionSpanProcessor.__init__">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.RelationExtractionSpanProcessor.__init__">[docs]</a>
</span><span data-line="1065">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">):</span>
</span><span data-line="1066"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the relation extraction processor.</span>
</span><span data-line="1067">
</span><span data-line="1068"><span class="sd">        Args:</span>
</span><span data-line="1069"><span class="sd">            config: Configuration object.</span>
</span><span data-line="1070"><span class="sd">            tokenizer: Transformer tokenizer.</span>
</span><span data-line="1071"><span class="sd">            words_splitter: Word-level tokenizer/splitter.</span>
</span><span data-line="1072"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1073">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">)</span>
</span><span data-line="1074">        <span class="bp">self</span><span class="o">.</span><span class="n">rel_token</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">rel_token</span></div>

</span><span data-line="1075">
<div class="viewcode-block" id="RelationExtractionSpanProcessor.batch_generate_class_mappings">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.RelationExtractionSpanProcessor.batch_generate_class_mappings">[docs]</a>
</span><span data-line="1076">    <span class="k">def</span><span class="w"> </span><span class="nf">batch_generate_class_mappings</span><span class="p">(</span>
</span><span data-line="1077">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1078">        <span class="n">batch_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
</span><span data-line="1079">        <span class="n">ner_negatives</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1080">        <span class="n">rel_negatives</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1081">        <span class="n">sampled_neg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span data-line="1082">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
</span><span data-line="1083"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate class mappings for both entities and relations.</span>
</span><span data-line="1084">
</span><span data-line="1085"><span class="sd">        Creates separate mappings for entity types and relation types with</span>
</span><span data-line="1086"><span class="sd">        support for negative sampling for both.</span>
</span><span data-line="1087">
</span><span data-line="1088"><span class="sd">        Args:</span>
</span><span data-line="1089"><span class="sd">            batch_list: List of example dictionaries.</span>
</span><span data-line="1090"><span class="sd">            ner_negatives: Optional pre-sampled negative entity types.</span>
</span><span data-line="1091"><span class="sd">            rel_negatives: Optional pre-sampled negative relation types.</span>
</span><span data-line="1092"><span class="sd">            sampled_neg: Number of negative types to sample if negatives not provided.</span>
</span><span data-line="1093">
</span><span data-line="1094"><span class="sd">        Returns:</span>
</span><span data-line="1095"><span class="sd">            Tuple containing:</span>
</span><span data-line="1096"><span class="sd">                - List of entity class-to-ID mappings</span>
</span><span data-line="1097"><span class="sd">                - List of entity ID-to-class mappings</span>
</span><span data-line="1098"><span class="sd">                - List of relation class-to-ID mappings</span>
</span><span data-line="1099"><span class="sd">                - List of relation ID-to-class mappings</span>
</span><span data-line="1100"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1101">        <span class="k">if</span> <span class="n">ner_negatives</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1102">            <span class="n">ner_negatives</span> <span class="o">=</span> <span class="n">get_negatives</span><span class="p">(</span><span class="n">batch_list</span><span class="p">,</span> <span class="n">sampled_neg</span><span class="o">=</span><span class="n">sampled_neg</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
</span><span data-line="1103">        <span class="k">if</span> <span class="n">rel_negatives</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1104">            <span class="n">rel_negatives</span> <span class="o">=</span> <span class="n">get_negatives</span><span class="p">(</span><span class="n">batch_list</span><span class="p">,</span> <span class="n">sampled_neg</span><span class="o">=</span><span class="n">sampled_neg</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;relations&quot;</span><span class="p">)</span>
</span><span data-line="1105">
</span><span data-line="1106">        <span class="n">class_to_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1107">        <span class="n">id_to_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1108">        <span class="n">rel_class_to_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1109">        <span class="n">rel_id_to_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1110">
</span><span data-line="1111">        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch_list</span><span class="p">:</span>
</span><span data-line="1112">            <span class="n">max_neg_type_ratio</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_neg_type_ratio</span><span class="p">)</span>
</span><span data-line="1113">            <span class="n">neg_type_ratio</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_neg_type_ratio</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_neg_type_ratio</span> <span class="k">else</span> <span class="mi">0</span>
</span><span data-line="1114">
</span><span data-line="1115">            <span class="c1"># Process NER types</span>
</span><span data-line="1116">            <span class="k">if</span> <span class="s2">&quot;ner_negatives&quot;</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
</span><span data-line="1117">                <span class="n">negs_i</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;ner_negatives&quot;</span><span class="p">]</span>
</span><span data-line="1118">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1119">                <span class="n">negs_i</span> <span class="o">=</span> <span class="n">ner_negatives</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;ner&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">neg_type_ratio</span><span class="p">]</span> <span class="k">if</span> <span class="n">neg_type_ratio</span> <span class="k">else</span> <span class="p">[]</span>
</span><span data-line="1120">
</span><span data-line="1121">            <span class="k">if</span> <span class="s2">&quot;ner_labels&quot;</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
</span><span data-line="1122">                <span class="n">types</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;ner_labels&quot;</span><span class="p">]</span>
</span><span data-line="1123">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1124">                <span class="n">types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;ner&quot;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">negs_i</span><span class="p">))</span>
</span><span data-line="1125">                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
</span><span data-line="1126">                <span class="n">types</span> <span class="o">=</span> <span class="n">types</span><span class="p">[:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_types</span><span class="p">)]</span>
</span><span data-line="1127">
</span><span data-line="1128">            <span class="n">class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span>
</span><span data-line="1129">            <span class="n">id_to_class</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">class_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span data-line="1130">            <span class="n">class_to_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_to_id</span><span class="p">)</span>
</span><span data-line="1131">            <span class="n">id_to_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_to_class</span><span class="p">)</span>
</span><span data-line="1132">
</span><span data-line="1133">            <span class="c1"># Process relation types</span>
</span><span data-line="1134">            <span class="k">if</span> <span class="s2">&quot;rel_negatives&quot;</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
</span><span data-line="1135">                <span class="n">rel_negs_i</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;rel_negatives&quot;</span><span class="p">]</span>
</span><span data-line="1136">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1137">                <span class="n">rel_negs_i</span> <span class="o">=</span> <span class="n">rel_negatives</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relations&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">*</span> <span class="n">neg_type_ratio</span><span class="p">]</span> <span class="k">if</span> <span class="n">neg_type_ratio</span> <span class="k">else</span> <span class="p">[]</span>
</span><span data-line="1138">
</span><span data-line="1139">            <span class="k">if</span> <span class="s2">&quot;rel_labels&quot;</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
</span><span data-line="1140">                <span class="n">rel_types</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;rel_labels&quot;</span><span class="p">]</span>
</span><span data-line="1141">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1142">                <span class="n">rel_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relations&quot;</span><span class="p">,</span> <span class="p">[])]</span> <span class="o">+</span> <span class="n">rel_negs_i</span><span class="p">))</span>
</span><span data-line="1143">                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">rel_types</span><span class="p">)</span>
</span><span data-line="1144">                <span class="n">rel_types</span> <span class="o">=</span> <span class="n">rel_types</span><span class="p">[:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_types</span><span class="p">)]</span>
</span><span data-line="1145">
</span><span data-line="1146">            <span class="n">rel_class_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rel_types</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span>
</span><span data-line="1147">            <span class="n">rel_id_to_class</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rel_class_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span data-line="1148">            <span class="n">rel_class_to_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_class_to_id</span><span class="p">)</span>
</span><span data-line="1149">            <span class="n">rel_id_to_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_id_to_class</span><span class="p">)</span>
</span><span data-line="1150">
</span><span data-line="1151">        <span class="k">return</span> <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span><span class="p">,</span> <span class="n">rel_class_to_ids</span><span class="p">,</span> <span class="n">rel_id_to_classes</span></div>

</span><span data-line="1152">
<div class="viewcode-block" id="RelationExtractionSpanProcessor.collate_raw_batch">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.RelationExtractionSpanProcessor.collate_raw_batch">[docs]</a>
</span><span data-line="1153">    <span class="k">def</span><span class="w"> </span><span class="nf">collate_raw_batch</span><span class="p">(</span>
</span><span data-line="1154">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1155">        <span class="n">batch_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
</span><span data-line="1156">        <span class="n">entity_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1157">        <span class="n">relation_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1158">        <span class="n">ner_negatives</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1159">        <span class="n">rel_negatives</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1160">        <span class="n">class_to_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1161">        <span class="n">id_to_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1162">        <span class="n">rel_class_to_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1163">        <span class="n">rel_id_to_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1164">        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">,</span>
</span><span data-line="1165">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span data-line="1166"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Collate a raw batch with entity and relation label mappings.</span>
</span><span data-line="1167">
</span><span data-line="1168"><span class="sd">        Args:</span>
</span><span data-line="1169"><span class="sd">            batch_list: List of raw example dictionaries.</span>
</span><span data-line="1170"><span class="sd">            entity_types: Optional predefined entity types.</span>
</span><span data-line="1171"><span class="sd">            relation_types: Optional predefined relation types.</span>
</span><span data-line="1172"><span class="sd">            ner_negatives: Optional negative entity types.</span>
</span><span data-line="1173"><span class="sd">            rel_negatives: Optional negative relation types.</span>
</span><span data-line="1174"><span class="sd">            class_to_ids: Optional entity class-to-ID mapping(s).</span>
</span><span data-line="1175"><span class="sd">            id_to_classes: Optional entity ID-to-class mapping(s).</span>
</span><span data-line="1176"><span class="sd">            rel_class_to_ids: Optional relation class-to-ID mapping(s).</span>
</span><span data-line="1177"><span class="sd">            rel_id_to_classes: Optional relation ID-to-class mapping(s).</span>
</span><span data-line="1178"><span class="sd">            key: Key for accessing labels in batch (default: &#39;ner&#39;).</span>
</span><span data-line="1179">
</span><span data-line="1180"><span class="sd">        Returns:</span>
</span><span data-line="1181"><span class="sd">            Dictionary containing collated batch data for joint entity and</span>
</span><span data-line="1182"><span class="sd">            relation extraction.</span>
</span><span data-line="1183"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1184">        <span class="k">if</span> <span class="n">class_to_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">entity_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1185">            <span class="c1"># Dynamically infer per-example mappings</span>
</span><span data-line="1186">            <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span><span class="p">,</span> <span class="n">rel_class_to_ids</span><span class="p">,</span> <span class="n">rel_id_to_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_generate_class_mappings</span><span class="p">(</span>
</span><span data-line="1187">                <span class="n">batch_list</span><span class="p">,</span> <span class="n">ner_negatives</span><span class="p">,</span> <span class="n">rel_negatives</span>
</span><span data-line="1188">            <span class="p">)</span>
</span><span data-line="1189">        <span class="k">elif</span> <span class="n">class_to_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1190">            <span class="c1"># Build mappings from entity_types</span>
</span><span data-line="1191">            <span class="k">if</span> <span class="n">entity_types</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span data-line="1192">                <span class="n">built</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_mapping</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">entity_types</span><span class="p">]</span>
</span><span data-line="1193">                <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">built</span><span class="p">))</span>
</span><span data-line="1194">                <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">class_to_ids</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">id_to_classes</span><span class="p">)</span>
</span><span data-line="1195">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1196">                <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span> <span class="o">=</span> <span class="n">make_mapping</span><span class="p">(</span><span class="n">entity_types</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span data-line="1197">
</span><span data-line="1198">            <span class="c1"># Build relation mappings</span>
</span><span data-line="1199">            <span class="k">if</span> <span class="n">relation_types</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span data-line="1200">                <span class="n">built</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_mapping</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">relation_types</span><span class="p">]</span>
</span><span data-line="1201">                <span class="n">rel_class_to_ids</span><span class="p">,</span> <span class="n">rel_id_to_classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">built</span><span class="p">))</span>
</span><span data-line="1202">                <span class="n">rel_class_to_ids</span><span class="p">,</span> <span class="n">rel_id_to_classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rel_class_to_ids</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">rel_id_to_classes</span><span class="p">)</span>
</span><span data-line="1203">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1204">                <span class="n">rel_class_to_ids</span><span class="p">,</span> <span class="n">rel_id_to_classes</span> <span class="o">=</span> <span class="n">make_mapping</span><span class="p">(</span><span class="n">relation_types</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span data-line="1205">
</span><span data-line="1206">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">class_to_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span data-line="1207">            <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="1208">                <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_example</span><span class="p">(</span>
</span><span data-line="1209">                    <span class="n">b</span><span class="p">[</span><span class="s2">&quot;tokenized_text&quot;</span><span class="p">],</span>
</span><span data-line="1210">                    <span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
</span><span data-line="1211">                    <span class="n">class_to_ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span data-line="1212">                    <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relations&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span data-line="1213">                    <span class="n">rel_class_to_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_class_to_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">rel_class_to_ids</span><span class="p">,</span>
</span><span data-line="1214">                <span class="p">)</span>
</span><span data-line="1215">                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_list</span><span class="p">)</span>
</span><span data-line="1216">            <span class="p">]</span>
</span><span data-line="1217">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1218">            <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="1219">                <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_example</span><span class="p">(</span>
</span><span data-line="1220">                    <span class="n">b</span><span class="p">[</span><span class="s2">&quot;tokenized_text&quot;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relations&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">rel_class_to_ids</span>
</span><span data-line="1221">                <span class="p">)</span>
</span><span data-line="1222">                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch_list</span>
</span><span data-line="1223">            <span class="p">]</span>
</span><span data-line="1224">
</span><span data-line="1225">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_batch_dict</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span><span class="p">,</span> <span class="n">rel_class_to_ids</span><span class="p">,</span> <span class="n">rel_id_to_classes</span><span class="p">)</span></div>

</span><span data-line="1226">
<div class="viewcode-block" id="RelationExtractionSpanProcessor.preprocess_example">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.RelationExtractionSpanProcessor.preprocess_example">[docs]</a>
</span><span data-line="1227">    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">ner</span><span class="p">,</span> <span class="n">classes_to_id</span><span class="p">,</span> <span class="n">relations</span><span class="p">,</span> <span class="n">rel_classes_to_id</span><span class="p">):</span>
</span><span data-line="1228"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Preprocess a single example for joint entity and relation extraction.</span>
</span><span data-line="1229">
</span><span data-line="1230"><span class="sd">        Processes both entity spans and relation triplets, ensuring consistent</span>
</span><span data-line="1231"><span class="sd">        indexing when entities are reordered.</span>
</span><span data-line="1232">
</span><span data-line="1233"><span class="sd">        Args:</span>
</span><span data-line="1234"><span class="sd">            tokens: List of token strings.</span>
</span><span data-line="1235"><span class="sd">            ner: List of entity annotations as (start, end, label) tuples.</span>
</span><span data-line="1236"><span class="sd">            classes_to_id: Mapping from entity class labels to integer IDs.</span>
</span><span data-line="1237"><span class="sd">            relations: List of relation annotations as (head_idx, tail_idx, rel_type) tuples.</span>
</span><span data-line="1238"><span class="sd">            rel_classes_to_id: Mapping from relation class labels to integer IDs.</span>
</span><span data-line="1239">
</span><span data-line="1240"><span class="sd">        Returns:</span>
</span><span data-line="1241"><span class="sd">            Dictionary containing:</span>
</span><span data-line="1242"><span class="sd">                - tokens: Token strings</span>
</span><span data-line="1243"><span class="sd">                - span_idx: Tensor of span indices</span>
</span><span data-line="1244"><span class="sd">                - span_label: Tensor of entity labels for each span</span>
</span><span data-line="1245"><span class="sd">                - seq_length: Sequence length</span>
</span><span data-line="1246"><span class="sd">                - entities: Original entity annotations</span>
</span><span data-line="1247"><span class="sd">                - relations: Original relation annotations</span>
</span><span data-line="1248"><span class="sd">                - rel_idx: Tensor of relation head/tail indices</span>
</span><span data-line="1249"><span class="sd">                - rel_label: Tensor of relation type labels</span>
</span><span data-line="1250">
</span><span data-line="1251"><span class="sd">        Warnings:</span>
</span><span data-line="1252"><span class="sd">            UserWarning: If sequence length exceeds max_len (gets truncated).</span>
</span><span data-line="1253"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1254">        <span class="n">max_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_width</span>
</span><span data-line="1255">
</span><span data-line="1256">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1257">            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;[PAD]&quot;</span><span class="p">]</span>
</span><span data-line="1258">        <span class="n">max_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_len</span>
</span><span data-line="1259">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
</span><span data-line="1260">            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sentence of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="si">}</span><span class="s2"> has been truncated to </span><span class="si">{</span><span class="n">max_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="1261">            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">max_len</span><span class="p">]</span>
</span><span data-line="1262">
</span><span data-line="1263">        <span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span data-line="1264">        <span class="n">spans_idx</span> <span class="o">=</span> <span class="n">prepare_span_idx</span><span class="p">(</span><span class="n">num_tokens</span><span class="p">,</span> <span class="n">max_width</span><span class="p">)</span>
</span><span data-line="1265">
</span><span data-line="1266">        <span class="k">if</span> <span class="n">ner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1267">            <span class="n">indexed_ner</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ner</span><span class="p">))</span>
</span><span data-line="1268">            <span class="n">indexed_ner_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">indexed_ner</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
</span><span data-line="1269">
</span><span data-line="1270">            <span class="n">ner_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">entity</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">indexed_ner_sorted</span><span class="p">]</span>
</span><span data-line="1271">
</span><span data-line="1272">            <span class="n">old_to_new_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">old_idx</span><span class="p">:</span> <span class="n">new_idx</span> <span class="k">for</span> <span class="n">new_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">old_idx</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indexed_ner_sorted</span><span class="p">)}</span>
</span><span data-line="1273">
</span><span data-line="1274">            <span class="k">if</span> <span class="n">relations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">relations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1275">                <span class="n">updated_relations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1276">                <span class="k">for</span> <span class="n">head_idx</span><span class="p">,</span> <span class="n">tail_idx</span><span class="p">,</span> <span class="n">rel_type</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
</span><span data-line="1277">                    <span class="k">if</span> <span class="n">head_idx</span> <span class="ow">in</span> <span class="n">old_to_new_idx</span> <span class="ow">and</span> <span class="n">tail_idx</span> <span class="ow">in</span> <span class="n">old_to_new_idx</span><span class="p">:</span>
</span><span data-line="1278">                        <span class="n">new_head_idx</span> <span class="o">=</span> <span class="n">old_to_new_idx</span><span class="p">[</span><span class="n">head_idx</span><span class="p">]</span>
</span><span data-line="1279">                        <span class="n">new_tail_idx</span> <span class="o">=</span> <span class="n">old_to_new_idx</span><span class="p">[</span><span class="n">tail_idx</span><span class="p">]</span>
</span><span data-line="1280">                        <span class="n">updated_relations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_head_idx</span><span class="p">,</span> <span class="n">new_tail_idx</span><span class="p">,</span> <span class="n">rel_type</span><span class="p">))</span>
</span><span data-line="1281">                <span class="n">relations</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">updated_relations</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span data-line="1282">
</span><span data-line="1283">            <span class="n">ner</span> <span class="o">=</span> <span class="n">ner_sorted</span>
</span><span data-line="1284">
</span><span data-line="1285">        <span class="c1"># Process entity labels</span>
</span><span data-line="1286">        <span class="n">dict_lab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dict</span><span class="p">(</span><span class="n">ner</span><span class="p">,</span> <span class="n">classes_to_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">ner</span> <span class="k">else</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span data-line="1287">        <span class="n">span_label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">dict_lab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spans_idx</span><span class="p">])</span>
</span><span data-line="1288">        <span class="n">spans_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">spans_idx</span><span class="p">)</span>
</span><span data-line="1289">        <span class="n">valid_span_mask</span> <span class="o">=</span> <span class="n">spans_idx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">num_tokens</span> <span class="o">-</span> <span class="mi">1</span>
</span><span data-line="1290">        <span class="n">span_label</span> <span class="o">=</span> <span class="n">span_label</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">valid_span_mask</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1291">
</span><span data-line="1292">        <span class="c1"># Create entity span to index mapping</span>
</span><span data-line="1293">        <span class="n">span_to_idx</span> <span class="o">=</span> <span class="p">{(</span><span class="n">spans_idx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">spans_idx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()):</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spans_idx</span><span class="p">))}</span>
</span><span data-line="1294">
</span><span data-line="1295">        <span class="c1"># Create entity index mapping (from original entity list to span indices)</span>
</span><span data-line="1296">        <span class="n">entity_to_span_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1297">        <span class="k">if</span> <span class="n">ner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1298">            <span class="k">for</span> <span class="n">ent_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ner</span><span class="p">):</span>  <span class="c1"># (start, end, label)</span>
</span><span data-line="1299">                <span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="n">span_to_idx</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">num_tokens</span><span class="p">:</span>
</span><span data-line="1300">                    <span class="n">entity_to_span_idx</span><span class="p">[</span><span class="n">ent_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">span_to_idx</span><span class="p">[(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>
</span><span data-line="1301">
</span><span data-line="1302">        <span class="c1"># Process relations</span>
</span><span data-line="1303">        <span class="n">rel_idx_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1304">        <span class="n">rel_label_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1305">
</span><span data-line="1306">        <span class="k">if</span> <span class="n">relations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1307">            <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
</span><span data-line="1308">                <span class="n">head_idx</span><span class="p">,</span> <span class="n">tail_idx</span><span class="p">,</span> <span class="n">rel_type</span> <span class="o">=</span> <span class="n">rel</span>
</span><span data-line="1309">
</span><span data-line="1310">                <span class="c1"># Check if both entities are valid and map to span indices</span>
</span><span data-line="1311">                <span class="k">if</span> <span class="n">head_idx</span> <span class="ow">in</span> <span class="n">entity_to_span_idx</span> <span class="ow">and</span> <span class="n">tail_idx</span> <span class="ow">in</span> <span class="n">entity_to_span_idx</span> <span class="ow">and</span> <span class="n">rel_type</span> <span class="ow">in</span> <span class="n">rel_classes_to_id</span><span class="p">:</span>
</span><span data-line="1312">                    <span class="n">rel_idx_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">head_idx</span><span class="p">,</span> <span class="n">tail_idx</span><span class="p">])</span>
</span><span data-line="1313">                    <span class="n">rel_label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_classes_to_id</span><span class="p">[</span><span class="n">rel_type</span><span class="p">])</span>
</span><span data-line="1314">
</span><span data-line="1315">        <span class="c1"># Convert to tensors</span>
</span><span data-line="1316">        <span class="k">if</span> <span class="n">rel_idx_list</span><span class="p">:</span>
</span><span data-line="1317">            <span class="n">rel_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">rel_idx_list</span><span class="p">)</span>
</span><span data-line="1318">            <span class="n">rel_label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">rel_label_list</span><span class="p">)</span>
</span><span data-line="1319">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1320">            <span class="n">rel_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
</span><span data-line="1321">            <span class="n">rel_label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
</span><span data-line="1322">
</span><span data-line="1323">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1324">            <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">,</span>
</span><span data-line="1325">            <span class="s2">&quot;span_idx&quot;</span><span class="p">:</span> <span class="n">spans_idx</span><span class="p">,</span>
</span><span data-line="1326">            <span class="s2">&quot;span_label&quot;</span><span class="p">:</span> <span class="n">span_label</span><span class="p">,</span>
</span><span data-line="1327">            <span class="s2">&quot;seq_length&quot;</span><span class="p">:</span> <span class="n">num_tokens</span><span class="p">,</span>
</span><span data-line="1328">            <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="n">ner</span><span class="p">,</span>
</span><span data-line="1329">            <span class="s2">&quot;relations&quot;</span><span class="p">:</span> <span class="n">relations</span><span class="p">,</span>
</span><span data-line="1330">            <span class="s2">&quot;rel_idx&quot;</span><span class="p">:</span> <span class="n">rel_idx</span><span class="p">,</span>
</span><span data-line="1331">            <span class="s2">&quot;rel_label&quot;</span><span class="p">:</span> <span class="n">rel_label</span><span class="p">,</span>
</span><span data-line="1332">        <span class="p">}</span></div>

</span><span data-line="1333">
<div class="viewcode-block" id="RelationExtractionSpanProcessor.create_batch_dict">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.RelationExtractionSpanProcessor.create_batch_dict">[docs]</a>
</span><span data-line="1334">    <span class="k">def</span><span class="w"> </span><span class="nf">create_batch_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">class_to_ids</span><span class="p">,</span> <span class="n">id_to_classes</span><span class="p">,</span> <span class="n">rel_class_to_ids</span><span class="p">,</span> <span class="n">rel_id_to_classes</span><span class="p">):</span>
</span><span data-line="1335"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a batch dictionary from preprocessed relation extraction examples.</span>
</span><span data-line="1336">
</span><span data-line="1337"><span class="sd">        Args:</span>
</span><span data-line="1338"><span class="sd">            batch: List of preprocessed example dictionaries.</span>
</span><span data-line="1339"><span class="sd">            class_to_ids: List of entity class-to-ID mappings.</span>
</span><span data-line="1340"><span class="sd">            id_to_classes: List of entity ID-to-class mappings.</span>
</span><span data-line="1341"><span class="sd">            rel_class_to_ids: List of relation class-to-ID mappings.</span>
</span><span data-line="1342"><span class="sd">            rel_id_to_classes: List of relation ID-to-class mappings.</span>
</span><span data-line="1343">
</span><span data-line="1344"><span class="sd">        Returns:</span>
</span><span data-line="1345"><span class="sd">            Dictionary containing all batch data for joint entity and relation</span>
</span><span data-line="1346"><span class="sd">            extraction, including entity spans, relation pairs, and their labels.</span>
</span><span data-line="1347"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1348">        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span data-line="1349">        <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span data-line="1350">        <span class="n">relations</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;relations&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span data-line="1351">
</span><span data-line="1352">        <span class="n">span_idx</span> <span class="o">=</span> <span class="n">pad_sequence</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;span_idx&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">],</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1353">        <span class="n">span_label</span> <span class="o">=</span> <span class="n">pad_sequence</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;span_label&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">],</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1354">        <span class="n">rel_idx</span> <span class="o">=</span> <span class="n">pad_sequence</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;rel_idx&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">],</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1355">        <span class="n">rel_label</span> <span class="o">=</span> <span class="n">pad_sequence</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;rel_label&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">],</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1356">
</span><span data-line="1357">        <span class="n">seq_length</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">el</span><span class="p">[</span><span class="s2">&quot;seq_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1358">        <span class="n">span_mask</span> <span class="o">=</span> <span class="n">span_label</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span><span data-line="1359">
</span><span data-line="1360">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1361">            <span class="s2">&quot;seq_length&quot;</span><span class="p">:</span> <span class="n">seq_length</span><span class="p">,</span>
</span><span data-line="1362">            <span class="s2">&quot;span_idx&quot;</span><span class="p">:</span> <span class="n">span_idx</span><span class="p">,</span>
</span><span data-line="1363">            <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">,</span>
</span><span data-line="1364">            <span class="s2">&quot;span_mask&quot;</span><span class="p">:</span> <span class="n">span_mask</span><span class="p">,</span>
</span><span data-line="1365">            <span class="s2">&quot;span_label&quot;</span><span class="p">:</span> <span class="n">span_label</span><span class="p">,</span>
</span><span data-line="1366">            <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="n">entities</span><span class="p">,</span>
</span><span data-line="1367">            <span class="s2">&quot;relations&quot;</span><span class="p">:</span> <span class="n">relations</span><span class="p">,</span>
</span><span data-line="1368">            <span class="s2">&quot;rel_idx&quot;</span><span class="p">:</span> <span class="n">rel_idx</span><span class="p">,</span>
</span><span data-line="1369">            <span class="s2">&quot;rel_label&quot;</span><span class="p">:</span> <span class="n">rel_label</span><span class="p">,</span>
</span><span data-line="1370">            <span class="s2">&quot;classes_to_id&quot;</span><span class="p">:</span> <span class="n">class_to_ids</span><span class="p">,</span>
</span><span data-line="1371">            <span class="s2">&quot;id_to_classes&quot;</span><span class="p">:</span> <span class="n">id_to_classes</span><span class="p">,</span>
</span><span data-line="1372">            <span class="s2">&quot;rel_class_to_ids&quot;</span><span class="p">:</span> <span class="n">rel_class_to_ids</span><span class="p">,</span>
</span><span data-line="1373">            <span class="s2">&quot;rel_id_to_classes&quot;</span><span class="p">:</span> <span class="n">rel_id_to_classes</span><span class="p">,</span>
</span><span data-line="1374">        <span class="p">}</span></div>

</span><span data-line="1375">
<div class="viewcode-block" id="RelationExtractionSpanProcessor.create_relation_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.RelationExtractionSpanProcessor.create_relation_labels">[docs]</a>
</span><span data-line="1376">    <span class="k">def</span><span class="w"> </span><span class="nf">create_relation_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">add_reversed_negatives</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_random_negatives</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">negative_ratio</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
</span><span data-line="1377"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create relation labels with negative pair sampling.</span>
</span><span data-line="1378">
</span><span data-line="1379"><span class="sd">        Generates training labels for relation extraction including both positive</span>
</span><span data-line="1380"><span class="sd">        relation pairs and carefully sampled negative pairs for contrastive learning.</span>
</span><span data-line="1381">
</span><span data-line="1382"><span class="sd">        Args:</span>
</span><span data-line="1383"><span class="sd">            batch: Batch dictionary containing entities and relations.</span>
</span><span data-line="1384"><span class="sd">            add_reversed_negatives: If True, add reversed direction pairs as</span>
</span><span data-line="1385"><span class="sd">                negatives (h,t) -&gt; (t,h). These are important hard negatives</span>
</span><span data-line="1386"><span class="sd">                for learning relation directionality.</span>
</span><span data-line="1387"><span class="sd">            add_random_negatives: If True, add random entity pairs as negatives</span>
</span><span data-line="1388"><span class="sd">                to provide additional training signal.</span>
</span><span data-line="1389"><span class="sd">            negative_ratio: Ratio of negative to positive pairs. For example,</span>
</span><span data-line="1390"><span class="sd">                2.0 means twice as many negatives as positives.</span>
</span><span data-line="1391">
</span><span data-line="1392"><span class="sd">        Returns:</span>
</span><span data-line="1393"><span class="sd">            Tuple containing:</span>
</span><span data-line="1394"><span class="sd">                - adj_matrix: Adjacency matrix indicating which entity pairs</span>
</span><span data-line="1395"><span class="sd">                  to consider (shape: [B, max_entities, max_entities])</span>
</span><span data-line="1396"><span class="sd">                - rel_matrix: Multi-hot encoded relation labels for each pair</span>
</span><span data-line="1397"><span class="sd">                  (shape: [B, max_pairs, num_relation_classes])</span>
</span><span data-line="1398"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1399">        <span class="n">B</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">])</span>
</span><span data-line="1400">        <span class="n">entity_label</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;span_label&quot;</span><span class="p">]</span>
</span><span data-line="1401">
</span><span data-line="1402">        <span class="n">batch_ents</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">entity_label</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1403">        <span class="n">max_En</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">batch_ents</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span data-line="1404">
</span><span data-line="1405">        <span class="n">rel_class_to_ids</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rel_class_to_ids&quot;</span><span class="p">]</span>
</span><span data-line="1406">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_class_to_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span data-line="1407">            <span class="n">C</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rel_class_to_ids</span><span class="p">)</span>
</span><span data-line="1408">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1409">            <span class="n">C</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rel_class_to_ids</span><span class="p">)</span>
</span><span data-line="1410">
</span><span data-line="1411">        <span class="n">adj_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">max_En</span><span class="p">,</span> <span class="n">max_En</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
</span><span data-line="1412">
</span><span data-line="1413">        <span class="c1"># Collect all pairs (positive + negative) and their relations</span>
</span><span data-line="1414">        <span class="n">all_pairs_info</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1415">        <span class="n">max_total_pairs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1416">
</span><span data-line="1417">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
</span><span data-line="1418">            <span class="n">N</span> <span class="o">=</span> <span class="n">batch_ents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span data-line="1419">            <span class="n">rel_idx_i</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rel_idx&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="1420">            <span class="n">rel_label_i</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rel_label&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="1421">
</span><span data-line="1422">            <span class="c1"># Dictionary to group relations by entity pair</span>
</span><span data-line="1423">            <span class="n">pair_to_relations</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1424">            <span class="n">positive_pairs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="1425">
</span><span data-line="1426">            <span class="c1"># Collect positive pairs</span>
</span><span data-line="1427">            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rel_label_i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span data-line="1428">                <span class="k">if</span> <span class="n">rel_label_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1429">                    <span class="n">e1</span> <span class="o">=</span> <span class="n">rel_idx_i</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span data-line="1430">                    <span class="n">e2</span> <span class="o">=</span> <span class="n">rel_idx_i</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span data-line="1431">
</span><span data-line="1432">                    <span class="k">if</span> <span class="n">e1</span> <span class="o">&lt;</span> <span class="n">N</span> <span class="ow">and</span> <span class="n">e2</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">:</span>
</span><span data-line="1433">                        <span class="n">pair_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span>
</span><span data-line="1434">                        <span class="n">positive_pairs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pair_key</span><span class="p">)</span>
</span><span data-line="1435">                        <span class="k">if</span> <span class="n">pair_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pair_to_relations</span><span class="p">:</span>
</span><span data-line="1436">                            <span class="n">pair_to_relations</span><span class="p">[</span><span class="n">pair_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1437">                        <span class="n">class_id</span> <span class="o">=</span> <span class="n">rel_label_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span data-line="1438">                        <span class="n">pair_to_relations</span><span class="p">[</span><span class="n">pair_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_id</span><span class="p">)</span>
</span><span data-line="1439">
</span><span data-line="1440">            <span class="c1"># Generate negative pairs</span>
</span><span data-line="1441">            <span class="n">negative_pairs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="1442">            <span class="n">num_positives</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive_pairs</span><span class="p">)</span>
</span><span data-line="1443">            <span class="n">target_negatives</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_positives</span> <span class="o">*</span> <span class="n">negative_ratio</span><span class="p">)</span>
</span><span data-line="1444">
</span><span data-line="1445">            <span class="c1"># 1. Add reversed pairs as negatives (most important!)</span>
</span><span data-line="1446">            <span class="k">if</span> <span class="n">add_reversed_negatives</span><span class="p">:</span>
</span><span data-line="1447">                <span class="k">for</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">positive_pairs</span><span class="p">:</span>
</span><span data-line="1448">                    <span class="n">reversed_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">e2</span><span class="p">,</span> <span class="n">e1</span><span class="p">)</span>
</span><span data-line="1449">                    <span class="c1"># Only add if reversed pair is NOT also a positive relation</span>
</span><span data-line="1450">                    <span class="k">if</span> <span class="n">reversed_pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">positive_pairs</span><span class="p">:</span>
</span><span data-line="1451">                        <span class="n">negative_pairs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reversed_pair</span><span class="p">)</span>
</span><span data-line="1452">
</span><span data-line="1453">            <span class="c1"># 2. Add random negative pairs if needed</span>
</span><span data-line="1454">            <span class="k">if</span> <span class="n">add_random_negatives</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_pairs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">target_negatives</span><span class="p">:</span>
</span><span data-line="1455">                <span class="c1"># Get entity span positions for proximity-based sampling</span>
</span><span data-line="1456">                <span class="n">entities</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="1457">                <span class="n">entity_positions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">]</span> <span class="k">if</span> <span class="n">entities</span> <span class="k">else</span> <span class="p">[]</span>
</span><span data-line="1458">
</span><span data-line="1459">                <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1460">                <span class="n">max_attempts</span> <span class="o">=</span> <span class="n">target_negatives</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># Avoid infinite loop</span>
</span><span data-line="1461">
</span><span data-line="1462">                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_pairs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">target_negatives</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="n">max_attempts</span><span class="p">:</span>
</span><span data-line="1463">                    <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="1464">
</span><span data-line="1465">                    <span class="c1"># Sample two different entities</span>
</span><span data-line="1466">                    <span class="n">e1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="1467">                    <span class="n">e2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="1468">
</span><span data-line="1469">                    <span class="k">if</span> <span class="n">e1</span> <span class="o">==</span> <span class="n">e2</span><span class="p">:</span>
</span><span data-line="1470">                        <span class="k">continue</span>
</span><span data-line="1471">
</span><span data-line="1472">                    <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span>
</span><span data-line="1473">
</span><span data-line="1474">                    <span class="c1"># Skip if already positive or already in negatives</span>
</span><span data-line="1475">                    <span class="k">if</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">positive_pairs</span> <span class="ow">or</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">negative_pairs</span><span class="p">:</span>
</span><span data-line="1476">                        <span class="k">continue</span>
</span><span data-line="1477">
</span><span data-line="1478">                    <span class="c1"># Optional: bias towards nearby entities (hard negatives)</span>
</span><span data-line="1479">                    <span class="k">if</span> <span class="n">entity_positions</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity_positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">e1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity_positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">e2</span><span class="p">:</span>
</span><span data-line="1480">                        <span class="n">pos1</span> <span class="o">=</span> <span class="n">entity_positions</span><span class="p">[</span><span class="n">e1</span><span class="p">]</span>
</span><span data-line="1481">                        <span class="n">pos2</span> <span class="o">=</span> <span class="n">entity_positions</span><span class="p">[</span><span class="n">e2</span><span class="p">]</span>
</span><span data-line="1482">                        <span class="n">distance</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Distance between entities</span>
</span><span data-line="1483">
</span><span data-line="1484">                        <span class="c1"># Sample with probability inversely proportional to distance</span>
</span><span data-line="1485">                        <span class="c1"># (closer entities are harder negatives)</span>
</span><span data-line="1486">                        <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span data-line="1487">                            <span class="k">continue</span>  <span class="c1"># Skip some far pairs</span>
</span><span data-line="1488">
</span><span data-line="1489">                    <span class="n">negative_pairs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
</span><span data-line="1490">
</span><span data-line="1491">            <span class="c1"># Combine all pairs (positives + negatives) and sort</span>
</span><span data-line="1492">            <span class="n">all_pairs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">positive_pairs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">negative_pairs</span><span class="p">))</span>
</span><span data-line="1493">
</span><span data-line="1494">            <span class="c1"># Store pair info: pair, is_positive, relations</span>
</span><span data-line="1495">            <span class="n">pair_info</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1496">            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">all_pairs</span><span class="p">:</span>
</span><span data-line="1497">                <span class="n">is_positive</span> <span class="o">=</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">positive_pairs</span>
</span><span data-line="1498">                <span class="n">relations</span> <span class="o">=</span> <span class="n">pair_to_relations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="1499">                <span class="n">pair_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pair</span><span class="p">,</span> <span class="n">is_positive</span><span class="p">,</span> <span class="n">relations</span><span class="p">))</span>
</span><span data-line="1500">
</span><span data-line="1501">            <span class="n">all_pairs_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair_info</span><span class="p">)</span>
</span><span data-line="1502">            <span class="n">max_total_pairs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_total_pairs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_pairs</span><span class="p">))</span>
</span><span data-line="1503">
</span><span data-line="1504">        <span class="c1"># Create matrices</span>
</span><span data-line="1505">        <span class="n">rel_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">max_total_pairs</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
</span><span data-line="1506">        <span class="n">pair_type_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">max_total_pairs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>  <span class="c1"># 1=positive, 0=negative</span>
</span><span data-line="1507">
</span><span data-line="1508">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
</span><span data-line="1509">            <span class="n">N</span> <span class="o">=</span> <span class="n">batch_ents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span data-line="1510">            <span class="n">pair_info</span> <span class="o">=</span> <span class="n">all_pairs_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="1511">
</span><span data-line="1512">            <span class="n">adj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span><span data-line="1513">
</span><span data-line="1514">            <span class="k">for</span> <span class="n">pair_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">is_positive</span><span class="p">,</span> <span class="n">relations</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pair_info</span><span class="p">):</span>
</span><span data-line="1515">                <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">pair</span>
</span><span data-line="1516">
</span><span data-line="1517">                <span class="c1"># Set adjacency (1.0 for both positive and negative pairs)</span>
</span><span data-line="1518">                <span class="n">adj</span><span class="p">[</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span data-line="1519">
</span><span data-line="1520">                <span class="c1"># Mark pair type</span>
</span><span data-line="1521">                <span class="n">pair_type_mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">pair_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">is_positive</span> <span class="k">else</span> <span class="mi">0</span>
</span><span data-line="1522">
</span><span data-line="1523">                <span class="k">if</span> <span class="n">is_positive</span><span class="p">:</span>
</span><span data-line="1524">                    <span class="c1"># Create multi-hot vector for positive pairs</span>
</span><span data-line="1525">                    <span class="k">for</span> <span class="n">class_id</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span>
</span><span data-line="1526">                        <span class="n">rel_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">pair_idx</span><span class="p">,</span> <span class="n">class_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span data-line="1527">
</span><span data-line="1528">            <span class="n">adj_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">N</span><span class="p">,</span> <span class="p">:</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">adj</span>
</span><span data-line="1529">
</span><span data-line="1530">        <span class="k">return</span> <span class="n">adj_matrix</span><span class="p">,</span> <span class="n">rel_matrix</span></div>

</span><span data-line="1531">
<div class="viewcode-block" id="RelationExtractionSpanProcessor.prepare_inputs">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.RelationExtractionSpanProcessor.prepare_inputs">[docs]</a>
</span><span data-line="1532">    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_inputs</span><span class="p">(</span>
</span><span data-line="1533">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1534">        <span class="n">texts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span data-line="1535">        <span class="n">entities</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span data-line="1536">        <span class="n">blank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1537">        <span class="n">relations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1538">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="1539">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</span><span data-line="1540"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare input texts with entity and relation type prompts.</span>
</span><span data-line="1541">
</span><span data-line="1542"><span class="sd">        Extends the base prepare_inputs to include relation type tokens in the prompt.</span>
</span><span data-line="1543">
</span><span data-line="1544"><span class="sd">        Args:</span>
</span><span data-line="1545"><span class="sd">            texts: Sequences of token strings, one per example.</span>
</span><span data-line="1546"><span class="sd">            entities: Entity types to extract.</span>
</span><span data-line="1547"><span class="sd">            blank: Optional blank entity token for zero-shot scenarios.</span>
</span><span data-line="1548"><span class="sd">            relations: Relation types to extract (optional).</span>
</span><span data-line="1549"><span class="sd">            **kwargs: Additional keyword arguments.</span>
</span><span data-line="1550">
</span><span data-line="1551"><span class="sd">        Returns:</span>
</span><span data-line="1552"><span class="sd">            Tuple containing:</span>
</span><span data-line="1553"><span class="sd">                - List of input text sequences with prepended prompts</span>
</span><span data-line="1554"><span class="sd">                - List of prompt lengths for each example</span>
</span><span data-line="1555"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1556">        <span class="n">input_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1557">        <span class="n">prompt_lengths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1558">
</span><span data-line="1559">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
</span><span data-line="1560">            <span class="n">ents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_entities</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">blank</span><span class="p">)</span>
</span><span data-line="1561">            <span class="n">ents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_remap_entities</span><span class="p">(</span><span class="n">ents</span><span class="p">)</span>
</span><span data-line="1562">
</span><span data-line="1563">            <span class="n">rels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_entities</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">relations</span><span class="p">,</span> <span class="n">blank</span><span class="p">)</span> <span class="k">if</span> <span class="n">relations</span> <span class="k">else</span> <span class="p">[]</span>
</span><span data-line="1564">            <span class="n">rels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_remap_entities</span><span class="p">(</span><span class="n">rels</span><span class="p">)</span>
</span><span data-line="1565">
</span><span data-line="1566">            <span class="n">prompt</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1567">            <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">ents</span><span class="p">:</span>
</span><span data-line="1568">                <span class="n">prompt</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ent_token</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ent</span><span class="p">)]</span>
</span><span data-line="1569">            <span class="n">prompt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sep_token</span><span class="p">)</span>
</span><span data-line="1570">
</span><span data-line="1571">            <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">rels</span><span class="p">:</span>
</span><span data-line="1572">                <span class="n">prompt</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_token</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rel</span><span class="p">)]</span>
</span><span data-line="1573">            <span class="n">prompt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sep_token</span><span class="p">)</span>
</span><span data-line="1574">
</span><span data-line="1575">            <span class="n">prompt_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">))</span>
</span><span data-line="1576">            <span class="n">input_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
</span><span data-line="1577">
</span><span data-line="1578">        <span class="k">return</span> <span class="n">input_texts</span><span class="p">,</span> <span class="n">prompt_lengths</span></div>

</span><span data-line="1579">
<div class="viewcode-block" id="RelationExtractionSpanProcessor.tokenize_inputs">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.RelationExtractionSpanProcessor.tokenize_inputs">[docs]</a>
</span><span data-line="1580">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="1581"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize input texts with entity and relation prompts.</span>
</span><span data-line="1582">
</span><span data-line="1583"><span class="sd">        Args:</span>
</span><span data-line="1584"><span class="sd">            texts: Sequences of token strings.</span>
</span><span data-line="1585"><span class="sd">            entities: Entity types for extraction.</span>
</span><span data-line="1586"><span class="sd">            blank: Optional blank entity token.</span>
</span><span data-line="1587"><span class="sd">            relations: Optional relation types for extraction.</span>
</span><span data-line="1588"><span class="sd">            **kwargs: Additional keyword arguments.</span>
</span><span data-line="1589">
</span><span data-line="1590"><span class="sd">        Returns:</span>
</span><span data-line="1591"><span class="sd">            Dictionary containing tokenized inputs with word masks.</span>
</span><span data-line="1592"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1593">        <span class="n">input_texts</span><span class="p">,</span> <span class="n">prompt_lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_inputs</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="n">blank</span><span class="p">,</span> <span class="n">relations</span><span class="o">=</span><span class="n">relations</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="1594">
</span><span data-line="1595">        <span class="n">tokenized_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">(</span>
</span><span data-line="1596">            <span class="n">input_texts</span><span class="p">,</span>
</span><span data-line="1597">            <span class="n">is_split_into_words</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1598">            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span data-line="1599">            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1600">            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;longest&quot;</span><span class="p">,</span>
</span><span data-line="1601">        <span class="p">)</span>
</span><span data-line="1602">        <span class="n">words_masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_word_mask</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">tokenized_inputs</span><span class="p">,</span> <span class="n">prompt_lengths</span><span class="p">)</span>
</span><span data-line="1603">        <span class="n">tokenized_inputs</span><span class="p">[</span><span class="s2">&quot;words_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">words_masks</span><span class="p">)</span>
</span><span data-line="1604">
</span><span data-line="1605">        <span class="k">return</span> <span class="n">tokenized_inputs</span></div>

</span><span data-line="1606">
<div class="viewcode-block" id="RelationExtractionSpanProcessor.tokenize_and_prepare_labels">
<a class="viewcode-back" href="../../../api/gliner.data_processing.processor.html#gliner.data_processing.processor.RelationExtractionSpanProcessor.tokenize_and_prepare_labels">[docs]</a>
</span><span data-line="1607">    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_and_prepare_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">prepare_labels</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="1608"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize inputs and prepare labels for joint entity-relation extraction.</span>
</span><span data-line="1609">
</span><span data-line="1610"><span class="sd">        Args:</span>
</span><span data-line="1611"><span class="sd">            batch: Batch dictionary with tokens, entities, relations, and class mappings.</span>
</span><span data-line="1612"><span class="sd">            prepare_labels: Whether to prepare labels.</span>
</span><span data-line="1613"><span class="sd">            *args: Variable length argument list.</span>
</span><span data-line="1614"><span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
</span><span data-line="1615">
</span><span data-line="1616"><span class="sd">        Returns:</span>
</span><span data-line="1617"><span class="sd">            Dictionary containing tokenized inputs, entity labels, relation adjacency</span>
</span><span data-line="1618"><span class="sd">            matrix, and relation labels.</span>
</span><span data-line="1619"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1620">        <span class="n">tokenized_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_inputs</span><span class="p">(</span>
</span><span data-line="1621">            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;classes_to_id&quot;</span><span class="p">],</span> <span class="n">blank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relations</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rel_class_to_ids&quot;</span><span class="p">]</span>
</span><span data-line="1622">        <span class="p">)</span>
</span><span data-line="1623">
</span><span data-line="1624">        <span class="k">if</span> <span class="n">prepare_labels</span><span class="p">:</span>
</span><span data-line="1625">            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_labels</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span data-line="1626">            <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
</span><span data-line="1627">
</span><span data-line="1628">            <span class="n">adj_matrix</span><span class="p">,</span> <span class="n">rel_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_relation_labels</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span data-line="1629">            <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;adj_matrix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adj_matrix</span>
</span><span data-line="1630">            <span class="n">tokenized_input</span><span class="p">[</span><span class="s2">&quot;rel_matrix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_matrix</span>
</span><span data-line="1631">
</span><span data-line="1632">        <span class="k">return</span> <span class="n">tokenized_input</span></div>
</div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, GLiNER community</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../../_static/documentation_options.js?v=dc91f075"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/shibuya.js?v=9b0e4dde"></script></body>
</html>