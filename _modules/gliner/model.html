<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>gliner.model - Home 0.2.24 documentation</title><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=d140fbf8" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="gliner.model"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../index.html">
      
      
      <strong>Home</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction to ðŸ‘‘ GLiNER</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instalation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configs.html">Components &amp; Configs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architectures.html">Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../convert_to_onnx.html">ONNX Export &amp; Deployment</a></li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/gliner.model.html">gliner.model module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/gliner.config.html">gliner.config module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/gliner.training.html">gliner.training package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.training.trainer.html">gliner.training.trainer module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/gliner.modeling.html">gliner.modeling package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.modeling.multitask.html">gliner.modeling.multitask package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/gliner.modeling.multitask.relations_layers.html">gliner.modeling.multitask.relations_layers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/gliner.modeling.multitask.triples_layers.html">gliner.modeling.multitask.triples_layers module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.modeling.base.html">gliner.modeling.base module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.modeling.decoder.html">gliner.modeling.decoder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.modeling.encoder.html">gliner.modeling.encoder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.modeling.layers.html">gliner.modeling.layers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.modeling.loss_functions.html">gliner.modeling.loss_functions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.modeling.outputs.html">gliner.modeling.outputs module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.modeling.scorers.html">gliner.modeling.scorers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.modeling.span_rep.html">gliner.modeling.span_rep module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.modeling.utils.html">gliner.modeling.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/gliner.data_processing.html">gliner.data_processing package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.data_processing.collator.html">gliner.data_processing.collator module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.data_processing.processor.html">gliner.data_processing.processor module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.data_processing.tokenizer.html">gliner.data_processing.tokenizer module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.data_processing.utils.html">gliner.data_processing.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/gliner.evaluation.html">gliner.evaluation package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.evaluation.evaluate_ner.html">gliner.evaluation.evaluate_ner module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.evaluation.evaluator.html">gliner.evaluation.evaluator module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.evaluation.utils.html">gliner.evaluation.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/gliner.onnx.html">gliner.onnx package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.onnx.model.html">gliner.onnx.model module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/gliner.decoding.html">gliner.decoding package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.decoding.trie.html">gliner.decoding.trie package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/gliner.decoding.trie.labels_trie.html">gliner.decoding.trie.labels_trie module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/gliner.decoding.trie.python_labels_trie.html">gliner.decoding.trie.python_labels_trie module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.decoding.decoder.html">gliner.decoding.decoder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/gliner.decoding.utils.html">gliner.decoding.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/gliner.utils.html">gliner.utils module</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">Home</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">gliner.model</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for gliner.model</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span data-line="2"><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span data-line="3"><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span data-line="5"><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span data-line="9">
</span><span data-line="10"><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span data-line="11"><span class="kn">import</span><span class="w"> </span><span class="nn">onnxruntime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ort</span>
</span><span data-line="12"><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span data-line="13"><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</span><span data-line="14"><span class="kn">from</span><span class="w"> </span><span class="nn">safetensors</span><span class="w"> </span><span class="kn">import</span> <span class="n">safe_open</span>
</span><span data-line="15"><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoTokenizer</span>
</span><span data-line="16"><span class="kn">from</span><span class="w"> </span><span class="nn">huggingface_hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">PyTorchModelHubMixin</span><span class="p">,</span> <span class="n">snapshot_download</span>
</span><span data-line="17"><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
</span><span data-line="18"><span class="kn">from</span><span class="w"> </span><span class="nn">safetensors.torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_file</span>
</span><span data-line="19">
</span><span data-line="20"><span class="k">try</span><span class="p">:</span>
</span><span data-line="21">    <span class="kn">from</span><span class="w"> </span><span class="nn">onnxruntime.quantization</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantType</span><span class="p">,</span> <span class="n">quantize_dynamic</span>
</span><span data-line="22"><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span data-line="23">    <span class="n">quantize_dynamic</span><span class="p">,</span> <span class="n">QuantType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span data-line="24">
</span><span data-line="25"><span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_module_available</span>
</span><span data-line="26"><span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="27">    <span class="n">GLiNERConfig</span><span class="p">,</span>
</span><span data-line="28">    <span class="n">BaseGLiNERConfig</span><span class="p">,</span>
</span><span data-line="29">    <span class="n">BiEncoderSpanConfig</span><span class="p">,</span>
</span><span data-line="30">    <span class="n">BiEncoderTokenConfig</span><span class="p">,</span>
</span><span data-line="31">    <span class="n">UniEncoderSpanConfig</span><span class="p">,</span>
</span><span data-line="32">    <span class="n">UniEncoderTokenConfig</span><span class="p">,</span>
</span><span data-line="33">    <span class="n">UniEncoderSpanRelexConfig</span><span class="p">,</span>
</span><span data-line="34">    <span class="n">UniEncoderSpanDecoderConfig</span><span class="p">,</span>
</span><span data-line="35"><span class="p">)</span>
</span><span data-line="36"><span class="kn">from</span><span class="w"> </span><span class="nn">.decoding</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpanDecoder</span><span class="p">,</span> <span class="n">TokenDecoder</span><span class="p">,</span> <span class="n">SpanRelexDecoder</span><span class="p">,</span> <span class="n">SpanGenerativeDecoder</span>
</span><span data-line="37"><span class="kn">from</span><span class="w"> </span><span class="nn">.training</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">TrainingArguments</span>
</span><span data-line="38"><span class="kn">from</span><span class="w"> </span><span class="nn">.evaluation</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseNEREvaluator</span><span class="p">,</span> <span class="n">BaseRelexEvaluator</span>
</span><span data-line="39"><span class="kn">from</span><span class="w"> </span><span class="nn">.onnx.model</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="40">    <span class="n">BaseORTModel</span><span class="p">,</span>
</span><span data-line="41">    <span class="n">BiEncoderSpanORTModel</span><span class="p">,</span>
</span><span data-line="42">    <span class="n">BiEncoderTokenORTModel</span><span class="p">,</span>
</span><span data-line="43">    <span class="n">UniEncoderSpanORTModel</span><span class="p">,</span>
</span><span data-line="44">    <span class="n">UniEncoderTokenORTModel</span><span class="p">,</span>
</span><span data-line="45">    <span class="n">UniEncoderSpanRelexORTModel</span><span class="p">,</span>
</span><span data-line="46"><span class="p">)</span>
</span><span data-line="47"><span class="kn">from</span><span class="w"> </span><span class="nn">.decoding.trie</span><span class="w"> </span><span class="kn">import</span> <span class="n">LabelsTrie</span>
</span><span data-line="48"><span class="kn">from</span><span class="w"> </span><span class="nn">.infer_packing</span><span class="w"> </span><span class="kn">import</span> <span class="n">InferencePackingConfig</span>
</span><span data-line="49"><span class="kn">from</span><span class="w"> </span><span class="nn">.modeling.base</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="50">    <span class="n">BaseModel</span><span class="p">,</span>
</span><span data-line="51">    <span class="n">BiEncoderSpanModel</span><span class="p">,</span>
</span><span data-line="52">    <span class="n">BiEncoderTokenModel</span><span class="p">,</span>
</span><span data-line="53">    <span class="n">UniEncoderSpanModel</span><span class="p">,</span>
</span><span data-line="54">    <span class="n">UniEncoderTokenModel</span><span class="p">,</span>
</span><span data-line="55">    <span class="n">UniEncoderSpanRelexModel</span><span class="p">,</span>
</span><span data-line="56">    <span class="n">UniEncoderSpanDecoderModel</span><span class="p">,</span>
</span><span data-line="57"><span class="p">)</span>
</span><span data-line="58"><span class="kn">from</span><span class="w"> </span><span class="nn">.data_processing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="59">    <span class="n">BaseProcessor</span><span class="p">,</span>
</span><span data-line="60">    <span class="n">BiEncoderSpanProcessor</span><span class="p">,</span>
</span><span data-line="61">    <span class="n">BiEncoderTokenProcessor</span><span class="p">,</span>
</span><span data-line="62">    <span class="n">UniEncoderSpanProcessor</span><span class="p">,</span>
</span><span data-line="63">    <span class="n">UniEncoderTokenProcessor</span><span class="p">,</span>
</span><span data-line="64">    <span class="n">UniEncoderSpanDecoderProcessor</span><span class="p">,</span>
</span><span data-line="65">    <span class="n">RelationExtractionSpanProcessor</span><span class="p">,</span>
</span><span data-line="66"><span class="p">)</span>
</span><span data-line="67"><span class="kn">from</span><span class="w"> </span><span class="nn">.data_processing.collator</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="68">    <span class="n">BiEncoderSpanDataCollator</span><span class="p">,</span>
</span><span data-line="69">    <span class="n">BiEncoderTokenDataCollator</span><span class="p">,</span>
</span><span data-line="70">    <span class="n">UniEncoderSpanDataCollator</span><span class="p">,</span>
</span><span data-line="71">    <span class="n">UniEncoderTokenDataCollator</span><span class="p">,</span>
</span><span data-line="72">    <span class="n">UniEncoderSpanDecoderDataCollator</span><span class="p">,</span>
</span><span data-line="73">    <span class="n">RelationExtractionSpanDataCollator</span><span class="p">,</span>
</span><span data-line="74"><span class="p">)</span>
</span><span data-line="75"><span class="kn">from</span><span class="w"> </span><span class="nn">.data_processing.tokenizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">WordsSplitter</span>
</span><span data-line="76">
</span><span data-line="77"><span class="k">if</span> <span class="n">is_module_available</span><span class="p">(</span><span class="s2">&quot;onnxruntime&quot;</span><span class="p">):</span>
</span><span data-line="78">    <span class="kn">import</span><span class="w"> </span><span class="nn">onnxruntime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ort</span>
</span><span data-line="79">
</span><span data-line="80">    <span class="n">ONNX_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="81"><span class="k">else</span><span class="p">:</span>
</span><span data-line="82">    <span class="n">ONNX_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="83">
</span><span data-line="84"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span data-line="85">
</span><span data-line="86">
<div class="viewcode-block" id="BaseGLiNER">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER">[docs]</a>
</span><span data-line="87"><span class="k">class</span><span class="w"> </span><span class="nc">BaseGLiNER</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">PyTorchModelHubMixin</span><span class="p">):</span>
</span><span data-line="88">    <span class="n">config_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="89">    <span class="n">model_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="90">    <span class="n">ort_model_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="91">    <span class="n">data_processor_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="92">    <span class="n">data_collator_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="93">    <span class="n">decoder_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="94">
<div class="viewcode-block" id="BaseGLiNER.__init__">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.__init__">[docs]</a>
</span><span data-line="95">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="96">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="97">        <span class="n">config</span><span class="p">:</span> <span class="n">BaseGLiNERConfig</span><span class="p">,</span>
</span><span data-line="98">        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="99">        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="100">        <span class="n">data_processor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProcessor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="101">        <span class="n">backbone_from_pretrained</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="102">        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="103">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="104">    <span class="p">):</span>
</span><span data-line="105"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a BaseGLiNER model.</span>
</span><span data-line="106">
</span><span data-line="107"><span class="sd">        Args:</span>
</span><span data-line="108"><span class="sd">            config: Model configuration object.</span>
</span><span data-line="109"><span class="sd">            model: Pre-initialized model instance. If None, creates a new model.</span>
</span><span data-line="110"><span class="sd">            tokenizer: Pre-initialized tokenizer. If None, creates a new tokenizer.</span>
</span><span data-line="111"><span class="sd">            data_processor: Pre-initialized data processor. If None, creates a new processor.</span>
</span><span data-line="112"><span class="sd">            backbone_from_pretrained: Whether to load the backbone from pretrained weights.</span>
</span><span data-line="113"><span class="sd">            cache_dir: Directory for caching downloaded models.</span>
</span><span data-line="114"><span class="sd">            **kwargs: Additional keyword arguments passed to model creation.</span>
</span><span data-line="115"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="116">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="117">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span data-line="118">
</span><span data-line="119">        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="120">            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span data-line="121">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="122">            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_model</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">backbone_from_pretrained</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="123">
</span><span data-line="124">        <span class="k">if</span> <span class="n">data_processor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="125">            <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span> <span class="o">=</span> <span class="n">data_processor</span>
</span><span data-line="126">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="127">            <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_data_processor</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="128">
</span><span data-line="129">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">BaseORTModel</span><span class="p">):</span>
</span><span data-line="130">            <span class="bp">self</span><span class="o">.</span><span class="n">onnx_model</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="131">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="132">            <span class="bp">self</span><span class="o">.</span><span class="n">onnx_model</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="133">
</span><span data-line="134">        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_class</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="135">
</span><span data-line="136">        <span class="bp">self</span><span class="o">.</span><span class="n">_keys_to_ignore_on_save</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="137">        <span class="bp">self</span><span class="o">.</span><span class="n">_inference_packing_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InferencePackingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>

</span><span data-line="138">
</span><span data-line="139">    <span class="nd">@abstractmethod</span>
</span><span data-line="140">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">backbone_from_pretrained</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="141"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="142"><span class="sd">        Create model instance. Must be implemented by child classes.</span>
</span><span data-line="143">
</span><span data-line="144"><span class="sd">        Returns:</span>
</span><span data-line="145"><span class="sd">            Model instance</span>
</span><span data-line="146"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="147">        <span class="k">pass</span>
</span><span data-line="148">
</span><span data-line="149">    <span class="nd">@abstractmethod</span>
</span><span data-line="150">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_data_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="151"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="152"><span class="sd">        Create data processor instance. Must be implemented by child classes.</span>
</span><span data-line="153">
</span><span data-line="154"><span class="sd">        Returns:</span>
</span><span data-line="155"><span class="sd">            Data processor instance</span>
</span><span data-line="156"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="157">        <span class="k">pass</span>
</span><span data-line="158">
<div class="viewcode-block" id="BaseGLiNER.resize_embeddings">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.resize_embeddings">[docs]</a>
</span><span data-line="159">    <span class="nd">@abstractmethod</span>
</span><span data-line="160">    <span class="k">def</span><span class="w"> </span><span class="nf">resize_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="161">        <span class="k">pass</span></div>

</span><span data-line="162">
<div class="viewcode-block" id="BaseGLiNER.inference">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.inference">[docs]</a>
</span><span data-line="163">    <span class="nd">@abstractmethod</span>
</span><span data-line="164">    <span class="k">def</span><span class="w"> </span><span class="nf">inference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="165">        <span class="k">pass</span></div>

</span><span data-line="166">
<div class="viewcode-block" id="BaseGLiNER.evaluate">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.evaluate">[docs]</a>
</span><span data-line="167">    <span class="nd">@abstractmethod</span>
</span><span data-line="168">    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="169">        <span class="k">pass</span></div>

</span><span data-line="170">
<div class="viewcode-block" id="BaseGLiNER.forward">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.forward">[docs]</a>
</span><span data-line="171">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="172"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass through the model.</span>
</span><span data-line="173">
</span><span data-line="174"><span class="sd">        Args:</span>
</span><span data-line="175"><span class="sd">            *args: Positional arguments passed to the model.</span>
</span><span data-line="176"><span class="sd">            **kwargs: Keyword arguments passed to the model.</span>
</span><span data-line="177">
</span><span data-line="178"><span class="sd">        Returns:</span>
</span><span data-line="179"><span class="sd">            Model output from the forward pass.</span>
</span><span data-line="180"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="181">        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="182">        <span class="k">return</span> <span class="n">output</span></div>

</span><span data-line="183">
</span><span data-line="184">    <span class="nd">@property</span>
</span><span data-line="185">    <span class="k">def</span><span class="w"> </span><span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="186"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the device where the model is located.</span>
</span><span data-line="187">
</span><span data-line="188"><span class="sd">        Returns:</span>
</span><span data-line="189"><span class="sd">            Torch device object (CPU or CUDA).</span>
</span><span data-line="190"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="191">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_model</span><span class="p">:</span>
</span><span data-line="192">            <span class="n">providers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_providers</span><span class="p">()</span>
</span><span data-line="193">            <span class="k">if</span> <span class="s2">&quot;CUDAExecutionProvider&quot;</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">:</span>
</span><span data-line="194">                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
</span><span data-line="195">            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span data-line="196">        <span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>
</span><span data-line="197">        <span class="k">return</span> <span class="n">device</span>
</span><span data-line="198">
<div class="viewcode-block" id="BaseGLiNER.configure_inference_packing">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.configure_inference_packing">[docs]</a>
</span><span data-line="199">    <span class="k">def</span><span class="w"> </span><span class="nf">configure_inference_packing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InferencePackingConfig</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="200"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure default packing behavior for inference calls.</span>
</span><span data-line="201">
</span><span data-line="202"><span class="sd">        Passing ``None`` disables packing by default. Individual inference</span>
</span><span data-line="203"><span class="sd">        methods accept a ``packing_config`` argument to override this setting</span>
</span><span data-line="204"><span class="sd">        on a per-call basis.</span>
</span><span data-line="205">
</span><span data-line="206"><span class="sd">        Args:</span>
</span><span data-line="207"><span class="sd">            config: Inference packing configuration or None to disable packing.</span>
</span><span data-line="208"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="209">        <span class="bp">self</span><span class="o">.</span><span class="n">_inference_packing_config</span> <span class="o">=</span> <span class="n">config</span></div>

</span><span data-line="210">
<div class="viewcode-block" id="BaseGLiNER.compile">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.compile">[docs]</a>
</span><span data-line="211">    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="212"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile the model using torch.compile for optimization.&quot;&quot;&quot;</span>
</span><span data-line="213">        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span></div>

</span><span data-line="214">
</span><span data-line="215">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_special_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="216"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get special tokens to add to tokenizer.</span>
</span><span data-line="217">
</span><span data-line="218"><span class="sd">        Can be overridden by child classes.</span>
</span><span data-line="219">
</span><span data-line="220"><span class="sd">        Returns:</span>
</span><span data-line="221"><span class="sd">            List of special tokens</span>
</span><span data-line="222"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="223">        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;[FLERT]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ent_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sep_token</span><span class="p">]</span>
</span><span data-line="224">        <span class="k">return</span> <span class="n">tokens</span>
</span><span data-line="225">
<div class="viewcode-block" id="BaseGLiNER.prepare_state_dict">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.prepare_state_dict">[docs]</a>
</span><span data-line="226">    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">):</span>
</span><span data-line="227"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare state dict for saving, handling torch.compile artifacts.</span>
</span><span data-line="228">
</span><span data-line="229"><span class="sd">        Args:</span>
</span><span data-line="230"><span class="sd">            state_dict: Original state dictionary from the model.</span>
</span><span data-line="231">
</span><span data-line="232"><span class="sd">        Returns:</span>
</span><span data-line="233"><span class="sd">            Cleaned state dictionary with torch.compile prefixes removed.</span>
</span><span data-line="234"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="235">        <span class="n">new_state_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="236">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="237">            <span class="n">_key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;_orig_mod\.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="238">            <span class="n">new_state_dict</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span>
</span><span data-line="239">        <span class="k">return</span> <span class="n">new_state_dict</span></div>

</span><span data-line="240">
<div class="viewcode-block" id="BaseGLiNER.save_pretrained">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.save_pretrained">[docs]</a>
</span><span data-line="241">    <span class="k">def</span><span class="w"> </span><span class="nf">save_pretrained</span><span class="p">(</span>
</span><span data-line="242">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="243">        <span class="n">save_directory</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
</span><span data-line="244">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="245">        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseGLiNERConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="246">        <span class="n">repo_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="247">        <span class="n">push_to_hub</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="248">        <span class="n">safe_serialization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="249">        <span class="o">**</span><span class="n">push_to_hub_kwargs</span><span class="p">,</span>
</span><span data-line="250">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="251"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save model weights and configuration to local directory.</span>
</span><span data-line="252">
</span><span data-line="253"><span class="sd">        Args:</span>
</span><span data-line="254"><span class="sd">            save_directory: Path to directory for saving.</span>
</span><span data-line="255"><span class="sd">            config: Model configuration. Uses self.config if None.</span>
</span><span data-line="256"><span class="sd">            repo_id: Repository ID for hub upload.</span>
</span><span data-line="257"><span class="sd">            push_to_hub: Whether to push to HuggingFace Hub.</span>
</span><span data-line="258"><span class="sd">            safe_serialization: Whether to use safetensors format.</span>
</span><span data-line="259"><span class="sd">            **push_to_hub_kwargs: Additional arguments for push_to_hub.</span>
</span><span data-line="260">
</span><span data-line="261"><span class="sd">        Returns:</span>
</span><span data-line="262"><span class="sd">            Repository URL if pushed to hub, None otherwise.</span>
</span><span data-line="263"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="264">        <span class="n">save_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>
</span><span data-line="265">        <span class="n">save_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="266">
</span><span data-line="267">        <span class="c1"># Save model weights</span>
</span><span data-line="268">        <span class="n">model_state_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
</span><span data-line="269">
</span><span data-line="270">        <span class="k">if</span> <span class="n">safe_serialization</span><span class="p">:</span>
</span><span data-line="271">            <span class="n">save_file</span><span class="p">(</span><span class="n">model_state_dict</span><span class="p">,</span> <span class="n">save_directory</span> <span class="o">/</span> <span class="s2">&quot;model.safetensors&quot;</span><span class="p">)</span>
</span><span data-line="272">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="273">            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_state_dict</span><span class="p">,</span> <span class="n">save_directory</span> <span class="o">/</span> <span class="s2">&quot;pytorch_model.bin&quot;</span><span class="p">)</span>
</span><span data-line="274">
</span><span data-line="275">        <span class="c1"># Save config</span>
</span><span data-line="276">        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="277">            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
</span><span data-line="278">        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="279">            <span class="n">config</span><span class="o">.</span><span class="n">to_json_file</span><span class="p">(</span><span class="n">save_directory</span> <span class="o">/</span> <span class="s2">&quot;gliner_config.json&quot;</span><span class="p">)</span>
</span><span data-line="280">
</span><span data-line="281">        <span class="c1"># Save tokenizer</span>
</span><span data-line="282">        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>
</span><span data-line="283">
</span><span data-line="284">        <span class="c1"># Push to hub if requested</span>
</span><span data-line="285">        <span class="k">if</span> <span class="n">push_to_hub</span><span class="p">:</span>
</span><span data-line="286">            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">push_to_hub_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="287">            <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="288">                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
</span><span data-line="289">            <span class="k">if</span> <span class="n">repo_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="290">                <span class="n">repo_id</span> <span class="o">=</span> <span class="n">save_directory</span><span class="o">.</span><span class="n">name</span>
</span><span data-line="291">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="292">
</span><span data-line="293">        <span class="k">return</span> <span class="kc">None</span></div>

</span><span data-line="294">
</span><span data-line="295">    <span class="nd">@classmethod</span>
</span><span data-line="296">    <span class="k">def</span><span class="w"> </span><span class="nf">_load_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="o">**</span><span class="n">config_overrides</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
</span><span data-line="297"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="298"><span class="sd">        Load configuration from file with optional overrides.</span>
</span><span data-line="299">
</span><span data-line="300"><span class="sd">        Args:</span>
</span><span data-line="301"><span class="sd">            config_file: Path to config file</span>
</span><span data-line="302"><span class="sd">            **config_overrides: Config parameters to override</span>
</span><span data-line="303">
</span><span data-line="304"><span class="sd">        Returns:</span>
</span><span data-line="305"><span class="sd">            Config instance</span>
</span><span data-line="306"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="307">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span data-line="308">            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span data-line="309">
</span><span data-line="310">        <span class="n">config_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="311">
</span><span data-line="312">        <span class="c1"># Apply overrides</span>
</span><span data-line="313">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config_overrides</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="314">            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="315">                <span class="n">config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="316">
</span><span data-line="317">        <span class="c1"># Use specific config class if defined, otherwise auto-detect</span>
</span><span data-line="318">        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="319">            <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_class</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>
</span><span data-line="320">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="321">            <span class="n">config</span> <span class="o">=</span> <span class="n">GLiNERConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>
</span><span data-line="322">
</span><span data-line="323">        <span class="k">return</span> <span class="n">config</span>
</span><span data-line="324">
</span><span data-line="325">    <span class="nd">@classmethod</span>
</span><span data-line="326">    <span class="k">def</span><span class="w"> </span><span class="nf">_load_tokenizer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">GLiNERConfig</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span data-line="327"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="328"><span class="sd">        Load tokenizer from directory.</span>
</span><span data-line="329">
</span><span data-line="330"><span class="sd">        Args:</span>
</span><span data-line="331"><span class="sd">            config: GLiNER config instance</span>
</span><span data-line="332"><span class="sd">            model_dir: Directory containing tokenizer files</span>
</span><span data-line="333"><span class="sd">            cache_dir: Cache directory for downloads</span>
</span><span data-line="334">
</span><span data-line="335"><span class="sd">        Returns:</span>
</span><span data-line="336"><span class="sd">            Tokenizer instance or None</span>
</span><span data-line="337"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="338">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;tokenizer_config.json&quot;</span><span class="p">):</span>
</span><span data-line="339">            <span class="k">return</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
</span><span data-line="340">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="341">            <span class="k">return</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
</span><span data-line="342">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="343">
</span><span data-line="344">    <span class="nd">@classmethod</span>
</span><span data-line="345">    <span class="k">def</span><span class="w"> </span><span class="nf">_load_state_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">map_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
</span><span data-line="346"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="347"><span class="sd">        Load state dict from file.</span>
</span><span data-line="348">
</span><span data-line="349"><span class="sd">        Args:</span>
</span><span data-line="350"><span class="sd">            model_file: Path to model file</span>
</span><span data-line="351"><span class="sd">            map_location: Device to map tensors to</span>
</span><span data-line="352">
</span><span data-line="353"><span class="sd">        Returns:</span>
</span><span data-line="354"><span class="sd">            State dict</span>
</span><span data-line="355"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="356">        <span class="k">if</span> <span class="n">model_file</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.safetensors&quot;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.safetensors&quot;</span><span class="p">):</span>
</span><span data-line="357">            <span class="n">state_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="358">            <span class="k">with</span> <span class="n">safe_open</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">framework</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">map_location</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span data-line="359">                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span data-line="360">                    <span class="n">state_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="361">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="362">            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">map_location</span><span class="p">),</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="363">        <span class="k">return</span> <span class="n">state_dict</span>
</span><span data-line="364">
</span><span data-line="365">    <span class="nd">@classmethod</span>
</span><span data-line="366">    <span class="k">def</span><span class="w"> </span><span class="nf">_download_model</span><span class="p">(</span>
</span><span data-line="367">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="368">        <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="369">        <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="370">        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="371">        <span class="n">force_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="372">        <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="373">        <span class="n">resume_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="374">        <span class="n">token</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="375">        <span class="n">local_files_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="376">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span data-line="377"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="378"><span class="sd">        Download model from HuggingFace Hub or use local directory.</span>
</span><span data-line="379">
</span><span data-line="380"><span class="sd">        Args:</span>
</span><span data-line="381"><span class="sd">            model_id: Model identifier or local path</span>
</span><span data-line="382"><span class="sd">            revision: Model revision</span>
</span><span data-line="383"><span class="sd">            cache_dir: Cache directory</span>
</span><span data-line="384"><span class="sd">            force_download: Force redownload</span>
</span><span data-line="385"><span class="sd">            proxies: Proxy configuration</span>
</span><span data-line="386"><span class="sd">            resume_download: Resume interrupted downloads</span>
</span><span data-line="387"><span class="sd">            token: HF token</span>
</span><span data-line="388"><span class="sd">            local_files_only: Only use local files</span>
</span><span data-line="389">
</span><span data-line="390"><span class="sd">        Returns:</span>
</span><span data-line="391"><span class="sd">            Path to model directory</span>
</span><span data-line="392"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="393">        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
</span><span data-line="394">
</span><span data-line="395">        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="396">            <span class="n">model_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
</span><span data-line="397">                <span class="n">snapshot_download</span><span class="p">(</span>
</span><span data-line="398">                    <span class="n">repo_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
</span><span data-line="399">                    <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span>
</span><span data-line="400">                    <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
</span><span data-line="401">                    <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
</span><span data-line="402">                    <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
</span><span data-line="403">                    <span class="n">resume_download</span><span class="o">=</span><span class="n">resume_download</span><span class="p">,</span>
</span><span data-line="404">                    <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
</span><span data-line="405">                    <span class="n">local_files_only</span><span class="o">=</span><span class="n">local_files_only</span><span class="p">,</span>
</span><span data-line="406">                <span class="p">)</span>
</span><span data-line="407">            <span class="p">)</span>
</span><span data-line="408">
</span><span data-line="409">        <span class="k">return</span> <span class="n">model_dir</span>
</span><span data-line="410">
</span><span data-line="411">    <span class="nd">@staticmethod</span>
</span><span data-line="412">    <span class="k">def</span><span class="w"> </span><span class="nf">_resize_token_embeddings</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">config_instance</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">resize_token_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span data-line="413">        <span class="n">add_tokens</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_get_special_tokens</span><span class="p">()</span>
</span><span data-line="414">        <span class="c1"># Resize token embeddings if needed</span>
</span><span data-line="415">        <span class="k">if</span> <span class="n">resize_token_embeddings</span> <span class="ow">and</span> <span class="p">(</span><span class="n">config_instance</span><span class="o">.</span><span class="n">class_token_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">config_instance</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span data-line="416">            <span class="k">if</span> <span class="n">tokenizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="417">                <span class="n">tokenizer</span><span class="o">.</span><span class="n">add_tokens</span><span class="p">(</span><span class="n">add_tokens</span><span class="p">,</span> <span class="n">special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="418">            <span class="n">instance</span><span class="o">.</span><span class="n">resize_embeddings</span><span class="p">()</span>
</span><span data-line="419">
<div class="viewcode-block" id="BaseGLiNER.load_from_config">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.load_from_config">[docs]</a>
</span><span data-line="420">    <span class="nd">@classmethod</span>
</span><span data-line="421">    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_config</span><span class="p">(</span>
</span><span data-line="422">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="423">        <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">GLiNERConfig</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
</span><span data-line="424">        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="425">        <span class="n">load_tokenizer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="426">        <span class="n">resize_token_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="427">        <span class="n">backbone_from_pretrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="428">        <span class="n">compile_torch_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="429">        <span class="n">map_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span data-line="430">        <span class="c1"># Config overrides</span>
</span><span data-line="431">        <span class="n">max_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="432">        <span class="n">max_width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="433">        <span class="n">post_fusion_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="434">        <span class="n">_attn_implementation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="435">        <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
</span><span data-line="436">    <span class="p">):</span>
</span><span data-line="437"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a model from configuration without loading pretrained weights.</span>
</span><span data-line="438">
</span><span data-line="439"><span class="sd">        This method creates a new model instance from scratch using the provided configuration.</span>
</span><span data-line="440"><span class="sd">        The backbone encoder can optionally be loaded from pretrained weights, but the GLiNER-specific</span>
</span><span data-line="441"><span class="sd">        layers are always randomly initialized.</span>
</span><span data-line="442">
</span><span data-line="443"><span class="sd">        Args:</span>
</span><span data-line="444"><span class="sd">            config: Model configuration (GLiNERConfig object, path to config file, or dict).</span>
</span><span data-line="445"><span class="sd">            cache_dir: Cache directory for downloads.</span>
</span><span data-line="446"><span class="sd">            load_tokenizer: Whether to load tokenizer.</span>
</span><span data-line="447"><span class="sd">            resize_token_embeddings: Whether to resize token embeddings.</span>
</span><span data-line="448"><span class="sd">            backbone_from_pretrained: Whether to load the backbone encoder from pretrained weights.</span>
</span><span data-line="449"><span class="sd">            compile_torch_model: Whether to compile with torch.compile.</span>
</span><span data-line="450"><span class="sd">            map_location: Device to map model to.</span>
</span><span data-line="451"><span class="sd">            max_length: Override max_length in config.</span>
</span><span data-line="452"><span class="sd">            max_width: Override max_width in config.</span>
</span><span data-line="453"><span class="sd">            post_fusion_schema: Override post_fusion_schema in config.</span>
</span><span data-line="454"><span class="sd">            _attn_implementation: Override attention implementation.</span>
</span><span data-line="455"><span class="sd">            **model_kwargs: Additional model initialization arguments.</span>
</span><span data-line="456">
</span><span data-line="457"><span class="sd">        Returns:</span>
</span><span data-line="458"><span class="sd">            Initialized model instance with randomly initialized weights (except backbone if specified).</span>
</span><span data-line="459">
</span><span data-line="460"><span class="sd">        Examples:</span>
</span><span data-line="461"><span class="sd">            &gt;&gt;&gt; config = GLiNERConfig(model_name=&quot;microsoft/deberta-v3-small&quot;)</span>
</span><span data-line="462"><span class="sd">            &gt;&gt;&gt; model = GLiNER.load_from_config(config)</span>
</span><span data-line="463"><span class="sd">            &gt;&gt;&gt; model = GLiNER.load_from_config(&quot;path/to/gliner_config.json&quot;)</span>
</span><span data-line="464"><span class="sd">            &gt;&gt;&gt; # Load with pretrained backbone but random GLiNER layers</span>
</span><span data-line="465"><span class="sd">            &gt;&gt;&gt; model = GLiNER.load_from_config(config, backbone_from_pretrained=True)</span>
</span><span data-line="466"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="467">        <span class="c1"># Load config from various sources</span>
</span><span data-line="468">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
</span><span data-line="469">            <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="470">            <span class="k">if</span> <span class="ow">not</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="471">                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config file not found: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="472">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span data-line="473">                <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span data-line="474">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span data-line="475">            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="476">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">BaseGLiNERConfig</span><span class="p">):</span>
</span><span data-line="477">            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span data-line="478">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="479">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;config must be a GLiNERConfig object, path to config file, or dict. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="480">        <span class="n">config_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="481">        <span class="c1"># Apply config overrides</span>
</span><span data-line="482">        <span class="k">if</span> <span class="n">max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="483">            <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;max_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_length</span>
</span><span data-line="484">        <span class="k">if</span> <span class="n">max_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="485">            <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;max_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_width</span>
</span><span data-line="486">        <span class="k">if</span> <span class="n">post_fusion_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="487">            <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;post_fusion_schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_fusion_schema</span>
</span><span data-line="488">        <span class="k">if</span> <span class="n">_attn_implementation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="489">            <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;_attn_implementation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_attn_implementation</span>
</span><span data-line="490">
</span><span data-line="491">        <span class="c1"># Create config instance using the class&#39;s config_class</span>
</span><span data-line="492">        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="493">            <span class="n">config_instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_class</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>
</span><span data-line="494">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="495">            <span class="n">config_instance</span> <span class="o">=</span> <span class="n">GLiNERConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>
</span><span data-line="496">
</span><span data-line="497">        <span class="c1"># Load tokenizer if requested</span>
</span><span data-line="498">        <span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="499">        <span class="k">if</span> <span class="n">load_tokenizer</span><span class="p">:</span>
</span><span data-line="500">            <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config_instance</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
</span><span data-line="501">
</span><span data-line="502">        <span class="c1"># Create model instance from scratch</span>
</span><span data-line="503">        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
</span><span data-line="504">            <span class="n">config_instance</span><span class="p">,</span>
</span><span data-line="505">            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span data-line="506">            <span class="n">backbone_from_pretrained</span><span class="o">=</span><span class="n">backbone_from_pretrained</span><span class="p">,</span>
</span><span data-line="507">            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
</span><span data-line="508">            <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
</span><span data-line="509">        <span class="p">)</span>
</span><span data-line="510">
</span><span data-line="511">        <span class="bp">cls</span><span class="o">.</span><span class="n">_resize_token_embeddings</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">config_instance</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">resize_token_embeddings</span><span class="p">)</span>
</span><span data-line="512">
</span><span data-line="513">        <span class="c1"># Move to device</span>
</span><span data-line="514">        <span class="n">instance</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">map_location</span><span class="p">)</span>
</span><span data-line="515">
</span><span data-line="516">        <span class="c1"># Compile if requested</span>
</span><span data-line="517">        <span class="k">if</span> <span class="n">compile_torch_model</span><span class="p">:</span>
</span><span data-line="518">            <span class="k">if</span> <span class="s2">&quot;cuda&quot;</span> <span class="ow">in</span> <span class="n">map_location</span><span class="p">:</span>
</span><span data-line="519">                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compiling torch model...&quot;</span><span class="p">)</span>
</span><span data-line="520">                <span class="n">instance</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span><span data-line="521">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="522">                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="523">                    <span class="s2">&quot;Cannot compile model on CPU. Set `map_location=&#39;cuda&#39;` to compile.&quot;</span><span class="p">,</span>
</span><span data-line="524">                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span data-line="525">                <span class="p">)</span>
</span><span data-line="526">        <span class="n">instance</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span data-line="527">        <span class="k">return</span> <span class="n">instance</span></div>

</span><span data-line="528">
<div class="viewcode-block" id="BaseGLiNER.from_pretrained">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.from_pretrained">[docs]</a>
</span><span data-line="529">    <span class="nd">@classmethod</span>
</span><span data-line="530">    <span class="k">def</span><span class="w"> </span><span class="nf">from_pretrained</span><span class="p">(</span>
</span><span data-line="531">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="532">        <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="533">        <span class="n">model_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="534">        <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="535">        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="536">        <span class="n">force_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="537">        <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="538">        <span class="n">resume_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="539">        <span class="n">local_files_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="540">        <span class="n">token</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="541">        <span class="n">map_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span data-line="542">        <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="543">        <span class="n">load_tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="544">        <span class="n">resize_token_embeddings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="545">        <span class="n">compile_torch_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="546">        <span class="n">load_onnx_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="547">        <span class="n">onnx_model_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;model.onnx&quot;</span><span class="p">,</span>
</span><span data-line="548">        <span class="n">session_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="549">        <span class="c1"># Config overrides</span>
</span><span data-line="550">        <span class="n">max_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="551">        <span class="n">max_width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="552">        <span class="n">post_fusion_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="553">        <span class="n">_attn_implementation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="554">        <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
</span><span data-line="555">    <span class="p">):</span>
</span><span data-line="556"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load pretrained model from HuggingFace Hub or local directory.</span>
</span><span data-line="557">
</span><span data-line="558"><span class="sd">        Args:</span>
</span><span data-line="559"><span class="sd">            model_id: Model identifier or local path.</span>
</span><span data-line="560"><span class="sd">            model_dir: Override model directory path.</span>
</span><span data-line="561"><span class="sd">            revision: Model revision.</span>
</span><span data-line="562"><span class="sd">            cache_dir: Cache directory.</span>
</span><span data-line="563"><span class="sd">            force_download: Force redownload.</span>
</span><span data-line="564"><span class="sd">            proxies: Proxy configuration.</span>
</span><span data-line="565"><span class="sd">            resume_download: Resume interrupted downloads.</span>
</span><span data-line="566"><span class="sd">            local_files_only: Only use local files.</span>
</span><span data-line="567"><span class="sd">            token: HF token for private repos.</span>
</span><span data-line="568"><span class="sd">            map_location: Device to map model to.</span>
</span><span data-line="569"><span class="sd">            strict: Enforce strict state_dict loading.</span>
</span><span data-line="570"><span class="sd">            load_tokenizer: Whether to load tokenizer.</span>
</span><span data-line="571"><span class="sd">            resize_token_embeddings: Whether to resize embeddings.</span>
</span><span data-line="572"><span class="sd">            compile_torch_model: Whether to compile with torch.compile.</span>
</span><span data-line="573"><span class="sd">            load_onnx_model: Whether to load ONNX model instead of PyTorch.</span>
</span><span data-line="574"><span class="sd">            onnx_model_file: Path to ONNX model file.</span>
</span><span data-line="575"><span class="sd">            session_options: ONNX runtime session options.</span>
</span><span data-line="576"><span class="sd">            max_length: Override max_length in config.</span>
</span><span data-line="577"><span class="sd">            max_width: Override max_width in config.</span>
</span><span data-line="578"><span class="sd">            post_fusion_schema: Override post_fusion_schema in config.</span>
</span><span data-line="579"><span class="sd">            _attn_implementation: Override attention implementation.</span>
</span><span data-line="580"><span class="sd">            **model_kwargs: Additional model initialization arguments.</span>
</span><span data-line="581">
</span><span data-line="582"><span class="sd">        Returns:</span>
</span><span data-line="583"><span class="sd">            Loaded model instance.</span>
</span><span data-line="584"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="585">        <span class="c1"># Download or locate model</span>
</span><span data-line="586">        <span class="k">if</span> <span class="n">model_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="587">            <span class="n">model_dir</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_download_model</span><span class="p">(</span>
</span><span data-line="588">                <span class="n">model_id</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">force_download</span><span class="p">,</span> <span class="n">proxies</span><span class="p">,</span> <span class="n">resume_download</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">local_files_only</span>
</span><span data-line="589">            <span class="p">)</span>
</span><span data-line="590">
</span><span data-line="591">        <span class="c1"># Find model file</span>
</span><span data-line="592">        <span class="n">model_file</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;model.safetensors&quot;</span>
</span><span data-line="593">        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="594">            <span class="n">model_file</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;pytorch_model.bin&quot;</span>
</span><span data-line="595">
</span><span data-line="596">        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="597">            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No model file found in </span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="598">
</span><span data-line="599">        <span class="c1"># Load config</span>
</span><span data-line="600">        <span class="n">config_file</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;gliner_config.json&quot;</span>
</span><span data-line="601">        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="602">            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No config file found in </span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="603">
</span><span data-line="604">        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_load_config</span><span class="p">(</span>
</span><span data-line="605">            <span class="n">config_file</span><span class="p">,</span>
</span><span data-line="606">            <span class="n">max_len</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
</span><span data-line="607">            <span class="n">max_width</span><span class="o">=</span><span class="n">max_width</span><span class="p">,</span>
</span><span data-line="608">            <span class="n">post_fusion_schema</span><span class="o">=</span><span class="n">post_fusion_schema</span><span class="p">,</span>
</span><span data-line="609">            <span class="n">_attn_implementation</span><span class="o">=</span><span class="n">_attn_implementation</span><span class="p">,</span>
</span><span data-line="610">        <span class="p">)</span>
</span><span data-line="611">
</span><span data-line="612">        <span class="c1"># Load tokenizer</span>
</span><span data-line="613">        <span class="k">if</span> <span class="n">load_tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="614">            <span class="n">load_tokenizer</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="615">
</span><span data-line="616">        <span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="617">        <span class="k">if</span> <span class="n">load_tokenizer</span><span class="p">:</span>
</span><span data-line="618">            <span class="n">tokenizer</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_load_tokenizer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">)</span>
</span><span data-line="619">
</span><span data-line="620">        <span class="k">if</span> <span class="ow">not</span> <span class="n">load_onnx_model</span><span class="p">:</span>
</span><span data-line="621">            <span class="c1"># Create model instance</span>
</span><span data-line="622">            <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
</span><span data-line="623">                <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">backbone_from_pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span>
</span><span data-line="624">            <span class="p">)</span>
</span><span data-line="625">
</span><span data-line="626">            <span class="bp">cls</span><span class="o">.</span><span class="n">_resize_token_embeddings</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">resize_token_embeddings</span><span class="p">)</span>
</span><span data-line="627">
</span><span data-line="628">            <span class="c1"># Load state dict</span>
</span><span data-line="629">            <span class="n">state_dict</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_load_state_dict</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">map_location</span><span class="p">)</span>
</span><span data-line="630">            <span class="n">instance</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
</span><span data-line="631">            <span class="n">instance</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">map_location</span><span class="p">)</span>
</span><span data-line="632">
</span><span data-line="633">            <span class="k">if</span> <span class="n">compile_torch_model</span><span class="p">:</span>
</span><span data-line="634">                <span class="k">if</span> <span class="s2">&quot;cuda&quot;</span> <span class="ow">in</span> <span class="n">map_location</span><span class="p">:</span>
</span><span data-line="635">                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compiling torch model...&quot;</span><span class="p">)</span>
</span><span data-line="636">                    <span class="n">instance</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span><span data-line="637">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="638">                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot compile model on CPU. Set `map_location=&#39;cuda&#39;` to compile.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="639">
</span><span data-line="640">            <span class="n">instance</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span data-line="641">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="642">            <span class="n">model_file</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="n">onnx_model_file</span>
</span><span data-line="643">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_file</span><span class="p">):</span>
</span><span data-line="644">                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The ONNX model can&#39;t be loaded from </span><span class="si">{</span><span class="n">model_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span data-line="645">            <span class="k">if</span> <span class="n">session_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="646">                <span class="n">session_options</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">SessionOptions</span><span class="p">()</span>
</span><span data-line="647">                <span class="n">session_options</span><span class="o">.</span><span class="n">graph_optimization_level</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">GraphOptimizationLevel</span><span class="o">.</span><span class="n">ORT_ENABLE_ALL</span>
</span><span data-line="648">            <span class="n">providers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CPUExecutionProvider&quot;</span><span class="p">]</span>
</span><span data-line="649">            <span class="k">if</span> <span class="s2">&quot;cuda&quot;</span> <span class="ow">in</span> <span class="n">map_location</span><span class="p">:</span>
</span><span data-line="650">                <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
</span><span data-line="651">                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;CUDA is not available but `map_location` is set to &#39;cuda&#39;.&quot;</span><span class="p">)</span>
</span><span data-line="652">                <span class="n">providers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CUDAExecutionProvider&quot;</span><span class="p">]</span>
</span><span data-line="653">            <span class="n">ort_session</span> <span class="o">=</span> <span class="n">ort</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">session_options</span><span class="p">,</span> <span class="n">providers</span><span class="o">=</span><span class="n">providers</span><span class="p">)</span>
</span><span data-line="654">            <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ort_model_class</span><span class="p">(</span><span class="n">ort_session</span><span class="p">)</span>
</span><span data-line="655">            <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</span><span data-line="656">
</span><span data-line="657">        <span class="k">return</span> <span class="n">instance</span></div>

</span><span data-line="658">
</span><span data-line="659">    <span class="k">def</span><span class="w"> </span><span class="nf">_check_onnx_export_preconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="660">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_model</span><span class="p">:</span>
</span><span data-line="661">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span data-line="662">                <span class="s2">&quot;This instance already wraps an ONNX/ORT model. Export is intended for PyTorch-based models.&quot;</span>
</span><span data-line="663">            <span class="p">)</span>
</span><span data-line="664">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ONNX_AVAILABLE</span><span class="p">:</span>
</span><span data-line="665">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;onnxruntime is not available. Install `onnxruntime` to export to ONNX.&quot;</span><span class="p">)</span>
</span><span data-line="666">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;data_processor&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;data_collator_class&quot;</span><span class="p">):</span>
</span><span data-line="667">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model is not fully initialized (missing data_processor or data_collator).&quot;</span><span class="p">)</span>
</span><span data-line="668">
</span><span data-line="669">    <span class="k">def</span><span class="w"> </span><span class="nf">_build_dummy_batch</span><span class="p">(</span>
</span><span data-line="670">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="671">        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="672">        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ONNX export dummy input.&quot;</span><span class="p">,</span>
</span><span data-line="673">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span data-line="674"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="675"><span class="sd">        Build a single CPU batch using the model&#39;s own preprocessing stack.</span>
</span><span data-line="676">
</span><span data-line="677"><span class="sd">        Concrete exporters can call this and then select the keys they need.</span>
</span><span data-line="678"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="679">        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="680">            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;person&quot;</span><span class="p">,</span> <span class="s2">&quot;organization&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">]</span>
</span><span data-line="681">
</span><span data-line="682">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="683">            <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span><span class="p">]</span>
</span><span data-line="684">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="685">            <span class="n">texts</span> <span class="o">=</span> <span class="n">text</span>
</span><span data-line="686">
</span><span data-line="687">        <span class="n">tokens</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_inputs</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span><span data-line="688">        <span class="n">input_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_base_input</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span data-line="689">
</span><span data-line="690">        <span class="n">collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator_class</span><span class="p">(</span>
</span><span data-line="691">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span data-line="692">            <span class="n">data_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="p">,</span>
</span><span data-line="693">            <span class="n">return_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="694">            <span class="n">return_entities</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="695">            <span class="n">return_id_to_classes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="696">            <span class="n">prepare_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="697">        <span class="p">)</span>
</span><span data-line="698">
</span><span data-line="699">        <span class="k">def</span><span class="w"> </span><span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">entity_types</span><span class="o">=</span><span class="n">labels</span><span class="p">):</span>
</span><span data-line="700">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="701">                <span class="k">return</span> <span class="n">collator</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">entity_types</span><span class="o">=</span><span class="n">entity_types</span><span class="p">)</span>
</span><span data-line="702">            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span data-line="703">                <span class="k">return</span> <span class="n">collator</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span data-line="704">
</span><span data-line="705">        <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">input_x</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">)</span>
</span><span data-line="706">        <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">))</span>
</span><span data-line="707">
</span><span data-line="708">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span data-line="709">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="710">                <span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span data-line="711">
</span><span data-line="712">        <span class="k">return</span> <span class="n">batch</span>
</span><span data-line="713">
</span><span data-line="714">    <span class="k">def</span><span class="w"> </span><span class="nf">_run_torch_onnx_export</span><span class="p">(</span>
</span><span data-line="715">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="716">        <span class="n">wrapper</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
</span><span data-line="717">        <span class="n">all_inputs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
</span><span data-line="718">        <span class="n">input_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="719">        <span class="n">output_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="720">        <span class="n">dynamic_axes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
</span><span data-line="721">        <span class="n">onnx_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
</span><span data-line="722">        <span class="n">opset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="723">    <span class="p">):</span>
</span><span data-line="724">        <span class="n">wrapper</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span data-line="725">        <span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span>
</span><span data-line="726">            <span class="n">wrapper</span><span class="p">,</span>
</span><span data-line="727">            <span class="n">all_inputs</span><span class="p">,</span>
</span><span data-line="728">            <span class="n">f</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">onnx_path</span><span class="p">),</span>
</span><span data-line="729">            <span class="n">input_names</span><span class="o">=</span><span class="n">input_names</span><span class="p">,</span>
</span><span data-line="730">            <span class="n">output_names</span><span class="o">=</span><span class="n">output_names</span><span class="p">,</span>
</span><span data-line="731">            <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">dynamic_axes</span><span class="p">,</span>
</span><span data-line="732">            <span class="n">opset_version</span><span class="o">=</span><span class="n">opset</span><span class="p">,</span>
</span><span data-line="733">            <span class="n">dynamo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="734">        <span class="p">)</span>
</span><span data-line="735">
</span><span data-line="736">    <span class="k">def</span><span class="w"> </span><span class="nf">_maybe_quantize_onnx</span><span class="p">(</span>
</span><span data-line="737">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="738">        <span class="n">onnx_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
</span><span data-line="739">        <span class="n">quantized_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
</span><span data-line="740">        <span class="n">quantize</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="741">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
</span><span data-line="742">        <span class="k">if</span> <span class="ow">not</span> <span class="n">quantize</span><span class="p">:</span>
</span><span data-line="743">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="744">
</span><span data-line="745">        <span class="k">if</span> <span class="n">quantize_dynamic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="746">            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;onnxruntime.quantization is not available; skipping quantization.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="747">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="748">
</span><span data-line="749">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="750">            <span class="n">quantize_dynamic</span><span class="p">(</span>
</span><span data-line="751">                <span class="n">model_input</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">onnx_path</span><span class="p">),</span>
</span><span data-line="752">                <span class="n">model_output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">quantized_path</span><span class="p">),</span>
</span><span data-line="753">                <span class="n">weight_type</span><span class="o">=</span><span class="n">QuantType</span><span class="o">.</span><span class="n">QUInt8</span><span class="p">,</span>
</span><span data-line="754">            <span class="p">)</span>
</span><span data-line="755">            <span class="k">return</span> <span class="n">quantized_path</span>
</span><span data-line="756">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="757">            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quantization failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="758">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="759">
</span><span data-line="760">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_onnx_input_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="761"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Define ONNX input specification for this model type.</span>
</span><span data-line="762">
</span><span data-line="763"><span class="sd">        Must be implemented by child classes that support ONNX export.</span>
</span><span data-line="764">
</span><span data-line="765"><span class="sd">        Returns:</span>
</span><span data-line="766"><span class="sd">            Dictionary with:</span>
</span><span data-line="767"><span class="sd">                - input_names: List of input tensor names</span>
</span><span data-line="768"><span class="sd">                - output_names: List of output tensor names</span>
</span><span data-line="769"><span class="sd">                - dynamic_axes: Dynamic axis specifications</span>
</span><span data-line="770"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="771">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span data-line="772">            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> must implement _get_onnx_input_spec() or override export_to_onnx() entirely.&quot;</span>
</span><span data-line="773">        <span class="p">)</span>
</span><span data-line="774">
</span><span data-line="775">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_onnx_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
</span><span data-line="776"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="777"><span class="sd">        Create ONNX export wrapper.</span>
</span><span data-line="778">
</span><span data-line="779"><span class="sd">        Default implementation creates a simple passthrough wrapper.</span>
</span><span data-line="780"><span class="sd">        Override this method for custom wrapper logic.</span>
</span><span data-line="781">
</span><span data-line="782"><span class="sd">        Args:</span>
</span><span data-line="783"><span class="sd">            core_model: The model to wrap</span>
</span><span data-line="784">
</span><span data-line="785"><span class="sd">        Returns:</span>
</span><span data-line="786"><span class="sd">            Wrapped model for ONNX export</span>
</span><span data-line="787"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="788">
</span><span data-line="789">        <span class="k">class</span><span class="w"> </span><span class="nc">DefaultWrapper</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="790">            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core</span><span class="p">):</span>
</span><span data-line="791">                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="792">                <span class="bp">self</span><span class="o">.</span><span class="n">core</span> <span class="o">=</span> <span class="n">core</span>
</span><span data-line="793">
</span><span data-line="794">            <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="795">                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="796">                <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">logits</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;logits&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="797">
</span><span data-line="798">        <span class="k">return</span> <span class="n">DefaultWrapper</span><span class="p">(</span><span class="n">core_model</span><span class="p">)</span>
</span><span data-line="799">
</span><span data-line="800">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_onnx_export_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="801"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get additional kwargs for ONNX export (e.g., labels for bi-encoders).</span>
</span><span data-line="802">
</span><span data-line="803"><span class="sd">        Override in child classes as needed.</span>
</span><span data-line="804">
</span><span data-line="805"><span class="sd">        Returns:</span>
</span><span data-line="806"><span class="sd">            Dictionary of kwargs to pass to _build_dummy_batch</span>
</span><span data-line="807"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="808">        <span class="k">return</span> <span class="p">{}</span>
</span><span data-line="809">
</span><span data-line="810">    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_onnx_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="o">**</span><span class="n">export_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="811"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="812"><span class="sd">        Prepare batch for ONNX export. Can be overridden for special preprocessing.</span>
</span><span data-line="813">
</span><span data-line="814"><span class="sd">        Args:</span>
</span><span data-line="815"><span class="sd">            batch: Dummy batch from _build_dummy_batch</span>
</span><span data-line="816"><span class="sd">            **export_kwargs: Additional export arguments</span>
</span><span data-line="817">
</span><span data-line="818"><span class="sd">        Returns:</span>
</span><span data-line="819"><span class="sd">            Tuple of (input_tuple, updated_spec) where input_tuple contains the actual</span>
</span><span data-line="820"><span class="sd">            inputs to pass to the wrapper and updated_spec may have modified input_names/dynamic_axes</span>
</span><span data-line="821"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="822">        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_onnx_input_spec</span><span class="p">()</span>
</span><span data-line="823">        <span class="n">all_inputs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;input_names&quot;</span><span class="p">])</span>
</span><span data-line="824">        <span class="k">return</span> <span class="n">all_inputs</span><span class="p">,</span> <span class="n">spec</span>
</span><span data-line="825">
<div class="viewcode-block" id="BaseGLiNER.export_to_onnx">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.export_to_onnx">[docs]</a>
</span><span data-line="826">    <span class="k">def</span><span class="w"> </span><span class="nf">export_to_onnx</span><span class="p">(</span>
</span><span data-line="827">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="828">        <span class="n">save_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
</span><span data-line="829">        <span class="n">onnx_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model.onnx&quot;</span><span class="p">,</span>
</span><span data-line="830">        <span class="n">quantized_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model_quantized.onnx&quot;</span><span class="p">,</span>
</span><span data-line="831">        <span class="n">quantize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="832">        <span class="n">opset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span>
</span><span data-line="833">        <span class="o">**</span><span class="n">export_kwargs</span><span class="p">,</span>
</span><span data-line="834">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="835"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Unified ONNX export method using specifications from child classes.</span>
</span><span data-line="836">
</span><span data-line="837"><span class="sd">        Args:</span>
</span><span data-line="838"><span class="sd">            save_dir: Directory to save ONNX files.</span>
</span><span data-line="839"><span class="sd">            onnx_filename: Name of the ONNX model file.</span>
</span><span data-line="840"><span class="sd">            quantized_filename: Name of the quantized model file.</span>
</span><span data-line="841"><span class="sd">            quantize: Whether to create a quantized version.</span>
</span><span data-line="842"><span class="sd">            opset: ONNX opset version.</span>
</span><span data-line="843"><span class="sd">            **export_kwargs: Additional export arguments (model-specific).</span>
</span><span data-line="844">
</span><span data-line="845"><span class="sd">        Returns:</span>
</span><span data-line="846"><span class="sd">            Dictionary with paths to exported models:</span>
</span><span data-line="847"><span class="sd">                - onnx_path: Path to standard ONNX model</span>
</span><span data-line="848"><span class="sd">                - quantized_path: Path to quantized model (if quantize=True)</span>
</span><span data-line="849"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="850">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_onnx_export_preconditions</span><span class="p">()</span>
</span><span data-line="851">
</span><span data-line="852">        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
</span><span data-line="853">        <span class="n">save_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="854">        <span class="n">onnx_path</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="o">/</span> <span class="n">onnx_filename</span>
</span><span data-line="855">
</span><span data-line="856">        <span class="c1"># Merge export kwargs with model-specific kwargs</span>
</span><span data-line="857">        <span class="n">batch_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_onnx_export_kwargs</span><span class="p">(),</span> <span class="o">**</span><span class="n">export_kwargs</span><span class="p">}</span>
</span><span data-line="858">        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_dummy_batch</span><span class="p">(</span><span class="o">**</span><span class="n">batch_kwargs</span><span class="p">)</span>
</span><span data-line="859">
</span><span data-line="860">        <span class="n">core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span data-line="861">
</span><span data-line="862">        <span class="c1"># Prepare inputs and get spec (allows for dynamic modification)</span>
</span><span data-line="863">        <span class="n">all_inputs</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_onnx_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">**</span><span class="n">export_kwargs</span><span class="p">)</span>
</span><span data-line="864">
</span><span data-line="865">        <span class="c1"># Create wrapper</span>
</span><span data-line="866">        <span class="n">wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_onnx_wrapper</span><span class="p">(</span><span class="n">core</span><span class="p">)</span>
</span><span data-line="867">
</span><span data-line="868">        <span class="c1"># Export</span>
</span><span data-line="869">        <span class="bp">self</span><span class="o">.</span><span class="n">_run_torch_onnx_export</span><span class="p">(</span>
</span><span data-line="870">            <span class="n">wrapper</span><span class="p">,</span>
</span><span data-line="871">            <span class="n">all_inputs</span><span class="p">,</span>
</span><span data-line="872">            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;input_names&quot;</span><span class="p">],</span>
</span><span data-line="873">            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;output_names&quot;</span><span class="p">],</span>
</span><span data-line="874">            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;dynamic_axes&quot;</span><span class="p">],</span>
</span><span data-line="875">            <span class="n">onnx_path</span><span class="p">,</span>
</span><span data-line="876">            <span class="n">opset</span><span class="p">,</span>
</span><span data-line="877">        <span class="p">)</span>
</span><span data-line="878">
</span><span data-line="879">        <span class="c1"># Quantize if requested</span>
</span><span data-line="880">        <span class="n">q_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_quantize_onnx</span><span class="p">(</span><span class="n">onnx_path</span><span class="p">,</span> <span class="n">save_dir</span> <span class="o">/</span> <span class="n">quantized_filename</span><span class="p">,</span> <span class="n">quantize</span><span class="p">)</span>
</span><span data-line="881">
</span><span data-line="882">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="883">            <span class="s2">&quot;onnx_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">onnx_path</span><span class="p">),</span>
</span><span data-line="884">            <span class="s2">&quot;quantized_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">q_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">q_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="885">        <span class="p">}</span></div>

</span><span data-line="886">
</span><span data-line="887">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_data_collator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="888"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="889"><span class="sd">        Create data collator. Override in child classes if needed.</span>
</span><span data-line="890">
</span><span data-line="891"><span class="sd">        Returns:</span>
</span><span data-line="892"><span class="sd">            Data collator instance</span>
</span><span data-line="893"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="894">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">data_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="p">,</span> <span class="n">prepare_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="895">
</span><span data-line="896">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_freezable_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="897"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="898"><span class="sd">        Get dictionary mapping component names to their actual modules.</span>
</span><span data-line="899">
</span><span data-line="900"><span class="sd">        Returns:</span>
</span><span data-line="901"><span class="sd">            dict: Mapping of component names to module objects</span>
</span><span data-line="902"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="903">        <span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="904">
</span><span data-line="905">        <span class="c1"># Text encoder (always present)</span>
</span><span data-line="906">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="907">            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>
</span><span data-line="908">            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;token_rep_layer&quot;</span><span class="p">)</span>
</span><span data-line="909">            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">token_rep_layer</span><span class="p">,</span> <span class="s2">&quot;bert_layer&quot;</span><span class="p">)</span>
</span><span data-line="910">        <span class="p">):</span>
</span><span data-line="911">            <span class="n">components</span><span class="p">[</span><span class="s2">&quot;text_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">token_rep_layer</span><span class="o">.</span><span class="n">bert_layer</span><span class="o">.</span><span class="n">model</span>
</span><span data-line="912">
</span><span data-line="913">        <span class="c1"># Labels encoder (optional)</span>
</span><span data-line="914">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="915">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">labels_encoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="916">            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;token_rep_layer&quot;</span><span class="p">)</span>
</span><span data-line="917">            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">token_rep_layer</span><span class="p">,</span> <span class="s2">&quot;labels_encoder&quot;</span><span class="p">)</span>
</span><span data-line="918">        <span class="p">):</span>
</span><span data-line="919">            <span class="n">components</span><span class="p">[</span><span class="s2">&quot;labels_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">token_rep_layer</span><span class="o">.</span><span class="n">labels_encoder</span><span class="o">.</span><span class="n">model</span>
</span><span data-line="920">
</span><span data-line="921">        <span class="c1"># Decoder (optional)</span>
</span><span data-line="922">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="923">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">labels_decoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="924">            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;decoder&quot;</span><span class="p">)</span>
</span><span data-line="925">            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="p">,</span> <span class="s2">&quot;decoder_layer&quot;</span><span class="p">)</span>
</span><span data-line="926">        <span class="p">):</span>
</span><span data-line="927">            <span class="n">components</span><span class="p">[</span><span class="s2">&quot;decoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">decoder_layer</span><span class="o">.</span><span class="n">model</span>
</span><span data-line="928">
</span><span data-line="929">        <span class="k">return</span> <span class="n">components</span>
</span><span data-line="930">
<div class="viewcode-block" id="BaseGLiNER.freeze_component">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.freeze_component">[docs]</a>
</span><span data-line="931">    <span class="k">def</span><span class="w"> </span><span class="nf">freeze_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="932"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="933"><span class="sd">        Freeze a specific component of the model.</span>
</span><span data-line="934">
</span><span data-line="935"><span class="sd">        Args:</span>
</span><span data-line="936"><span class="sd">            component_name: Name of component to freeze (e.g., &#39;text_encoder&#39;, &#39;labels_encoder&#39;, &#39;decoder&#39;)</span>
</span><span data-line="937"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="938">        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_freezable_components</span><span class="p">()</span>
</span><span data-line="939">        <span class="k">if</span> <span class="n">component_name</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
</span><span data-line="940">            <span class="n">components</span><span class="p">[</span><span class="n">component_name</span><span class="p">]</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="941">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Frozen: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">component_name</span><span class="p">)</span>
</span><span data-line="942">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="943">            <span class="n">available</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span data-line="944">            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component &#39;</span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&#39; not found. Available components: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

</span><span data-line="945">
<div class="viewcode-block" id="BaseGLiNER.unfreeze_component">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.unfreeze_component">[docs]</a>
</span><span data-line="946">    <span class="k">def</span><span class="w"> </span><span class="nf">unfreeze_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="947"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="948"><span class="sd">        Unfreeze a specific component of the model.</span>
</span><span data-line="949">
</span><span data-line="950"><span class="sd">        Args:</span>
</span><span data-line="951"><span class="sd">            component_name: Name of component to unfreeze</span>
</span><span data-line="952"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="953">        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_freezable_components</span><span class="p">()</span>
</span><span data-line="954">        <span class="k">if</span> <span class="n">component_name</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
</span><span data-line="955">            <span class="n">components</span><span class="p">[</span><span class="n">component_name</span><span class="p">]</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="956">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unfrozen: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">component_name</span><span class="p">)</span>
</span><span data-line="957">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="958">            <span class="n">available</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span data-line="959">            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component &#39;</span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&#39; not found. Available components: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

</span><span data-line="960">
<div class="viewcode-block" id="BaseGLiNER.create_training_args">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.create_training_args">[docs]</a>
</span><span data-line="961">    <span class="nd">@classmethod</span>
</span><span data-line="962">    <span class="k">def</span><span class="w"> </span><span class="nf">create_training_args</span><span class="p">(</span>
</span><span data-line="963">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="964">        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
</span><span data-line="965">        <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e-5</span><span class="p">,</span>
</span><span data-line="966">        <span class="n">weight_decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span data-line="967">        <span class="n">others_lr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="968">        <span class="n">others_weight_decay</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="969">        <span class="n">focal_loss_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span data-line="970">        <span class="n">focal_loss_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span data-line="971">        <span class="n">focal_loss_prob_margin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span data-line="972">        <span class="n">loss_reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
</span><span data-line="973">        <span class="n">negatives</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span data-line="974">        <span class="n">masking</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span data-line="975">        <span class="n">lr_scheduler_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
</span><span data-line="976">        <span class="n">warmup_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span data-line="977">        <span class="n">per_device_train_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span data-line="978">        <span class="n">per_device_eval_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span data-line="979">        <span class="n">max_grad_norm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span data-line="980">        <span class="n">max_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
</span><span data-line="981">        <span class="n">save_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span data-line="982">        <span class="n">save_total_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span data-line="983">        <span class="n">logging_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span data-line="984">        <span class="n">use_cpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="985">        <span class="n">bf16</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="986">        <span class="n">dataloader_num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span data-line="987">        <span class="n">report_to</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span data-line="988">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="989">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrainingArguments</span><span class="p">:</span>
</span><span data-line="990"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create training arguments with sensible defaults.</span>
</span><span data-line="991">
</span><span data-line="992"><span class="sd">        Args:</span>
</span><span data-line="993"><span class="sd">            output_dir: Directory to save model checkpoints.</span>
</span><span data-line="994"><span class="sd">            learning_rate: Learning rate for main parameters.</span>
</span><span data-line="995"><span class="sd">            weight_decay: Weight decay for main parameters.</span>
</span><span data-line="996"><span class="sd">            others_lr: Learning rate for other parameters.</span>
</span><span data-line="997"><span class="sd">            others_weight_decay: Weight decay for other parameters.</span>
</span><span data-line="998"><span class="sd">            focal_loss_alpha: Alpha for focal loss.</span>
</span><span data-line="999"><span class="sd">            focal_loss_gamma: Gamma for focal loss.</span>
</span><span data-line="1000"><span class="sd">            focal_loss_prob_margin: Probability margin for focal loss.</span>
</span><span data-line="1001"><span class="sd">            loss_reduction: Loss reduction method.</span>
</span><span data-line="1002"><span class="sd">            negatives: Negative sampling ratio.</span>
</span><span data-line="1003"><span class="sd">            masking: Masking strategy.</span>
</span><span data-line="1004"><span class="sd">            lr_scheduler_type: Learning rate scheduler type.</span>
</span><span data-line="1005"><span class="sd">            warmup_ratio: Warmup ratio.</span>
</span><span data-line="1006"><span class="sd">            per_device_train_batch_size: Training batch size.</span>
</span><span data-line="1007"><span class="sd">            per_device_eval_batch_size: Evaluation batch size.</span>
</span><span data-line="1008"><span class="sd">            max_grad_norm: Maximum gradient norm.</span>
</span><span data-line="1009"><span class="sd">            max_steps: Maximum training steps.</span>
</span><span data-line="1010"><span class="sd">            save_steps: Save checkpoint every N steps.</span>
</span><span data-line="1011"><span class="sd">            save_total_limit: Maximum number of checkpoints to keep.</span>
</span><span data-line="1012"><span class="sd">            logging_steps: Log every N steps.</span>
</span><span data-line="1013"><span class="sd">            use_cpu: Whether to use CPU.</span>
</span><span data-line="1014"><span class="sd">            bf16: Whether to use bfloat16.</span>
</span><span data-line="1015"><span class="sd">            dataloader_num_workers: Number of dataloader workers.</span>
</span><span data-line="1016"><span class="sd">            report_to: Where to report metrics.</span>
</span><span data-line="1017"><span class="sd">            **kwargs: Additional training arguments.</span>
</span><span data-line="1018">
</span><span data-line="1019"><span class="sd">        Returns:</span>
</span><span data-line="1020"><span class="sd">            TrainingArguments instance.</span>
</span><span data-line="1021"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1022">        <span class="k">return</span> <span class="n">TrainingArguments</span><span class="p">(</span>
</span><span data-line="1023">            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
</span><span data-line="1024">            <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
</span><span data-line="1025">            <span class="n">weight_decay</span><span class="o">=</span><span class="n">weight_decay</span><span class="p">,</span>
</span><span data-line="1026">            <span class="n">others_lr</span><span class="o">=</span><span class="n">others_lr</span> <span class="ow">or</span> <span class="n">learning_rate</span><span class="p">,</span>
</span><span data-line="1027">            <span class="n">others_weight_decay</span><span class="o">=</span><span class="n">others_weight_decay</span> <span class="ow">or</span> <span class="n">weight_decay</span><span class="p">,</span>
</span><span data-line="1028">            <span class="n">focal_loss_gamma</span><span class="o">=</span><span class="n">focal_loss_gamma</span><span class="p">,</span>
</span><span data-line="1029">            <span class="n">focal_loss_alpha</span><span class="o">=</span><span class="n">focal_loss_alpha</span><span class="p">,</span>
</span><span data-line="1030">            <span class="n">focal_loss_prob_margin</span><span class="o">=</span><span class="n">focal_loss_prob_margin</span><span class="p">,</span>
</span><span data-line="1031">            <span class="n">loss_reduction</span><span class="o">=</span><span class="n">loss_reduction</span><span class="p">,</span>
</span><span data-line="1032">            <span class="n">negatives</span><span class="o">=</span><span class="n">negatives</span><span class="p">,</span>
</span><span data-line="1033">            <span class="n">masking</span><span class="o">=</span><span class="n">masking</span><span class="p">,</span>
</span><span data-line="1034">            <span class="n">lr_scheduler_type</span><span class="o">=</span><span class="n">lr_scheduler_type</span><span class="p">,</span>
</span><span data-line="1035">            <span class="n">warmup_ratio</span><span class="o">=</span><span class="n">warmup_ratio</span><span class="p">,</span>
</span><span data-line="1036">            <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="n">per_device_train_batch_size</span><span class="p">,</span>
</span><span data-line="1037">            <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="n">per_device_eval_batch_size</span><span class="p">,</span>
</span><span data-line="1038">            <span class="n">max_grad_norm</span><span class="o">=</span><span class="n">max_grad_norm</span><span class="p">,</span>
</span><span data-line="1039">            <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span>
</span><span data-line="1040">            <span class="n">save_steps</span><span class="o">=</span><span class="n">save_steps</span><span class="p">,</span>
</span><span data-line="1041">            <span class="n">save_total_limit</span><span class="o">=</span><span class="n">save_total_limit</span><span class="p">,</span>
</span><span data-line="1042">            <span class="n">dataloader_num_workers</span><span class="o">=</span><span class="n">dataloader_num_workers</span><span class="p">,</span>
</span><span data-line="1043">            <span class="n">logging_steps</span><span class="o">=</span><span class="n">logging_steps</span><span class="p">,</span>
</span><span data-line="1044">            <span class="n">use_cpu</span><span class="o">=</span><span class="n">use_cpu</span><span class="p">,</span>
</span><span data-line="1045">            <span class="n">report_to</span><span class="o">=</span><span class="n">report_to</span><span class="p">,</span>
</span><span data-line="1046">            <span class="n">bf16</span><span class="o">=</span><span class="n">bf16</span><span class="p">,</span>
</span><span data-line="1047">            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="1048">        <span class="p">)</span></div>

</span><span data-line="1049">
<div class="viewcode-block" id="BaseGLiNER.train_model">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseGLiNER.train_model">[docs]</a>
</span><span data-line="1050">    <span class="k">def</span><span class="w"> </span><span class="nf">train_model</span><span class="p">(</span>
</span><span data-line="1051">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1052">        <span class="n">train_dataset</span><span class="p">,</span>
</span><span data-line="1053">        <span class="n">eval_dataset</span><span class="p">,</span>
</span><span data-line="1054">        <span class="n">training_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TrainingArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1055">        <span class="n">freeze_components</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1056">        <span class="n">compile_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1057">        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1058">        <span class="o">**</span><span class="n">training_kwargs</span><span class="p">,</span>
</span><span data-line="1059">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Trainer</span><span class="p">:</span>
</span><span data-line="1060"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Train the model.</span>
</span><span data-line="1061">
</span><span data-line="1062"><span class="sd">        Args:</span>
</span><span data-line="1063"><span class="sd">            train_dataset: Training dataset.</span>
</span><span data-line="1064"><span class="sd">            eval_dataset: Evaluation dataset.</span>
</span><span data-line="1065"><span class="sd">            training_args: Training arguments (created with defaults if None).</span>
</span><span data-line="1066"><span class="sd">            freeze_components: List of component names to freeze (e.g., [&#39;text_encoder&#39;, &#39;decoder&#39;]).</span>
</span><span data-line="1067"><span class="sd">            compile_model: Whether to compile model with torch.compile.</span>
</span><span data-line="1068"><span class="sd">            output_dir: Output directory (required if training_args is None).</span>
</span><span data-line="1069"><span class="sd">            **training_kwargs: Additional kwargs for creating training args.</span>
</span><span data-line="1070">
</span><span data-line="1071"><span class="sd">        Returns:</span>
</span><span data-line="1072"><span class="sd">            Trained Trainer instance.</span>
</span><span data-line="1073"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1074">        <span class="c1"># Create training arguments if not provided</span>
</span><span data-line="1075">        <span class="k">if</span> <span class="n">training_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1076">            <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1077">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either training_args or output_dir must be provided&quot;</span><span class="p">)</span>
</span><span data-line="1078">            <span class="n">training_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_training_args</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">training_kwargs</span><span class="p">)</span>
</span><span data-line="1079">
</span><span data-line="1080">        <span class="c1"># Compile model if requested</span>
</span><span data-line="1081">        <span class="k">if</span> <span class="n">compile_model</span><span class="p">:</span>
</span><span data-line="1082">            <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span><span data-line="1083">
</span><span data-line="1084">        <span class="c1"># Freeze components if specified</span>
</span><span data-line="1085">        <span class="k">if</span> <span class="n">freeze_components</span><span class="p">:</span>
</span><span data-line="1086">            <span class="k">for</span> <span class="n">component_name</span> <span class="ow">in</span> <span class="n">freeze_components</span><span class="p">:</span>
</span><span data-line="1087">                <span class="bp">self</span><span class="o">.</span><span class="n">freeze_component</span><span class="p">(</span><span class="n">component_name</span><span class="p">)</span>
</span><span data-line="1088">
</span><span data-line="1089">        <span class="c1"># Create data collator</span>
</span><span data-line="1090">        <span class="n">data_collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_data_collator</span><span class="p">()</span>
</span><span data-line="1091">
</span><span data-line="1092">        <span class="c1"># Create trainer</span>
</span><span data-line="1093">        <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
</span><span data-line="1094">            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span data-line="1095">            <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
</span><span data-line="1096">            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
</span><span data-line="1097">            <span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">,</span>
</span><span data-line="1098">            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">,</span>
</span><span data-line="1099">            <span class="n">data_collator</span><span class="o">=</span><span class="n">data_collator</span><span class="p">,</span>
</span><span data-line="1100">        <span class="p">)</span>
</span><span data-line="1101">
</span><span data-line="1102">        <span class="c1"># Train</span>
</span><span data-line="1103">        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span data-line="1104">
</span><span data-line="1105">        <span class="k">return</span> <span class="n">trainer</span></div>
</div>

</span><span data-line="1106">
</span><span data-line="1107">
<div class="viewcode-block" id="BaseEncoderGLiNER">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseEncoderGLiNER">[docs]</a>
</span><span data-line="1108"><span class="k">class</span><span class="w"> </span><span class="nc">BaseEncoderGLiNER</span><span class="p">(</span><span class="n">BaseGLiNER</span><span class="p">):</span>
</span><span data-line="1109">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">backbone_from_pretrained</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="1110">        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">backbone_from_pretrained</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="1111">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</span><span data-line="1112">
</span><span data-line="1113">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_data_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">words_splitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="1114">        <span class="k">if</span> <span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1115">            <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
</span><span data-line="1116">        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor_class</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">)</span>
</span><span data-line="1117">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span>
</span><span data-line="1118">
<div class="viewcode-block" id="BaseEncoderGLiNER.set_class_indices">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseEncoderGLiNER.set_class_indices">[docs]</a>
</span><span data-line="1119">    <span class="k">def</span><span class="w"> </span><span class="nf">set_class_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1120"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the class token index in the configuration based on tokenizer vocabulary.&quot;&quot;&quot;</span>
</span><span data-line="1121">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">class_token_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span></div>

</span><span data-line="1122">
<div class="viewcode-block" id="BaseEncoderGLiNER.resize_embeddings">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseEncoderGLiNER.resize_embeddings">[docs]</a>
</span><span data-line="1123">    <span class="k">def</span><span class="w"> </span><span class="nf">resize_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_class_token_index</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span data-line="1124"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resize token embeddings to match tokenizer vocabulary size.</span>
</span><span data-line="1125">
</span><span data-line="1126"><span class="sd">        Args:</span>
</span><span data-line="1127"><span class="sd">            set_class_token_index: Whether to update the class token index.</span>
</span><span data-line="1128"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1129">        <span class="k">if</span> <span class="n">set_class_token_index</span><span class="p">:</span>
</span><span data-line="1130">            <span class="bp">self</span><span class="o">.</span><span class="n">set_class_indices</span><span class="p">()</span>
</span><span data-line="1131">
</span><span data-line="1132">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">:</span>
</span><span data-line="1133">            <span class="n">new_num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">)</span>
</span><span data-line="1134">            <span class="n">model_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">token_rep_layer</span><span class="o">.</span><span class="n">resize_token_embeddings</span><span class="p">(</span><span class="n">new_num_tokens</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1135">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">model_embeds</span><span class="o">.</span><span class="n">num_embeddings</span>
</span><span data-line="1136">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;encoder_config&quot;</span><span class="p">):</span>
</span><span data-line="1137">                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">encoder_config</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">model_embeds</span><span class="o">.</span><span class="n">num_embeddings</span></div>

</span><span data-line="1138">
<div class="viewcode-block" id="BaseEncoderGLiNER.prepare_inputs">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseEncoderGLiNER.prepare_inputs">[docs]</a>
</span><span data-line="1139">    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
</span><span data-line="1140"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare inputs for the model by tokenizing and creating index mappings.</span>
</span><span data-line="1141">
</span><span data-line="1142"><span class="sd">        Args:</span>
</span><span data-line="1143"><span class="sd">            texts: The input texts to process.</span>
</span><span data-line="1144">
</span><span data-line="1145"><span class="sd">        Returns:</span>
</span><span data-line="1146"><span class="sd">            Tuple containing:</span>
</span><span data-line="1147"><span class="sd">                - all_tokens: List of tokenized texts</span>
</span><span data-line="1148"><span class="sd">                - all_start_token_idx_to_text_idx: Start position mappings</span>
</span><span data-line="1149"><span class="sd">                - all_end_token_idx_to_text_idx: End position mappings</span>
</span><span data-line="1150"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1151">        <span class="n">all_tokens</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1152">        <span class="n">all_start_token_idx_to_text_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1153">        <span class="n">all_end_token_idx_to_text_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1154">
</span><span data-line="1155">        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
</span><span data-line="1156">            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1157">            <span class="n">start_token_idx_to_text_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1158">            <span class="n">end_token_idx_to_text_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1159">            <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">words_splitter</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span><span data-line="1160">                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span data-line="1161">                <span class="n">start_token_idx_to_text_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
</span><span data-line="1162">                <span class="n">end_token_idx_to_text_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
</span><span data-line="1163">            <span class="n">all_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span data-line="1164">            <span class="n">all_start_token_idx_to_text_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_token_idx_to_text_idx</span><span class="p">)</span>
</span><span data-line="1165">            <span class="n">all_end_token_idx_to_text_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_token_idx_to_text_idx</span><span class="p">)</span>
</span><span data-line="1166">        <span class="k">return</span> <span class="n">all_tokens</span><span class="p">,</span> <span class="n">all_start_token_idx_to_text_idx</span><span class="p">,</span> <span class="n">all_end_token_idx_to_text_idx</span></div>

</span><span data-line="1167">
<div class="viewcode-block" id="BaseEncoderGLiNER.prepare_base_input">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseEncoderGLiNER.prepare_base_input">[docs]</a>
</span><span data-line="1168">    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_base_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="1169"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare base input format for data collation.</span>
</span><span data-line="1170">
</span><span data-line="1171"><span class="sd">        Args:</span>
</span><span data-line="1172"><span class="sd">            all_tokens: List of tokenized texts.</span>
</span><span data-line="1173">
</span><span data-line="1174"><span class="sd">        Returns:</span>
</span><span data-line="1175"><span class="sd">            List of input dictionaries ready for collation.</span>
</span><span data-line="1176"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1177">        <span class="n">input_x</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;tokenized_text&quot;</span><span class="p">:</span> <span class="n">tk</span><span class="p">,</span> <span class="s2">&quot;ner&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span> <span class="k">for</span> <span class="n">tk</span> <span class="ow">in</span> <span class="n">all_tokens</span><span class="p">]</span>
</span><span data-line="1178">        <span class="k">return</span> <span class="n">input_x</span></div>

</span><span data-line="1179">
</span><span data-line="1180">    <span class="k">def</span><span class="w"> </span><span class="nf">_process_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">flat_ner</span><span class="p">,</span> <span class="n">multi_label</span><span class="p">,</span> <span class="n">packing_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">external_inputs</span><span class="p">):</span>
</span><span data-line="1181"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shared batch processing logic.&quot;&quot;&quot;</span>
</span><span data-line="1182">        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1183">        <span class="n">is_onnx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_model</span>
</span><span data-line="1184">        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span data-line="1185">
</span><span data-line="1186">        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
</span><span data-line="1187">            <span class="c1"># Move to device once (outside condition)</span>
</span><span data-line="1188">            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_onnx</span><span class="p">:</span>
</span><span data-line="1189">                <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span data-line="1190">
</span><span data-line="1191">            <span class="c1"># Prepare model inputs</span>
</span><span data-line="1192">            <span class="n">model_inputs</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1193">                <span class="n">batch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="1194">                <span class="k">if</span> <span class="n">packing_config</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1195">                <span class="k">else</span> <span class="p">{</span><span class="o">**</span><span class="n">batch</span><span class="p">,</span> <span class="o">**</span><span class="n">external_inputs</span><span class="p">,</span> <span class="s2">&quot;packing_config&quot;</span><span class="p">:</span> <span class="n">packing_config</span><span class="p">}</span>
</span><span data-line="1196">            <span class="p">)</span>
</span><span data-line="1197">
</span><span data-line="1198">            <span class="c1"># Get predictions</span>
</span><span data-line="1199">            <span class="n">model_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1200">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_logits</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="1201">                <span class="n">model_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">model_logits</span><span class="p">)</span>
</span><span data-line="1202">
</span><span data-line="1203">            <span class="c1"># Decode</span>
</span><span data-line="1204">            <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span data-line="1205">                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">],</span>
</span><span data-line="1206">                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;id_to_classes&quot;</span><span class="p">],</span>
</span><span data-line="1207">                <span class="n">model_logits</span><span class="p">,</span>
</span><span data-line="1208">                <span class="n">flat_ner</span><span class="o">=</span><span class="n">flat_ner</span><span class="p">,</span>
</span><span data-line="1209">                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
</span><span data-line="1210">                <span class="n">multi_label</span><span class="o">=</span><span class="n">multi_label</span><span class="p">,</span>
</span><span data-line="1211">            <span class="p">)</span>
</span><span data-line="1212">            <span class="n">outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
</span><span data-line="1213">
</span><span data-line="1214">        <span class="k">return</span> <span class="n">outputs</span>
</span><span data-line="1215">
<div class="viewcode-block" id="BaseEncoderGLiNER.inference">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseEncoderGLiNER.inference">[docs]</a>
</span><span data-line="1216">    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span data-line="1217">    <span class="k">def</span><span class="w"> </span><span class="nf">inference</span><span class="p">(</span>
</span><span data-line="1218">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1219">        <span class="n">texts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span data-line="1220">        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="1221">        <span class="n">flat_ner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1222">        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span data-line="1223">        <span class="n">multi_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1224">        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span data-line="1225">        <span class="n">packing_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InferencePackingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1226">        <span class="o">**</span><span class="n">external_inputs</span><span class="p">,</span>
</span><span data-line="1227">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
</span><span data-line="1228"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict entities for a batch of texts.</span>
</span><span data-line="1229">
</span><span data-line="1230"><span class="sd">        Args:</span>
</span><span data-line="1231"><span class="sd">            texts: A list of input texts to predict entities for or a single text string.</span>
</span><span data-line="1232"><span class="sd">            labels: A list of labels to predict.</span>
</span><span data-line="1233"><span class="sd">            flat_ner: Whether to use flat NER. Defaults to True.</span>
</span><span data-line="1234"><span class="sd">            threshold: Confidence threshold for predictions. Defaults to 0.5.</span>
</span><span data-line="1235"><span class="sd">            multi_label: Whether to allow multiple labels per token. Defaults to False.</span>
</span><span data-line="1236"><span class="sd">            batch_size: Batch size for processing. Defaults to 8.</span>
</span><span data-line="1237"><span class="sd">            packing_config: Configuration describing how to pack encoder inputs. When None</span>
</span><span data-line="1238"><span class="sd">                the instance-level configuration set via configure_inference_packing is used.</span>
</span><span data-line="1239"><span class="sd">            **external_inputs: Additional inputs to pass to the model.</span>
</span><span data-line="1240">
</span><span data-line="1241"><span class="sd">        Returns:</span>
</span><span data-line="1242"><span class="sd">            List of lists with predicted entities, where each entity is a dictionary containing:</span>
</span><span data-line="1243"><span class="sd">                - start: Start character position</span>
</span><span data-line="1244"><span class="sd">                - end: End character position</span>
</span><span data-line="1245"><span class="sd">                - text: Entity text</span>
</span><span data-line="1246"><span class="sd">                - label: Entity type</span>
</span><span data-line="1247"><span class="sd">                - score: Confidence score</span>
</span><span data-line="1248"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1249">        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span data-line="1250">        <span class="c1"># raw input preparation</span>
</span><span data-line="1251">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="1252">            <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">texts</span><span class="p">]</span>
</span><span data-line="1253">
</span><span data-line="1254">        <span class="n">entity_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
</span><span data-line="1255">
</span><span data-line="1256">        <span class="n">tokens</span><span class="p">,</span> <span class="n">all_start_token_idx_to_text_idx</span><span class="p">,</span> <span class="n">all_end_token_idx_to_text_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_inputs</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span><span data-line="1257">
</span><span data-line="1258">        <span class="n">input_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_base_input</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span data-line="1259">
</span><span data-line="1260">        <span class="n">collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator_class</span><span class="p">(</span>
</span><span data-line="1261">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span data-line="1262">            <span class="n">data_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="p">,</span>
</span><span data-line="1263">            <span class="n">return_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1264">            <span class="n">return_entities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1265">            <span class="n">return_id_to_classes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1266">            <span class="n">prepare_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1267">        <span class="p">)</span>
</span><span data-line="1268">
</span><span data-line="1269">        <span class="k">def</span><span class="w"> </span><span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">entity_types</span><span class="o">=</span><span class="n">entity_types</span><span class="p">):</span>
</span><span data-line="1270">            <span class="n">batch_out</span> <span class="o">=</span> <span class="n">collator</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">entity_types</span><span class="o">=</span><span class="n">entity_types</span><span class="p">)</span>
</span><span data-line="1271">            <span class="k">return</span> <span class="n">batch_out</span>
</span><span data-line="1272">
</span><span data-line="1273">        <span class="n">data_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">input_x</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">)</span>
</span><span data-line="1274">
</span><span data-line="1275">        <span class="n">active_packing</span> <span class="o">=</span> <span class="n">packing_config</span> <span class="k">if</span> <span class="n">packing_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inference_packing_config</span>
</span><span data-line="1276">        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_batches</span><span class="p">(</span>
</span><span data-line="1277">            <span class="n">data_loader</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">flat_ner</span><span class="p">,</span> <span class="n">multi_label</span><span class="p">,</span> <span class="n">packing_config</span><span class="o">=</span><span class="n">active_packing</span><span class="p">,</span> <span class="o">**</span><span class="n">external_inputs</span>
</span><span data-line="1278">        <span class="p">)</span>
</span><span data-line="1279">
</span><span data-line="1280">        <span class="n">all_entities</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1281">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
</span><span data-line="1282">            <span class="n">start_token_idx_to_text_idx</span> <span class="o">=</span> <span class="n">all_start_token_idx_to_text_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="1283">            <span class="n">end_token_idx_to_text_idx</span> <span class="o">=</span> <span class="n">all_end_token_idx_to_text_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="1284">            <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1285">            <span class="k">for</span> <span class="n">start_token_idx</span><span class="p">,</span> <span class="n">end_token_idx</span><span class="p">,</span> <span class="n">ent_type</span><span class="p">,</span> <span class="n">ent_score</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
</span><span data-line="1286">                <span class="n">start_text_idx</span> <span class="o">=</span> <span class="n">start_token_idx_to_text_idx</span><span class="p">[</span><span class="n">start_token_idx</span><span class="p">]</span>
</span><span data-line="1287">                <span class="n">end_text_idx</span> <span class="o">=</span> <span class="n">end_token_idx_to_text_idx</span><span class="p">[</span><span class="n">end_token_idx</span><span class="p">]</span>
</span><span data-line="1288">                <span class="n">ent_details</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="1289">                    <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start_token_idx_to_text_idx</span><span class="p">[</span><span class="n">start_token_idx</span><span class="p">],</span>
</span><span data-line="1290">                    <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end_token_idx_to_text_idx</span><span class="p">[</span><span class="n">end_token_idx</span><span class="p">],</span>
</span><span data-line="1291">                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">start_text_idx</span><span class="p">:</span><span class="n">end_text_idx</span><span class="p">],</span>
</span><span data-line="1292">                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">ent_type</span><span class="p">,</span>
</span><span data-line="1293">                    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">ent_score</span><span class="p">,</span>
</span><span data-line="1294">                <span class="p">}</span>
</span><span data-line="1295">                <span class="n">entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ent_details</span><span class="p">)</span>
</span><span data-line="1296">
</span><span data-line="1297">            <span class="n">all_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
</span><span data-line="1298">
</span><span data-line="1299">        <span class="k">return</span> <span class="n">all_entities</span></div>

</span><span data-line="1300">
<div class="viewcode-block" id="BaseEncoderGLiNER.predict_entities">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseEncoderGLiNER.predict_entities">[docs]</a>
</span><span data-line="1301">    <span class="k">def</span><span class="w"> </span><span class="nf">predict_entities</span><span class="p">(</span>
</span><span data-line="1302">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1303">        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="1304">        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="1305">        <span class="n">flat_ner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1306">        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span data-line="1307">        <span class="n">multi_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1308">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="1309">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="1310"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict entities for a single text input.</span>
</span><span data-line="1311">
</span><span data-line="1312"><span class="sd">        Args:</span>
</span><span data-line="1313"><span class="sd">            text: The input text to predict entities for.</span>
</span><span data-line="1314"><span class="sd">            labels: The labels to predict.</span>
</span><span data-line="1315"><span class="sd">            flat_ner: Whether to use flat NER. Defaults to True.</span>
</span><span data-line="1316"><span class="sd">            threshold: Confidence threshold for predictions. Defaults to 0.5.</span>
</span><span data-line="1317"><span class="sd">            multi_label: Whether to allow multiple labels per entity. Defaults to False.</span>
</span><span data-line="1318"><span class="sd">            **kwargs: Additional arguments passed to inference.</span>
</span><span data-line="1319">
</span><span data-line="1320"><span class="sd">        Returns:</span>
</span><span data-line="1321"><span class="sd">            List of entity predictions as dictionaries.</span>
</span><span data-line="1322"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1323">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
</span><span data-line="1324">            <span class="p">[</span><span class="n">text</span><span class="p">],</span> <span class="n">labels</span><span class="p">,</span> <span class="n">flat_ner</span><span class="o">=</span><span class="n">flat_ner</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">multi_label</span><span class="o">=</span><span class="n">multi_label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="1325">        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

</span><span data-line="1326">
<div class="viewcode-block" id="BaseEncoderGLiNER.batch_predict_entities">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseEncoderGLiNER.batch_predict_entities">[docs]</a>
</span><span data-line="1327">    <span class="k">def</span><span class="w"> </span><span class="nf">batch_predict_entities</span><span class="p">(</span>
</span><span data-line="1328">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1329">        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="1330">        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="1331">        <span class="n">flat_ner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1332">        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span data-line="1333">        <span class="n">multi_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1334">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="1335">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
</span><span data-line="1336"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict entities for multiple texts.</span>
</span><span data-line="1337">
</span><span data-line="1338"><span class="sd">        DEPRECATED: Use `inference` instead.</span>
</span><span data-line="1339">
</span><span data-line="1340"><span class="sd">        This method will be removed in a future release. It now forwards to</span>
</span><span data-line="1341"><span class="sd">        `GLiNER.inference(...)` to perform inference.</span>
</span><span data-line="1342">
</span><span data-line="1343"><span class="sd">        Args:</span>
</span><span data-line="1344"><span class="sd">            texts: Input texts.</span>
</span><span data-line="1345"><span class="sd">            labels: Labels to predict.</span>
</span><span data-line="1346"><span class="sd">            flat_ner: Use flat NER. Defaults to True.</span>
</span><span data-line="1347"><span class="sd">            threshold: Confidence threshold. Defaults to 0.5.</span>
</span><span data-line="1348"><span class="sd">            multi_label: Allow multiple labels per token/entity. Defaults to False.</span>
</span><span data-line="1349"><span class="sd">            **kwargs: Extra arguments forwarded to inference (e.g., batch_size).</span>
</span><span data-line="1350">
</span><span data-line="1351"><span class="sd">        Returns:</span>
</span><span data-line="1352"><span class="sd">            List of entity predictions for each text.</span>
</span><span data-line="1353"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1354">        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="1355">            <span class="s2">&quot;GLiNER.batch_predict_entities is deprecated and will be removed in a future release. &quot;</span>
</span><span data-line="1356">            <span class="s2">&quot;Please use GLiNER.inference instead.&quot;</span><span class="p">,</span>
</span><span data-line="1357">            <span class="ne">FutureWarning</span><span class="p">,</span>
</span><span data-line="1358">            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span data-line="1359">        <span class="p">)</span>
</span><span data-line="1360">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
</span><span data-line="1361">            <span class="n">texts</span><span class="p">,</span>
</span><span data-line="1362">            <span class="n">labels</span><span class="p">,</span>
</span><span data-line="1363">            <span class="n">flat_ner</span><span class="o">=</span><span class="n">flat_ner</span><span class="p">,</span>
</span><span data-line="1364">            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
</span><span data-line="1365">            <span class="n">multi_label</span><span class="o">=</span><span class="n">multi_label</span><span class="p">,</span>
</span><span data-line="1366">            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="1367">        <span class="p">)</span></div>

</span><span data-line="1368">
<div class="viewcode-block" id="BaseEncoderGLiNER.evaluate">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseEncoderGLiNER.evaluate">[docs]</a>
</span><span data-line="1369">    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span>
</span><span data-line="1370">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1371">        <span class="n">test_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span data-line="1372">        <span class="n">flat_ner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1373">        <span class="n">multi_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1374">        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span data-line="1375">        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
</span><span data-line="1376">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span data-line="1377"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the model on a given test dataset.</span>
</span><span data-line="1378">
</span><span data-line="1379"><span class="sd">        Args:</span>
</span><span data-line="1380"><span class="sd">            test_data: The test data containing text and entity annotations.</span>
</span><span data-line="1381"><span class="sd">            flat_ner: Whether to use flat NER. Defaults to False.</span>
</span><span data-line="1382"><span class="sd">            multi_label: Whether to use multi-label classification. Defaults to False.</span>
</span><span data-line="1383"><span class="sd">            threshold: The threshold for predictions. Defaults to 0.5.</span>
</span><span data-line="1384"><span class="sd">            batch_size: The batch size for evaluation. Defaults to 12.</span>
</span><span data-line="1385">
</span><span data-line="1386"><span class="sd">        Returns:</span>
</span><span data-line="1387"><span class="sd">            Tuple containing the evaluation output and the F1 score.</span>
</span><span data-line="1388"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1389">        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span data-line="1390">        <span class="c1"># Create the dataset and data loader</span>
</span><span data-line="1391">        <span class="n">dataset</span> <span class="o">=</span> <span class="n">test_data</span>
</span><span data-line="1392">        <span class="n">collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator_class</span><span class="p">(</span>
</span><span data-line="1393">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span data-line="1394">            <span class="n">data_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="p">,</span>
</span><span data-line="1395">            <span class="n">return_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1396">            <span class="n">return_entities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1397">            <span class="n">return_id_to_classes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1398">            <span class="n">prepare_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1399">        <span class="p">)</span>
</span><span data-line="1400">        <span class="n">data_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collator</span><span class="p">)</span>
</span><span data-line="1401">
</span><span data-line="1402">        <span class="n">all_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_batches</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">flat_ner</span><span class="p">,</span> <span class="n">multi_label</span><span class="p">)</span>
</span><span data-line="1403">        <span class="n">all_trues</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1404">
</span><span data-line="1405">        <span class="c1"># Iterate over data batches</span>
</span><span data-line="1406">        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
</span><span data-line="1407">            <span class="n">all_trues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">])</span>
</span><span data-line="1408">
</span><span data-line="1409">        <span class="c1"># Evaluate the predictions</span>
</span><span data-line="1410">        <span class="n">evaluator</span> <span class="o">=</span> <span class="n">BaseNEREvaluator</span><span class="p">(</span><span class="n">all_trues</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">)</span>
</span><span data-line="1411">        <span class="n">out</span><span class="p">,</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
</span><span data-line="1412">
</span><span data-line="1413">        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">f1</span></div>
</div>

</span><span data-line="1414">
</span><span data-line="1415">
<div class="viewcode-block" id="BaseBiEncoderGLiNER">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseBiEncoderGLiNER">[docs]</a>
</span><span data-line="1416"><span class="k">class</span><span class="w"> </span><span class="nc">BaseBiEncoderGLiNER</span><span class="p">(</span><span class="n">BaseEncoderGLiNER</span><span class="p">):</span>
</span><span data-line="1417">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_data_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">words_splitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="1418">        <span class="n">labels_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">labels_encoder</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
</span><span data-line="1419">        <span class="k">if</span> <span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1420">            <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
</span><span data-line="1421">
</span><span data-line="1422">        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor_class</span><span class="p">(</span>
</span><span data-line="1423">            <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">,</span> <span class="n">labels_tokenizer</span><span class="o">=</span><span class="n">labels_tokenizer</span>
</span><span data-line="1424">        <span class="p">)</span>
</span><span data-line="1425">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span>
</span><span data-line="1426">
<div class="viewcode-block" id="BaseBiEncoderGLiNER.resize_embeddings">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseBiEncoderGLiNER.resize_embeddings">[docs]</a>
</span><span data-line="1427">    <span class="k">def</span><span class="w"> </span><span class="nf">resize_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="1428">        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Resizing embeddings is not supported for bi-encoder models.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

</span><span data-line="1429">
<div class="viewcode-block" id="BaseBiEncoderGLiNER.encode_labels">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseBiEncoderGLiNER.encode_labels">[docs]</a>
</span><span data-line="1430">    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span data-line="1431">    <span class="k">def</span><span class="w"> </span><span class="nf">encode_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
</span><span data-line="1432"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute embeddings for labels using the label encoder.</span>
</span><span data-line="1433">
</span><span data-line="1434"><span class="sd">        Args:</span>
</span><span data-line="1435"><span class="sd">            labels: A list of labels to encode.</span>
</span><span data-line="1436"><span class="sd">            batch_size: Batch size for processing labels.</span>
</span><span data-line="1437">
</span><span data-line="1438"><span class="sd">        Returns:</span>
</span><span data-line="1439"><span class="sd">            Tensor containing label embeddings with shape (num_labels, hidden_size).</span>
</span><span data-line="1440">
</span><span data-line="1441"><span class="sd">        Raises:</span>
</span><span data-line="1442"><span class="sd">            NotImplementedError: If the model doesn&#39;t have a label encoder.</span>
</span><span data-line="1443"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1444">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">labels_encoder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1445">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Labels pre-encoding is supported only for bi-encoder model.&quot;</span><span class="p">)</span>
</span><span data-line="1446">
</span><span data-line="1447">        <span class="c1"># Create a DataLoader for efficient batching</span>
</span><span data-line="1448">        <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
</span><span data-line="1449">
</span><span data-line="1450">        <span class="n">labels_embeddings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1451">
</span><span data-line="1452">        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Encoding labels&quot;</span><span class="p">):</span>
</span><span data-line="1453">            <span class="n">tokenized_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">labels_tokenizer</span><span class="p">(</span>
</span><span data-line="1454">                <span class="n">batch</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span>
</span><span data-line="1455">            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1456">            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>  <span class="c1"># Disable gradient calculation for inference</span>
</span><span data-line="1457">                <span class="n">curr_labels_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">token_rep_layer</span><span class="o">.</span><span class="n">encode_labels</span><span class="p">(</span><span class="o">**</span><span class="n">tokenized_labels</span><span class="p">)</span>
</span><span data-line="1458">            <span class="n">labels_embeddings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_labels_embeddings</span><span class="p">)</span>
</span><span data-line="1459">
</span><span data-line="1460">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">labels_embeddings</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

</span><span data-line="1461">
<div class="viewcode-block" id="BaseBiEncoderGLiNER.batch_predict_with_embeds">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseBiEncoderGLiNER.batch_predict_with_embeds">[docs]</a>
</span><span data-line="1462">    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span data-line="1463">    <span class="k">def</span><span class="w"> </span><span class="nf">batch_predict_with_embeds</span><span class="p">(</span>
</span><span data-line="1464">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1465">        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="1466">        <span class="n">labels_embeddings</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span data-line="1467">        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="1468">        <span class="n">flat_ner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1469">        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span data-line="1470">        <span class="n">multi_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1471">        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span data-line="1472">        <span class="n">packing_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InferencePackingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1473">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
</span><span data-line="1474"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict entities for a batch of texts using pre-computed label embeddings.</span>
</span><span data-line="1475">
</span><span data-line="1476"><span class="sd">        Args:</span>
</span><span data-line="1477"><span class="sd">            texts: A list of input texts to predict entities for.</span>
</span><span data-line="1478"><span class="sd">            labels_embeddings: Pre-computed embeddings for the labels.</span>
</span><span data-line="1479"><span class="sd">            labels: List of label strings corresponding to the embeddings.</span>
</span><span data-line="1480"><span class="sd">            flat_ner: Whether to use flat NER. Defaults to True.</span>
</span><span data-line="1481"><span class="sd">            threshold: Confidence threshold for predictions. Defaults to 0.5.</span>
</span><span data-line="1482"><span class="sd">            multi_label: Whether to allow multiple labels per token. Defaults to False.</span>
</span><span data-line="1483"><span class="sd">            batch_size: Batch size for processing. Defaults to 8.</span>
</span><span data-line="1484"><span class="sd">            packing_config: Configuration describing how to pack encoder inputs. When None</span>
</span><span data-line="1485"><span class="sd">                the instance-level configuration set via configure_inference_packing is used.</span>
</span><span data-line="1486">
</span><span data-line="1487"><span class="sd">        Returns:</span>
</span><span data-line="1488"><span class="sd">            List of lists with predicted entities.</span>
</span><span data-line="1489"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1490">        <span class="n">all_entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
</span><span data-line="1491">            <span class="n">texts</span><span class="p">,</span>
</span><span data-line="1492">            <span class="n">labels</span><span class="p">,</span>
</span><span data-line="1493">            <span class="n">flat_ner</span><span class="o">=</span><span class="n">flat_ner</span><span class="p">,</span>
</span><span data-line="1494">            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
</span><span data-line="1495">            <span class="n">multi_label</span><span class="o">=</span><span class="n">multi_label</span><span class="p">,</span>
</span><span data-line="1496">            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span data-line="1497">            <span class="n">packing_config</span><span class="o">=</span><span class="n">packing_config</span><span class="p">,</span>
</span><span data-line="1498">            <span class="n">labels_embeddings</span><span class="o">=</span><span class="n">labels_embeddings</span><span class="p">,</span>
</span><span data-line="1499">        <span class="p">)</span>
</span><span data-line="1500">
</span><span data-line="1501">        <span class="k">return</span> <span class="n">all_entities</span></div>

</span><span data-line="1502">
<div class="viewcode-block" id="BaseBiEncoderGLiNER.predict_with_embeds">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BaseBiEncoderGLiNER.predict_with_embeds">[docs]</a>
</span><span data-line="1503">    <span class="k">def</span><span class="w"> </span><span class="nf">predict_with_embeds</span><span class="p">(</span>
</span><span data-line="1504">        <span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">labels_embeddings</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">flat_ner</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">multi_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="1505">    <span class="p">):</span>
</span><span data-line="1506"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict entities for a single text input using pre-computed label embeddings.</span>
</span><span data-line="1507">
</span><span data-line="1508"><span class="sd">        Args:</span>
</span><span data-line="1509"><span class="sd">            text: The input text to predict entities for.</span>
</span><span data-line="1510"><span class="sd">            labels_embeddings: Pre-computed embeddings for the labels.</span>
</span><span data-line="1511"><span class="sd">            labels: List of label strings corresponding to the embeddings.</span>
</span><span data-line="1512"><span class="sd">            flat_ner: Whether to use flat NER. Defaults to True.</span>
</span><span data-line="1513"><span class="sd">            threshold: Confidence threshold for predictions. Defaults to 0.5.</span>
</span><span data-line="1514"><span class="sd">            multi_label: Whether to allow multiple labels per entity. Defaults to False.</span>
</span><span data-line="1515"><span class="sd">            **kwargs: Additional arguments passed to batch_predict_with_embeds.</span>
</span><span data-line="1516">
</span><span data-line="1517"><span class="sd">        Returns:</span>
</span><span data-line="1518"><span class="sd">            List of entity predictions.</span>
</span><span data-line="1519"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1520">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_predict_with_embeds</span><span class="p">(</span>
</span><span data-line="1521">            <span class="p">[</span><span class="n">text</span><span class="p">],</span> <span class="n">labels_embeddings</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">flat_ner</span><span class="o">=</span><span class="n">flat_ner</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">multi_label</span><span class="o">=</span><span class="n">multi_label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="1522">        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

</span><span data-line="1523">
</span><span data-line="1524">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_onnx_export_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1525"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide default labels for bi-encoder ONNX export.&quot;&quot;&quot;</span>
</span><span data-line="1526">        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;organization&quot;</span><span class="p">,</span> <span class="s2">&quot;person&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">]}</span>
</span><span data-line="1527">
</span><span data-line="1528">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_base_input_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="1529"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get base input names (text-related inputs).</span>
</span><span data-line="1530">
</span><span data-line="1531"><span class="sd">        Override in child classes for different architectures.</span>
</span><span data-line="1532"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1533">        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span data-line="1534">
</span><span data-line="1535">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_label_input_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="1536"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get label encoder input names.&quot;&quot;&quot;</span>
</span><span data-line="1537">        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;labels_input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;labels_attention_mask&quot;</span><span class="p">]</span>
</span><span data-line="1538">
</span><span data-line="1539">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_embedding_input_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="1540"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get name for pre-computed embeddings input.&quot;&quot;&quot;</span>
</span><span data-line="1541">        <span class="k">return</span> <span class="s2">&quot;labels_embeddings&quot;</span>
</span><span data-line="1542">
</span><span data-line="1543">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_base_dynamic_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="1544"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get base dynamic axes (text-related).</span>
</span><span data-line="1545">
</span><span data-line="1546"><span class="sd">        Override in child classes for different architectures.</span>
</span><span data-line="1547"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1548">        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span data-line="1549">
</span><span data-line="1550">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_label_dynamic_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="1551"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get label encoder dynamic axes.&quot;&quot;&quot;</span>
</span><span data-line="1552">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1553">            <span class="s2">&quot;labels_input_ids&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;num_labels&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;label_seq_length&quot;</span><span class="p">},</span>
</span><span data-line="1554">            <span class="s2">&quot;labels_attention_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;num_labels&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;label_seq_length&quot;</span><span class="p">},</span>
</span><span data-line="1555">        <span class="p">}</span>
</span><span data-line="1556">
</span><span data-line="1557">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_embedding_dynamic_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="1558"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get pre-computed embeddings dynamic axes.&quot;&quot;&quot;</span>
</span><span data-line="1559">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1560">            <span class="s2">&quot;labels_embeddings&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;num_labels&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;hidden_size&quot;</span><span class="p">},</span>
</span><span data-line="1561">        <span class="p">}</span>
</span><span data-line="1562">
</span><span data-line="1563">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_output_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1564"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get output specification.</span>
</span><span data-line="1565">
</span><span data-line="1566"><span class="sd">        Override in child classes for different output shapes.</span>
</span><span data-line="1567"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1568">        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span data-line="1569">
</span><span data-line="1570">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_onnx_input_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1571"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build full input spec with label encoder.</span>
</span><span data-line="1572">
</span><span data-line="1573"><span class="sd">        This is the default spec (without pre-computed embeddings).</span>
</span><span data-line="1574"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1575">        <span class="n">base_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_input_names</span><span class="p">()</span>
</span><span data-line="1576">        <span class="n">label_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_label_input_names</span><span class="p">()</span>
</span><span data-line="1577">
</span><span data-line="1578">        <span class="n">base_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_dynamic_axes</span><span class="p">()</span>
</span><span data-line="1579">        <span class="n">label_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_label_dynamic_axes</span><span class="p">()</span>
</span><span data-line="1580">        <span class="n">output_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_output_spec</span><span class="p">()</span>
</span><span data-line="1581">
</span><span data-line="1582">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1583">            <span class="s2">&quot;input_names&quot;</span><span class="p">:</span> <span class="n">base_names</span> <span class="o">+</span> <span class="n">label_names</span><span class="p">,</span>
</span><span data-line="1584">            <span class="s2">&quot;output_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;logits&quot;</span><span class="p">],</span>
</span><span data-line="1585">            <span class="s2">&quot;dynamic_axes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">base_axes</span><span class="p">,</span> <span class="o">**</span><span class="n">label_axes</span><span class="p">,</span> <span class="o">**</span><span class="n">output_spec</span><span class="p">},</span>
</span><span data-line="1586">        <span class="p">}</span>
</span><span data-line="1587">
</span><span data-line="1588">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_onnx_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
</span><span data-line="1589"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1590"><span class="sd">        Create flexible wrapper that handles both modes.</span>
</span><span data-line="1591">
</span><span data-line="1592"><span class="sd">        The wrapper signature adapts based on input spec.</span>
</span><span data-line="1593"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1594">        <span class="n">input_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_onnx_input_spec</span><span class="p">()[</span><span class="s2">&quot;input_names&quot;</span><span class="p">]</span>
</span><span data-line="1595">
</span><span data-line="1596">        <span class="k">class</span><span class="w"> </span><span class="nc">BiEncoderWrapper</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="1597">            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">param_names</span><span class="p">):</span>
</span><span data-line="1598">                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="1599">                <span class="bp">self</span><span class="o">.</span><span class="n">core</span> <span class="o">=</span> <span class="n">core</span>
</span><span data-line="1600">                <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">param_names</span>
</span><span data-line="1601">
</span><span data-line="1602">            <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span data-line="1603">                <span class="c1"># Build kwargs from positional args</span>
</span><span data-line="1604">                <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
</span><span data-line="1605">                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="1606">                <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">logits</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;logits&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1607">
</span><span data-line="1608">        <span class="k">return</span> <span class="n">BiEncoderWrapper</span><span class="p">(</span><span class="n">core_model</span><span class="p">,</span> <span class="n">input_names</span><span class="p">)</span>
</span><span data-line="1609">
</span><span data-line="1610">    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_onnx_batch</span><span class="p">(</span>
</span><span data-line="1611">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1612">        <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
</span><span data-line="1613">        <span class="n">from_labels_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1614">        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1615">        <span class="o">**</span><span class="n">export_kwargs</span><span class="p">,</span>
</span><span data-line="1616">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="1617"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1618"><span class="sd">        Prepare batch for bi-encoder export with optional pre-computed embeddings.</span>
</span><span data-line="1619">
</span><span data-line="1620"><span class="sd">        Args:</span>
</span><span data-line="1621"><span class="sd">            batch: Dummy batch</span>
</span><span data-line="1622"><span class="sd">            from_labels_embeddings: If True, use pre-computed embeddings mode</span>
</span><span data-line="1623"><span class="sd">            labels: Labels for embedding computation</span>
</span><span data-line="1624"><span class="sd">            **export_kwargs: Additional arguments</span>
</span><span data-line="1625">
</span><span data-line="1626"><span class="sd">        Returns:</span>
</span><span data-line="1627"><span class="sd">            Tuple of (inputs, spec)</span>
</span><span data-line="1628"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1629">        <span class="k">if</span> <span class="n">from_labels_embeddings</span><span class="p">:</span>
</span><span data-line="1630">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;encode_labels&quot;</span><span class="p">):</span>
</span><span data-line="1631">                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;from_labels_embeddings=True requires encode_labels() method&quot;</span><span class="p">)</span>
</span><span data-line="1632">
</span><span data-line="1633">            <span class="c1"># Compute embeddings</span>
</span><span data-line="1634">            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1635">                <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;organization&quot;</span><span class="p">,</span> <span class="s2">&quot;person&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">])</span>
</span><span data-line="1636">            <span class="n">labels_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span data-line="1637">
</span><span data-line="1638">            <span class="c1"># Build spec with embeddings</span>
</span><span data-line="1639">            <span class="n">base_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_input_names</span><span class="p">()</span>
</span><span data-line="1640">            <span class="n">embed_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding_input_name</span><span class="p">()</span>
</span><span data-line="1641">
</span><span data-line="1642">            <span class="n">base_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_dynamic_axes</span><span class="p">()</span>
</span><span data-line="1643">            <span class="n">embed_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding_dynamic_axes</span><span class="p">()</span>
</span><span data-line="1644">            <span class="n">output_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_output_spec</span><span class="p">()</span>
</span><span data-line="1645">
</span><span data-line="1646">            <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="1647">                <span class="s2">&quot;input_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">*</span><span class="n">base_names</span><span class="p">,</span> <span class="n">embed_name</span><span class="p">],</span>
</span><span data-line="1648">                <span class="s2">&quot;output_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;logits&quot;</span><span class="p">],</span>
</span><span data-line="1649">                <span class="s2">&quot;dynamic_axes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">base_axes</span><span class="p">,</span> <span class="o">**</span><span class="n">embed_axes</span><span class="p">,</span> <span class="o">**</span><span class="n">output_spec</span><span class="p">},</span>
</span><span data-line="1650">            <span class="p">}</span>
</span><span data-line="1651">
</span><span data-line="1652">            <span class="c1"># Build inputs</span>
</span><span data-line="1653">            <span class="n">all_inputs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">labels_embeds</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">embed_name</span> <span class="k">else</span> <span class="n">batch</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;input_names&quot;</span><span class="p">])</span>
</span><span data-line="1654">
</span><span data-line="1655">            <span class="k">return</span> <span class="n">all_inputs</span><span class="p">,</span> <span class="n">spec</span>
</span><span data-line="1656">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1657">            <span class="c1"># Use default spec (full bi-encoder)</span>
</span><span data-line="1658">            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_prepare_onnx_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">**</span><span class="n">export_kwargs</span><span class="p">)</span></div>

</span><span data-line="1659">
</span><span data-line="1660">
<div class="viewcode-block" id="UniEncoderSpanGLiNER">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderSpanGLiNER">[docs]</a>
</span><span data-line="1661"><span class="k">class</span><span class="w"> </span><span class="nc">UniEncoderSpanGLiNER</span><span class="p">(</span><span class="n">BaseEncoderGLiNER</span><span class="p">):</span>
</span><span data-line="1662">    <span class="n">config_class</span> <span class="o">=</span> <span class="n">UniEncoderSpanConfig</span>
</span><span data-line="1663">    <span class="n">model_class</span> <span class="o">=</span> <span class="n">UniEncoderSpanModel</span>
</span><span data-line="1664">    <span class="n">ort_model_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">UniEncoderSpanORTModel</span>
</span><span data-line="1665">    <span class="n">data_processor_class</span> <span class="o">=</span> <span class="n">UniEncoderSpanProcessor</span>
</span><span data-line="1666">    <span class="n">data_collator_class</span> <span class="o">=</span> <span class="n">UniEncoderSpanDataCollator</span>
</span><span data-line="1667">    <span class="n">decoder_class</span> <span class="o">=</span> <span class="n">SpanDecoder</span>
</span><span data-line="1668">
</span><span data-line="1669">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_onnx_input_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1670"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Define ONNX input specification for UniEncoderSpan model.&quot;&quot;&quot;</span>
</span><span data-line="1671">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1672">            <span class="s2">&quot;input_names&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span data-line="1673">                <span class="s2">&quot;input_ids&quot;</span><span class="p">,</span>
</span><span data-line="1674">                <span class="s2">&quot;attention_mask&quot;</span><span class="p">,</span>
</span><span data-line="1675">                <span class="s2">&quot;words_mask&quot;</span><span class="p">,</span>
</span><span data-line="1676">                <span class="s2">&quot;text_lengths&quot;</span><span class="p">,</span>
</span><span data-line="1677">                <span class="s2">&quot;span_idx&quot;</span><span class="p">,</span>
</span><span data-line="1678">                <span class="s2">&quot;span_mask&quot;</span><span class="p">,</span>
</span><span data-line="1679">            <span class="p">],</span>
</span><span data-line="1680">            <span class="s2">&quot;output_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;logits&quot;</span><span class="p">],</span>
</span><span data-line="1681">            <span class="s2">&quot;dynamic_axes&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="1682">                <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1683">                <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1684">                <span class="s2">&quot;words_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1685">                <span class="s2">&quot;text_lengths&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">},</span>
</span><span data-line="1686">                <span class="s2">&quot;span_idx&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;num_spans&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;idx&quot;</span><span class="p">},</span>
</span><span data-line="1687">                <span class="s2">&quot;span_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;num_spans&quot;</span><span class="p">},</span>
</span><span data-line="1688">                <span class="s2">&quot;logits&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="1689">                    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span>
</span><span data-line="1690">                    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">,</span>
</span><span data-line="1691">                    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;num_spans&quot;</span><span class="p">,</span>
</span><span data-line="1692">                    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;num_classes&quot;</span><span class="p">,</span>
</span><span data-line="1693">                <span class="p">},</span>
</span><span data-line="1694">            <span class="p">},</span>
</span><span data-line="1695">        <span class="p">}</span>
</span><span data-line="1696">
</span><span data-line="1697">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_onnx_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
</span><span data-line="1698"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create wrapper for UniEncoderSpan ONNX export.&quot;&quot;&quot;</span>
</span><span data-line="1699">
</span><span data-line="1700">        <span class="k">class</span><span class="w"> </span><span class="nc">UniEncoderSpanWrapper</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="1701">            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core</span><span class="p">):</span>
</span><span data-line="1702">                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="1703">                <span class="bp">self</span><span class="o">.</span><span class="n">core</span> <span class="o">=</span> <span class="n">core</span>
</span><span data-line="1704">
</span><span data-line="1705">            <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
</span><span data-line="1706">                <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1707">                <span class="n">input_ids</span><span class="p">,</span>
</span><span data-line="1708">                <span class="n">attention_mask</span><span class="p">,</span>
</span><span data-line="1709">                <span class="n">words_mask</span><span class="p">,</span>
</span><span data-line="1710">                <span class="n">text_lengths</span><span class="p">,</span>
</span><span data-line="1711">                <span class="n">span_idx</span><span class="p">,</span>
</span><span data-line="1712">                <span class="n">span_mask</span><span class="p">,</span>
</span><span data-line="1713">            <span class="p">):</span>
</span><span data-line="1714">                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core</span><span class="p">(</span>
</span><span data-line="1715">                    <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
</span><span data-line="1716">                    <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
</span><span data-line="1717">                    <span class="n">words_mask</span><span class="o">=</span><span class="n">words_mask</span><span class="p">,</span>
</span><span data-line="1718">                    <span class="n">text_lengths</span><span class="o">=</span><span class="n">text_lengths</span><span class="p">,</span>
</span><span data-line="1719">                    <span class="n">span_idx</span><span class="o">=</span><span class="n">span_idx</span><span class="p">,</span>
</span><span data-line="1720">                    <span class="n">span_mask</span><span class="o">=</span><span class="n">span_mask</span><span class="p">,</span>
</span><span data-line="1721">                <span class="p">)</span>
</span><span data-line="1722">                <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">logits</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;logits&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1723">
</span><span data-line="1724">        <span class="k">return</span> <span class="n">UniEncoderSpanWrapper</span><span class="p">(</span><span class="n">core_model</span><span class="p">)</span></div>

</span><span data-line="1725">
</span><span data-line="1726">
<div class="viewcode-block" id="UniEncoderTokenGLiNER">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderTokenGLiNER">[docs]</a>
</span><span data-line="1727"><span class="k">class</span><span class="w"> </span><span class="nc">UniEncoderTokenGLiNER</span><span class="p">(</span><span class="n">BaseEncoderGLiNER</span><span class="p">):</span>
</span><span data-line="1728">    <span class="n">config_class</span> <span class="o">=</span> <span class="n">UniEncoderTokenConfig</span>
</span><span data-line="1729">    <span class="n">model_class</span> <span class="o">=</span> <span class="n">UniEncoderTokenModel</span>
</span><span data-line="1730">    <span class="n">ort_model_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">UniEncoderTokenORTModel</span>
</span><span data-line="1731">    <span class="n">data_processor_class</span> <span class="o">=</span> <span class="n">UniEncoderTokenProcessor</span>
</span><span data-line="1732">    <span class="n">data_collator_class</span> <span class="o">=</span> <span class="n">UniEncoderTokenDataCollator</span>
</span><span data-line="1733">    <span class="n">decoder_class</span> <span class="o">=</span> <span class="n">TokenDecoder</span>
</span><span data-line="1734">
</span><span data-line="1735">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_onnx_input_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1736"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Define ONNX input specification for UniEncoderToken model.&quot;&quot;&quot;</span>
</span><span data-line="1737">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1738">            <span class="s2">&quot;input_names&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span data-line="1739">                <span class="s2">&quot;input_ids&quot;</span><span class="p">,</span>
</span><span data-line="1740">                <span class="s2">&quot;attention_mask&quot;</span><span class="p">,</span>
</span><span data-line="1741">                <span class="s2">&quot;words_mask&quot;</span><span class="p">,</span>
</span><span data-line="1742">                <span class="s2">&quot;text_lengths&quot;</span><span class="p">,</span>
</span><span data-line="1743">            <span class="p">],</span>
</span><span data-line="1744">            <span class="s2">&quot;output_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;logits&quot;</span><span class="p">],</span>
</span><span data-line="1745">            <span class="s2">&quot;dynamic_axes&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="1746">                <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1747">                <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1748">                <span class="s2">&quot;words_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1749">                <span class="s2">&quot;text_lengths&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">},</span>
</span><span data-line="1750">                <span class="s2">&quot;logits&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="1751">                    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;position&quot;</span><span class="p">,</span>
</span><span data-line="1752">                    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span>
</span><span data-line="1753">                    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">,</span>
</span><span data-line="1754">                    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;num_classes&quot;</span><span class="p">,</span>
</span><span data-line="1755">                <span class="p">},</span>
</span><span data-line="1756">            <span class="p">},</span>
</span><span data-line="1757">        <span class="p">}</span>
</span><span data-line="1758">
</span><span data-line="1759">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_onnx_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
</span><span data-line="1760"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create wrapper for UniEncoderToken ONNX export.&quot;&quot;&quot;</span>
</span><span data-line="1761">
</span><span data-line="1762">        <span class="k">class</span><span class="w"> </span><span class="nc">UniEncoderTokenWrapper</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="1763">            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core</span><span class="p">):</span>
</span><span data-line="1764">                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="1765">                <span class="bp">self</span><span class="o">.</span><span class="n">core</span> <span class="o">=</span> <span class="n">core</span>
</span><span data-line="1766">
</span><span data-line="1767">            <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
</span><span data-line="1768">                <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1769">                <span class="n">input_ids</span><span class="p">,</span>
</span><span data-line="1770">                <span class="n">attention_mask</span><span class="p">,</span>
</span><span data-line="1771">                <span class="n">words_mask</span><span class="p">,</span>
</span><span data-line="1772">                <span class="n">text_lengths</span><span class="p">,</span>
</span><span data-line="1773">            <span class="p">):</span>
</span><span data-line="1774">                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core</span><span class="p">(</span>
</span><span data-line="1775">                    <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
</span><span data-line="1776">                    <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
</span><span data-line="1777">                    <span class="n">words_mask</span><span class="o">=</span><span class="n">words_mask</span><span class="p">,</span>
</span><span data-line="1778">                    <span class="n">text_lengths</span><span class="o">=</span><span class="n">text_lengths</span><span class="p">,</span>
</span><span data-line="1779">                <span class="p">)</span>
</span><span data-line="1780">                <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">logits</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;logits&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1781">
</span><span data-line="1782">        <span class="k">return</span> <span class="n">UniEncoderTokenWrapper</span><span class="p">(</span><span class="n">core_model</span><span class="p">)</span></div>

</span><span data-line="1783">
</span><span data-line="1784">
<div class="viewcode-block" id="BiEncoderSpanGLiNER">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BiEncoderSpanGLiNER">[docs]</a>
</span><span data-line="1785"><span class="k">class</span><span class="w"> </span><span class="nc">BiEncoderSpanGLiNER</span><span class="p">(</span><span class="n">BaseBiEncoderGLiNER</span><span class="p">):</span>
</span><span data-line="1786">    <span class="n">config_class</span> <span class="o">=</span> <span class="n">BiEncoderSpanConfig</span>
</span><span data-line="1787">    <span class="n">model_class</span> <span class="o">=</span> <span class="n">BiEncoderSpanModel</span>
</span><span data-line="1788">    <span class="n">ort_model_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">BiEncoderSpanORTModel</span>
</span><span data-line="1789">    <span class="n">data_processor_class</span> <span class="o">=</span> <span class="n">BiEncoderSpanProcessor</span>
</span><span data-line="1790">    <span class="n">data_collator_class</span> <span class="o">=</span> <span class="n">BiEncoderSpanDataCollator</span>
</span><span data-line="1791">    <span class="n">decoder_class</span> <span class="o">=</span> <span class="n">SpanDecoder</span>
</span><span data-line="1792">
</span><span data-line="1793">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_base_input_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="1794"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Base inputs for span-based bi-encoder.&quot;&quot;&quot;</span>
</span><span data-line="1795">        <span class="k">return</span> <span class="p">[</span>
</span><span data-line="1796">            <span class="s2">&quot;input_ids&quot;</span><span class="p">,</span>
</span><span data-line="1797">            <span class="s2">&quot;attention_mask&quot;</span><span class="p">,</span>
</span><span data-line="1798">            <span class="s2">&quot;words_mask&quot;</span><span class="p">,</span>
</span><span data-line="1799">            <span class="s2">&quot;text_lengths&quot;</span><span class="p">,</span>
</span><span data-line="1800">            <span class="s2">&quot;span_idx&quot;</span><span class="p">,</span>
</span><span data-line="1801">            <span class="s2">&quot;span_mask&quot;</span><span class="p">,</span>
</span><span data-line="1802">        <span class="p">]</span>
</span><span data-line="1803">
</span><span data-line="1804">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_base_dynamic_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="1805"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Base dynamic axes for span-based bi-encoder.&quot;&quot;&quot;</span>
</span><span data-line="1806">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1807">            <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1808">            <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1809">            <span class="s2">&quot;words_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1810">            <span class="s2">&quot;text_lengths&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">},</span>
</span><span data-line="1811">            <span class="s2">&quot;span_idx&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;num_spans&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;idx&quot;</span><span class="p">},</span>
</span><span data-line="1812">            <span class="s2">&quot;span_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;num_spans&quot;</span><span class="p">},</span>
</span><span data-line="1813">        <span class="p">}</span>
</span><span data-line="1814">
</span><span data-line="1815">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_output_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1816"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Output specification for span-based model.&quot;&quot;&quot;</span>
</span><span data-line="1817">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1818">            <span class="s2">&quot;logits&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="1819">                <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span>
</span><span data-line="1820">                <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">,</span>
</span><span data-line="1821">                <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;num_spans&quot;</span><span class="p">,</span>
</span><span data-line="1822">                <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;num_classes&quot;</span><span class="p">,</span>
</span><span data-line="1823">            <span class="p">},</span>
</span><span data-line="1824">        <span class="p">}</span></div>

</span><span data-line="1825">
</span><span data-line="1826">
<div class="viewcode-block" id="BiEncoderTokenGLiNER">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.BiEncoderTokenGLiNER">[docs]</a>
</span><span data-line="1827"><span class="k">class</span><span class="w"> </span><span class="nc">BiEncoderTokenGLiNER</span><span class="p">(</span><span class="n">BaseBiEncoderGLiNER</span><span class="p">):</span>
</span><span data-line="1828">    <span class="n">config_class</span> <span class="o">=</span> <span class="n">BiEncoderTokenConfig</span>
</span><span data-line="1829">    <span class="n">model_class</span> <span class="o">=</span> <span class="n">BiEncoderTokenModel</span>
</span><span data-line="1830">    <span class="n">ort_model_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">BiEncoderTokenORTModel</span>
</span><span data-line="1831">    <span class="n">data_processor_class</span> <span class="o">=</span> <span class="n">BiEncoderTokenProcessor</span>
</span><span data-line="1832">    <span class="n">data_collator_class</span> <span class="o">=</span> <span class="n">BiEncoderTokenDataCollator</span>
</span><span data-line="1833">    <span class="n">decoder_class</span> <span class="o">=</span> <span class="n">TokenDecoder</span>
</span><span data-line="1834">
</span><span data-line="1835">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_base_input_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span data-line="1836"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Base inputs for token-based bi-encoder.&quot;&quot;&quot;</span>
</span><span data-line="1837">        <span class="k">return</span> <span class="p">[</span>
</span><span data-line="1838">            <span class="s2">&quot;input_ids&quot;</span><span class="p">,</span>
</span><span data-line="1839">            <span class="s2">&quot;attention_mask&quot;</span><span class="p">,</span>
</span><span data-line="1840">            <span class="s2">&quot;words_mask&quot;</span><span class="p">,</span>
</span><span data-line="1841">            <span class="s2">&quot;text_lengths&quot;</span><span class="p">,</span>
</span><span data-line="1842">        <span class="p">]</span>
</span><span data-line="1843">
</span><span data-line="1844">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_base_dynamic_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="1845"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Base dynamic axes for token-based bi-encoder.&quot;&quot;&quot;</span>
</span><span data-line="1846">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1847">            <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1848">            <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1849">            <span class="s2">&quot;words_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="1850">            <span class="s2">&quot;text_lengths&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">},</span>
</span><span data-line="1851">        <span class="p">}</span>
</span><span data-line="1852">
</span><span data-line="1853">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_output_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1854"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Output specification for token-based model.&quot;&quot;&quot;</span>
</span><span data-line="1855">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="1856">            <span class="s2">&quot;logits&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="1857">                <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;position&quot;</span><span class="p">,</span>
</span><span data-line="1858">                <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span>
</span><span data-line="1859">                <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">,</span>
</span><span data-line="1860">                <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;num_classes&quot;</span><span class="p">,</span>
</span><span data-line="1861">            <span class="p">},</span>
</span><span data-line="1862">        <span class="p">}</span></div>

</span><span data-line="1863">
</span><span data-line="1864">
<div class="viewcode-block" id="UniEncoderSpanDecoderGLiNER">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderSpanDecoderGLiNER">[docs]</a>
</span><span data-line="1865"><span class="k">class</span><span class="w"> </span><span class="nc">UniEncoderSpanDecoderGLiNER</span><span class="p">(</span><span class="n">BaseEncoderGLiNER</span><span class="p">):</span>
</span><span data-line="1866"><span class="w">    </span><span class="sd">&quot;&quot;&quot;GLiNER model with span-based encoding and label decoding capabilities.</span>
</span><span data-line="1867">
</span><span data-line="1868"><span class="sd">    Supports generating textual labels for entities.</span>
</span><span data-line="1869"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1870">
</span><span data-line="1871">    <span class="n">config_class</span> <span class="o">=</span> <span class="n">UniEncoderSpanDecoderConfig</span>  <span class="c1"># Uses base config with labels_decoder settings</span>
</span><span data-line="1872">    <span class="n">model_class</span> <span class="o">=</span> <span class="n">UniEncoderSpanDecoderModel</span>
</span><span data-line="1873">    <span class="n">ort_model_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1874">    <span class="n">data_processor_class</span> <span class="o">=</span> <span class="n">UniEncoderSpanDecoderProcessor</span>
</span><span data-line="1875">    <span class="n">data_collator_class</span> <span class="o">=</span> <span class="n">UniEncoderSpanDecoderDataCollator</span>
</span><span data-line="1876">    <span class="n">decoder_class</span> <span class="o">=</span> <span class="n">SpanGenerativeDecoder</span>
</span><span data-line="1877">
</span><span data-line="1878">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_data_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">words_splitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="1879"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create data processor with decoder tokenizer.&quot;&quot;&quot;</span>
</span><span data-line="1880">        <span class="k">if</span> <span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1881">            <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
</span><span data-line="1882">
</span><span data-line="1883">        <span class="k">if</span> <span class="n">words_splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1884">            <span class="n">words_splitter</span> <span class="o">=</span> <span class="n">WordsSplitter</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">words_splitter_type</span><span class="p">)</span>
</span><span data-line="1885">
</span><span data-line="1886">        <span class="c1"># Load decoder tokenizer</span>
</span><span data-line="1887">        <span class="n">decoder_tokenizer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1888">        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">labels_decoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1889">            <span class="n">decoder_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
</span><span data-line="1890">                <span class="n">config</span><span class="o">.</span><span class="n">labels_decoder</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">add_prefix_space</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="1891">            <span class="p">)</span>
</span><span data-line="1892">            <span class="k">if</span> <span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1893">                <span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
</span><span data-line="1894">
</span><span data-line="1895">        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor_class</span><span class="p">(</span>
</span><span data-line="1896">            <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">,</span> <span class="n">decoder_tokenizer</span><span class="o">=</span><span class="n">decoder_tokenizer</span>
</span><span data-line="1897">        <span class="p">)</span>
</span><span data-line="1898">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span>
</span><span data-line="1899">
<div class="viewcode-block" id="UniEncoderSpanDecoderGLiNER.set_labels_trie">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderSpanDecoderGLiNER.set_labels_trie">[docs]</a>
</span><span data-line="1900">    <span class="k">def</span><span class="w"> </span><span class="nf">set_labels_trie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
</span><span data-line="1901"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the labels trie for constrained generation.</span>
</span><span data-line="1902">
</span><span data-line="1903"><span class="sd">        Args:</span>
</span><span data-line="1904"><span class="sd">            labels: Labels that will be used for constrained generation.</span>
</span><span data-line="1905">
</span><span data-line="1906"><span class="sd">        Returns:</span>
</span><span data-line="1907"><span class="sd">            Trie structure for constrained beam search.</span>
</span><span data-line="1908">
</span><span data-line="1909"><span class="sd">        Raises:</span>
</span><span data-line="1910"><span class="sd">            NotImplementedError: If the model doesn&#39;t have a decoder.</span>
</span><span data-line="1911"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1912">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">decoder_tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1913">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Label trie is implemented only for models with decoder.&quot;</span><span class="p">)</span>
</span><span data-line="1914">
</span><span data-line="1915">        <span class="n">tokenized_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1916">        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
</span><span data-line="1917">            <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span data-line="1918">            <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">:</span>
</span><span data-line="1919">                <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span data-line="1920">            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>
</span><span data-line="1921">            <span class="n">tokenized_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span data-line="1922">
</span><span data-line="1923">        <span class="n">trie</span> <span class="o">=</span> <span class="n">LabelsTrie</span><span class="p">(</span><span class="n">tokenized_labels</span><span class="p">)</span>
</span><span data-line="1924">        <span class="k">return</span> <span class="n">trie</span></div>

</span><span data-line="1925">
<div class="viewcode-block" id="UniEncoderSpanDecoderGLiNER.generate_labels">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderSpanDecoderGLiNER.generate_labels">[docs]</a>
</span><span data-line="1926">    <span class="k">def</span><span class="w"> </span><span class="nf">generate_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">):</span>
</span><span data-line="1927"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate textual class labels for each entity span.</span>
</span><span data-line="1928">
</span><span data-line="1929"><span class="sd">        Args:</span>
</span><span data-line="1930"><span class="sd">            model_output: Model output containing decoder_embedding and decoder_embedding_mask.</span>
</span><span data-line="1931"><span class="sd">            **gen_kwargs: Generation parameters (max_new_tokens, temperature, etc.).</span>
</span><span data-line="1932">
</span><span data-line="1933"><span class="sd">        Returns:</span>
</span><span data-line="1934"><span class="sd">            List of generated label strings.</span>
</span><span data-line="1935"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1936">        <span class="n">dec_embeds</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">decoder_embedding</span>
</span><span data-line="1937">        <span class="k">if</span> <span class="n">dec_embeds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1938">            <span class="k">return</span> <span class="p">[]</span>
</span><span data-line="1939">
</span><span data-line="1940">        <span class="n">dec_mask</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">decoder_embedding_mask</span>
</span><span data-line="1941">
</span><span data-line="1942">        <span class="n">gen_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate_labels</span><span class="p">(</span>
</span><span data-line="1943">            <span class="n">dec_embeds</span><span class="p">,</span>
</span><span data-line="1944">            <span class="n">dec_mask</span><span class="p">,</span>
</span><span data-line="1945">            <span class="n">max_new_tokens</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;max_new_tokens&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
</span><span data-line="1946">            <span class="n">eos_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">,</span>
</span><span data-line="1947">            <span class="n">pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
</span><span data-line="1948">            <span class="n">do_sample</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;do_sample&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
</span><span data-line="1949">            <span class="n">temperature</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
</span><span data-line="1950">            <span class="n">num_return_sequences</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;num_return_sequences&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span data-line="1951">            <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
</span><span data-line="1952">        <span class="p">)</span>
</span><span data-line="1953">
</span><span data-line="1954">        <span class="n">gen_texts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">gen_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1955">        <span class="k">return</span> <span class="n">gen_texts</span></div>

</span><span data-line="1956">
<div class="viewcode-block" id="UniEncoderSpanDecoderGLiNER.inference">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderSpanDecoderGLiNER.inference">[docs]</a>
</span><span data-line="1957">    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span data-line="1958">    <span class="k">def</span><span class="w"> </span><span class="nf">inference</span><span class="p">(</span>
</span><span data-line="1959">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1960">        <span class="n">texts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span data-line="1961">        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="1962">        <span class="n">flat_ner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1963">        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span data-line="1964">        <span class="n">multi_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1965">        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span data-line="1966">        <span class="n">gen_constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1967">        <span class="n">num_gen_sequences</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span data-line="1968">        <span class="n">packing_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InferencePackingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1969">        <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
</span><span data-line="1970">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
</span><span data-line="1971"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict entities with optional label generation.</span>
</span><span data-line="1972">
</span><span data-line="1973"><span class="sd">        Args:</span>
</span><span data-line="1974"><span class="sd">            texts: Input texts (string or list of strings).</span>
</span><span data-line="1975"><span class="sd">            labels: Entity type labels.</span>
</span><span data-line="1976"><span class="sd">            flat_ner: Whether to use flat NER.</span>
</span><span data-line="1977"><span class="sd">            threshold: Confidence threshold.</span>
</span><span data-line="1978"><span class="sd">            multi_label: Allow multiple labels per span.</span>
</span><span data-line="1979"><span class="sd">            batch_size: Batch size for processing.</span>
</span><span data-line="1980"><span class="sd">            gen_constraints: Labels to constrain generation.</span>
</span><span data-line="1981"><span class="sd">            num_gen_sequences: Number of label sequences to generate per span.</span>
</span><span data-line="1982"><span class="sd">            packing_config: Inference packing configuration.</span>
</span><span data-line="1983"><span class="sd">            **gen_kwargs: Additional generation parameters.</span>
</span><span data-line="1984">
</span><span data-line="1985"><span class="sd">        Returns:</span>
</span><span data-line="1986"><span class="sd">            List of entity predictions with optional generated labels.</span>
</span><span data-line="1987"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1988">        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span data-line="1989">
</span><span data-line="1990">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="1991">            <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">texts</span><span class="p">]</span>
</span><span data-line="1992">
</span><span data-line="1993">        <span class="n">entity_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
</span><span data-line="1994">
</span><span data-line="1995">        <span class="n">tokens</span><span class="p">,</span> <span class="n">all_start_token_idx_to_text_idx</span><span class="p">,</span> <span class="n">all_end_token_idx_to_text_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_inputs</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span><span data-line="1996">        <span class="n">input_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_base_input</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span data-line="1997">
</span><span data-line="1998">        <span class="n">collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator_class</span><span class="p">(</span>
</span><span data-line="1999">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span data-line="2000">            <span class="n">data_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="p">,</span>
</span><span data-line="2001">            <span class="n">return_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2002">            <span class="n">return_entities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2003">            <span class="n">return_id_to_classes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2004">            <span class="n">prepare_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="2005">        <span class="p">)</span>
</span><span data-line="2006">
</span><span data-line="2007">        <span class="k">def</span><span class="w"> </span><span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">entity_types</span><span class="o">=</span><span class="n">entity_types</span><span class="p">):</span>
</span><span data-line="2008">            <span class="n">batch_out</span> <span class="o">=</span> <span class="n">collator</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">entity_types</span><span class="o">=</span><span class="n">entity_types</span><span class="p">)</span>
</span><span data-line="2009">            <span class="k">return</span> <span class="n">batch_out</span>
</span><span data-line="2010">
</span><span data-line="2011">        <span class="n">data_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">input_x</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">)</span>
</span><span data-line="2012">
</span><span data-line="2013">        <span class="n">active_packing</span> <span class="o">=</span> <span class="n">packing_config</span> <span class="k">if</span> <span class="n">packing_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inference_packing_config</span>
</span><span data-line="2014">
</span><span data-line="2015">        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2016">        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
</span><span data-line="2017">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_model</span><span class="p">:</span>
</span><span data-line="2018">                <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span data-line="2019">
</span><span data-line="2020">            <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">active_packing</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{</span><span class="o">**</span><span class="n">batch</span><span class="p">,</span> <span class="s2">&quot;packing_config&quot;</span><span class="p">:</span> <span class="n">active_packing</span><span class="p">}</span>
</span><span data-line="2021">            <span class="n">model_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
</span><span data-line="2022">
</span><span data-line="2023">            <span class="n">model_logits</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">logits</span>
</span><span data-line="2024">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_logits</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="2025">                <span class="n">model_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">model_logits</span><span class="p">)</span>
</span><span data-line="2026">
</span><span data-line="2027">            <span class="c1"># Generate labels if decoder is available</span>
</span><span data-line="2028">            <span class="n">gen_labels</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="2029">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">labels_decoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2030">                <span class="n">labels_trie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_labels_trie</span><span class="p">(</span><span class="n">gen_constraints</span><span class="p">)</span> <span class="k">if</span> <span class="n">gen_constraints</span> <span class="k">else</span> <span class="kc">None</span>
</span><span data-line="2031">                <span class="n">gen_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_labels</span><span class="p">(</span>
</span><span data-line="2032">                    <span class="n">model_output</span><span class="p">,</span> <span class="n">labels_trie</span><span class="o">=</span><span class="n">labels_trie</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="n">num_gen_sequences</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span>
</span><span data-line="2033">                <span class="p">)</span>
</span><span data-line="2034">
</span><span data-line="2035">            <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span data-line="2036">                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">],</span>
</span><span data-line="2037">                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;id_to_classes&quot;</span><span class="p">],</span>
</span><span data-line="2038">                <span class="n">model_logits</span><span class="p">,</span>
</span><span data-line="2039">                <span class="n">flat_ner</span><span class="o">=</span><span class="n">flat_ner</span><span class="p">,</span>
</span><span data-line="2040">                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
</span><span data-line="2041">                <span class="n">multi_label</span><span class="o">=</span><span class="n">multi_label</span><span class="p">,</span>
</span><span data-line="2042">                <span class="n">gen_labels</span><span class="o">=</span><span class="n">gen_labels</span><span class="p">,</span>
</span><span data-line="2043">                <span class="n">sel_idx</span><span class="o">=</span><span class="n">model_output</span><span class="o">.</span><span class="n">decoder_span_idx</span><span class="p">,</span>
</span><span data-line="2044">                <span class="n">num_gen_sequences</span><span class="o">=</span><span class="n">num_gen_sequences</span><span class="p">,</span>
</span><span data-line="2045">            <span class="p">)</span>
</span><span data-line="2046">            <span class="n">outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
</span><span data-line="2047">
</span><span data-line="2048">        <span class="c1"># Convert to entity format</span>
</span><span data-line="2049">        <span class="n">all_entities</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2050">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
</span><span data-line="2051">            <span class="n">start_token_idx_to_text_idx</span> <span class="o">=</span> <span class="n">all_start_token_idx_to_text_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="2052">            <span class="n">end_token_idx_to_text_idx</span> <span class="o">=</span> <span class="n">all_end_token_idx_to_text_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="2053">            <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2054">
</span><span data-line="2055">            <span class="k">for</span> <span class="n">start_token_idx</span><span class="p">,</span> <span class="n">end_token_idx</span><span class="p">,</span> <span class="n">ent_type</span><span class="p">,</span> <span class="n">gen_ent_type</span><span class="p">,</span> <span class="n">ent_score</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
</span><span data-line="2056">                <span class="n">start_text_idx</span> <span class="o">=</span> <span class="n">start_token_idx_to_text_idx</span><span class="p">[</span><span class="n">start_token_idx</span><span class="p">]</span>
</span><span data-line="2057">                <span class="n">end_text_idx</span> <span class="o">=</span> <span class="n">end_token_idx_to_text_idx</span><span class="p">[</span><span class="n">end_token_idx</span><span class="p">]</span>
</span><span data-line="2058">
</span><span data-line="2059">                <span class="n">ent_details</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="2060">                    <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start_text_idx</span><span class="p">,</span>
</span><span data-line="2061">                    <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end_text_idx</span><span class="p">,</span>
</span><span data-line="2062">                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">start_text_idx</span><span class="p">:</span><span class="n">end_text_idx</span><span class="p">],</span>
</span><span data-line="2063">                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">ent_type</span><span class="p">,</span>
</span><span data-line="2064">                    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">ent_score</span><span class="p">,</span>
</span><span data-line="2065">                <span class="p">}</span>
</span><span data-line="2066">
</span><span data-line="2067">                <span class="k">if</span> <span class="n">gen_ent_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2068">                    <span class="n">ent_details</span><span class="p">[</span><span class="s2">&quot;generated_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_ent_type</span>
</span><span data-line="2069">
</span><span data-line="2070">                <span class="n">entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ent_details</span><span class="p">)</span>
</span><span data-line="2071">
</span><span data-line="2072">            <span class="n">all_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
</span><span data-line="2073">
</span><span data-line="2074">        <span class="k">return</span> <span class="n">all_entities</span></div>

</span><span data-line="2075">
<div class="viewcode-block" id="UniEncoderSpanDecoderGLiNER.export_to_onnx">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderSpanDecoderGLiNER.export_to_onnx">[docs]</a>
</span><span data-line="2076">    <span class="k">def</span><span class="w"> </span><span class="nf">export_to_onnx</span><span class="p">(</span>
</span><span data-line="2077">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2078">        <span class="n">save_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
</span><span data-line="2079">        <span class="n">onnx_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model.onnx&quot;</span><span class="p">,</span>
</span><span data-line="2080">        <span class="n">quantized_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model_quantized.onnx&quot;</span><span class="p">,</span>
</span><span data-line="2081">        <span class="n">quantize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2082">        <span class="n">opset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span>
</span><span data-line="2083">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="2084"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="2085"><span class="sd">        ONNX export not supported for encoder-decoder models.</span>
</span><span data-line="2086">
</span><span data-line="2087"><span class="sd">        Raises:</span>
</span><span data-line="2088"><span class="sd">            NotImplementedError: Always raised as this model type cannot be exported to ONNX</span>
</span><span data-line="2089"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2090">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span data-line="2091">            <span class="s2">&quot;ONNX export is not supported for encoder-decoder GLiNER models &quot;</span>
</span><span data-line="2092">            <span class="s2">&quot;(UniEncoderSpanDecoderGLiNER) because of the generative decoder head. &quot;</span>
</span><span data-line="2093">            <span class="s2">&quot;The decoder requires iterative generation which is not suitable for &quot;</span>
</span><span data-line="2094">            <span class="s2">&quot;static ONNX graph export. Consider:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span data-line="2095">            <span class="s2">&quot;1. Export the encoder-only variant (UniEncoderSpanGLiNER)</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span data-line="2096">            <span class="s2">&quot;2. Use PyTorch for inference with this model</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span data-line="2097">            <span class="s2">&quot;3. Implement a custom ONNX pipeline with separate encoder/decoder exports&quot;</span>
</span><span data-line="2098">        <span class="p">)</span></div>
</div>

</span><span data-line="2099">
</span><span data-line="2100">
<div class="viewcode-block" id="UniEncoderSpanRelexGLiNER">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderSpanRelexGLiNER">[docs]</a>
</span><span data-line="2101"><span class="k">class</span><span class="w"> </span><span class="nc">UniEncoderSpanRelexGLiNER</span><span class="p">(</span><span class="n">BaseEncoderGLiNER</span><span class="p">):</span>
</span><span data-line="2102"><span class="w">    </span><span class="sd">&quot;&quot;&quot;GLiNER model for both entity recognition and relation extraction.</span>
</span><span data-line="2103">
</span><span data-line="2104"><span class="sd">    Performs joint entity and relation prediction, allowing the model to simultaneously</span>
</span><span data-line="2105"><span class="sd">    detect entities and the relationships between them in a single forward pass.</span>
</span><span data-line="2106"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2107">
</span><span data-line="2108">    <span class="n">config_class</span> <span class="o">=</span> <span class="n">UniEncoderSpanRelexConfig</span>
</span><span data-line="2109">    <span class="n">model_class</span> <span class="o">=</span> <span class="n">UniEncoderSpanRelexModel</span>
</span><span data-line="2110">    <span class="n">ort_model_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">UniEncoderSpanRelexORTModel</span>
</span><span data-line="2111">    <span class="n">data_processor_class</span> <span class="o">=</span> <span class="n">RelationExtractionSpanProcessor</span>
</span><span data-line="2112">    <span class="n">data_collator_class</span> <span class="o">=</span> <span class="n">RelationExtractionSpanDataCollator</span>
</span><span data-line="2113">    <span class="n">decoder_class</span> <span class="o">=</span> <span class="n">SpanRelexDecoder</span>
</span><span data-line="2114">
</span><span data-line="2115">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_data_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">words_splitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="2116"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create relation extraction data processor.&quot;&quot;&quot;</span>
</span><span data-line="2117">        <span class="k">if</span> <span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2118">            <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
</span><span data-line="2119">
</span><span data-line="2120">        <span class="k">if</span> <span class="n">words_splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2121">            <span class="n">words_splitter</span> <span class="o">=</span> <span class="n">WordsSplitter</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">words_splitter_type</span><span class="p">)</span>
</span><span data-line="2122">
</span><span data-line="2123">        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor_class</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">words_splitter</span><span class="p">)</span>
</span><span data-line="2124">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span>
</span><span data-line="2125">
</span><span data-line="2126">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_special_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="2127"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get special tokens to add to tokenizer.</span>
</span><span data-line="2128">
</span><span data-line="2129"><span class="sd">        Can be overridden by child classes.</span>
</span><span data-line="2130">
</span><span data-line="2131"><span class="sd">        Returns:</span>
</span><span data-line="2132"><span class="sd">            List of special tokens</span>
</span><span data-line="2133"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2134">        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ent_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sep_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rel_token</span><span class="p">]</span>
</span><span data-line="2135">        <span class="k">return</span> <span class="n">tokens</span>
</span><span data-line="2136">
<div class="viewcode-block" id="UniEncoderSpanRelexGLiNER.set_class_indices">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderSpanRelexGLiNER.set_class_indices">[docs]</a>
</span><span data-line="2137">    <span class="k">def</span><span class="w"> </span><span class="nf">set_class_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="2138"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the class token indices for entities and relations in the configuration.&quot;&quot;&quot;</span>
</span><span data-line="2139">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">class_token_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span>
</span><span data-line="2140">
</span><span data-line="2141">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rel_token_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">transformer_tokenizer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></div>

</span><span data-line="2142">
<div class="viewcode-block" id="UniEncoderSpanRelexGLiNER.inference">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderSpanRelexGLiNER.inference">[docs]</a>
</span><span data-line="2143">    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span data-line="2144">    <span class="k">def</span><span class="w"> </span><span class="nf">inference</span><span class="p">(</span>
</span><span data-line="2145">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2146">        <span class="n">texts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span data-line="2147">        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="2148">        <span class="n">relations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span data-line="2149">        <span class="n">flat_ner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="2150">        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span data-line="2151">        <span class="n">adjacency_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2152">        <span class="n">relation_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2153">        <span class="n">multi_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2154">        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span data-line="2155">        <span class="n">packing_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InferencePackingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2156">        <span class="n">return_relations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="2157">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]]:</span>
</span><span data-line="2158"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict entities and relations.</span>
</span><span data-line="2159">
</span><span data-line="2160"><span class="sd">        Args:</span>
</span><span data-line="2161"><span class="sd">            texts: Input texts (str or List[str]).</span>
</span><span data-line="2162"><span class="sd">            labels: Entity type labels (List[str]).</span>
</span><span data-line="2163"><span class="sd">            relations: Relation type labels (List[str]).</span>
</span><span data-line="2164"><span class="sd">            flat_ner: Whether to use flat NER (no nested entities).</span>
</span><span data-line="2165"><span class="sd">            threshold: Confidence threshold for entities.</span>
</span><span data-line="2166"><span class="sd">            adjacency_threshold: Confidence threshold for adjacency matrix reconstruction (defaults to threshold).</span>
</span><span data-line="2167"><span class="sd">            relation_threshold: Confidence threshold for relations (defaults to threshold).</span>
</span><span data-line="2168"><span class="sd">            multi_label: Allow multiple labels per span.</span>
</span><span data-line="2169"><span class="sd">            batch_size: Batch size for processing.</span>
</span><span data-line="2170"><span class="sd">            packing_config: Inference packing configuration.</span>
</span><span data-line="2171"><span class="sd">            return_relations: Whether to return relation predictions.</span>
</span><span data-line="2172">
</span><span data-line="2173"><span class="sd">        Returns:</span>
</span><span data-line="2174"><span class="sd">            Tuple of (entities, relations) if return_relations=True, else just entities.</span>
</span><span data-line="2175"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2176">        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span data-line="2177">
</span><span data-line="2178">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="2179">            <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">texts</span><span class="p">]</span>
</span><span data-line="2180">
</span><span data-line="2181">        <span class="k">if</span> <span class="n">relation_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2182">            <span class="n">relation_threshold</span> <span class="o">=</span> <span class="n">threshold</span>
</span><span data-line="2183">
</span><span data-line="2184">        <span class="k">if</span> <span class="n">adjacency_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2185">            <span class="n">adjacency_threshold</span> <span class="o">=</span> <span class="n">threshold</span>
</span><span data-line="2186">
</span><span data-line="2187">        <span class="c1"># Prepare entity and relation types</span>
</span><span data-line="2188">        <span class="n">entity_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
</span><span data-line="2189">        <span class="n">relation_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">relations</span><span class="p">))</span>
</span><span data-line="2190">
</span><span data-line="2191">        <span class="n">tokens</span><span class="p">,</span> <span class="n">all_start_token_idx_to_text_idx</span><span class="p">,</span> <span class="n">all_end_token_idx_to_text_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_inputs</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span><span data-line="2192">        <span class="n">input_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_base_input</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span data-line="2193">
</span><span data-line="2194">        <span class="n">collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator_class</span><span class="p">(</span>
</span><span data-line="2195">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span data-line="2196">            <span class="n">data_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="p">,</span>
</span><span data-line="2197">            <span class="n">return_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2198">            <span class="n">return_entities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2199">            <span class="n">return_id_to_classes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2200">            <span class="n">return_rel_id_to_classes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2201">            <span class="n">prepare_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="2202">        <span class="p">)</span>
</span><span data-line="2203">
</span><span data-line="2204">        <span class="k">def</span><span class="w"> </span><span class="nf">collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
</span><span data-line="2205">            <span class="n">batch_out</span> <span class="o">=</span> <span class="n">collator</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">entity_types</span><span class="o">=</span><span class="n">entity_types</span><span class="p">,</span> <span class="n">relation_types</span><span class="o">=</span><span class="n">relation_types</span><span class="p">)</span>
</span><span data-line="2206">            <span class="k">return</span> <span class="n">batch_out</span>
</span><span data-line="2207">
</span><span data-line="2208">        <span class="n">data_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">input_x</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">)</span>
</span><span data-line="2209">
</span><span data-line="2210">        <span class="n">active_packing</span> <span class="o">=</span> <span class="n">packing_config</span> <span class="k">if</span> <span class="n">packing_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inference_packing_config</span>
</span><span data-line="2211">
</span><span data-line="2212">        <span class="n">all_entity_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2213">        <span class="n">all_relation_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2214">        <span class="n">all_id_to_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2215">        <span class="n">all_rel_id_to_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2216">
</span><span data-line="2217">        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
</span><span data-line="2218">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_model</span><span class="p">:</span>
</span><span data-line="2219">                <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span data-line="2220">
</span><span data-line="2221">            <span class="c1"># Store id_to_classes before model forward pass</span>
</span><span data-line="2222">            <span class="n">batch_id_to_classes</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id_to_classes&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="2223">            <span class="n">batch_rel_id_to_classes</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rel_id_to_classes&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="2224">
</span><span data-line="2225">            <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">active_packing</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{</span><span class="o">**</span><span class="n">batch</span><span class="p">,</span> <span class="s2">&quot;packing_config&quot;</span><span class="p">:</span> <span class="n">active_packing</span><span class="p">}</span>
</span><span data-line="2226">            <span class="n">model_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">adjacency_threshold</span><span class="o">=</span><span class="n">adjacency_threshold</span><span class="p">)</span>
</span><span data-line="2227">
</span><span data-line="2228">            <span class="c1"># Decode entities</span>
</span><span data-line="2229">            <span class="n">model_logits</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">logits</span>
</span><span data-line="2230">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_logits</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="2231">                <span class="n">model_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">model_logits</span><span class="p">)</span>
</span><span data-line="2232">
</span><span data-line="2233">            <span class="n">rel_idx</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">rel_idx</span>
</span><span data-line="2234">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_idx</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="2235">                <span class="n">rel_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">rel_idx</span><span class="p">)</span>
</span><span data-line="2236">
</span><span data-line="2237">            <span class="n">rel_logits</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">rel_logits</span>
</span><span data-line="2238">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_logits</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="2239">                <span class="n">rel_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">rel_logits</span><span class="p">)</span>
</span><span data-line="2240">
</span><span data-line="2241">            <span class="n">rel_mask</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">rel_mask</span>
</span><span data-line="2242">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_mask</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="2243">                <span class="n">rel_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">rel_mask</span><span class="p">)</span>
</span><span data-line="2244">
</span><span data-line="2245">            <span class="n">decoded_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span data-line="2246">                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">],</span>
</span><span data-line="2247">                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;id_to_classes&quot;</span><span class="p">],</span>
</span><span data-line="2248">                <span class="n">model_logits</span><span class="p">,</span>
</span><span data-line="2249">                <span class="n">rel_idx</span><span class="o">=</span><span class="n">rel_idx</span><span class="p">,</span>
</span><span data-line="2250">                <span class="n">rel_logits</span><span class="o">=</span><span class="n">rel_logits</span><span class="p">,</span>
</span><span data-line="2251">                <span class="n">rel_mask</span><span class="o">=</span><span class="n">rel_mask</span><span class="p">,</span>
</span><span data-line="2252">                <span class="n">flat_ner</span><span class="o">=</span><span class="n">flat_ner</span><span class="p">,</span>
</span><span data-line="2253">                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
</span><span data-line="2254">                <span class="n">relation_threshold</span><span class="o">=</span><span class="n">relation_threshold</span><span class="p">,</span>
</span><span data-line="2255">                <span class="n">multi_label</span><span class="o">=</span><span class="n">multi_label</span><span class="p">,</span>
</span><span data-line="2256">                <span class="n">rel_id_to_classes</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rel_id_to_classes&quot;</span><span class="p">],</span>
</span><span data-line="2257">            <span class="p">)</span>
</span><span data-line="2258">
</span><span data-line="2259">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">decoded_results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="2260">                <span class="n">decoded_entities</span> <span class="o">=</span> <span class="n">decoded_results</span>
</span><span data-line="2261">                <span class="n">decoded_relations</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="2262">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2263">                <span class="n">decoded_entities</span><span class="p">,</span> <span class="n">decoded_relations</span> <span class="o">=</span> <span class="n">decoded_results</span>
</span><span data-line="2264">
</span><span data-line="2265">            <span class="n">all_entity_outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">decoded_entities</span><span class="p">)</span>
</span><span data-line="2266">            <span class="n">all_id_to_classes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_id_to_classes</span><span class="p">)</span>
</span><span data-line="2267">            <span class="n">all_rel_id_to_classes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_rel_id_to_classes</span><span class="p">)</span>
</span><span data-line="2268">
</span><span data-line="2269">            <span class="c1"># Store relation outputs if available</span>
</span><span data-line="2270">            <span class="k">if</span> <span class="n">return_relations</span> <span class="ow">and</span> <span class="n">decoded_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2271">                <span class="n">all_relation_outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">decoded_relations</span><span class="p">)</span>
</span><span data-line="2272">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2273">                <span class="c1"># Append empty relation outputs for each batch item</span>
</span><span data-line="2274">                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">])):</span>
</span><span data-line="2275">                    <span class="n">all_relation_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span data-line="2276">
</span><span data-line="2277">        <span class="c1"># Convert entities to standard format</span>
</span><span data-line="2278">        <span class="n">all_entities</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2279">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_entity_outputs</span><span class="p">):</span>
</span><span data-line="2280">            <span class="n">start_token_idx_to_text_idx</span> <span class="o">=</span> <span class="n">all_start_token_idx_to_text_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="2281">            <span class="n">end_token_idx_to_text_idx</span> <span class="o">=</span> <span class="n">all_end_token_idx_to_text_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="2282">            <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2283">
</span><span data-line="2284">            <span class="k">for</span> <span class="n">start_token_idx</span><span class="p">,</span> <span class="n">end_token_idx</span><span class="p">,</span> <span class="n">ent_type</span><span class="p">,</span> <span class="n">ent_score</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
</span><span data-line="2285">                <span class="n">start_text_idx</span> <span class="o">=</span> <span class="n">start_token_idx_to_text_idx</span><span class="p">[</span><span class="n">start_token_idx</span><span class="p">]</span>
</span><span data-line="2286">                <span class="n">end_text_idx</span> <span class="o">=</span> <span class="n">end_token_idx_to_text_idx</span><span class="p">[</span><span class="n">end_token_idx</span><span class="p">]</span>
</span><span data-line="2287">
</span><span data-line="2288">                <span class="n">entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span data-line="2289">                    <span class="p">{</span>
</span><span data-line="2290">                        <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start_text_idx</span><span class="p">,</span>
</span><span data-line="2291">                        <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end_text_idx</span><span class="p">,</span>
</span><span data-line="2292">                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">start_text_idx</span><span class="p">:</span><span class="n">end_text_idx</span><span class="p">],</span>
</span><span data-line="2293">                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">ent_type</span><span class="p">,</span>
</span><span data-line="2294">                        <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">ent_score</span><span class="p">,</span>
</span><span data-line="2295">                    <span class="p">}</span>
</span><span data-line="2296">                <span class="p">)</span>
</span><span data-line="2297">
</span><span data-line="2298">            <span class="n">all_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
</span><span data-line="2299">
</span><span data-line="2300">        <span class="k">if</span> <span class="n">return_relations</span><span class="p">:</span>
</span><span data-line="2301">            <span class="c1"># Process relations</span>
</span><span data-line="2302">            <span class="n">all_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_relations</span><span class="p">(</span>
</span><span data-line="2303">                <span class="n">all_relation_outputs</span><span class="p">,</span>
</span><span data-line="2304">                <span class="n">all_entity_outputs</span><span class="p">,</span>
</span><span data-line="2305">                <span class="n">all_start_token_idx_to_text_idx</span><span class="p">,</span>
</span><span data-line="2306">                <span class="n">all_end_token_idx_to_text_idx</span><span class="p">,</span>
</span><span data-line="2307">                <span class="n">texts</span><span class="p">,</span>
</span><span data-line="2308">            <span class="p">)</span>
</span><span data-line="2309">            <span class="k">return</span> <span class="n">all_entities</span><span class="p">,</span> <span class="n">all_relations</span>
</span><span data-line="2310">
</span><span data-line="2311">        <span class="k">return</span> <span class="n">all_entities</span></div>

</span><span data-line="2312">
</span><span data-line="2313">    <span class="k">def</span><span class="w"> </span><span class="nf">_process_relations</span><span class="p">(</span>
</span><span data-line="2314">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2315">        <span class="n">relation_outputs</span><span class="p">,</span>
</span><span data-line="2316">        <span class="n">all_entity_outputs</span><span class="p">,</span>
</span><span data-line="2317">        <span class="n">all_start_token_idx_to_text_idx</span><span class="p">,</span>
</span><span data-line="2318">        <span class="n">all_end_token_idx_to_text_idx</span><span class="p">,</span>
</span><span data-line="2319">        <span class="n">texts</span><span class="p">,</span>
</span><span data-line="2320">    <span class="p">):</span>
</span><span data-line="2321"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="2322"><span class="sd">        Process relation predictions into readable format.</span>
</span><span data-line="2323">
</span><span data-line="2324"><span class="sd">        Args:</span>
</span><span data-line="2325"><span class="sd">            relation_outputs: List of relation tuples per example, where each tuple is</span>
</span><span data-line="2326"><span class="sd">                            (head_idx, relation_label, tail_idx, score)</span>
</span><span data-line="2327"><span class="sd">            all_entity_outputs: List of entity outputs per example (token-level)</span>
</span><span data-line="2328"><span class="sd">            all_start_token_idx_to_text_idx: Token to text index mappings (start)</span>
</span><span data-line="2329"><span class="sd">            all_end_token_idx_to_text_idx: Token to text index mappings (end)</span>
</span><span data-line="2330"><span class="sd">            texts: Original input texts</span>
</span><span data-line="2331">
</span><span data-line="2332"><span class="sd">        Returns:</span>
</span><span data-line="2333"><span class="sd">            List of relation lists, one per example</span>
</span><span data-line="2334"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2335">        <span class="n">all_relations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2336">
</span><span data-line="2337">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rel_tuples</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">relation_outputs</span><span class="p">):</span>
</span><span data-line="2338">            <span class="k">if</span> <span class="n">rel_tuples</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rel_tuples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="2339">                <span class="n">all_relations</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
</span><span data-line="2340">                <span class="k">continue</span>
</span><span data-line="2341">
</span><span data-line="2342">            <span class="n">relations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2343">            <span class="n">entities_list</span> <span class="o">=</span> <span class="n">all_entity_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># Token-level entities: (start, end, type, score)</span>
</span><span data-line="2344">            <span class="n">start_token_idx_to_text_idx</span> <span class="o">=</span> <span class="n">all_start_token_idx_to_text_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="2345">            <span class="n">end_token_idx_to_text_idx</span> <span class="o">=</span> <span class="n">all_end_token_idx_to_text_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span data-line="2346">
</span><span data-line="2347">            <span class="c1"># Process each relation tuple from decoder</span>
</span><span data-line="2348">            <span class="k">for</span> <span class="n">head_idx</span><span class="p">,</span> <span class="n">relation_label</span><span class="p">,</span> <span class="n">tail_idx</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">rel_tuples</span><span class="p">:</span>
</span><span data-line="2349">                <span class="c1"># Validate entity indices</span>
</span><span data-line="2350">                <span class="k">if</span> <span class="n">head_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entities_list</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tail_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entities_list</span><span class="p">):</span>
</span><span data-line="2351">                    <span class="k">continue</span>
</span><span data-line="2352">
</span><span data-line="2353">                <span class="c1"># Get head and tail entities (token-level)</span>
</span><span data-line="2354">                <span class="n">head_start_tok</span><span class="p">,</span> <span class="n">head_end_tok</span><span class="p">,</span> <span class="n">head_type</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">entities_list</span><span class="p">[</span><span class="n">head_idx</span><span class="p">]</span>
</span><span data-line="2355">                <span class="n">tail_start_tok</span><span class="p">,</span> <span class="n">tail_end_tok</span><span class="p">,</span> <span class="n">tail_type</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">entities_list</span><span class="p">[</span><span class="n">tail_idx</span><span class="p">]</span>
</span><span data-line="2356">
</span><span data-line="2357">                <span class="c1"># Convert token indices to text indices</span>
</span><span data-line="2358">                <span class="n">head_start_text</span> <span class="o">=</span> <span class="n">start_token_idx_to_text_idx</span><span class="p">[</span><span class="n">head_start_tok</span><span class="p">]</span>
</span><span data-line="2359">                <span class="n">head_end_text</span> <span class="o">=</span> <span class="n">end_token_idx_to_text_idx</span><span class="p">[</span><span class="n">head_end_tok</span><span class="p">]</span>
</span><span data-line="2360">                <span class="n">tail_start_text</span> <span class="o">=</span> <span class="n">start_token_idx_to_text_idx</span><span class="p">[</span><span class="n">tail_start_tok</span><span class="p">]</span>
</span><span data-line="2361">                <span class="n">tail_end_text</span> <span class="o">=</span> <span class="n">end_token_idx_to_text_idx</span><span class="p">[</span><span class="n">tail_end_tok</span><span class="p">]</span>
</span><span data-line="2362">
</span><span data-line="2363">                <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span data-line="2364">                    <span class="p">{</span>
</span><span data-line="2365">                        <span class="s2">&quot;head&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2366">                            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">head_start_text</span><span class="p">,</span>
</span><span data-line="2367">                            <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">head_end_text</span><span class="p">,</span>
</span><span data-line="2368">                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">head_start_text</span><span class="p">:</span><span class="n">head_end_text</span><span class="p">],</span>
</span><span data-line="2369">                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">head_type</span><span class="p">,</span>
</span><span data-line="2370">                            <span class="s2">&quot;entity_idx&quot;</span><span class="p">:</span> <span class="n">head_idx</span><span class="p">,</span>
</span><span data-line="2371">                        <span class="p">},</span>
</span><span data-line="2372">                        <span class="s2">&quot;tail&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2373">                            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">tail_start_text</span><span class="p">,</span>
</span><span data-line="2374">                            <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">tail_end_text</span><span class="p">,</span>
</span><span data-line="2375">                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">tail_start_text</span><span class="p">:</span><span class="n">tail_end_text</span><span class="p">],</span>
</span><span data-line="2376">                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">tail_type</span><span class="p">,</span>
</span><span data-line="2377">                            <span class="s2">&quot;entity_idx&quot;</span><span class="p">:</span> <span class="n">tail_idx</span><span class="p">,</span>
</span><span data-line="2378">                        <span class="p">},</span>
</span><span data-line="2379">                        <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="n">relation_label</span><span class="p">,</span>
</span><span data-line="2380">                        <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
</span><span data-line="2381">                    <span class="p">}</span>
</span><span data-line="2382">                <span class="p">)</span>
</span><span data-line="2383">
</span><span data-line="2384">            <span class="n">all_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relations</span><span class="p">)</span>
</span><span data-line="2385">
</span><span data-line="2386">        <span class="k">return</span> <span class="n">all_relations</span>
</span><span data-line="2387">
<div class="viewcode-block" id="UniEncoderSpanRelexGLiNER.evaluate">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.UniEncoderSpanRelexGLiNER.evaluate">[docs]</a>
</span><span data-line="2388">    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span>
</span><span data-line="2389">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2390">        <span class="n">test_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span data-line="2391">        <span class="n">flat_ner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2392">        <span class="n">multi_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2393">        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span data-line="2394">        <span class="n">adjacency_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2395">        <span class="n">relation_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2396">        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
</span><span data-line="2397">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
</span><span data-line="2398"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the model on both NER and relation extraction tasks.</span>
</span><span data-line="2399">
</span><span data-line="2400"><span class="sd">        Args:</span>
</span><span data-line="2401"><span class="sd">            test_data: The test data containing text, entity, and relation annotations.</span>
</span><span data-line="2402"><span class="sd">            flat_ner: Whether to use flat NER. Defaults to False.</span>
</span><span data-line="2403"><span class="sd">            multi_label: Whether to use multi-label classification. Defaults to False.</span>
</span><span data-line="2404"><span class="sd">            threshold: The threshold for entity predictions. Defaults to 0.5.</span>
</span><span data-line="2405"><span class="sd">            adjacency_threshold: Threshold for adjacency matrix reconstruction. Defaults to threshold.</span>
</span><span data-line="2406"><span class="sd">            relation_threshold: The threshold for relation predictions. Defaults to threshold.</span>
</span><span data-line="2407"><span class="sd">            batch_size: The batch size for evaluation. Defaults to 12.</span>
</span><span data-line="2408">
</span><span data-line="2409"><span class="sd">        Returns:</span>
</span><span data-line="2410"><span class="sd">            Tuple of ((ner_output, ner_f1), (rel_output, rel_f1)) containing:</span>
</span><span data-line="2411"><span class="sd">            - ner_output: Formatted string with NER P, R, F1</span>
</span><span data-line="2412"><span class="sd">            - ner_f1: NER F1 score</span>
</span><span data-line="2413"><span class="sd">            - rel_output: Formatted string with relation extraction P, R, F1</span>
</span><span data-line="2414"><span class="sd">            - rel_f1: Relation extraction F1 score</span>
</span><span data-line="2415"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2416">        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span data-line="2417">        
</span><span data-line="2418">        <span class="k">if</span> <span class="n">relation_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2419">            <span class="n">relation_threshold</span> <span class="o">=</span> <span class="n">threshold</span>
</span><span data-line="2420">        
</span><span data-line="2421">        <span class="k">if</span> <span class="n">adjacency_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2422">            <span class="n">adjacency_threshold</span> <span class="o">=</span> <span class="n">threshold</span>
</span><span data-line="2423">        
</span><span data-line="2424">        <span class="c1"># Create the dataset and data loader</span>
</span><span data-line="2425">        <span class="n">dataset</span> <span class="o">=</span> <span class="n">test_data</span>
</span><span data-line="2426">        <span class="n">collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator_class</span><span class="p">(</span>
</span><span data-line="2427">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span data-line="2428">            <span class="n">data_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="p">,</span>
</span><span data-line="2429">            <span class="n">return_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2430">            <span class="n">return_entities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2431">            <span class="n">return_relations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2432">            <span class="n">return_id_to_classes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2433">            <span class="n">return_rel_id_to_classes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2434">            <span class="n">prepare_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="2435">        <span class="p">)</span>
</span><span data-line="2436">        <span class="n">data_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
</span><span data-line="2437">            <span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collator</span>
</span><span data-line="2438">        <span class="p">)</span>
</span><span data-line="2439">
</span><span data-line="2440">        <span class="n">all_entity_preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2441">        <span class="n">all_relation_preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2442">        <span class="n">all_true_entities</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2443">        <span class="n">all_true_relations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2444">
</span><span data-line="2445">        <span class="c1"># Iterate over data batches</span>
</span><span data-line="2446">        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
</span><span data-line="2447">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_model</span><span class="p">:</span>
</span><span data-line="2448">                <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span data-line="2449">
</span><span data-line="2450">            <span class="c1"># Get model predictions</span>
</span><span data-line="2451">            <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="2452">            <span class="n">model_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
</span><span data-line="2453">                <span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">adjacency_threshold</span><span class="o">=</span><span class="n">adjacency_threshold</span>
</span><span data-line="2454">            <span class="p">)</span>
</span><span data-line="2455">
</span><span data-line="2456">            <span class="c1"># Extract logits and relation outputs</span>
</span><span data-line="2457">            <span class="n">model_logits</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">logits</span>
</span><span data-line="2458">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_logits</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="2459">                <span class="n">model_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">model_logits</span><span class="p">)</span>
</span><span data-line="2460">
</span><span data-line="2461">            <span class="n">rel_idx</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">rel_idx</span>
</span><span data-line="2462">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_idx</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="2463">                <span class="n">rel_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">rel_idx</span><span class="p">)</span>
</span><span data-line="2464">
</span><span data-line="2465">            <span class="n">rel_logits</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">rel_logits</span>
</span><span data-line="2466">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_logits</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="2467">                <span class="n">rel_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">rel_logits</span><span class="p">)</span>
</span><span data-line="2468">
</span><span data-line="2469">            <span class="n">rel_mask</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">rel_mask</span>
</span><span data-line="2470">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_mask</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="2471">                <span class="n">rel_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">rel_mask</span><span class="p">)</span>
</span><span data-line="2472">
</span><span data-line="2473">            <span class="c1"># Decode predictions</span>
</span><span data-line="2474">            <span class="n">decoded_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span data-line="2475">                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">],</span>
</span><span data-line="2476">                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;id_to_classes&quot;</span><span class="p">],</span>
</span><span data-line="2477">                <span class="n">model_logits</span><span class="p">,</span>
</span><span data-line="2478">                <span class="n">rel_idx</span><span class="o">=</span><span class="n">rel_idx</span><span class="p">,</span>
</span><span data-line="2479">                <span class="n">rel_logits</span><span class="o">=</span><span class="n">rel_logits</span><span class="p">,</span>
</span><span data-line="2480">                <span class="n">rel_mask</span><span class="o">=</span><span class="n">rel_mask</span><span class="p">,</span>
</span><span data-line="2481">                <span class="n">flat_ner</span><span class="o">=</span><span class="n">flat_ner</span><span class="p">,</span>
</span><span data-line="2482">                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
</span><span data-line="2483">                <span class="n">relation_threshold</span><span class="o">=</span><span class="n">relation_threshold</span><span class="p">,</span>
</span><span data-line="2484">                <span class="n">multi_label</span><span class="o">=</span><span class="n">multi_label</span><span class="p">,</span>
</span><span data-line="2485">                <span class="n">rel_id_to_classes</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rel_id_to_classes&quot;</span><span class="p">],</span>
</span><span data-line="2486">            <span class="p">)</span>
</span><span data-line="2487">
</span><span data-line="2488">            <span class="c1"># Unpack results</span>
</span><span data-line="2489">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">decoded_results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span data-line="2490">                <span class="n">decoded_entities</span><span class="p">,</span> <span class="n">decoded_relations</span> <span class="o">=</span> <span class="n">decoded_results</span>
</span><span data-line="2491">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2492">                <span class="n">decoded_entities</span> <span class="o">=</span> <span class="n">decoded_results</span>
</span><span data-line="2493">                <span class="n">decoded_relations</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">decoded_entities</span><span class="p">))]</span>
</span><span data-line="2494">
</span><span data-line="2495">            <span class="n">all_entity_preds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">decoded_entities</span><span class="p">)</span>
</span><span data-line="2496">            <span class="n">all_relation_preds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">decoded_relations</span><span class="p">)</span>
</span><span data-line="2497">
</span><span data-line="2498">            <span class="c1"># Extract ground truth</span>
</span><span data-line="2499">            <span class="n">all_true_entities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">])</span>
</span><span data-line="2500">            <span class="n">all_true_relations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relations&quot;</span><span class="p">,</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]))]))</span>
</span><span data-line="2501">
</span><span data-line="2502">        <span class="c1"># Evaluate NER</span>
</span><span data-line="2503">        <span class="n">ner_evaluator</span> <span class="o">=</span> <span class="n">BaseNEREvaluator</span><span class="p">(</span><span class="n">all_true_entities</span><span class="p">,</span> <span class="n">all_entity_preds</span><span class="p">)</span>
</span><span data-line="2504">        <span class="n">ner_output</span><span class="p">,</span> <span class="n">ner_f1</span> <span class="o">=</span> <span class="n">ner_evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
</span><span data-line="2505">
</span><span data-line="2506">        <span class="c1"># Evaluate Relations</span>
</span><span data-line="2507">        <span class="c1"># Format data for relation evaluator: list of (entities, relations) tuples</span>
</span><span data-line="2508">        <span class="n">all_true_rel_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_true_entities</span><span class="p">,</span> <span class="n">all_true_relations</span><span class="p">))</span>
</span><span data-line="2509">        <span class="n">all_pred_rel_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_entity_preds</span><span class="p">,</span> <span class="n">all_relation_preds</span><span class="p">))</span>
</span><span data-line="2510">        
</span><span data-line="2511">        <span class="n">rel_evaluator</span> <span class="o">=</span> <span class="n">BaseRelexEvaluator</span><span class="p">(</span><span class="n">all_true_rel_data</span><span class="p">,</span> <span class="n">all_pred_rel_data</span><span class="p">)</span>
</span><span data-line="2512">        <span class="n">rel_output</span><span class="p">,</span> <span class="n">rel_f1</span> <span class="o">=</span> <span class="n">rel_evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
</span><span data-line="2513">
</span><span data-line="2514">        <span class="k">return</span> <span class="p">(</span><span class="n">ner_output</span><span class="p">,</span> <span class="n">ner_f1</span><span class="p">),</span> <span class="p">(</span><span class="n">rel_output</span><span class="p">,</span> <span class="n">rel_f1</span><span class="p">)</span></div>

</span><span data-line="2515">
</span><span data-line="2516">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_onnx_input_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2517"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Define ONNX input specification for UniEncoderSpanRelex model.&quot;&quot;&quot;</span>
</span><span data-line="2518">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="2519">            <span class="s2">&quot;input_names&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span data-line="2520">                <span class="s2">&quot;input_ids&quot;</span><span class="p">,</span>
</span><span data-line="2521">                <span class="s2">&quot;attention_mask&quot;</span><span class="p">,</span>
</span><span data-line="2522">                <span class="s2">&quot;words_mask&quot;</span><span class="p">,</span>
</span><span data-line="2523">                <span class="s2">&quot;text_lengths&quot;</span><span class="p">,</span>
</span><span data-line="2524">                <span class="s2">&quot;span_idx&quot;</span><span class="p">,</span>
</span><span data-line="2525">                <span class="s2">&quot;span_mask&quot;</span><span class="p">,</span>
</span><span data-line="2526">            <span class="p">],</span>
</span><span data-line="2527">            <span class="s2">&quot;output_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;logits&quot;</span><span class="p">,</span> <span class="s2">&quot;rel_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;rel_logits&quot;</span><span class="p">,</span> <span class="s2">&quot;rel_mask&quot;</span><span class="p">],</span>
</span><span data-line="2528">            <span class="s2">&quot;dynamic_axes&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2529">                <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="2530">                <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="2531">                <span class="s2">&quot;words_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">},</span>
</span><span data-line="2532">                <span class="s2">&quot;text_lengths&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">},</span>
</span><span data-line="2533">                <span class="s2">&quot;span_idx&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;num_spans&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;idx&quot;</span><span class="p">},</span>
</span><span data-line="2534">                <span class="s2">&quot;span_mask&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;num_spans&quot;</span><span class="p">},</span>
</span><span data-line="2535">                <span class="s2">&quot;logits&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2536">                    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span>
</span><span data-line="2537">                    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;sequence_length&quot;</span><span class="p">,</span>
</span><span data-line="2538">                    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;num_spans&quot;</span><span class="p">,</span>
</span><span data-line="2539">                    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;num_ent_classes&quot;</span><span class="p">,</span>
</span><span data-line="2540">                <span class="p">},</span>
</span><span data-line="2541">                <span class="s2">&quot;rel_idx&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2542">                    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span>
</span><span data-line="2543">                    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;num_pairs&quot;</span><span class="p">,</span>
</span><span data-line="2544">                    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;pair_index&quot;</span><span class="p">,</span>
</span><span data-line="2545">                <span class="p">},</span>
</span><span data-line="2546">                <span class="s2">&quot;rel_logits&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2547">                    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span>
</span><span data-line="2548">                    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;num_pairs&quot;</span><span class="p">,</span>
</span><span data-line="2549">                    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;num_rel_classes&quot;</span><span class="p">,</span>
</span><span data-line="2550">                <span class="p">},</span>
</span><span data-line="2551">                <span class="s2">&quot;rel_mask&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2552">                    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">,</span>
</span><span data-line="2553">                    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;num_pairs&quot;</span><span class="p">,</span>
</span><span data-line="2554">                <span class="p">},</span>
</span><span data-line="2555">            <span class="p">},</span>
</span><span data-line="2556">        <span class="p">}</span>
</span><span data-line="2557">
</span><span data-line="2558">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_onnx_export_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2559"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide default labels for relation extraction ONNX export.&quot;&quot;&quot;</span>
</span><span data-line="2560">        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="s2">&quot;tail&quot;</span><span class="p">]}</span>
</span><span data-line="2561">
</span><span data-line="2562">    <span class="k">def</span><span class="w"> </span><span class="nf">_create_onnx_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
</span><span data-line="2563"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create wrapper for UniEncoderSpanRelex ONNX export.&quot;&quot;&quot;</span>
</span><span data-line="2564">
</span><span data-line="2565">        <span class="k">class</span><span class="w"> </span><span class="nc">UniEncoderSpanRelexWrapper</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="2566">            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core</span><span class="p">):</span>
</span><span data-line="2567">                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="2568">                <span class="bp">self</span><span class="o">.</span><span class="n">core</span> <span class="o">=</span> <span class="n">core</span>
</span><span data-line="2569">
</span><span data-line="2570">            <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
</span><span data-line="2571">                <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2572">                <span class="n">input_ids</span><span class="p">,</span>
</span><span data-line="2573">                <span class="n">attention_mask</span><span class="p">,</span>
</span><span data-line="2574">                <span class="n">words_mask</span><span class="p">,</span>
</span><span data-line="2575">                <span class="n">text_lengths</span><span class="p">,</span>
</span><span data-line="2576">                <span class="n">span_idx</span><span class="p">,</span>
</span><span data-line="2577">                <span class="n">span_mask</span><span class="p">,</span>
</span><span data-line="2578">            <span class="p">):</span>
</span><span data-line="2579">                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core</span><span class="p">(</span>
</span><span data-line="2580">                    <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
</span><span data-line="2581">                    <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
</span><span data-line="2582">                    <span class="n">words_mask</span><span class="o">=</span><span class="n">words_mask</span><span class="p">,</span>
</span><span data-line="2583">                    <span class="n">text_lengths</span><span class="o">=</span><span class="n">text_lengths</span><span class="p">,</span>
</span><span data-line="2584">                    <span class="n">span_idx</span><span class="o">=</span><span class="n">span_idx</span><span class="p">,</span>
</span><span data-line="2585">                    <span class="n">span_mask</span><span class="o">=</span><span class="n">span_mask</span><span class="p">,</span>
</span><span data-line="2586">                <span class="p">)</span>
</span><span data-line="2587">                <span class="c1"># Return all outputs for relation extraction</span>
</span><span data-line="2588">                <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">rel_idx</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">rel_logits</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">rel_mask</span>
</span><span data-line="2589">
</span><span data-line="2590">        <span class="k">return</span> <span class="n">UniEncoderSpanRelexWrapper</span><span class="p">(</span><span class="n">core_model</span><span class="p">)</span></div>

</span><span data-line="2591">
</span><span data-line="2592">
<div class="viewcode-block" id="GLiNER">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.GLiNER">[docs]</a>
</span><span data-line="2593"><span class="k">class</span><span class="w"> </span><span class="nc">GLiNER</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">PyTorchModelHubMixin</span><span class="p">):</span>
</span><span data-line="2594"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Meta GLiNER class that automatically instantiates the appropriate GLiNER variant.</span>
</span><span data-line="2595">
</span><span data-line="2596"><span class="sd">    This class provides a unified interface for all GLiNER models, automatically switching to</span>
</span><span data-line="2597"><span class="sd">    specialized model types based on the model configuration. It supports various NER architectures</span>
</span><span data-line="2598"><span class="sd">    including uni-encoder, bi-encoder, decoder-based, and relation extraction models.</span>
</span><span data-line="2599">
</span><span data-line="2600"><span class="sd">    The class automatically detects the model type based on:</span>
</span><span data-line="2601"><span class="sd">        - span_mode: Token-level vs span-level</span>
</span><span data-line="2602"><span class="sd">        - labels_encoder: Uni-encoder vs bi-encoder</span>
</span><span data-line="2603"><span class="sd">        - labels_decoder: Standard vs decoder-based</span>
</span><span data-line="2604"><span class="sd">        - relations_layer: NER-only vs joint entity-relation extraction</span>
</span><span data-line="2605">
</span><span data-line="2606"><span class="sd">    Attributes:</span>
</span><span data-line="2607"><span class="sd">        model: The loaded GLiNER model instance (automatically typed).</span>
</span><span data-line="2608"><span class="sd">        config: Model configuration.</span>
</span><span data-line="2609"><span class="sd">        data_processor: Data processor for the model.</span>
</span><span data-line="2610"><span class="sd">        decoder: Decoder for predictions.</span>
</span><span data-line="2611">
</span><span data-line="2612"><span class="sd">    Examples:</span>
</span><span data-line="2613"><span class="sd">        Load a pretrained uni-encoder span model:</span>
</span><span data-line="2614"><span class="sd">        &gt;&gt;&gt; model = GLiNER.from_pretrained(&quot;urchade/gliner_small-v2.1&quot;)</span>
</span><span data-line="2615">
</span><span data-line="2616"><span class="sd">        Load a bi-encoder model:</span>
</span><span data-line="2617"><span class="sd">        &gt;&gt;&gt; model = GLiNER.from_pretrained(&quot;knowledgator/gliner-bi-small-v1.0&quot;)</span>
</span><span data-line="2618">
</span><span data-line="2619"><span class="sd">        Load from local configuration:</span>
</span><span data-line="2620"><span class="sd">        &gt;&gt;&gt; config = GLiNERConfig.from_pretrained(&quot;config.json&quot;)</span>
</span><span data-line="2621"><span class="sd">        &gt;&gt;&gt; model = GLiNER.from_config(config)</span>
</span><span data-line="2622">
</span><span data-line="2623"><span class="sd">        Initialize from scratch:</span>
</span><span data-line="2624"><span class="sd">        &gt;&gt;&gt; config = GLiNERConfig(model_name=&quot;microsoft/deberta-v3-small&quot;)</span>
</span><span data-line="2625"><span class="sd">        &gt;&gt;&gt; model = GLiNER(config)</span>
</span><span data-line="2626"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2627">
<div class="viewcode-block" id="GLiNER.__init__">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.GLiNER.__init__">[docs]</a>
</span><span data-line="2628">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">GLiNERConfig</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="2629"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a GLiNER model with automatic type detection.</span>
</span><span data-line="2630">
</span><span data-line="2631"><span class="sd">        This constructor determines the appropriate GLiNER variant based on the configuration</span>
</span><span data-line="2632"><span class="sd">        and replaces itself with an instance of that variant.</span>
</span><span data-line="2633">
</span><span data-line="2634"><span class="sd">        Args:</span>
</span><span data-line="2635"><span class="sd">            config: Model configuration (GLiNERConfig object, path to config file, or dict).</span>
</span><span data-line="2636"><span class="sd">            **kwargs: Additional arguments passed to the specific GLiNER variant.</span>
</span><span data-line="2637">
</span><span data-line="2638"><span class="sd">        Examples:</span>
</span><span data-line="2639"><span class="sd">            &gt;&gt;&gt; config = GLiNERConfig(model_name=&quot;bert-base-cased&quot;)</span>
</span><span data-line="2640"><span class="sd">            &gt;&gt;&gt; model = GLiNER(config)</span>
</span><span data-line="2641"><span class="sd">            &gt;&gt;&gt; model = GLiNER(&quot;path/to/gliner_config.json&quot;)</span>
</span><span data-line="2642"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2643">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="2644">
</span><span data-line="2645">        <span class="c1"># Load config if it&#39;s a path or dict</span>
</span><span data-line="2646">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
</span><span data-line="2647">            <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="2648">            <span class="k">if</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="2649">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span data-line="2650">                    <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span data-line="2651">                <span class="n">config</span> <span class="o">=</span> <span class="n">GLiNERConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>
</span><span data-line="2652">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2653">                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config file not found: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="2654">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span data-line="2655">            <span class="n">config</span> <span class="o">=</span> <span class="n">GLiNERConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="2656">
</span><span data-line="2657">        <span class="c1"># Determine the appropriate GLiNER class based on config</span>
</span><span data-line="2658">        <span class="n">gliner_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gliner_class</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="2659">
</span><span data-line="2660">        <span class="c1"># Create instance of the appropriate class</span>
</span><span data-line="2661">        <span class="n">new_instance</span> <span class="o">=</span> <span class="n">gliner_class</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="2662">
</span><span data-line="2663">        <span class="c1"># Replace this instance with the specific GLiNER variant</span>
</span><span data-line="2664">        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_instance</span><span class="p">)</span>
</span><span data-line="2665">        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">new_instance</span><span class="o">.</span><span class="vm">__dict__</span></div>

</span><span data-line="2666">
</span><span data-line="2667">    <span class="nd">@staticmethod</span>
</span><span data-line="2668">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_gliner_class</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">GLiNERConfig</span><span class="p">):</span>
</span><span data-line="2669"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the appropriate GLiNER class based on configuration.</span>
</span><span data-line="2670">
</span><span data-line="2671"><span class="sd">        Args:</span>
</span><span data-line="2672"><span class="sd">            config: GLiNER configuration object.</span>
</span><span data-line="2673">
</span><span data-line="2674"><span class="sd">        Returns:</span>
</span><span data-line="2675"><span class="sd">            The appropriate GLiNER class type.</span>
</span><span data-line="2676"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2677">        <span class="n">is_token_level</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">span_mode</span> <span class="o">==</span> <span class="s2">&quot;token_level&quot;</span>
</span><span data-line="2678">        <span class="n">has_labels_encoder</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">labels_encoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="2679">        <span class="n">has_labels_decoder</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">labels_decoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="2680">        <span class="n">has_relations</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">relations_layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="2681">
</span><span data-line="2682">        <span class="c1"># Priority order: relations &gt; decoder &gt; bi-encoder &gt; token vs span</span>
</span><span data-line="2683">
</span><span data-line="2684">        <span class="k">if</span> <span class="n">has_relations</span><span class="p">:</span>
</span><span data-line="2685">            <span class="k">return</span> <span class="n">UniEncoderSpanRelexGLiNER</span>
</span><span data-line="2686">
</span><span data-line="2687">        <span class="k">if</span> <span class="n">has_labels_decoder</span><span class="p">:</span>
</span><span data-line="2688">            <span class="k">if</span> <span class="n">has_labels_encoder</span><span class="p">:</span>
</span><span data-line="2689">                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="2690">                    <span class="s2">&quot;labels_encoder and labels_decoder are both set. &quot;</span>
</span><span data-line="2691">                    <span class="s2">&quot;Using decoder model (labels_encoder will be ignored).&quot;</span><span class="p">,</span>
</span><span data-line="2692">                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span data-line="2693">                <span class="p">)</span>
</span><span data-line="2694">            <span class="k">return</span> <span class="n">UniEncoderSpanDecoderGLiNER</span>
</span><span data-line="2695">
</span><span data-line="2696">        <span class="k">if</span> <span class="n">has_labels_encoder</span><span class="p">:</span>
</span><span data-line="2697">            <span class="k">if</span> <span class="n">is_token_level</span><span class="p">:</span>
</span><span data-line="2698">                <span class="k">return</span> <span class="n">BiEncoderTokenGLiNER</span>
</span><span data-line="2699">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2700">                <span class="k">return</span> <span class="n">BiEncoderSpanGLiNER</span>
</span><span data-line="2701">
</span><span data-line="2702">        <span class="c1"># Default: uni-encoder</span>
</span><span data-line="2703">        <span class="k">if</span> <span class="n">is_token_level</span><span class="p">:</span>
</span><span data-line="2704">            <span class="k">return</span> <span class="n">UniEncoderTokenGLiNER</span>
</span><span data-line="2705">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2706">            <span class="k">return</span> <span class="n">UniEncoderSpanGLiNER</span>
</span><span data-line="2707">
<div class="viewcode-block" id="GLiNER.from_pretrained">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.GLiNER.from_pretrained">[docs]</a>
</span><span data-line="2708">    <span class="nd">@classmethod</span>
</span><span data-line="2709">    <span class="k">def</span><span class="w"> </span><span class="nf">from_pretrained</span><span class="p">(</span>
</span><span data-line="2710">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="2711">        <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="2712">        <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2713">        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2714">        <span class="n">force_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2715">        <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2716">        <span class="n">resume_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2717">        <span class="n">local_files_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2718">        <span class="n">token</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2719">        <span class="n">map_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span data-line="2720">        <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2721">        <span class="n">load_tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2722">        <span class="n">resize_token_embeddings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="2723">        <span class="n">compile_torch_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2724">        <span class="n">load_onnx_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2725">        <span class="n">onnx_model_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;model.onnx&quot;</span><span class="p">,</span>
</span><span data-line="2726">        <span class="c1"># Config overrides</span>
</span><span data-line="2727">        <span class="n">max_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2728">        <span class="n">max_width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2729">        <span class="n">post_fusion_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2730">        <span class="n">_attn_implementation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2731">        <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
</span><span data-line="2732">    <span class="p">):</span>
</span><span data-line="2733"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a pretrained GLiNER model with automatic type detection.</span>
</span><span data-line="2734">
</span><span data-line="2735"><span class="sd">        This method loads the configuration, determines the appropriate GLiNER variant,</span>
</span><span data-line="2736"><span class="sd">        and delegates to that variant&#39;s from_pretrained method.</span>
</span><span data-line="2737">
</span><span data-line="2738"><span class="sd">        Args:</span>
</span><span data-line="2739"><span class="sd">            model_id: Model identifier or local path.</span>
</span><span data-line="2740"><span class="sd">            revision: Model revision.</span>
</span><span data-line="2741"><span class="sd">            cache_dir: Cache directory.</span>
</span><span data-line="2742"><span class="sd">            force_download: Force redownload.</span>
</span><span data-line="2743"><span class="sd">            proxies: Proxy configuration.</span>
</span><span data-line="2744"><span class="sd">            resume_download: Resume interrupted downloads.</span>
</span><span data-line="2745"><span class="sd">            local_files_only: Only use local files.</span>
</span><span data-line="2746"><span class="sd">            token: HF token for private repos.</span>
</span><span data-line="2747"><span class="sd">            map_location: Device to map model to.</span>
</span><span data-line="2748"><span class="sd">            strict: Enforce strict state_dict loading.</span>
</span><span data-line="2749"><span class="sd">            load_tokenizer: Whether to load tokenizer.</span>
</span><span data-line="2750"><span class="sd">            resize_token_embeddings: Whether to resize embeddings.</span>
</span><span data-line="2751"><span class="sd">            compile_torch_model: Whether to compile with torch.compile.</span>
</span><span data-line="2752"><span class="sd">            load_onnx_model: Whether to load ONNX model instead of PyTorch.</span>
</span><span data-line="2753"><span class="sd">            onnx_model_file: Path to ONNX model file.</span>
</span><span data-line="2754"><span class="sd">            max_length: Override max_length in config.</span>
</span><span data-line="2755"><span class="sd">            max_width: Override max_width in config.</span>
</span><span data-line="2756"><span class="sd">            post_fusion_schema: Override post_fusion_schema in config.</span>
</span><span data-line="2757"><span class="sd">            _attn_implementation: Override attention implementation.</span>
</span><span data-line="2758"><span class="sd">            **model_kwargs: Additional model initialization arguments.</span>
</span><span data-line="2759">
</span><span data-line="2760"><span class="sd">        Returns:</span>
</span><span data-line="2761"><span class="sd">            Appropriate GLiNER model instance.</span>
</span><span data-line="2762">
</span><span data-line="2763"><span class="sd">        Examples:</span>
</span><span data-line="2764"><span class="sd">            &gt;&gt;&gt; model = GLiNER.from_pretrained(&quot;urchade/gliner_small-v2.1&quot;)</span>
</span><span data-line="2765"><span class="sd">            &gt;&gt;&gt; model = GLiNER.from_pretrained(&quot;knowledgator/gliner-bi-small-v1.0&quot;)</span>
</span><span data-line="2766"><span class="sd">            &gt;&gt;&gt; model = GLiNER.from_pretrained(&quot;path/to/local/model&quot;)</span>
</span><span data-line="2767"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2768">        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
</span><span data-line="2769">        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="2770">            <span class="n">model_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
</span><span data-line="2771">                <span class="n">snapshot_download</span><span class="p">(</span>
</span><span data-line="2772">                    <span class="n">repo_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
</span><span data-line="2773">                    <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span>
</span><span data-line="2774">                    <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
</span><span data-line="2775">                    <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
</span><span data-line="2776">                    <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
</span><span data-line="2777">                    <span class="n">resume_download</span><span class="o">=</span><span class="n">resume_download</span><span class="p">,</span>
</span><span data-line="2778">                    <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
</span><span data-line="2779">                    <span class="n">local_files_only</span><span class="o">=</span><span class="n">local_files_only</span><span class="p">,</span>
</span><span data-line="2780">                <span class="p">)</span>
</span><span data-line="2781">            <span class="p">)</span>
</span><span data-line="2782">
</span><span data-line="2783">        <span class="c1"># Load config to determine model type</span>
</span><span data-line="2784">        <span class="n">config_file</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;gliner_config.json&quot;</span>
</span><span data-line="2785">        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="2786">            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No config file found in </span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="2787">
</span><span data-line="2788">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span data-line="2789">            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span data-line="2790">
</span><span data-line="2791">        <span class="n">config_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="2792">
</span><span data-line="2793">        <span class="n">config</span> <span class="o">=</span> <span class="n">GLiNERConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>
</span><span data-line="2794">
</span><span data-line="2795">        <span class="c1"># Determine the appropriate class</span>
</span><span data-line="2796">        <span class="n">gliner_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_gliner_class</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="2797">
</span><span data-line="2798">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading the following GLiNER type: </span><span class="si">%s</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">gliner_class</span><span class="p">)</span>
</span><span data-line="2799">        <span class="c1"># Delegate to the specific class&#39;s from_pretrained method</span>
</span><span data-line="2800">        <span class="k">return</span> <span class="n">gliner_class</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
</span><span data-line="2801">            <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
</span><span data-line="2802">            <span class="n">model_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="p">,</span>
</span><span data-line="2803">            <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span>
</span><span data-line="2804">            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
</span><span data-line="2805">            <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
</span><span data-line="2806">            <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
</span><span data-line="2807">            <span class="n">resume_download</span><span class="o">=</span><span class="n">resume_download</span><span class="p">,</span>
</span><span data-line="2808">            <span class="n">local_files_only</span><span class="o">=</span><span class="n">local_files_only</span><span class="p">,</span>
</span><span data-line="2809">            <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
</span><span data-line="2810">            <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span>
</span><span data-line="2811">            <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">,</span>
</span><span data-line="2812">            <span class="n">load_tokenizer</span><span class="o">=</span><span class="n">load_tokenizer</span><span class="p">,</span>
</span><span data-line="2813">            <span class="n">resize_token_embeddings</span><span class="o">=</span><span class="n">resize_token_embeddings</span><span class="p">,</span>
</span><span data-line="2814">            <span class="n">compile_torch_model</span><span class="o">=</span><span class="n">compile_torch_model</span><span class="p">,</span>
</span><span data-line="2815">            <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
</span><span data-line="2816">            <span class="n">max_width</span><span class="o">=</span><span class="n">max_width</span><span class="p">,</span>
</span><span data-line="2817">            <span class="n">post_fusion_schema</span><span class="o">=</span><span class="n">post_fusion_schema</span><span class="p">,</span>
</span><span data-line="2818">            <span class="n">_attn_implementation</span><span class="o">=</span><span class="n">_attn_implementation</span><span class="p">,</span>
</span><span data-line="2819">            <span class="n">load_onnx_model</span><span class="o">=</span><span class="n">load_onnx_model</span><span class="p">,</span>
</span><span data-line="2820">            <span class="n">onnx_model_file</span><span class="o">=</span><span class="n">onnx_model_file</span><span class="p">,</span>
</span><span data-line="2821">            <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
</span><span data-line="2822">        <span class="p">)</span></div>

</span><span data-line="2823">
<div class="viewcode-block" id="GLiNER.from_config">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.GLiNER.from_config">[docs]</a>
</span><span data-line="2824">    <span class="nd">@classmethod</span>
</span><span data-line="2825">    <span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span>
</span><span data-line="2826">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="2827">        <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">GLiNERConfig</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
</span><span data-line="2828">        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2829">        <span class="n">load_tokenizer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="2830">        <span class="n">resize_token_embeddings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="2831">        <span class="n">backbone_from_pretrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="2832">        <span class="n">compile_torch_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2833">        <span class="n">map_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
</span><span data-line="2834">        <span class="c1"># Config overrides</span>
</span><span data-line="2835">        <span class="n">max_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2836">        <span class="n">max_width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2837">        <span class="n">post_fusion_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2838">        <span class="n">_attn_implementation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2839">        <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
</span><span data-line="2840">    <span class="p">):</span>
</span><span data-line="2841"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a GLiNER model from configuration.</span>
</span><span data-line="2842">
</span><span data-line="2843"><span class="sd">        Args:</span>
</span><span data-line="2844"><span class="sd">            config: Model configuration (GLiNERConfig object, path to config file, or dict).</span>
</span><span data-line="2845"><span class="sd">            cache_dir: Cache directory for downloads.</span>
</span><span data-line="2846"><span class="sd">            load_tokenizer: Whether to load tokenizer.</span>
</span><span data-line="2847"><span class="sd">            resize_token_embeddings: Whether to resize token embeddings.</span>
</span><span data-line="2848"><span class="sd">            backbone_from_pretrained: Whether to load the backbone encoder from pretrained weights.</span>
</span><span data-line="2849"><span class="sd">            compile_torch_model: Whether to compile with torch.compile.</span>
</span><span data-line="2850"><span class="sd">            map_location: Device to map model to.</span>
</span><span data-line="2851"><span class="sd">            max_length: Override max_length in config.</span>
</span><span data-line="2852"><span class="sd">            max_width: Override max_width in config.</span>
</span><span data-line="2853"><span class="sd">            post_fusion_schema: Override post_fusion_schema in config.</span>
</span><span data-line="2854"><span class="sd">            _attn_implementation: Override attention implementation.</span>
</span><span data-line="2855"><span class="sd">            **model_kwargs: Additional model initialization arguments.</span>
</span><span data-line="2856">
</span><span data-line="2857"><span class="sd">        Returns:</span>
</span><span data-line="2858"><span class="sd">            Initialized GLiNER model instance.</span>
</span><span data-line="2859">
</span><span data-line="2860"><span class="sd">        Examples:</span>
</span><span data-line="2861"><span class="sd">            &gt;&gt;&gt; config = GLiNERConfig(model_name=&quot;microsoft/deberta-v3-small&quot;)</span>
</span><span data-line="2862"><span class="sd">            &gt;&gt;&gt; model = GLiNER.from_config(config)</span>
</span><span data-line="2863"><span class="sd">            &gt;&gt;&gt; model = GLiNER.from_config(&quot;path/to/gliner_config.json&quot;)</span>
</span><span data-line="2864"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2865">        <span class="c1"># Load config if needed</span>
</span><span data-line="2866">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
</span><span data-line="2867">            <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="2868">            <span class="k">if</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="2869">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span data-line="2870">                    <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span data-line="2871">                <span class="n">config_</span> <span class="o">=</span> <span class="n">GLiNERConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>
</span><span data-line="2872">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2873">                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config file not found: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="2874">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span data-line="2875">            <span class="n">config_</span> <span class="o">=</span> <span class="n">GLiNERConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="2876">
</span><span data-line="2877">        <span class="c1"># Determine the appropriate class</span>
</span><span data-line="2878">        <span class="n">gliner_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_gliner_class</span><span class="p">(</span><span class="n">config_</span><span class="p">)</span>
</span><span data-line="2879">
</span><span data-line="2880">        <span class="c1"># Delegate to that class&#39;s load_from_config</span>
</span><span data-line="2881">        <span class="k">return</span> <span class="n">gliner_class</span><span class="o">.</span><span class="n">load_from_config</span><span class="p">(</span>
</span><span data-line="2882">            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
</span><span data-line="2883">            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
</span><span data-line="2884">            <span class="n">load_tokenizer</span><span class="o">=</span><span class="n">load_tokenizer</span><span class="p">,</span>
</span><span data-line="2885">            <span class="n">resize_token_embeddings</span><span class="o">=</span><span class="n">resize_token_embeddings</span><span class="p">,</span>
</span><span data-line="2886">            <span class="n">backbone_from_pretrained</span><span class="o">=</span><span class="n">backbone_from_pretrained</span><span class="p">,</span>
</span><span data-line="2887">            <span class="n">compile_torch_model</span><span class="o">=</span><span class="n">compile_torch_model</span><span class="p">,</span>
</span><span data-line="2888">            <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span>
</span><span data-line="2889">            <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
</span><span data-line="2890">            <span class="n">max_width</span><span class="o">=</span><span class="n">max_width</span><span class="p">,</span>
</span><span data-line="2891">            <span class="n">post_fusion_schema</span><span class="o">=</span><span class="n">post_fusion_schema</span><span class="p">,</span>
</span><span data-line="2892">            <span class="n">_attn_implementation</span><span class="o">=</span><span class="n">_attn_implementation</span><span class="p">,</span>
</span><span data-line="2893">            <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
</span><span data-line="2894">        <span class="p">)</span></div>

</span><span data-line="2895">
</span><span data-line="2896">    <span class="nd">@property</span>
</span><span data-line="2897">    <span class="k">def</span><span class="w"> </span><span class="nf">model_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="2898"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Map configuration patterns to their corresponding GLiNER classes.</span>
</span><span data-line="2899">
</span><span data-line="2900"><span class="sd">        Returns:</span>
</span><span data-line="2901"><span class="sd">            Dictionary mapping model types to their classes and descriptions.</span>
</span><span data-line="2902"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2903">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="2904">            <span class="s2">&quot;gliner_uni_encoder_span&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2905">                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">UniEncoderSpanGLiNER</span><span class="p">,</span>
</span><span data-line="2906">                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Standard span-based NER with single encoder&quot;</span><span class="p">,</span>
</span><span data-line="2907">                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2908">                    <span class="s2">&quot;span_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;span_level&quot;</span><span class="p">,</span>
</span><span data-line="2909">                    <span class="s2">&quot;labels_encoder&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2910">                    <span class="s2">&quot;labels_decoder&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2911">                    <span class="s2">&quot;relations_layer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2912">                <span class="p">},</span>
</span><span data-line="2913">            <span class="p">},</span>
</span><span data-line="2914">            <span class="s2">&quot;gliner_uni_encoder_token&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2915">                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">UniEncoderTokenGLiNER</span><span class="p">,</span>
</span><span data-line="2916">                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Token-level NER with single encoder&quot;</span><span class="p">,</span>
</span><span data-line="2917">                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2918">                    <span class="s2">&quot;span_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;token_level&quot;</span><span class="p">,</span>
</span><span data-line="2919">                    <span class="s2">&quot;labels_encoder&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2920">                    <span class="s2">&quot;labels_decoder&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2921">                    <span class="s2">&quot;relations_layer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2922">                <span class="p">},</span>
</span><span data-line="2923">            <span class="p">},</span>
</span><span data-line="2924">            <span class="s2">&quot;gliner_bi_encoder_span&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2925">                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">BiEncoderSpanGLiNER</span><span class="p">,</span>
</span><span data-line="2926">                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Span-based NER with separate text and label encoders&quot;</span><span class="p">,</span>
</span><span data-line="2927">                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2928">                    <span class="s2">&quot;span_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;span_level&quot;</span><span class="p">,</span>
</span><span data-line="2929">                    <span class="s2">&quot;labels_encoder&quot;</span><span class="p">:</span> <span class="s2">&quot;required&quot;</span><span class="p">,</span>
</span><span data-line="2930">                    <span class="s2">&quot;labels_decoder&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2931">                    <span class="s2">&quot;relations_layer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2932">                <span class="p">},</span>
</span><span data-line="2933">            <span class="p">},</span>
</span><span data-line="2934">            <span class="s2">&quot;gliner_bi_encoder_token&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2935">                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">BiEncoderTokenGLiNER</span><span class="p">,</span>
</span><span data-line="2936">                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Token-level NER with separate text and label encoders&quot;</span><span class="p">,</span>
</span><span data-line="2937">                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2938">                    <span class="s2">&quot;span_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;token_level&quot;</span><span class="p">,</span>
</span><span data-line="2939">                    <span class="s2">&quot;labels_encoder&quot;</span><span class="p">:</span> <span class="s2">&quot;required&quot;</span><span class="p">,</span>
</span><span data-line="2940">                    <span class="s2">&quot;labels_decoder&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2941">                    <span class="s2">&quot;relations_layer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2942">                <span class="p">},</span>
</span><span data-line="2943">            <span class="p">},</span>
</span><span data-line="2944">            <span class="s2">&quot;gliner_uni_encoder_span_decoder&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2945">                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">UniEncoderSpanDecoderGLiNER</span><span class="p">,</span>
</span><span data-line="2946">                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Span-based NER with label generation decoder&quot;</span><span class="p">,</span>
</span><span data-line="2947">                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;span_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;span_level&quot;</span><span class="p">,</span> <span class="s2">&quot;labels_decoder&quot;</span><span class="p">:</span> <span class="s2">&quot;required&quot;</span><span class="p">,</span> <span class="s2">&quot;relations_layer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
</span><span data-line="2948">            <span class="p">},</span>
</span><span data-line="2949">            <span class="s2">&quot;gliner_uni_encoder_span_relex&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span data-line="2950">                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">UniEncoderSpanRelexGLiNER</span><span class="p">,</span>
</span><span data-line="2951">                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Joint entity and relation extraction with single encoder&quot;</span><span class="p">,</span>
</span><span data-line="2952">                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;span_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;span_level&quot;</span><span class="p">,</span> <span class="s2">&quot;labels_encoder&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;relations_layer&quot;</span><span class="p">:</span> <span class="s2">&quot;required&quot;</span><span class="p">},</span>
</span><span data-line="2953">            <span class="p">},</span>
</span><span data-line="2954">        <span class="p">}</span>
</span><span data-line="2955">
<div class="viewcode-block" id="GLiNER.get_model_type">
<a class="viewcode-back" href="../../api/gliner.model.html#gliner.GLiNER.get_model_type">[docs]</a>
</span><span data-line="2956">    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="2957"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="2958"><span class="sd">        Get the type of the current model instance.</span>
</span><span data-line="2959">
</span><span data-line="2960"><span class="sd">        Returns:</span>
</span><span data-line="2961"><span class="sd">            String identifier of the model type</span>
</span><span data-line="2962"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2963">        <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span data-line="2964">
</span><span data-line="2965">        <span class="n">type_mapping</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="2966">            <span class="s2">&quot;UniEncoderSpanGLiNER&quot;</span><span class="p">:</span> <span class="s2">&quot;gliner_uni_encoder_span&quot;</span><span class="p">,</span>
</span><span data-line="2967">            <span class="s2">&quot;UniEncoderTokenGLiNER&quot;</span><span class="p">:</span> <span class="s2">&quot;gliner_uni_encoder_token&quot;</span><span class="p">,</span>
</span><span data-line="2968">            <span class="s2">&quot;BiEncoderSpanGLiNER&quot;</span><span class="p">:</span> <span class="s2">&quot;gliner_bi_encoder_span&quot;</span><span class="p">,</span>
</span><span data-line="2969">            <span class="s2">&quot;BiEncoderTokenGLiNER&quot;</span><span class="p">:</span> <span class="s2">&quot;gliner_bi_encoder_token&quot;</span><span class="p">,</span>
</span><span data-line="2970">            <span class="s2">&quot;UniEncoderSpanDecoderGLiNER&quot;</span><span class="p">:</span> <span class="s2">&quot;gliner_uni_encoder_span_decoder&quot;</span><span class="p">,</span>
</span><span data-line="2971">            <span class="s2">&quot;UniEncoderSpanRelexGLiNER&quot;</span><span class="p">:</span> <span class="s2">&quot;gliner_uni_encoder_span_relex&quot;</span><span class="p">,</span>
</span><span data-line="2972">        <span class="p">}</span>
</span><span data-line="2973">
</span><span data-line="2974">        <span class="k">return</span> <span class="n">type_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span></div>

</span><span data-line="2975">
</span><span data-line="2976">    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="2977"><span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation of the model.&quot;&quot;&quot;</span>
</span><span data-line="2978">        <span class="n">model_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_type</span><span class="p">()</span>
</span><span data-line="2979">        <span class="n">model_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="p">{})</span>
</span><span data-line="2980">        <span class="n">description</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown model type&quot;</span><span class="p">)</span>
</span><span data-line="2981">
</span><span data-line="2982">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="2983">            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span data-line="2984">            <span class="sa">f</span><span class="s2">&quot;  type=</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span data-line="2985">            <span class="sa">f</span><span class="s2">&quot;  description=&#39;</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span data-line="2986">            <span class="sa">f</span><span class="s2">&quot;  config=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span data-line="2987">            <span class="sa">f</span><span class="s2">&quot;)&quot;</span>
</span><span data-line="2988">        <span class="p">)</span></div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, GLiNER community</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=dc91f075"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=9b0e4dde"></script></body>
</html>