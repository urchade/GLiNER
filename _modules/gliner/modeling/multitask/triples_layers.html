<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>gliner.modeling.multitask.triples_layers - Home 0.2.24 documentation</title><link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/shibuya.css?v=d140fbf8" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="gliner.modeling.multitask.triples_layers"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../../../index.html">
      
      
      <strong>Home</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro.html">Introduction to ðŸ‘‘ GLiNER</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../instalation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../configs.html">Components &amp; Configs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../architectures.html">Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../convert_to_onnx.html">ONNX Export &amp; Deployment</a></li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gliner.model.html">gliner.model module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gliner.config.html">gliner.config module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gliner.training.html">gliner.training package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.training.trainer.html">gliner.training.trainer module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gliner.modeling.html">gliner.modeling package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.modeling.multitask.html">gliner.modeling.multitask package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/gliner.modeling.multitask.relations_layers.html">gliner.modeling.multitask.relations_layers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/gliner.modeling.multitask.triples_layers.html">gliner.modeling.multitask.triples_layers module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.modeling.base.html">gliner.modeling.base module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.modeling.decoder.html">gliner.modeling.decoder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.modeling.encoder.html">gliner.modeling.encoder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.modeling.layers.html">gliner.modeling.layers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.modeling.loss_functions.html">gliner.modeling.loss_functions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.modeling.outputs.html">gliner.modeling.outputs module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.modeling.scorers.html">gliner.modeling.scorers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.modeling.span_rep.html">gliner.modeling.span_rep module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.modeling.utils.html">gliner.modeling.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gliner.data_processing.html">gliner.data_processing package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.data_processing.collator.html">gliner.data_processing.collator module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.data_processing.processor.html">gliner.data_processing.processor module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.data_processing.tokenizer.html">gliner.data_processing.tokenizer module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.data_processing.utils.html">gliner.data_processing.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gliner.evaluation.html">gliner.evaluation package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.evaluation.evaluate_ner.html">gliner.evaluation.evaluate_ner module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.evaluation.evaluator.html">gliner.evaluation.evaluator module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.evaluation.utils.html">gliner.evaluation.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gliner.onnx.html">gliner.onnx package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.onnx.model.html">gliner.onnx.model module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gliner.decoding.html">gliner.decoding package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.decoding.trie.html">gliner.decoding.trie package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/gliner.decoding.trie.labels_trie.html">gliner.decoding.trie.labels_trie module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/gliner.decoding.trie.python_labels_trie.html">gliner.decoding.trie.python_labels_trie module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.decoding.decoder.html">gliner.decoding.decoder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gliner.decoding.utils.html">gliner.decoding.utils module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/gliner.utils.html">gliner.utils module</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../../index.html"><span itemprop="name">Home</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">gliner.modeling.multitask.triples_layers</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for gliner.modeling.multitask.triples_layers</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="2">
</span><span data-line="3"><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">fft</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
</span><span data-line="6">
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">..layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_projection_layer</span>
</span><span data-line="8">
</span><span data-line="9">
</span><span data-line="10"><span class="k">def</span><span class="w"> </span><span class="nf">_split_complex</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span data-line="11"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Assume last dim = 2k and split into real / imag parts.&quot;&quot;&quot;</span>
</span><span data-line="12">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="13">
</span><span data-line="14">
</span><span data-line="15"><span class="k">def</span><span class="w"> </span><span class="nf">_split_quaternion</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span data-line="16"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Assume last dim = 4k and split into (1,i,j,k) parts.&quot;&quot;&quot;</span>
</span><span data-line="17">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="18">
</span><span data-line="19">
</span><span data-line="20"><span class="k">def</span><span class="w"> </span><span class="nf">_norm_clamp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">max_norm</span><span class="p">):</span>
</span><span data-line="21">    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="n">max_norm</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
</span><span data-line="22">
</span><span data-line="23">
<div class="viewcode-block" id="NormBasedInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.NormBasedInteraction">[docs]</a>
</span><span data-line="24"><span class="k">class</span><span class="w"> </span><span class="nc">NormBasedInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<div class="viewcode-block" id="NormBasedInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.NormBasedInteraction.__init__">[docs]</a>
</span><span data-line="25">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="26">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="27">        <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="28">        <span class="n">p</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span data-line="29">        <span class="n">power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span data-line="30">        <span class="n">clamp_norm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
</span><span data-line="31">        <span class="n">use_scorer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="32">        <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
</span><span data-line="33">    <span class="p">):</span>
</span><span data-line="34"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="35"><span class="sd">        Base class for norm-based KGE interactions.</span>
</span><span data-line="36">
</span><span data-line="37"><span class="sd">        Args:</span>
</span><span data-line="38"><span class="sd">            dim: Embedding dimension</span>
</span><span data-line="39"><span class="sd">            p: â„“_p norm (e.g. 1 or 2) used in â€–Â·â€–_p</span>
</span><span data-line="40"><span class="sd">            power: Raise norm to this power before negating</span>
</span><span data-line="41"><span class="sd">            clamp_norm: Optional upper bound for numerical stability</span>
</span><span data-line="42"><span class="sd">            use_scorer: If True, use learned projection instead of norm</span>
</span><span data-line="43"><span class="sd">            dropout: Dropout rate for scorer (if used)</span>
</span><span data-line="44"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="45">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="46">        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
</span><span data-line="47">        <span class="bp">self</span><span class="o">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">power</span>
</span><span data-line="48">        <span class="bp">self</span><span class="o">.</span><span class="n">clamp</span> <span class="o">=</span> <span class="n">clamp_norm</span>
</span><span data-line="49">
</span><span data-line="50">        <span class="c1"># Optional learned scorer instead of norm</span>
</span><span data-line="51">        <span class="k">if</span> <span class="n">use_scorer</span><span class="p">:</span>
</span><span data-line="52">            <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span> <span class="o">=</span> <span class="n">create_projection_layer</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="53">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="54">            <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span> <span class="o">=</span> <span class="kc">None</span></div>

</span><span data-line="55">
</span><span data-line="56">    <span class="k">def</span><span class="w"> </span><span class="nf">_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span data-line="57"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="58"><span class="sd">        Score residual vector.</span>
</span><span data-line="59">
</span><span data-line="60"><span class="sd">        Args:</span>
</span><span data-line="61"><span class="sd">            x: (..., D) residual vector</span>
</span><span data-line="62">
</span><span data-line="63"><span class="sd">        Returns:</span>
</span><span data-line="64"><span class="sd">            scores: (...) scalar scores (higher = better)</span>
</span><span data-line="65"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="66">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="67">            <span class="c1"># Use learned projection</span>
</span><span data-line="68">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="69">
</span><span data-line="70">        <span class="c1"># Use norm-based scoring</span>
</span><span data-line="71">        <span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="72">        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">)</span>
</span><span data-line="73">        <span class="n">d</span> <span class="o">=</span> <span class="n">_norm_clamp</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamp</span><span class="p">)</span>
</span><span data-line="74">        <span class="k">return</span> <span class="o">-</span><span class="n">d</span>  <span class="c1"># Negative distance (higher = better)</span></div>

</span><span data-line="75">
</span><span data-line="76">
<div class="viewcode-block" id="UMInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.UMInteraction">[docs]</a>
</span><span data-line="77"><span class="k">class</span><span class="w"> </span><span class="nc">UMInteraction</span><span class="p">(</span><span class="n">NormBasedInteraction</span><span class="p">):</span>
</span><span data-line="78"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Unstructured model â€–h - tâ€–.&quot;&quot;&quot;</span>
</span><span data-line="79">
<div class="viewcode-block" id="UMInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.UMInteraction.__init__">[docs]</a>
</span><span data-line="80">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="81">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

</span><span data-line="82">
<div class="viewcode-block" id="UMInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.UMInteraction.forward">[docs]</a>
</span><span data-line="83">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="84">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span><span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span></div>
</div>

</span><span data-line="85">
</span><span data-line="86">
<div class="viewcode-block" id="SEInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.SEInteraction">[docs]</a>
</span><span data-line="87"><span class="k">class</span><span class="w"> </span><span class="nc">SEInteraction</span><span class="p">(</span><span class="n">NormBasedInteraction</span><span class="p">):</span>
</span><span data-line="88"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Structure Embedding (SE).</span>
</span><span data-line="89">
</span><span data-line="90"><span class="sd">    Uses head / tail specific diagonal matrices built from relation.</span>
</span><span data-line="91"><span class="sd">    h&#39; = diag(r) Â· h    ,    t&#39; = diag(r) Â· t</span>
</span><span data-line="92"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="93">
<div class="viewcode-block" id="SEInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.SEInteraction.__init__">[docs]</a>
</span><span data-line="94">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="95">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

</span><span data-line="96">
<div class="viewcode-block" id="SEInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.SEInteraction.forward">[docs]</a>
</span><span data-line="97">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="98">        <span class="n">diag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag_embed</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D, D)</span>
</span><span data-line="99">        <span class="n">h_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">diag</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="100">        <span class="n">t_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">diag</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="101">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span><span class="p">(</span><span class="n">h_</span> <span class="o">-</span> <span class="n">t_</span><span class="p">)</span></div>
</div>

</span><span data-line="102">
</span><span data-line="103">
<div class="viewcode-block" id="TransEInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TransEInteraction">[docs]</a>
</span><span data-line="104"><span class="k">class</span><span class="w"> </span><span class="nc">TransEInteraction</span><span class="p">(</span><span class="n">NormBasedInteraction</span><span class="p">):</span>
</span><span data-line="105"><span class="w">    </span><span class="sd">&quot;&quot;&quot;TransE â€–h + r âˆ’ tâ€–.&quot;&quot;&quot;</span>
</span><span data-line="106">
<div class="viewcode-block" id="TransEInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TransEInteraction.__init__">[docs]</a>
</span><span data-line="107">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="108">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

</span><span data-line="109">
<div class="viewcode-block" id="TransEInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TransEInteraction.forward">[docs]</a>
</span><span data-line="110">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="111">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span><span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">r</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span></div>
</div>

</span><span data-line="112">
</span><span data-line="113">
<div class="viewcode-block" id="TransHInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TransHInteraction">[docs]</a>
</span><span data-line="114"><span class="k">class</span><span class="w"> </span><span class="nc">TransHInteraction</span><span class="p">(</span><span class="n">NormBasedInteraction</span><span class="p">):</span>
</span><span data-line="115"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="116"><span class="sd">    TransH â€“ project entities to a relation-specific hyperplane.</span>
</span><span data-line="117">
</span><span data-line="118"><span class="sd">    Learn mappings from base relation r to:</span>
</span><span data-line="119"><span class="sd">        r_tr = W_tr * r + b_tr  (translation)</span>
</span><span data-line="120"><span class="sd">        w    = W_w  * r + b_w   (hyperplane normal)</span>
</span><span data-line="121"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="122">
<div class="viewcode-block" id="TransHInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TransHInteraction.__init__">[docs]</a>
</span><span data-line="123">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="124">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">power</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="125">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_rtr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span data-line="126">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_w</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span></div>

</span><span data-line="127">
<div class="viewcode-block" id="TransHInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TransHInteraction.forward">[docs]</a>
</span><span data-line="128">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="129">        <span class="c1"># Map base relation vector -&gt; translation &amp; normal</span>
</span><span data-line="130">        <span class="n">r_tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_rtr</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D)</span>
</span><span data-line="131">        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_w</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D)</span>
</span><span data-line="132">        <span class="n">w</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="133">
</span><span data-line="134">        <span class="k">def</span><span class="w"> </span><span class="nf">proj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span data-line="135">            <span class="c1"># Project: x_proj = x - (xÂ·w) w</span>
</span><span data-line="136">            <span class="n">dot</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="137">            <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">dot</span> <span class="o">*</span> <span class="n">w</span>
</span><span data-line="138">
</span><span data-line="139">        <span class="n">h_proj</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span><span data-line="140">        <span class="n">t_proj</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span data-line="141">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span><span class="p">(</span><span class="n">h_proj</span> <span class="o">+</span> <span class="n">r_tr</span> <span class="o">-</span> <span class="n">t_proj</span><span class="p">)</span></div>
</div>

</span><span data-line="142">
</span><span data-line="143">
<div class="viewcode-block" id="TransFInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TransFInteraction">[docs]</a>
</span><span data-line="144"><span class="k">class</span><span class="w"> </span><span class="nc">TransFInteraction</span><span class="p">(</span><span class="n">NormBasedInteraction</span><span class="p">):</span>
</span><span data-line="145"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="146"><span class="sd">    TransF â€“ element-wise relation-specific scaling before translation.</span>
</span><span data-line="147">
</span><span data-line="148"><span class="sd">    Learn mappings from base relation r to:</span>
</span><span data-line="149"><span class="sd">        r_vec = W_r * r + b_r</span>
</span><span data-line="150"><span class="sd">        alpha = W_alpha * r + b_alpha</span>
</span><span data-line="151"><span class="sd">        beta  = W_beta * r + b_beta</span>
</span><span data-line="152">
</span><span data-line="153"><span class="sd">    Score is â€–(alpha âˆ˜ h) + r_vec âˆ’ (beta âˆ˜ t)â€–_p</span>
</span><span data-line="154"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="155">
<div class="viewcode-block" id="TransFInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TransFInteraction.__init__">[docs]</a>
</span><span data-line="156">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="157">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">power</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="158">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_rvec</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span data-line="159">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_alpha</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span data-line="160">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_beta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span data-line="161">
</span><span data-line="162">        <span class="c1"># Initialize to start close to plain TransE</span>
</span><span data-line="163">        <span class="c1"># r_vec â‰ˆ r (identity), alpha â‰ˆ 1, beta â‰ˆ 1</span>
</span><span data-line="164">        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_rvec</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span data-line="165">            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">eye_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_to_rvec</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
</span><span data-line="166">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="167">            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_to_rvec</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
</span><span data-line="168">        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_to_rvec</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
</span><span data-line="169">
</span><span data-line="170">        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_to_alpha</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
</span><span data-line="171">        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">ones_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_to_alpha</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
</span><span data-line="172">
</span><span data-line="173">        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_to_beta</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
</span><span data-line="174">        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">ones_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_to_beta</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span></div>

</span><span data-line="175">
<div class="viewcode-block" id="TransFInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TransFInteraction.forward">[docs]</a>
</span><span data-line="176">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="177">        <span class="n">r_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_rvec</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D)</span>
</span><span data-line="178">        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_alpha</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D)</span>
</span><span data-line="179">        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_beta</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D)</span>
</span><span data-line="180">
</span><span data-line="181">        <span class="n">h_</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">h</span>
</span><span data-line="182">        <span class="n">t_</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">t</span>
</span><span data-line="183">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span><span class="p">(</span><span class="n">h_</span> <span class="o">+</span> <span class="n">r_vec</span> <span class="o">-</span> <span class="n">t_</span><span class="p">)</span></div>
</div>

</span><span data-line="184">
</span><span data-line="185">
<div class="viewcode-block" id="PairREInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.PairREInteraction">[docs]</a>
</span><span data-line="186"><span class="k">class</span><span class="w"> </span><span class="nc">PairREInteraction</span><span class="p">(</span><span class="n">NormBasedInteraction</span><span class="p">):</span>
</span><span data-line="187"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="188"><span class="sd">    PairRE â€“ per-relation element-wise scaling of h &amp; t.</span>
</span><span data-line="189">
</span><span data-line="190"><span class="sd">    Learn mappings from base relation r to:</span>
</span><span data-line="191"><span class="sd">        alpha = W_alpha * r + b_alpha</span>
</span><span data-line="192"><span class="sd">        beta  = W_beta * r + b_beta</span>
</span><span data-line="193"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="194">
<div class="viewcode-block" id="PairREInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.PairREInteraction.__init__">[docs]</a>
</span><span data-line="195">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="196">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">power</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="197">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_alpha</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span data-line="198">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_beta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span></div>

</span><span data-line="199">
<div class="viewcode-block" id="PairREInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.PairREInteraction.forward">[docs]</a>
</span><span data-line="200">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="201">        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_alpha</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D)</span>
</span><span data-line="202">        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_beta</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D)</span>
</span><span data-line="203">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">h</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span></div>
</div>

</span><span data-line="204">
</span><span data-line="205">
<div class="viewcode-block" id="TripleREInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TripleREInteraction">[docs]</a>
</span><span data-line="206"><span class="k">class</span><span class="w"> </span><span class="nc">TripleREInteraction</span><span class="p">(</span><span class="n">NormBasedInteraction</span><span class="p">):</span>
</span><span data-line="207"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="208"><span class="sd">    TripleRE â€“ LineaRE + scalar Î³ per relation.</span>
</span><span data-line="209">
</span><span data-line="210"><span class="sd">    Learn mappings from base relation r to:</span>
</span><span data-line="211"><span class="sd">        alpha = W_alpha * r + b_alpha</span>
</span><span data-line="212"><span class="sd">        beta  = W_beta * r + b_beta</span>
</span><span data-line="213"><span class="sd">        delta = W_delta * r + b_delta</span>
</span><span data-line="214"><span class="sd">        gamma = w_gamma^T * r + b_gamma (scalar)</span>
</span><span data-line="215"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="216">
<div class="viewcode-block" id="TripleREInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TripleREInteraction.__init__">[docs]</a>
</span><span data-line="217">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="218">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">power</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="219">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_alpha</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span data-line="220">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_beta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span data-line="221">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_delta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span data-line="222">        <span class="bp">self</span><span class="o">.</span><span class="n">r_to_gamma</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

</span><span data-line="223">
<div class="viewcode-block" id="TripleREInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TripleREInteraction.forward">[docs]</a>
</span><span data-line="224">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="225">        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_alpha</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D)</span>
</span><span data-line="226">        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_beta</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D)</span>
</span><span data-line="227">        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_delta</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., D)</span>
</span><span data-line="228">        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_to_gamma</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># (..., 1)</span>
</span><span data-line="229">
</span><span data-line="230">        <span class="n">base_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">h</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>  <span class="c1"># (...)</span>
</span><span data-line="231">        <span class="k">return</span> <span class="n">gamma</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">base_score</span></div>
</div>

</span><span data-line="232">
</span><span data-line="233">
<div class="viewcode-block" id="DistMultInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.DistMultInteraction">[docs]</a>
</span><span data-line="234"><span class="k">class</span><span class="w"> </span><span class="nc">DistMultInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="235"><span class="w">    </span><span class="sd">&quot;&quot;&quot;DistMult â€“ Î£_d h_d r_d t_d.&quot;&quot;&quot;</span>
</span><span data-line="236">
<div class="viewcode-block" id="DistMultInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.DistMultInteraction.forward">[docs]</a>
</span><span data-line="237">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="238">        <span class="k">return</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>
</div>

</span><span data-line="239">
</span><span data-line="240">
<div class="viewcode-block" id="SimplEInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.SimplEInteraction">[docs]</a>
</span><span data-line="241"><span class="k">class</span><span class="w"> </span><span class="nc">SimplEInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="242"><span class="w">    </span><span class="sd">&quot;&quot;&quot;SimplE â€“ split every embedding into (forward, backward) halves.</span>
</span><span data-line="243">
</span><span data-line="244"><span class="sd">    score = Â½( âŸ¨h_f, r_f, t_bâŸ© + âŸ¨t_f, r_b, h_bâŸ© )</span>
</span><span data-line="245"><span class="sd">    Requires even dimension.</span>
</span><span data-line="246"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="247">
<div class="viewcode-block" id="SimplEInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.SimplEInteraction.__init__">[docs]</a>
</span><span data-line="248">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">):</span>
</span><span data-line="249">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="250">        <span class="k">if</span> <span class="n">dim</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="251">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SimplE requires even dimension, got </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

</span><span data-line="252">
<div class="viewcode-block" id="SimplEInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.SimplEInteraction.forward">[docs]</a>
</span><span data-line="253">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="254">        <span class="n">h_f</span><span class="p">,</span> <span class="n">h_b</span> <span class="o">=</span> <span class="n">_split_complex</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span><span data-line="255">        <span class="n">t_f</span><span class="p">,</span> <span class="n">t_b</span> <span class="o">=</span> <span class="n">_split_complex</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span data-line="256">        <span class="n">r_f</span><span class="p">,</span> <span class="n">r_b</span> <span class="o">=</span> <span class="n">_split_complex</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span><span data-line="257">        <span class="n">s1</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_f</span> <span class="o">*</span> <span class="n">r_f</span> <span class="o">*</span> <span class="n">t_b</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="258">        <span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_f</span> <span class="o">*</span> <span class="n">r_b</span> <span class="o">*</span> <span class="n">h_b</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="259">        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">s1</span> <span class="o">+</span> <span class="n">s2</span><span class="p">)</span></div>
</div>

</span><span data-line="260">
</span><span data-line="261">
<div class="viewcode-block" id="TuckERInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TuckERInteraction">[docs]</a>
</span><span data-line="262"><span class="k">class</span><span class="w"> </span><span class="nc">TuckERInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="263"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="264"><span class="sd">    TuckER â€“ global core tensor W (D_r Ã— D_e Ã— D_e).</span>
</span><span data-line="265"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="266">
<div class="viewcode-block" id="TuckERInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TuckERInteraction.__init__">[docs]</a>
</span><span data-line="267">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_e</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">d_r</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
</span><span data-line="268">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="269">        <span class="bp">self</span><span class="o">.</span><span class="n">d_e</span> <span class="o">=</span> <span class="n">d_e</span>
</span><span data-line="270">        <span class="bp">self</span><span class="o">.</span><span class="n">d_r</span> <span class="o">=</span> <span class="n">d_r</span>
</span><span data-line="271">        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">d_r</span><span class="p">,</span> <span class="n">d_e</span><span class="p">,</span> <span class="n">d_e</span><span class="p">))</span>
</span><span data-line="272">        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span data-line="273">        <span class="bp">self</span><span class="o">.</span><span class="n">bn0</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">d_e</span><span class="p">)</span>
</span><span data-line="274">        <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">d_e</span><span class="p">)</span>
</span><span data-line="275">        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
</span><span data-line="276">        <span class="bp">self</span><span class="o">.</span><span class="n">input_dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span></div>

</span><span data-line="277">
<div class="viewcode-block" id="TuckERInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TuckERInteraction.forward">[docs]</a>
</span><span data-line="278">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="279">        <span class="c1"># Store original shape for reshaping later</span>
</span><span data-line="280">        <span class="n">orig_shape</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="281">
</span><span data-line="282">        <span class="c1"># Flatten to 2D for BatchNorm: (batch_size, d_e)</span>
</span><span data-line="283">        <span class="n">h_2d</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_e</span><span class="p">)</span>
</span><span data-line="284">        <span class="n">t_2d</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_e</span><span class="p">)</span>
</span><span data-line="285">
</span><span data-line="286">        <span class="c1"># Apply BatchNorm and dropout</span>
</span><span data-line="287">        <span class="n">h_bn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn0</span><span class="p">(</span><span class="n">h_2d</span><span class="p">)</span>
</span><span data-line="288">        <span class="n">t_bn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="n">t_2d</span><span class="p">)</span>
</span><span data-line="289">
</span><span data-line="290">        <span class="c1"># Reshape back to original shape (except last dim)</span>
</span><span data-line="291">        <span class="n">h_bn</span> <span class="o">=</span> <span class="n">h_bn</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">orig_shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_e</span><span class="p">)</span>
</span><span data-line="292">        <span class="n">t_bn</span> <span class="o">=</span> <span class="n">t_bn</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">orig_shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_e</span><span class="p">)</span>
</span><span data-line="293">
</span><span data-line="294">        <span class="c1"># Apply input dropout</span>
</span><span data-line="295">        <span class="n">h_bn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dropout</span><span class="p">(</span><span class="n">h_bn</span><span class="p">)</span>
</span><span data-line="296">        <span class="n">t_bn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dropout</span><span class="p">(</span><span class="n">t_bn</span><span class="p">)</span>
</span><span data-line="297">
</span><span data-line="298">        <span class="c1"># Reshape r for matrix multiplication</span>
</span><span data-line="299">        <span class="n">r_shape</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="300">        <span class="n">r_2d</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_r</span><span class="p">)</span>
</span><span data-line="301">
</span><span data-line="302">        <span class="c1"># Core interaction: r x W â†’ (batch, d_e, d_e)</span>
</span><span data-line="303">        <span class="n">W_mat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">r_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>  <span class="c1"># (batch, d_e, d_e)</span>
</span><span data-line="304">        <span class="n">W_mat</span> <span class="o">=</span> <span class="n">W_mat</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">r_shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_e</span><span class="p">)</span>
</span><span data-line="305">
</span><span data-line="306">        <span class="c1"># Apply dropout on core tensor output</span>
</span><span data-line="307">        <span class="n">W_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">W_mat</span><span class="p">)</span>
</span><span data-line="308">
</span><span data-line="309">        <span class="c1"># Compute h x W_mat</span>
</span><span data-line="310">        <span class="n">hr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">h_bn</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">W_mat</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="311">
</span><span data-line="312">        <span class="c1"># Final score</span>
</span><span data-line="313">        <span class="n">scores</span> <span class="o">=</span> <span class="p">(</span><span class="n">hr</span> <span class="o">*</span> <span class="n">t_bn</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="314">        <span class="k">return</span> <span class="n">scores</span></div>
</div>

</span><span data-line="315">
</span><span data-line="316">
<div class="viewcode-block" id="DistMAInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.DistMAInteraction">[docs]</a>
</span><span data-line="317"><span class="k">class</span><span class="w"> </span><span class="nc">DistMAInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="318"><span class="w">    </span><span class="sd">&quot;&quot;&quot;DistMA â€“ sum of pairwise dot products.&quot;&quot;&quot;</span>
</span><span data-line="319">
<div class="viewcode-block" id="DistMAInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.DistMAInteraction.forward">[docs]</a>
</span><span data-line="320">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="321">        <span class="k">return</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>
</div>

</span><span data-line="322">
</span><span data-line="323">
<div class="viewcode-block" id="ComplExInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ComplExInteraction">[docs]</a>
</span><span data-line="324"><span class="k">class</span><span class="w"> </span><span class="nc">ComplExInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="325"><span class="w">    </span><span class="sd">&quot;&quot;&quot;ComplEx â€“ Re(âŸ¨h, r, conj(t)âŸ©) with complex embeddings.</span>
</span><span data-line="326">
</span><span data-line="327"><span class="sd">    Requires even dimension.</span>
</span><span data-line="328"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="329">
<div class="viewcode-block" id="ComplExInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ComplExInteraction.__init__">[docs]</a>
</span><span data-line="330">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">):</span>
</span><span data-line="331">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="332">        <span class="k">if</span> <span class="n">dim</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="333">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ComplEx requires even dimension, got </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

</span><span data-line="334">
<div class="viewcode-block" id="ComplExInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ComplExInteraction.forward">[docs]</a>
</span><span data-line="335">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="336">        <span class="n">h_re</span><span class="p">,</span> <span class="n">h_im</span> <span class="o">=</span> <span class="n">_split_complex</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span><span data-line="337">        <span class="n">r_re</span><span class="p">,</span> <span class="n">r_im</span> <span class="o">=</span> <span class="n">_split_complex</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span><span data-line="338">        <span class="n">t_re</span><span class="p">,</span> <span class="n">t_im</span> <span class="o">=</span> <span class="n">_split_complex</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span data-line="339">        <span class="k">return</span> <span class="p">(</span><span class="n">h_re</span> <span class="o">*</span> <span class="n">r_re</span> <span class="o">*</span> <span class="n">t_re</span> <span class="o">+</span> <span class="n">h_re</span> <span class="o">*</span> <span class="n">r_im</span> <span class="o">*</span> <span class="n">t_im</span> <span class="o">+</span> <span class="n">h_im</span> <span class="o">*</span> <span class="n">r_re</span> <span class="o">*</span> <span class="n">t_im</span> <span class="o">-</span> <span class="n">h_im</span> <span class="o">*</span> <span class="n">r_im</span> <span class="o">*</span> <span class="n">t_re</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>
</div>

</span><span data-line="340">
</span><span data-line="341">
<div class="viewcode-block" id="QuatEInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.QuatEInteraction">[docs]</a>
</span><span data-line="342"><span class="k">class</span><span class="w"> </span><span class="nc">QuatEInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="343"><span class="w">    </span><span class="sd">&quot;&quot;&quot;QuatE â€“ use Hamilton product (a,b,c,d)â¨‚(e,f,g,h).</span>
</span><span data-line="344">
</span><span data-line="345"><span class="sd">    Requires dimension divisible by 4.</span>
</span><span data-line="346"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="347">
<div class="viewcode-block" id="QuatEInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.QuatEInteraction.__init__">[docs]</a>
</span><span data-line="348">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">):</span>
</span><span data-line="349">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="350">        <span class="k">if</span> <span class="n">dim</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="351">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;QuatE requires dimension divisible by 4, got </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

</span><span data-line="352">
<div class="viewcode-block" id="QuatEInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.QuatEInteraction.forward">[docs]</a>
</span><span data-line="353">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="354">        <span class="n">h0</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span> <span class="o">=</span> <span class="n">_split_quaternion</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span><span data-line="355">        <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span> <span class="o">=</span> <span class="n">_split_quaternion</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span><span data-line="356">        <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span> <span class="o">=</span> <span class="n">_split_quaternion</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span data-line="357">        <span class="c1"># Hamilton product h â¨‚ r</span>
</span><span data-line="358">        <span class="n">A0</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">-</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">r1</span> <span class="o">-</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">r2</span> <span class="o">-</span> <span class="n">h3</span> <span class="o">*</span> <span class="n">r3</span>
</span><span data-line="359">        <span class="n">A1</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">r3</span> <span class="o">-</span> <span class="n">h3</span> <span class="o">*</span> <span class="n">r2</span>
</span><span data-line="360">        <span class="n">A2</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">r2</span> <span class="o">-</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">r3</span> <span class="o">+</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">h3</span> <span class="o">*</span> <span class="n">r1</span>
</span><span data-line="361">        <span class="n">A3</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">r3</span> <span class="o">+</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">r2</span> <span class="o">-</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">h3</span> <span class="o">*</span> <span class="n">r0</span>
</span><span data-line="362">        <span class="k">return</span> <span class="p">(</span><span class="n">A0</span> <span class="o">*</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">A3</span> <span class="o">*</span> <span class="n">t3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>
</div>

</span><span data-line="363">
</span><span data-line="364">
<div class="viewcode-block" id="HolEInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.HolEInteraction">[docs]</a>
</span><span data-line="365"><span class="k">class</span><span class="w"> </span><span class="nc">HolEInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="366"><span class="w">    </span><span class="sd">&quot;&quot;&quot;HolE â€“ circular correlation Ï•(h, t) Â· r.&quot;&quot;&quot;</span>
</span><span data-line="367">
<div class="viewcode-block" id="HolEInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.HolEInteraction.forward">[docs]</a>
</span><span data-line="368">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="369">        <span class="c1"># Convert to float32 for FFT stability</span>
</span><span data-line="370">        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="371">        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="372">        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="373">
</span><span data-line="374">        <span class="c1"># FFT-based circular correlation</span>
</span><span data-line="375">        <span class="n">fft_h</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="376">        <span class="n">fft_t</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="377">        <span class="n">corr</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">fft_h</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">fft_t</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="378">        <span class="k">return</span> <span class="p">(</span><span class="n">corr</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>
</div>

</span><span data-line="379">
</span><span data-line="380">
<div class="viewcode-block" id="ERMLPInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ERMLPInteraction">[docs]</a>
</span><span data-line="381"><span class="k">class</span><span class="w"> </span><span class="nc">ERMLPInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="382"><span class="w">    </span><span class="sd">&quot;&quot;&quot;ER-MLP: 2-layer perceptron on concatenated [h, r, t].&quot;&quot;&quot;</span>
</span><span data-line="383">
<div class="viewcode-block" id="ERMLPInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ERMLPInteraction.__init__">[docs]</a>
</span><span data-line="384">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hidden</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">):</span>
</span><span data-line="385">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="386">        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">hidden</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></div>

</span><span data-line="387">
<div class="viewcode-block" id="ERMLPInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ERMLPInteraction.forward">[docs]</a>
</span><span data-line="388">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="389">        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="390">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>
</div>

</span><span data-line="391">
</span><span data-line="392">
<div class="viewcode-block" id="ConvKBInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ConvKBInteraction">[docs]</a>
</span><span data-line="393"><span class="k">class</span><span class="w"> </span><span class="nc">ConvKBInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="394"><span class="w">    </span><span class="sd">&quot;&quot;&quot;ConvKB: Convolutional Knowledge Base interaction (Conv1d version).&quot;&quot;&quot;</span>
</span><span data-line="395">
<div class="viewcode-block" id="ConvKBInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ConvKBInteraction.__init__">[docs]</a>
</span><span data-line="396">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_filters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span><span data-line="397">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="398">
</span><span data-line="399">        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
</span><span data-line="400">        <span class="bp">self</span><span class="o">.</span><span class="n">n_filters</span> <span class="o">=</span> <span class="n">n_filters</span>
</span><span data-line="401">
</span><span data-line="402">        <span class="c1"># Dropout layer</span>
</span><span data-line="403">        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
</span><span data-line="404">
</span><span data-line="405">        <span class="c1"># Conv1d over the 3-embedding dimension</span>
</span><span data-line="406">        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span>
</span><span data-line="407">            <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># [h, r, t]</span>
</span><span data-line="408">            <span class="n">out_channels</span><span class="o">=</span><span class="n">n_filters</span><span class="p">,</span>
</span><span data-line="409">            <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span data-line="410">            <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span data-line="411">            <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span data-line="412">            <span class="n">bias</span><span class="o">=</span><span class="n">use_bias</span><span class="p">,</span>
</span><span data-line="413">        <span class="p">)</span>
</span><span data-line="414">
</span><span data-line="415">        <span class="c1"># Project concatenated feature maps to score</span>
</span><span data-line="416">        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_filters</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

</span><span data-line="417">
<div class="viewcode-block" id="ConvKBInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ConvKBInteraction.forward">[docs]</a>
</span><span data-line="418">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="419"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="420"><span class="sd">        Score triples (h, r, t).</span>
</span><span data-line="421">
</span><span data-line="422"><span class="sd">        Args:</span>
</span><span data-line="423"><span class="sd">            h: Head entities (..., D)</span>
</span><span data-line="424"><span class="sd">            r: Relations (..., D)</span>
</span><span data-line="425"><span class="sd">            t: Tail entities (..., D)</span>
</span><span data-line="426">
</span><span data-line="427"><span class="sd">        Returns:</span>
</span><span data-line="428"><span class="sd">            scores: Triple scores (...)</span>
</span><span data-line="429"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="430">        <span class="c1"># Store original shape</span>
</span><span data-line="431">        <span class="n">orig_shape</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="432">
</span><span data-line="433">        <span class="c1"># Flatten to batch dimension</span>
</span><span data-line="434">        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="435">        <span class="n">h_flat</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="436">        <span class="n">r_flat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="437">        <span class="n">t_flat</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="438">
</span><span data-line="439">        <span class="c1"># Stack [h, r, t]: (B, 3, k)</span>
</span><span data-line="440">        <span class="n">stacked</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">h_flat</span><span class="p">,</span> <span class="n">r_flat</span><span class="p">,</span> <span class="n">t_flat</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, 3, k)</span>
</span><span data-line="441">
</span><span data-line="442">        <span class="c1"># Apply 1D convolution: (B, n_filters, k)</span>
</span><span data-line="443">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">stacked</span><span class="p">)</span>
</span><span data-line="444">        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="445">
</span><span data-line="446">        <span class="c1"># Flatten: (B, n_filters * k)</span>
</span><span data-line="447">        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="448">
</span><span data-line="449">        <span class="c1"># Apply dropout</span>
</span><span data-line="450">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="451">
</span><span data-line="452">        <span class="c1"># Project to score</span>
</span><span data-line="453">        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B,)</span>
</span><span data-line="454">
</span><span data-line="455">        <span class="c1"># Reshape back to original shape</span>
</span><span data-line="456">        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">orig_shape</span><span class="p">)</span>
</span><span data-line="457">
</span><span data-line="458">        <span class="k">return</span> <span class="n">scores</span></div>
</div>

</span><span data-line="459">
</span><span data-line="460">
<div class="viewcode-block" id="ConvEInteraction">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ConvEInteraction">[docs]</a>
</span><span data-line="461"><span class="k">class</span><span class="w"> </span><span class="nc">ConvEInteraction</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="462"><span class="w">    </span><span class="sd">&quot;&quot;&quot;ConvE: Convolutional interaction matching reference implementation.</span>
</span><span data-line="463">
</span><span data-line="464"><span class="sd">    Stacks head and relation embeddings vertically and applies 2D convolution.</span>
</span><span data-line="465"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="466">
<div class="viewcode-block" id="ConvEInteraction.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ConvEInteraction.__init__">[docs]</a>
</span><span data-line="467">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="468">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="469">        <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="470">        <span class="n">emb_dim1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="471">        <span class="n">n_filters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span data-line="472">        <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span data-line="473">        <span class="n">input_drop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
</span><span data-line="474">        <span class="n">hidden_drop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
</span><span data-line="475">        <span class="n">feat_drop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
</span><span data-line="476">        <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="477">    <span class="p">):</span>
</span><span data-line="478">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="479">
</span><span data-line="480">        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
</span><span data-line="481">        <span class="bp">self</span><span class="o">.</span><span class="n">emb_dim1</span> <span class="o">=</span> <span class="n">emb_dim1</span>
</span><span data-line="482">        <span class="bp">self</span><span class="o">.</span><span class="n">emb_dim2</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">//</span> <span class="n">emb_dim1</span>
</span><span data-line="483">
</span><span data-line="484">        <span class="k">if</span> <span class="n">dim</span> <span class="o">%</span> <span class="n">emb_dim1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="485">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Embedding dim </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2"> must be divisible by emb_dim1 </span><span class="si">{</span><span class="n">emb_dim1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="486">
</span><span data-line="487">        <span class="c1"># Dropout layers</span>
</span><span data-line="488">        <span class="bp">self</span><span class="o">.</span><span class="n">inp_drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">input_drop</span><span class="p">)</span>
</span><span data-line="489">        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">hidden_drop</span><span class="p">)</span>
</span><span data-line="490">        <span class="bp">self</span><span class="o">.</span><span class="n">feature_map_drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">(</span><span class="n">feat_drop</span><span class="p">)</span>
</span><span data-line="491">
</span><span data-line="492">        <span class="c1"># Convolutional layer</span>
</span><span data-line="493">        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_filters</span><span class="p">,</span> <span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">use_bias</span><span class="p">)</span>
</span><span data-line="494">
</span><span data-line="495">        <span class="n">conv_out_h</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">emb_dim1</span> <span class="o">-</span> <span class="n">kernel_size</span> <span class="o">+</span> <span class="mi">1</span>
</span><span data-line="496">        <span class="n">conv_out_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_dim2</span> <span class="o">-</span> <span class="n">kernel_size</span> <span class="o">+</span> <span class="mi">1</span>
</span><span data-line="497">        <span class="n">hidden_size</span> <span class="o">=</span> <span class="n">n_filters</span> <span class="o">*</span> <span class="n">conv_out_h</span> <span class="o">*</span> <span class="n">conv_out_w</span>
</span><span data-line="498">
</span><span data-line="499">        <span class="c1"># Fully connected layer to project back to embedding dimension</span>
</span><span data-line="500">        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span></div>

</span><span data-line="501">
<div class="viewcode-block" id="ConvEInteraction.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.ConvEInteraction.forward">[docs]</a>
</span><span data-line="502">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="503"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="504"><span class="sd">        Score triples (h, r, t).</span>
</span><span data-line="505">
</span><span data-line="506"><span class="sd">        Args:</span>
</span><span data-line="507"><span class="sd">            h: Head entities (..., D)</span>
</span><span data-line="508"><span class="sd">            r: Relations (..., D)</span>
</span><span data-line="509"><span class="sd">            t: Tail entities (..., D)</span>
</span><span data-line="510">
</span><span data-line="511"><span class="sd">        Returns:</span>
</span><span data-line="512"><span class="sd">            scores: Triple scores (...)</span>
</span><span data-line="513"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="514">        <span class="c1"># Store original shape for later</span>
</span><span data-line="515">        <span class="n">orig_shape</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="516">
</span><span data-line="517">        <span class="c1"># Flatten to batch dimension</span>
</span><span data-line="518">        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="519">        <span class="n">h_flat</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="520">        <span class="n">r_flat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="521">        <span class="n">t_flat</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="522">
</span><span data-line="523">        <span class="c1"># Reshape embeddings into 2D &quot;images&quot;</span>
</span><span data-line="524">        <span class="n">h_img</span> <span class="o">=</span> <span class="n">h_flat</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_dim1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_dim2</span><span class="p">)</span>
</span><span data-line="525">        <span class="n">r_img</span> <span class="o">=</span> <span class="n">r_flat</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_dim1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_dim2</span><span class="p">)</span>
</span><span data-line="526">
</span><span data-line="527">        <span class="c1"># Stack head and relation vertically (along height dimension)</span>
</span><span data-line="528">        <span class="n">stacked</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">h_img</span><span class="p">,</span> <span class="n">r_img</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (B, 1, 2*emb_dim1, emb_dim2)</span>
</span><span data-line="529">
</span><span data-line="530">        <span class="c1"># Input dropout</span>
</span><span data-line="531">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inp_drop</span><span class="p">(</span><span class="n">stacked</span><span class="p">)</span>
</span><span data-line="532">
</span><span data-line="533">        <span class="c1"># Convolution</span>
</span><span data-line="534">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># (B, n_filters, conv_out_h, conv_out_w)</span>
</span><span data-line="535">        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="536">
</span><span data-line="537">        <span class="c1"># Feature map dropout</span>
</span><span data-line="538">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_map_drop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="539">
</span><span data-line="540">        <span class="c1"># Flatten feature maps</span>
</span><span data-line="541">        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="542">
</span><span data-line="543">        <span class="c1"># Fully connected projection</span>
</span><span data-line="544">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># (B, dim)</span>
</span><span data-line="545">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_drop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="546">        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="547">
</span><span data-line="548">        <span class="c1"># Score against tail entities (dot product)</span>
</span><span data-line="549">        <span class="n">scores</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">t_flat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="550">
</span><span data-line="551">        <span class="c1"># Reshape back to original shape</span>
</span><span data-line="552">        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">orig_shape</span><span class="p">)</span>
</span><span data-line="553">
</span><span data-line="554">        <span class="k">return</span> <span class="n">scores</span></div>
</div>

</span><span data-line="555">
</span><span data-line="556">
<div class="viewcode-block" id="TriplesScoreLayer">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TriplesScoreLayer">[docs]</a>
</span><span data-line="557"><span class="k">class</span><span class="w"> </span><span class="nc">TriplesScoreLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="558"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for knowledge graph triple scoring interactions.</span>
</span><span data-line="559">
</span><span data-line="560"><span class="sd">    Optimized for relation extraction in entity recognition models.</span>
</span><span data-line="561">
</span><span data-line="562"><span class="sd">    Args:</span>
</span><span data-line="563"><span class="sd">        interaction_mode: The type of interaction to use. Available modes:</span>
</span><span data-line="564"><span class="sd">            - Translational: UM, SE, TransE, TransH, TransF, PairRE, TripleRE</span>
</span><span data-line="565"><span class="sd">            - Semantic: DistMult, SimplE, ComplEx, QuatE, HolE, DistMA</span>
</span><span data-line="566"><span class="sd">            - Neural: TuckER, ERMLP, ConvE, ConvKB</span>
</span><span data-line="567"><span class="sd">        dim: Embedding dimension (required for most interactions).</span>
</span><span data-line="568"><span class="sd">        **kwargs: Extra parameters for specific interactions:</span>
</span><span data-line="569"><span class="sd">            - TuckER: requires d_e, d_r, optional dropout</span>
</span><span data-line="570"><span class="sd">            - ERMLP: optional hidden (default 2048)</span>
</span><span data-line="571"><span class="sd">            - ConvE: requires emb_dim1, optional n_filters, kernel_size, input_drop,</span>
</span><span data-line="572"><span class="sd">            hidden_drop, feat_drop, use_bias</span>
</span><span data-line="573"><span class="sd">            - ConvKB: optional n_filters, dropout, use_bias</span>
</span><span data-line="574"><span class="sd">            - Norm-based (TransE, TransH, etc.): optional p, power, clamp_norm,</span>
</span><span data-line="575"><span class="sd">            use_scorer, dropout</span>
</span><span data-line="576"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="577">
</span><span data-line="578">    <span class="c1"># Define dimension requirements for each interaction</span>
</span><span data-line="579">    <span class="n">DIMENSION_REQUIREMENTS</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="580">        <span class="s2">&quot;ComplEx&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
</span><span data-line="581">        <span class="s2">&quot;SimplE&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
</span><span data-line="582">        <span class="s2">&quot;QuatE&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
</span><span data-line="583">    <span class="p">}</span>
</span><span data-line="584">
<div class="viewcode-block" id="TriplesScoreLayer.__init__">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TriplesScoreLayer.__init__">[docs]</a>
</span><span data-line="585">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interaction_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="586">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="587">        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">interaction_mode</span>
</span><span data-line="588">        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
</span><span data-line="589">
</span><span data-line="590">        <span class="c1"># Validate dimension requirements</span>
</span><span data-line="591">        <span class="bp">self</span><span class="o">.</span><span class="n">validate_dimensions</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="592">
</span><span data-line="593">        <span class="c1"># Create the appropriate interaction</span>
</span><span data-line="594">        <span class="k">if</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;UM&quot;</span><span class="p">:</span>
</span><span data-line="595">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">UMInteraction</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="596">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;SE&quot;</span><span class="p">:</span>
</span><span data-line="597">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">SEInteraction</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="598">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;TransE&quot;</span><span class="p">:</span>
</span><span data-line="599">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">TransEInteraction</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="600">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;TransH&quot;</span><span class="p">:</span>
</span><span data-line="601">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">TransHInteraction</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="602">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;TransF&quot;</span><span class="p">:</span>
</span><span data-line="603">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">TransFInteraction</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="604">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;PairRE&quot;</span><span class="p">:</span>
</span><span data-line="605">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">PairREInteraction</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="606">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;TripleRE&quot;</span><span class="p">:</span>
</span><span data-line="607">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">TripleREInteraction</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="608">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;DistMult&quot;</span><span class="p">:</span>
</span><span data-line="609">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">DistMultInteraction</span><span class="p">()</span>
</span><span data-line="610">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;SimplE&quot;</span><span class="p">:</span>
</span><span data-line="611">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">SimplEInteraction</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="612">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;DistMA&quot;</span><span class="p">:</span>
</span><span data-line="613">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">DistMAInteraction</span><span class="p">()</span>
</span><span data-line="614">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;ComplEx&quot;</span><span class="p">:</span>
</span><span data-line="615">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">ComplExInteraction</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="616">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;QuatE&quot;</span><span class="p">:</span>
</span><span data-line="617">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">QuatEInteraction</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
</span><span data-line="618">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;HolE&quot;</span><span class="p">:</span>
</span><span data-line="619">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">HolEInteraction</span><span class="p">()</span>
</span><span data-line="620">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;TuckER&quot;</span><span class="p">:</span>
</span><span data-line="621">            <span class="n">d_e</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d_e&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span data-line="622">            <span class="n">d_r</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;d_r&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span data-line="623">            <span class="n">dropout</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dropout&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
</span><span data-line="624">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">TuckERInteraction</span><span class="p">(</span><span class="n">d_e</span><span class="p">,</span> <span class="n">d_r</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
</span><span data-line="625">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;ERMLP&quot;</span><span class="p">:</span>
</span><span data-line="626">            <span class="n">hidden</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
</span><span data-line="627">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">ERMLPInteraction</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
</span><span data-line="628">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;ConvE&quot;</span><span class="p">:</span>
</span><span data-line="629">            <span class="n">emb_dim1</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;emb_dim1&quot;</span><span class="p">)</span>
</span><span data-line="630">            <span class="k">if</span> <span class="n">emb_dim1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="631">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ConvE requires `emb_dim1` argument (height of reshaped embedding).&quot;</span><span class="p">)</span>
</span><span data-line="632">            <span class="n">n_filters</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_filters&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</span><span data-line="633">            <span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kernel_size&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span data-line="634">            <span class="n">input_drop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_drop&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
</span><span data-line="635">            <span class="n">hidden_drop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hidden_drop&quot;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
</span><span data-line="636">            <span class="n">feat_drop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feat_drop&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
</span><span data-line="637">            <span class="n">use_bias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_bias&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="638">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">ConvEInteraction</span><span class="p">(</span>
</span><span data-line="639">                <span class="n">dim</span><span class="p">,</span> <span class="n">emb_dim1</span><span class="p">,</span> <span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">input_drop</span><span class="p">,</span> <span class="n">hidden_drop</span><span class="p">,</span> <span class="n">feat_drop</span><span class="p">,</span> <span class="n">use_bias</span>
</span><span data-line="640">            <span class="p">)</span>
</span><span data-line="641">        <span class="k">elif</span> <span class="n">interaction_mode</span> <span class="o">==</span> <span class="s2">&quot;ConvKB&quot;</span><span class="p">:</span>
</span><span data-line="642">            <span class="n">n_filters</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_filters&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span><span data-line="643">            <span class="n">dropout</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dropout&quot;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
</span><span data-line="644">            <span class="n">use_bias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_bias&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="645">            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">ConvKBInteraction</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">n_filters</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">use_bias</span><span class="p">)</span>
</span><span data-line="646">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="647">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown interaction mode &#39;</span><span class="si">{</span><span class="n">interaction_mode</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span></div>

</span><span data-line="648">
<div class="viewcode-block" id="TriplesScoreLayer.validate_dimensions">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TriplesScoreLayer.validate_dimensions">[docs]</a>
</span><span data-line="649">    <span class="k">def</span><span class="w"> </span><span class="nf">validate_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="650"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="651"><span class="sd">        Validate that the embedding dimension meets requirements for this interaction.</span>
</span><span data-line="652">
</span><span data-line="653"><span class="sd">        Args:</span>
</span><span data-line="654"><span class="sd">            dim: The embedding dimension to validate</span>
</span><span data-line="655">
</span><span data-line="656"><span class="sd">        Raises:</span>
</span><span data-line="657"><span class="sd">            ValueError: If dimension requirements are not met</span>
</span><span data-line="658"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="659">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIMENSION_REQUIREMENTS</span><span class="p">:</span>
</span><span data-line="660">            <span class="n">check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIMENSION_REQUIREMENTS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">]</span>
</span><span data-line="661">            <span class="k">if</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
</span><span data-line="662">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ComplEx&quot;</span><span class="p">,</span> <span class="s2">&quot;SimplE&quot;</span><span class="p">]:</span>
</span><span data-line="663">                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2"> requires even embedding dimension. Got </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span data-line="664">                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;QuatE&quot;</span><span class="p">:</span>
</span><span data-line="665">                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2"> requires embedding dimension divisible by 4. Got </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span data-line="666">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="667">                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2"> has dimension requirements not satisfied by </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span data-line="668">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

</span><span data-line="669">
<div class="viewcode-block" id="TriplesScoreLayer.forward">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TriplesScoreLayer.forward">[docs]</a>
</span><span data-line="670">    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span data-line="671"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="672"><span class="sd">        Score triples (h, r, t).</span>
</span><span data-line="673">
</span><span data-line="674"><span class="sd">        Args:</span>
</span><span data-line="675"><span class="sd">            h: Head entities (..., D)</span>
</span><span data-line="676"><span class="sd">            r: Relations (..., D)</span>
</span><span data-line="677"><span class="sd">            t: Tail entities (..., D)</span>
</span><span data-line="678">
</span><span data-line="679"><span class="sd">        Returns:</span>
</span><span data-line="680"><span class="sd">            scores: Triple scores (...)</span>
</span><span data-line="681"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="682">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span></div>

</span><span data-line="683">
<div class="viewcode-block" id="TriplesScoreLayer.forward_batched_relations">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TriplesScoreLayer.forward_batched_relations">[docs]</a>
</span><span data-line="684">    <span class="k">def</span><span class="w"> </span><span class="nf">forward_batched_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">rel_embeddings</span><span class="p">):</span>
</span><span data-line="685"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="686"><span class="sd">        Efficiently score entity pairs against all relation types.</span>
</span><span data-line="687">
</span><span data-line="688"><span class="sd">        Args:</span>
</span><span data-line="689"><span class="sd">            h: Head entities (B, N, D)</span>
</span><span data-line="690"><span class="sd">            t: Tail entities (B, N, D)</span>
</span><span data-line="691"><span class="sd">            rel_embeddings: Relation type embeddings (B, C, D) or (C, D)</span>
</span><span data-line="692">
</span><span data-line="693"><span class="sd">        Returns:</span>
</span><span data-line="694"><span class="sd">            scores: (B, N, C) scores for each pair against each relation type</span>
</span><span data-line="695"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="696">        <span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="697">
</span><span data-line="698">        <span class="c1"># Handle both batched and unbatched relation embeddings</span>
</span><span data-line="699">        <span class="k">if</span> <span class="n">rel_embeddings</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span data-line="700">            <span class="n">C</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rel_embeddings</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="701">            <span class="n">rel_embeddings</span> <span class="o">=</span> <span class="n">rel_embeddings</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="702">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="703">            <span class="n">C</span> <span class="o">=</span> <span class="n">rel_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="704">
</span><span data-line="705">        <span class="c1"># Expand dimensions for broadcasting</span>
</span><span data-line="706">        <span class="n">h_exp</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="707">        <span class="n">t_exp</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="708">        <span class="n">r_exp</span> <span class="o">=</span> <span class="n">rel_embeddings</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="709">
</span><span data-line="710">        <span class="c1"># Reshape to (B*N*C, D) for efficient batch processing</span>
</span><span data-line="711">        <span class="n">h_flat</span> <span class="o">=</span> <span class="n">h_exp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="712">        <span class="n">r_flat</span> <span class="o">=</span> <span class="n">r_exp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="713">        <span class="n">t_flat</span> <span class="o">=</span> <span class="n">t_exp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="714">
</span><span data-line="715">        <span class="c1"># Score all triples at once</span>
</span><span data-line="716">        <span class="n">scores_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="p">(</span><span class="n">h_flat</span><span class="p">,</span> <span class="n">r_flat</span><span class="p">,</span> <span class="n">t_flat</span><span class="p">)</span>
</span><span data-line="717">
</span><span data-line="718">        <span class="c1"># Reshape back to (B, N, C)</span>
</span><span data-line="719">        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores_flat</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</span><span data-line="720">
</span><span data-line="721">        <span class="k">return</span> <span class="n">scores</span></div>

</span><span data-line="722">
<div class="viewcode-block" id="TriplesScoreLayer.forward_single_relation">
<a class="viewcode-back" href="../../../../api/gliner.modeling.multitask.triples_layers.html#gliner.modeling.multitask.triples_layers.TriplesScoreLayer.forward_single_relation">[docs]</a>
</span><span data-line="723">    <span class="k">def</span><span class="w"> </span><span class="nf">forward_single_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span data-line="724"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="725"><span class="sd">        Score entity pairs with a single relation type.</span>
</span><span data-line="726">
</span><span data-line="727"><span class="sd">        Args:</span>
</span><span data-line="728"><span class="sd">            h: Head entities (B, N, D)</span>
</span><span data-line="729"><span class="sd">            t: Tail entities (B, N, D)</span>
</span><span data-line="730"><span class="sd">            r: Single relation embedding (B, D) or (D,)</span>
</span><span data-line="731">
</span><span data-line="732"><span class="sd">        Returns:</span>
</span><span data-line="733"><span class="sd">            scores: (B, N) scores for each pair with the given relation</span>
</span><span data-line="734"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="735">        <span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="736">
</span><span data-line="737">        <span class="c1"># Expand relation to match batch and pair dimensions</span>
</span><span data-line="738">        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="739">            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="740">        <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span data-line="741">            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="742">
</span><span data-line="743">        <span class="c1"># Flatten for scoring</span>
</span><span data-line="744">        <span class="n">h_flat</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="745">        <span class="n">t_flat</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="746">        <span class="n">r_flat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span data-line="747">
</span><span data-line="748">        <span class="c1"># Score</span>
</span><span data-line="749">        <span class="n">scores_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="p">(</span><span class="n">h_flat</span><span class="p">,</span> <span class="n">r_flat</span><span class="p">,</span> <span class="n">t_flat</span><span class="p">)</span>
</span><span data-line="750">
</span><span data-line="751">        <span class="c1"># Reshape to (B, N)</span>
</span><span data-line="752">        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores_flat</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span><span data-line="753">
</span><span data-line="754">        <span class="k">return</span> <span class="n">scores</span></div>
</div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, GLiNER community</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../../../_static/documentation_options.js?v=dc91f075"></script>
      <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/shibuya.js?v=9b0e4dde"></script></body>
</html>